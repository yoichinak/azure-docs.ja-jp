---
title: SQL Server 可用性グループ リスナーを Azure 仮想マシンに作成する | Microsoft Docs
description: Azure Virtual Machines に SQL Server の AlwaysOn 可用性グループのリスナーを作成する手順を説明します。
services: virtual-machines
documentationcenter: na
author: MikeRayMSFT
manager: craigg
editor: monicar
ms.assetid: d1f291e9-9af2-41ba-9d29-9541e3adcfcf
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 02/16/2017
ms.author: mikeray
ms.openlocfilehash: 7ef26dc5fa7676ca590d56978c735bf4a195440b
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/11/2018
ms.locfileid: "38698052"
---
# <a name="configure-a-load-balancer-for-an-always-on-availability-group-in-azure"></a>Azure の AlwaysOn 可用性グループに使用するロード バランサーの構成
この記事では、Azure Resource Manager で動作する Azure 仮想マシンに、SQL Server AlwaysOn 可用性グループのロード バランサーを作成する方法について説明します。 SQL Server インスタンスが Azure 仮想マシン上で実行されている場合、可用性グループにロード バランサーが必要となります。 ロード バランサーには、可用性グループ リスナーの IP アドレスが格納されます。 可用性グループが複数のリージョンにまたがっている場合は、各リージョンにロード バランサーが必要です。

この作業を行うには、Resource Manager で動作する Azure 仮想マシンに SQL Server 可用性グループがデプロイされている必要があります。 両方の SQL Server 仮想マシンが同じ可用性セットに属している必要があります。 [Microsoft のテンプレート](virtual-machines-windows-portal-sql-alwayson-availability-groups.md)を使用すると、Resource Manager で自動的に可用性グループを作成することができます。 内部ロード バランサーは、このテンプレートによって自動的に作成されます。 

必要に応じて [可用性グループを手動で構成](virtual-machines-windows-portal-sql-availability-group-tutorial.md)することもできます。

この記事は、可用性グループの構成が既に済んでいることを前提としています。  

関連トピック:

* [Azure VM での AlwaysOn 可用性グループの構成 (GUI)](virtual-machines-windows-portal-sql-availability-group-tutorial.md)   
* [Azure リソース マネージャーと PowerShell を使用した VNet 間の接続の構成](../../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md)

この記事では、Azure Portal でロード バランサーを作成し、必要な構成を行います。 その作業が済んだら、可用性グループ リスナーのロード バランサーの IP アドレスを使用するようにクラスターを構成します。

## <a name="create-and-configure-the-load-balancer-in-the-azure-portal"></a>Azure ポータルでのロード バランサーの作成と構成
この作業の一環として、次の手順を実行します。

1. Azure Portal でロード バランサーを作成して IP アドレスを構成します。
2. バックエンド プールを構成します。
3. プローブを作成します。 
4. 負荷分散規則を設定します。

> [!NOTE]
> SQL Server インスタンスが複数のリソース グループや複数のリージョンに存在する場合、各手順を 2 回 (リソース グループごとに 1 回) 行ってください。
> 
> 

### <a name="step-1-create-the-load-balancer-and-configure-the-ip-address"></a>手順 1: ロード バランサーを作成して IP アドレスを構成する
まず、ロード バランサーを作成します。 

1. Azure ポータルで、SQL Server の仮想マシンを含んだリソース グループを開きます。 

2. リソース グループで **[追加]** をクリックします。

3. **ロード バランサー**を探し、検索結果から **[ロード バランサー]** (**Microsoft** によって発行されたもの) を選択します。

4. **[ロード バランサー]** ブレードで **[作成]** をクリックします。

5. **[ロード バランサーの作成]** ダイアログボックスで、次のようにロード バランサーを構成します。

   | Setting | 値 |
   | --- | --- |
   | **名前** |ロード バランサーを表すテキスト名  (例: **sqlLB**)。 |
   | **種類** |**内部**: ほとんどの実装では、内部ロード バランサーを使います。この場合、同じ仮想ネットワーク内のアプリケーションが可用性グループに接続できます。  </br> **外部**: アプリケーションがパブリック インターネット接続経由で可用性グループに接続できます。 |
   | **Virtual Network** |SQL Server インスタンスが存在する仮想ネットワークを選択します。 |
   | **サブネット** |SQL Server インスタンスが存在するサブネットを選択します。 |
   | **IP アドレスの割り当て** |**静的** |
   | **プライベート IP アドレス** |サブネット内の利用可能な IP アドレスを指定します。 この IP アドレスは、クラスターにリスナーを作成するときに使用します。 この記事で後ほど示す PowerShell スクリプトの `$ILBIP` 変数には、このアドレスを使用してください。 |
   | **サブスクリプション** |複数のサブスクリプションを所有している場合、このフィールドが表示されます。 このリソースに関連付けられているサブスクリプションを選択します。 通常は、可用性グループのすべてのリソースについて同じサブスクリプションを選択してください。 |
   | **[リソース グループ]** |SQL Server インスタンスが存在するリソース グループを選択します。 |
   | **場所** |Azure において SQL Server インスタンスが存在する場所を選択します。 |

6. **Create** をクリックしてください。 

ロード バランサーが Azure によって作成されます。 このロード バランサーは、特定のネットワーク、サブネット、リソース グループ、場所に従属します。 Azure の処理が完了したら、ロード バランサーの設定を Azure で確認してください。 

### <a name="step-2-configure-the-back-end-pool"></a>手順 2: バックエンド プールを構成する
Azure では、バックエンド アドレス プールを "*バックエンド プール*" と呼んでいます。 この例では、可用性グループに含まれる 2 つの SQL Server インスタンスのアドレスがバックエンド プールとなります。 

1. リソース グループで、作成したロード バランサーをクリックします。 

2. **[設定]** の **[バックエンド プール]** をクリックします。

3. **[バックエンド プール]** の **[追加]** をクリックしてバックエンド アドレス プールを作成します。 

4. **[バックエンド プールの追加]** の **[名前]** に、バックエンド プールの名前を入力します。

5. **[仮想マシン]** の **[仮想マシンの追加]** をクリックします。 

6. **[仮想マシンの選択]** の **[可用性セットの選択]** をクリックし、SQL Server 仮想マシンの追加先となる可用性セットを指定します。

7. 可用性セットを選択したら、**[仮想マシンの選択]** をクリックし、可用性グループにおける SQL Server インスタンスのホストとなる 2 つの仮想マシンを選んで **[選択]** をクリックします。 

8. **[OK]** をクリックして、**[仮想マシンの選択]** のブレードと、**[バックエンド プールの追加]** を閉じます。 

バックエンド アドレス プールの設定が Azure で更新されます。 これで 2 つの SQL Server インスタンスから成るプールが可用性セットに作成されました。

### <a name="step-3-create-a-probe"></a>手順 3: プローブを作成する
このプローブで定義された方法で、現在どの SQL Server インスタンスが可用性グループ リスナーを所有しているかが Azure によって確認されます。 Azure は、プローブの作成時に定義されたポートで、IP アドレスに基づいてサービスをプローブします。

1. ロード バランサーの **[設定]** ブレードで **[Health probes (正常性のプローブ)]** をクリックします。 

2. **[Health probes (正常性のプローブ)]** ブレードで **[追加]** をクリックします。

3. **[プローブの追加]** ブレードでプローブを構成します。 次の値を使用してプローブを構成します。

   | Setting | 値 |
   | --- | --- |
   | **名前** |プローブを表すテキスト名  (例: **SQLAlwaysOnEndPointProbe**)。 |
   | **プロトコル** |**TCP** |
   | **ポート** |空いている任意のポートを使用できます  (例: *59999*)。 |
   | **間隔** |*5* |
   | **異常のしきい値** |*2* |

4.  Click **OK**. 

> [!NOTE]
> 指定したポートは、両方の SQL Server インスタンスのファイアウォールで必ず開放してください。 使用する TCP ポートに対する入力方向の規則が両方のインスタンスに必要となります。 詳細については、「[ファイアウォール規則を追加または編集する](http://technet.microsoft.com/library/cc753558.aspx)」をご覧ください。 
> 
> 

Azure はこのプローブを作成、使用して、どの SQL Server インスタンスが可用性グループのリスナーを所有しているかを判定します。

### <a name="step-4-set-the-load-balancing-rules"></a>手順 4: 負荷分散規則を設定する
SQL Server インスタンスへのトラフィックをロード バランサーでどのようにルーティングするかは、負荷分散規則で設定します。 2 つの SQL Server インスタンスのうち可用性グループ リスナー リソースを所有できるのは一度に 1 つだけであるため、このロード バランサーでは Direct Server Return を有効にします。

1. ロード バランサーの **[設定]** ブレードで **[負荷分散規則]** をクリックします。 

2. **[負荷分散規則]** ブレードで、**[追加]** をクリックします。

3. **[負荷分散規則の追加]** ブレードを使用して負荷分散規則を構成します。 次の設定を使用します。 

   | Setting | 値 |
   | --- | --- |
   | **名前** |負荷分散規則を表すテキスト名  (例: **SQLAlwaysOnEndPointListener**)。 |
   | **プロトコル** |**TCP** |
   | **ポート** |*1433* |
   | **バックエンド ポート** |*1433*この規則には **[フローティング IP (Direct Server Return)]** が使用されるため、この値は無視されます。 |
   | **プローブ** |このロード バランサーに対して作成したプローブの名前を使用します。 |
   | **セッション永続化** |**なし** |
   | **アイドル タイムアウト (分)** |*4* |
   | **フローティング IP (ダイレクト サーバー リターン)** |**有効** |

   > [!NOTE]
   > ブレード上で一部の設定が隠れて見えないときは下へスクロールしてください。
   > 

4. Click **OK**. 
5. 負荷分散規則が Azure によって構成されます。 以上、可用性グループのリスナーのホストとなっている SQL Server インスタンスにトラフィックをルーティングするようにロード バランサーを構成しました。 

この時点で、リソース グループのロード バランサーが両方の SQL Server マシンに接続されています。 またロード バランサーには、可用性グループへの要求にいずれかのマシンが応答できるよう、SQL Server AlwaysOn 可用性グループ リスナーの IP アドレスが格納されます。

> [!NOTE]
> SQL Server インスタンスが 2 つの異なるリージョンに存在する場合、もう一方のリージョンについても以上の手順を繰り返す必要があります。 ロード バランサーはリージョンごとに必要です。 
> 
> 

## <a name="configure-the-cluster-to-use-the-load-balancer-ip-address"></a>ロード バランサーの IP アドレスを使用するようにクラスターを構成する
次に、クラスター上のリスナーを構成し、リスナーをオンラインに切り替えます。 以下の手順を実行します。 

1. 可用性グループ リスナーをフェールオーバー クラスターで作成します。 

2. リスナーをオンラインにします。

### <a name="step-5-create-the-availability-group-listener-on-the-failover-cluster"></a>手順 5: 可用性グループ リスナーをフェールオーバー クラスターで作成する
この手順では、フェールオーバー クラスター マネージャーおよび SQL Server Management Studio で可用性グループ リスナーを手動で作成します。

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

### <a name="verify-the-configuration-of-the-listener"></a>リスナーの構成を確認します。

クラスター リソースと依存関係が正しく構成されていれば、SQL Server Management Studio にリスナーが表示されます。 リスナーのポートを設定するために、次の手順を実行してください。

1. SQL Server Management Studio を起動し、プライマリ レプリカに接続します。

2. **[AlwaysOn 高可用性]** > **[可用性グループ]** > **[可用性グループ リスナー]** の順に移動します。  
    フェールオーバー クラスター マネージャーで作成したリスナー名が表示されます。 

3. リスナー名を右クリックし、**[プロパティ]** をクリックします。

4. **[ポート]** ボックスで、以前に使用した $EndpointPort (既定値は 1433) を使用し、可用性グループ リスナーのポート番号を指定して、**[OK]** をクリックします。

これで、可用性グループが Resource Manager モードで実行されている Azure 仮想マシンにデプロイされました。 

## <a name="test-the-connection-to-the-listener"></a>リスナーへの接続をテストする
次の手順を実行して接続をテストします。

1. 同じ仮想ネットワークに存在する、レプリカを所有していない SQL Server インスタンスに RDP で接続します。 このサーバーは、クラスター内の別の SQL Server インスタンスでもかまいません。

2. **sqlcmd** ユーティリティを使用して接続をテストします。 たとえば、次のスクリプトはリスナー経由で Windows 認証を使用し、プライマリ レプリカとの **sqlcmd** 接続を確立しています。
   
        sqlcmd -S <listenerName> -E

SQLCMD 接続では、プライマリ レプリカのホストとなる SQL Server インスタンスに対して自動的に接続されます。 

## <a name="create-an-ip-address-for-an-additional-availability-group"></a>追加の可用性グループの IP アドレスを作成する

各可用性グループは、個別のリスナーを使用します。 各リスナーには独自の IP アドレスがあります。 追加のリスナーの IP アドレスを保持するために、同じロード バランサーを使用します。 可用性グループを作成した後で、IP アドレスをロード バランサーに追加し、リスナーを構成します。

Azure Portal で IP アドレスをロード バランサーに追加するには、次の手順に従います。

1. Azure Portal で、ロード バランサーを含むリソース グループを開き、ロード バランサーをクリックします。 

2. **[設定]** の **[フロントエンド IP プール]** をクリックし、**[追加]** をクリックします。 

3. **[フロントエンド IP アドレスの追加]** で、フロントエンドの名前を割り当てます。 

4. **[仮想ネットワーク]** と **[サブネット]** が SQL Server インスタンスと同じであることを確認します。

5. リスナーの IP アドレスを設定します。 
   
   >[!TIP]
   >IP アドレスを静的に設定し、現在サブネットで使用されていないアドレスを入力することができます。 また、IP アドレスを動的に設定して、新しいフロントエンド IP プールを保存することもできます。 その場合、使用可能な IP アドレスが、Azure Portal によって自動的にプールに割り当てられます。 その後、フロントエンド IP プールを再び開いて、割り当てを静的に変更することができます。 

6. リスナーの IP アドレスを保存します。 

7. 次の設定で正常性プローブを追加します。

   |Setting |値
   |:-----|:----
   |**名前** |プローブを識別する名前。
   |**プロトコル** |TCP
   |**ポート** |未使用の TCP ポート。すべての仮想マシンで使用できる必要があります。 他の目的では使用できません。 2 つのリスナーが同じプローブ ポートを使用することはできません。 
   |**間隔** |プローブの試行の間隔。 既定値 (5) を使用します。
   |**異常のしきい値** |連続する失敗の回数のしきい値。これを超えると、仮想マシンが異常と見なされます。

8. **[OK]** をクリックして、プローブを保存します。 

9. 負荷分散規則の作成 **[負荷分散規則]** をクリックし、**[追加]** をクリックします。

10. 新しい負荷分散規則を次の設定で構成します。

   |Setting |値
   |:-----|:----
   |**名前** |負荷分散規則を識別する名前。 
   |**フロントエンド IP アドレス** |作成した IP アドレスを選択します。 
   |**プロトコル** |TCP
   |**ポート** |SQL Server インスタンスで使用されているポートを使用します。 変更していない限り、既定のインスタンスはポート 1433 を使用します。 
   |**バックエンド ポート** |**[ポート]** と同じ値を使用します。
   |**バックエンド プール** |SQL Server インスタンスがある仮想マシンを含むプールです。 
   |**正常性プローブ** |作成したプローブを選択します。
   |**セッション永続化** |なし
   |**アイドル タイムアウト (分)** |既定値 (4)
   |**フローティング IP (ダイレクト サーバー リターン)** | 有効

### <a name="configure-the-availability-group-to-use-the-new-ip-address"></a>新しい IP アドレスを使用して可用性グループを構成する

クラスターの構成を完了するには、最初の可用性グループを作成したときの手順を繰り返します。 つまり、[新しい IP アドレスを使用するクラスター](#configure-the-cluster-to-use-the-load-balancer-ip-address)を構成します。 

リスナーの IP アドレスを追加した後は、追加の可用性グループを次の手順で構成できます。 

1. 新しい IP アドレスのプローブ ポートが両方の SQL Server 仮想マシンで開かれていることを確認する。 

2. [クラスター マネージャーでクライアント アクセス ポイントを追加する](#addcap)。

3. [可用性グループの IP リソースを構成する](#congroup)。

   >[!IMPORTANT]
   >IP アドレスを作成する場合は、ロード バランサーに追加した IP アドレスを使用します。  

4. [SQL Server 可用性グループ リソースがクライアント アクセス ポイントに依存するように設定する](#dependencyGroup)。

5. [クライアント アクセス ポイント リソースが IP アドレスに依存するように設定する](#listname)。
 
6. [PowerShell でクラスターのパラメーターを設定する](#setparam)。

新しい IP アドレスを使用するように可用性グループを構成した後は、リスナーへの接続を構成します。 

## <a name="add-load-balancing-rule-for-distributed-availability-group"></a>分散可用性グループの負荷分散規則を追加する

可用性グループが分散可用性グループに参加している場合は、ロード バランサーに追加の規則が必要になります。 この規則には、分散可用性グループ リスナーによって使用されるポートが格納されます。

>[!IMPORTANT]
>この手順は、可用性グループが[分散可用性グループ](http://docs.microsoft.com/sql/database-engine/availability-groups/windows/configure-distributed-availability-groups)に参加している場合にのみ適用されます。 

1. 分散可用性グループに参加している各サーバーで、分散可用性グループ リスナーの TCP ポートに関する受信規則を作成します。 ドキュメントでは、多くの例で 5022 が使用されます。 

1. Azure Portal でロード バランサーをクリックし、**[負荷分散規則]** をクリックした後、**[+ 追加]** をクリックします。 

1. 負荷分散規則を次の設定で作成します。

   |Setting |値
   |:-----|:----
   |**名前** |分散可用性グループの負荷分散規則を識別するための名前。 
   |**フロントエンド IP アドレス** |可用性グループと同じフロント エンド IP アドレスを使用します。
   |**プロトコル** |TCP
   |**ポート** |5022 - [分散可用性グループのエンドポイント リスナー](http://docs.microsoft.com/sql/database-engine/availability-groups/windows/configure-distributed-availability-groups)用のポート。</br> 任意のポートを使用できます。  
   |**バックエンド ポート** | 5022 - **[ポート]** と同じ値を使用します。
   |**バックエンド プール** |SQL Server インスタンスがある仮想マシンを含むプールです。 
   |**正常性プローブ** |作成したプローブを選択します。
   |**セッション永続化** |なし
   |**アイドル タイムアウト (分)** |既定値 (4)
   |**フローティング IP (ダイレクト サーバー リターン)** | 有効

分散可用性グループに参加している他の可用性グループのロード バランサーについても、これらの手順を繰り返します。

## <a name="next-steps"></a>次の手順

- [異なるリージョンの Azure Virtual Machines に SQL Server AlwaysOn 可用性グループを構成する](virtual-machines-windows-portal-sql-availability-group-dr.md)
