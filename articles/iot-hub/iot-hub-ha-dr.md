---
title: Azure IoT Hub の高可用性とディザスター リカバリー | Microsoft Docs
description: ディザスター リカバリー機能を持つ高可用性 Azure IoT ソリューションの構築を支援する Azure および IoT Hub 機能について説明します。
author: rkmanda
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 08/07/2018
ms.author: rkmanda
ms.openlocfilehash: 04a3f4bbe1f0534d0eed88fbb8eb6ada4000a4f0
ms.sourcegitcommit: 35ceadc616f09dd3c88377a7f6f4d068e23cceec
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/08/2018
ms.locfileid: "39620401"
---
# <a name="iot-hub-high-availability-and-disaster-recovery"></a>IoT Hub の高可用性とディザスター リカバリー
回復力のある IoT ソリューションを実装するための第一歩として、設計者、開発者、経営者は、構築しているソリューションのアップタイム目標を定義する必要があります。 アップタイム目標は、主にシナリオごとの細かい事業目標に基づいて定義できます。 このような背景から、この[Azure ビジネス継続性テクニカル ガイダンス](https://docs.microsoft.com/azure/architecture/resiliency/)に関する記事では、ビジネス継続性とディザスター リカバリーについて考慮する際に役立つ一般的なフレームワークについて説明しています。 [Azure アプリケーションのディザスター リカバリーと高可用性](https://msdn.microsoft.com/library/dn251004.aspx)に関するページでは、高可用性 (HA) とディザスター リカバリー (DR) を実現するための Azure アプリケーションの戦略に関するアーキテクチャのガイダンスを確認できます。

この記事では、特に IoT Hub サービスによって提供されている HA および DR の機能について説明します。 この記事では、次のように幅広い分野について取り上げています。

- リージョン内 HA
- リージョン間 DR
- リージョン間 HA の達成

IoT ソリューションに定義するアップタイム目標に応じて、後述するオプションから、事業目標に最適なものを判断することをお勧めします。 こうした HA/DR の代替方法のいずれかを IoT ソリューションに組み込むには、以下の条件間のトレードオフを慎重に評価する必要があります。
- 必要な回復性のレベル 
- 実装とメンテナンスの複雑さ
- 売上原価 (COGS) への影響


## <a name="intra-region-ha"></a>リージョン内 HA
IoT Hub サービスは、サービスのほぼすべてのレイヤーに冗長性を実装することで、リージョン内 HA を提供しています。 [IoT Hub サービスで発行されている SLA](https://azure.microsoft.com/support/legal/sla/iot-hub) は、これらの冗長性を利用することで達成されます。 これらの HA 機能を利用するために、IoT ソリューションの開発者が追加の作業を行う必要はありません。 IoT Hub ではかなり高いアップタイムが保証されていますが、分散コンピューティング プラットフォームの場合と同様に一時的な障害が発生する可能性があります。 ソリューションをオンプレミス ソリューションからクラウドに移行し始めたばかりの場合は、重視する点を "平均失敗間隔" の最適化から "平均回復時間" の最適化に移す必要があります。 言い換えると、混在環境のクラウドで運用している場合、一時的な障害は正常とみなされます。 一時的な障害に対処するには、クラウド アプリケーションと対話するコンポーネントに適切な[再試行ポリシー](iot-hub-reliability-features-in-sdks.md)を組み込む必要があります。

> [!NOTE]
> また、一部の Azure サービスは、 [Availability Zone (AZ)](../availability-zones/az-overview.md) と統合することで、リージョン内の可用性のレイヤーを追加しています。 現在、AZ は IoT Hub サービスでサポートされていません。

## <a name="cross-region-dr"></a>リージョン間 DR
停電やその他の物理的な資産の不具合により、データセンターに長時間の停止が発生する場合があります。 このようなイベントはまれであり、その間に、前述のリージョン内 HA 機能があっても常に役立つとは限りません。 IoT Hub には、このような長時間の停止から復旧するための複数のソリューションが用意されています。 このような状況で利用できる回復オプションは、"Microsoft が開始するフェールオーバー" と "手動フェールオーバー" です。 この 2 つの根本的な違いは、前者は Microsoft が開始し、後者はユーザーが開始する点です。 また、Microsoft が開始するフェールオーバー オプションと比較して、手動フェールオーバーは目標復旧時間 (RTO) が短くなります。 各オプションで指定する具体的な RTO については、以下のセクションで説明します。 いずれかのオプションを使用してプライマリ リージョンから IoT Hub のフェールオーバーを実行すると、対応する [Azure geo ペア リージョン](../best-practices-availability-paired-regions.md)でハブは完全に機能します。


これらのいずれのフェールオーバー オプションにも、次の回復ポイントの目標 (RPO) が提供されています。

| データ型 | 回復ポイントの目標 (RPO) |
| --- | --- |
| ID レジストリ |0 ～ 5 分間のデータ損失 |
| デバイス ツイン データ |0 ～ 5 分間のデータ損失 |
| クラウドからデバイスへのメッセージ** |0 ～ 5 分間のデータ損失 |
| 親**とデバイスのジョブ |0 ～ 5 分間のデータ損失 |
| デバイスからクラウドへのメッセージ |すべての未読メッセージが失われる |
| 操作の監視メッセージ |すべての未読メッセージが失われる |
| クラウドからデバイスへのフィードバック メッセージ |すべての未読メッセージが失われる |

IoT Hub のフェールオーバー操作が完了すると、デバイスおよびバックエンド アプリケーションからのすべての操作は、機能し続けることが期待されます。手動操作は必要ありません。

> [!CAUTION]
> - IoT Hub の組み込みイベント エンドポイントのイベント ハブと互換性のある名前とエンドポイントは、フェールオーバー後に変更されます。 イベント ハブ クライアントまたはイベント プロセッサ ホストのいずれかを使用して組み込みエンドポイントからテレメトリ メッセージを受信する場合は、 [IoT Hub 接続文字列](iot-hub-devguide-messages-read-builtin.md#read-from-the-built-in-endpoint)を使用して接続を確立する必要があります。 これにより、フェールオーバー後に手動操作することなく、バックエンド アプリケーションは継続的に動作します。 バックエンド アプリケーションでイベント ハブと互換性のある名前とエンドポイントを直接使用する場合、フェールオーバー後も運用を継続するには、[新しいイベント ハブ互換の名前とエンドポイントを取得して](iot-hub-devguide-messages-read-builtin.md#read-from-the-built-in-endpoint)アプリケーションを再構成する必要があります。
>
> - フェールオーバー後、Event Grid から発行されたイベントは、それらの Event Grid のサブスクリプションを引き続き利用できる場合、以前に構成された同じサブスクリプションから使用できます。
>
> - この機能のプレビュー版では、クラウド からデバイスへのメッセージと親ジョブは、手動フェールオーバーの一部として復旧されません。

### <a name="microsoft-initiated-failover"></a>Microsoft が開始するフェールオーバー
Microsoft が開始するフェールオーバーは、Microsoft が実行します。まれではありますが、影響を受けるリージョンのすべての IoT ハブは、対応する geo ペア リージョンにフェールオーバーされます。 このプロセスは既定のオプションであり (ユーザーがオプトアウトすることはできません)、ユーザー操作は必要はありません。 Microsoft は、このオプションを実行するタイミングを権利を留保します。 このメカニズムでは、ユーザーのハブがフェールオーバーされる前にユーザーの同意を必要としません。 Microsoft が開始するフェールオーバーには、2-26 時間の目標復旧時間 (RTO) があります。 RTO が大きい値なのは、Microsoft がそのリージョンの影響を受けるすべてのお客様に代わってフェールオーバー操作を実行する必要があるためです。 約 1 日のダウンタイムを維持できる、あまり重要ではない IoT ソリューションを実行している場合は、IoT ソリューションの全体的なディザスター リカバリー目標を満たすために、このオプションを利用しても問題ありません。 このプロセスがトリガーされた後、ランタイム操作が完全に使用できるようになるまでの合計時間については、「復旧時間」を参照してください。

### <a name="manual-failover-preview"></a>手動フェールオーバー (プレビュー)

Microsoft が開始するフェールオーバーで指定されている RTO ではビジネスのアップタイム目標が満たされない場合は、手動フェールオーバーを使用してフェールオーバー処理を開始することを検討してください。 このオプションを使用する RTO は、10 分から数時間の間の任意の時間にすることができます。 現在、RTO は、フェールオーバーされている IoT Hub インスタンスに対して登録されているデバイス数の関数です。 約 100,000 台のデバイスをホストしているハブの RTO は約 15 分であると想定できます。 このプロセスがトリガーされた後、ランタイム操作が完全に使用できるようになるまでの合計時間については、「復旧時間」を参照してください。

プライマリ リージョンでダウンタイムが発生しているかどうかにかかわらず、手動フェールオーバー オプションは常に使用できます。 そのため、このオプションは、計画されたフェールオーバーを実行する場合にも使用することができます。 計画されたフェールオーバーの使用例の 1 つとして、定期的なフェールオーバー ドリルを実行する場合です。 ただし、計画されたフェールオーバー操作により、このオプションの RTO で定義された期間にハブのダウンタイムが発生し、前述の RPO の表で定義されたデータ損失が発生する点にも注意してください。 実際の災害が発生したときにエンドツーエンドのソリューションが稼動することを確認するために、計画されたフェールオーバー オプションを定期的に実行するように、テスト IoT Hub インスタンスを設定することをお勧めします。

> [!IMPORTANT]
> - 運用環境で使用されている IoT Hub では、テスト ドリルを実行しないでください。
>
> - 手動フェールオーバーは、Azure の geo ペア リージョン間でハブを永続的に移行するメカニズムとして使用しないでください。 以前のプライマリ リージョンをホームとするデバイスからハブに対して実行される操作の待機時間が長くなります。
>
> - 手動フェールオーバーは現在プレビュー段階であり、次の Azure リージョンでは使用できません。 米国東部、米国西部、北ヨーロッパ、西ヨーロッパ、ブラジル南部、米国中南部。

### <a name="failback"></a>フェールバック

旧プライマリ リージョンへのフェールバックは、別の時間にフェールオーバー アクションをトリガーすることで実現できます。 元のプライマリ リージョンで長時間の停止から回復するために、元のフェールオーバー操作が実行された場合、その場所が停止状態から復旧した後にハブを元の場所にフェールバックすることをお勧めします。

> [!IMPORTANT]
> - 1 日に 2 回の正常なフェールオーバーと 2 回の正常なフェールバック操作のみを実行できます。
>
> - バックからバックへのフェールオーバー/フェールバック操作は許可されていません。 これらの操作の間に 1 時間待機する必要があります。

### <a name="time-to-recover"></a>復旧時間

IoT Hub インスタンスの FQDN (したがって接続文字列も) は同じポスト フェールオーバーのままですが、基の IP アドレスは変更されます。 そのため、フェールオーバー プロセスがトリガーされてから、IoT Hub インスタンスに対して実行されるランタイム操作が完全に機能するようになるまでの全体的な時間は、次の関数で表すことができます。

復旧時間 = RTO [手動フェールオーバーの場合は 10 分 - 2 時間 | Microsoft が開始するフェールオーバーの場合は 2 - 26 時間] + DNS 伝達の待機時間 + クライアント アプリケーションがキャッシュされている IoT Hub IP アドレスを更新するためにかかる時間。

> [!IMPORTANT]
> IoT SDK は、IoT Hub の IP アドレスをキャッシュしません。 SDK とのインターフェイスがあるユーザー コードの場合、IoT Hub の IP アドレスをキャッシュしないことをお勧めします。

## <a name="achieve-cross-region-ha"></a>リージョン間 HA を達成する
Microsoft が開始するフェールオーバーまたは手動フェールオーバーのオプションで指定される RTO によってビジネスのアップタイム目標が満たされない場合は、デバイスごとの自動リージョン間フェールオーバーのメカニズムを実装することを検討してください。
IoT ソリューションでのデプロイ トポロジの詳しい説明はこの記事の範囲外です。 この記事では、高可用性とディザスター リカバリーを実現するために、 *地域フェールオーバー* デプロイ モデルについて検討します。

地域フェールオーバー モデルの場合、ソリューション バック エンドは主に 1 つのデータセンターの場所で実行されます。 セカンダリ IoT ハブとバック エンドは、別のデータセンターの場所にデプロイされています。 プライマリ リージョンの IoT ハブに障害が発生した場合、またはデバイスからプライマリ リージョンへのネットワーク接続が中断された場合、デバイスはセカンダリ サービス エンドポイントを使用します。 1 つのリージョン内ではなく、リージョン間フェールオーバー モデルを実装することで、ソリューションの可用性を改善できます。 

大まかに言えば、IoT Hub で地域フェールオーバー モデルを実装するには、次の手順を実行する必要があります。

* **セカンダリ IoT Hub とデバイス ルーティングのロジック**: プライマリ リージョンでサービスの中断が発生した場合、セカンダリ リージョンへのデバイスの接続を開始する必要があります。 関連するサービスのほとんどが状態認識型の場合、ソリューションの管理者がリージョン間のフェールオーバー プロセスをトリガーするのはよくあることです。 プロセスの制御を維持しながら、新しいエンドポイントをデバイスに伝達する最善の方法は、 *コンシェルジェ*" サービスで、現在のアクティブなエンドポイント サービスがないかどうかを定期的にチェックすることです。 コンシェルジェ サービスは Web アプリケーションで、DNS リダイレクト手法 ([Azure Traffic Manager](../traffic-manager/traffic-manager-overview.md) など) を使用してレプリケートされ、到達可能な状態が保持されます。

   > [!NOTE]
   > Azure Traffic Manager では、IoT Hub サービスはサポートされているエンドポイントの種類ではありません。 エンドポイントの正常性プローブ API を実装して、提案されたコンシェルジュ サービスを Azure Traffic Manager に統合することをお勧めします。

* **ID レジストリ レプリケーション**: 使用するには、ソリューションに接続できるすべてのデバイス ID をセカンダリ IoT ハブに格納する必要があります。 ソリューションでは、デバイス ID の geo レプリケートされたバックアップを保持し、デバイスのアクティブなエンドポイントを切り替える前に、そのバックアップをセカンダリ IoT ハブにアップロードしなければなりません。 IoT Hub のデバイス ID エクスポート機能は、この点で役に立ちます。 詳細については、IoT Hub 開発者ガイドの ID レジストリに関するページを参照してください。
* **マージ ロジック**: 再度プライマリ リージョンが使用可能になった時点で、セカンダリ サイトで作成されたすべての状態とデータをプライマリ リージョンに移行する必要があります。 状態とデータは主にデバイス ID およびアプリケーション メタデータと関連しており、プライマリ IoT ハブとマージする必要があります。また、プライマリ リージョンにある他のアプリケーション固有のストアとのマージが必要になることもあります。 この手順を簡単にするには、べき等操作を使用する必要があります。 べき等操作により、最終的に一貫性のあるイベント分布だけでなく、イベント重複や順不同配信の副次的な影響を最小限に抑えられます。 また、アプリケーション ロジックは、潜在的な不整合を許容するように、あるいはやや時代遅れに設計する必要があります。 これは、回復ポイントの目標 (RPO) に基づいてシステムが回復するために追加の時間がかかるためです。

## <a name="choose-the-right-hadr-option"></a>適切な HA/DR オプションを選択する
この記事で説明した HA/DR のオプションの概要です。実際のソリューションに適したオプションを選択する際の基準の枠組みとして利用してください。

| HA/DR のオプション | RTO | RPO | 手動操作が必要? | 実装の複雑さ | 追加コストの影響|
| --- | --- | --- | --- | --- | --- | --- |
| Microsoft が開始するフェールオーバー |2 - 26 時間|前述の RPO の表を参照してください|いいえ |なし|なし|
| 手動フェールオーバー |10 分 - 2 時間|前述の RPO の表を参照してください|[はい]|非常に低い。 この操作は、ポータルからトリガーする必要があります。|なし|
| リージョン間 HA |1 分未満|カスタム HA ソリューションのレプリケーション頻度によって変わります|いいえ |高|1 IoT Hub のコストの 1 倍を超えます|

## <a name="next-steps"></a>次の手順
Azure IoT Hub についてさらに学習するには、次のリンクを使用してください。

* [IoT Hub の使用 (チュートリアル)](quickstart-send-telemetry-dotnet.md)
* [Azure IoT Hub とは](about-iot-hub.md)