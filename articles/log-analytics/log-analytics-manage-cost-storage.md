---
title: Azure Log Analytics でデータのコストを管理する | Microsoft Docs
description: Azure で Log Analytics ワークスペースの料金プランを変更し、データ ボリュームとアイテム保持ポリシーを管理する方法について説明します。
services: log-analytics
documentationcenter: log-analytics
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/27/2018
ms.author: magoedte
ms.component: na
ms.openlocfilehash: 1d797df3f03e9b92569d37495310a5c162f5f981
ms.sourcegitcommit: 5892c4e1fe65282929230abadf617c0be8953fd9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2018
ms.locfileid: "37130930"
---
# <a name="manage-cost-by-controlling-data-volume-and-retention-in-log-analytics"></a>Log Analytics でデータ ボリュームと保有期間を制御してコストを管理する
Log Analytics は、企業内のソースまたは Azure に展開されたソースから毎日大量のデータを収集し、インデックスを付けて、保存する処理をスケーリングおよびサポートするように設計されています。  これは組織の主要な原動力になる場合がありますが、最終的に基になる原動力はコスト効率です。 そのためには、Log Analytisc ワークスペースのコストは、収集されるデータのボリュームだけでなく、選択されているプラン、および接続されたソースから生成されたデータの保持期間にも依存することを、理解しておくことが重要です。  

この記事では、データ ボリュームとストレージの拡大を事前に監視し、制限を定義して関連コストを制御する方法を説明します。 

データのコストは、次の要因に大きく依存する可能性があります。 

- 収集元のシステム、インフラストラクチャのコンポーネント、クラウド リソースなどの数 
- メッセージ キュー、ログ、イベント、セキュリティ関連データ、パフォーマンス メトリックなど、ソースによって作成されるデータの種類 
- これらのソースによって生成されてワークスペースに取り込まれるデータのボリューム 
- データがワークスペースに保持される期間  
- 有効な管理ソリューションの数、データ ソース、および収集の頻度 

> [!NOTE]
> 各ソリューションが収集するデータ量を見積もる際には、各ソリューションのドキュメントをご覧ください。   

マイクロソフト エンタープライズ契約の署名が 2018 年 7 月 1 日より前のお客様、またはサブスクリプションに Log Analytics ワークスペースを既に作成済みのお客様は、まだ *Free* レベルにアクセスすることができます。 サブスクリプションが既存の EA 加入契約に関連付けられていない場合、2018 年 4 月 2 日より後に新しいサブスクリプションでワークスペースを作成するときに、*Free* レベルは利用できません。  *Free* レベルを使っている場合は、データのリテンション期間は 7 日間に制限されます。  "*スタンドアロン*" レベルまたは "*有料*" レベルの場合は、収集されたデータは 31 日間利用できます。 *Free* レベルには 1 日当たり 500 MB のインジェスト制限があり、許可されているボリュームを常に超えることが確実な場合は、ワークスペースを有料プランに変更し、この制限を超えてデータを収集できます。 

> [!NOTE]
> 有料プランで長い保持期間を選択する場合は、料金がかかります。 プランの種類はいつでも変更できます。価格について詳しくは、[価格の詳細](https://azure.microsoft.com/pricing/details/log-analytics/)に関するページをご覧ください。 

データ ボリュームを制限してコストを管理するには、日次上限とデータ リテンション期間の 2 つの方法があります。  

## <a name="review-estimated-cost"></a>推定りコストを確認する
Log Analytics では、最近の使用パターンに基づいてコストを簡単に理解できます。  このためには、次の手順を実行します。  

1. [Azure Portal](http://portal.azure.com) にサインインします。 
2. Azure Portal で、**[すべてのサービス]** をクリックします。 リソースの一覧で、「**Log Analytics**」と入力します。 入力を始めると、入力内容に基づいて、一覧がフィルター処理されます。 **[Log Analytics]** を選択します。<br><br> ![Azure Portal](media/log-analytics-quick-collect-azurevm/azure-portal-01.png)<br><br>  
3. Log Analytics のサブスクリプション ウィンドウで、ワークスペースを選び、左側のウィンドウで **[使用量と推定コスト]** をクリックします。<br><br> ![[使用量と推定コスト] ページ](media/log-analytics-manage-cost-storage/usage-estimated-cost-dashboard-01.png)<br>

このページでは、該当の月のデータ ボリュームを確認できます。 これには、受信して Log Analytics ワークスペースに格納されたすべてのデータが含まれます。  ページ上部の **[使用量の詳細]** をクリックすると、使用量ダッシュボードにデータ ボリュームの傾向の情報がソース別、コンピューター別、サービス別に表示されます。 日次上限を表示および設定したり、リテンション期間を変更したりするには、**[データ ボリュームの管理]** をクリックします。
 
Log Analytics の課金は Azure の課金内容に加えられます。 Azure Portal の [課金] または [Azure Billing Portal](https://account.windowsazure.com/Subscriptions) で、Azure の課金内容の詳細を確認できます。  

## <a name="daily-cap"></a>日次上限
Azure Portal から Log Analytics ワークスペースを作成するときに *Free* プランを選ぶと、日次制限が 500 MB に設定されます。 他の価格プランには制限はありません。 日次上限を構成して、ワークスペースの毎日のインジェストを制限できますが、1 日の上限に達することが目標ではないので注意する必要があります。  そうしないと、その日の残りの時間についてデータが失われ、ワークスペースで最新のデータが利用できることに依存する機能を持つ他の Azure サービスやソリューションに影響を与える可能性があります。  その結果、IT サービスをサポートするリソースの正常性状態を監視してアラートを受け取る機能が影響を受けます。  日次上限は、管理対象リソースからのデータ ボリュームの予期しない増加を管理して制限内の留めるための手段、または単にワークスペースの計画外の料金を制限する手段として使うためのものです。  

日次上限に達すると、課金対象のデータの種類の収集は、その日はそれ以上行われません。 選択した Log Analytics ワークスペースのページの上部に警告バナーが表示され、**LogManagement** カテゴリの *Operation* テーブルに操作イベントが送信されます。 [*1 日の上限を次に設定する*] で定義されているリセット時刻が過ぎると、データ収集が再開されます。 この操作イベントに基づいてアラート ルールを定義し、データの日次制限に達したら通知するよう構成することをお勧めします。 

### <a name="identify-what-daily-data-limit-to-define"></a>定義する日次データ制限を明らかにする 
[Log Analytics の使用量と推定コスト](log-analytics-usage.md)に関する記事を参照し、データ インジェストの傾向および定義する日次データ ボリューム上限について理解してください。 上限に達した後はリソースを監視できなくなるので、慎重に検討してください。 

### <a name="manage-the-maximum-daily-data-volume"></a>最大日次データ ボリュームを管理する 
次の手順では、Log Analytics が 1 日に取り込むデータのボリュームを管理する制限を構成する方法について説明します。  

1. ワークスペースの左ウィンドウから **[使用量と推定コスト]** を選びます。
2. 選んだワークスペースの **[使用量と推定コスト]** ページの上部にある **[データ ボリュームの管理]** をクリックします。 
5. 日次上限は既定では **[オフ]** になっています。有効にするには、**[オン]** をクリックし、GB/日でデータ ボリュームの制限を設定します。<br><br> ![Log Analytics のデータ制限の構成](media/log-analytics-manage-cost-storage/set-daily-volume-cap-01.png)

### <a name="alert-when-limit-reached"></a>制限に達したらアラートする
データ制限のしきい値に達したら Azure Portal に視覚的な合図が表示されますが、この動作は、早急な措置を必要とする運用上の問題を管理する方法と、必ずしも一致していない場合があります。  アラート通知を受け取るには、Azure Monitor で新しいアラート ルールを作成します。  詳しくは、[アラートを作成、表示、管理する方法](../monitoring-and-diagnostics/monitor-alerts-unified-usage.md)に関するページをご覧ください。      

最初は、次のようにアラートを設定することをお勧めします。

* ターゲット: Log Analytics リソースを選びます
* 条件: 
   * シグナル名: カスタム ログ検索
   * 検索クエリ: Operation | where Detail has 'OverQuota'
   * 基準: 結果の数
   * 条件: より大きい
   * しきい値: 0
   * 期間: 5 (分)
   * 頻度: 5 (分)
* アラート ルール名: 1 日のデータ制限に達しました
* 重大度: 警告 (重大度 1)

アラートを定義した後で制限に達すると、アラートがトリガーされ、アクション グループで定義されている応答が実行されます。 メールおよびテキスト メッセージでチームに通知したり、webhook、Automation Runbook、または[外部の ITSM ソリューションとの統合](log-analytics-itsmc-overview.md#create-itsm-work-items-from-azure-alerts)を使ってアクションを自動化したりできます。 

## <a name="change-the-data-retention-period"></a>データ保持期間の変更 
次の手順では、ワークスペースにログ データを保持する期間を構成する方法について説明します。
 
1. ワークスペースの左ウィンドウから **[使用量と推定コスト]** を選びます。
2. **[使用量と推定コスト]** ページの上部にある **[データ ボリュームの管理]** をクリックします。
5. ウィンドウで、スライダーを移動して日数を増減し、**[OK]** をクリックします。  *無料*プランをご利用の場合は、データ保持期間を変更できません。この設定を制御するには、有料プランにアップグレードする必要があります。<br><br> ![ワークスペースのデータ保持の設定の変更](media/log-analytics-manage-cost-storage/manage-cost-change-retention-01.png)

## <a name="troubleshooting"></a>トラブルシューティング
**質問**: Log Analytics がデータを収集しなくなった場合にトラブルシューティングするにはどうすればよいですか? 
**回答**: 無料の価格レベルを使用しており、1 日に 500 MB を超えるデータを送信した場合、その日の残りはデータ収集が停止します。 1 日の制限に達したことが、Log Analytics がデータの収集を停止したり、データがないように見えたりする一般的な原因です。  
データ収集が開始および停止すると、Log Analytics は Operation 型のイベントを作成します。  
1 日の制限に達し、データがなくなっているかどうかを確認するには、検索でクエリ Operation | where OperationCategory == 'Data Collection Status' を実行します。   
データ収集が停止するとき、OperationStatus は [警告] です。 データ収集が開始するとき、OperationStatus は [成功] です。  
次の表は、データ収集が停止する原因と、データ収集を再開するための推奨されるアクションを示しています。  

|収集が停止する原因| 解決策| 
|-----------------------|---------|
|無料のデータの 1 日の制限に達した<sup>1</sup>|収集が自動的に再開される次の日まで待つか、または有料の価格レベルに変更します。|
|データ ボリュームの管理で定義されている日次制限に達した|収集が自動的に再開される次の日まで待つか、「[最大日次データ ボリュームを管理する](#manage-the-maximum-daily-volume)」で説明されているようにして 1 日のデータ ボリューム制限を増やします|
|次のために、Azure サブスクリプションが中断された状態にある<br> 無料試用版が終了した<br> Azure パスの期限が切れた<br> 1 月の使用制限に達した (たとえば、MSDN または Visual Studio サブスクリプションで)|有料のサブスクリプションに変換する<br> 制限を削除するか、または制限がリセットされるまで待つ|

<sup>1</sup> ワークスペースで無料の価格レベルを使用している場合、サービスへの 1 日あたりのデータ送信は 500 MB に制限されます。 1 日の制限に達した場合、データ収集は翌日まで停止します。 データ収集が停止されている間に送信されたデータはインデックスが作成されず、検索には使用できません。 データ収集が再開されたとき、処理は送信された新しいデータに対してのみ実行されます。 

Log Analytics は UTC 時刻を使います。 上限に達したすべてのワークスペースでデータの取り込みが同時に始まるのを防ぐため、リセット時刻はワークスペースによって異なります。 ワークスペースが 1 日の上限に達した場合、**[1 日の上限を次に設定する]** で定義されているリセット時刻の後で処理が再開されます。<br><br> ![Log Analytics の制限の UTC タイムゾーン](media/log-analytics-manage-cost-storage/data-volume-mgmt-limit-utc.png)

**質問**: データ収集が停止したときに通知を受けるにはどうすればよいですか? 
**回答**: 説明されている手順を使用してデータ収集が停止したときに通知する "*日次データ上限のアラートを作成*" し、アラート ルールへのアクションの追加手順に従って、アラート ルールに対するメール、webhook、または Runbook のアクションを構成します。 

## <a name="next-steps"></a>次の手順  

使用量とコストの管理に役立つデータの収集量、データを送信するソース、および送信されるデータの種類を指定するには、「[Log Analytics でのデータ使用状況の分析](log-analytics-usage.md)」をご覧ください。