---
title: Azure ExpressRoute 回線に使用する Network Performance Monitor の構成 | Microsoft Docs
description: Azure ExpressRoute 回線に対してクラウドベースのネットワーク監視 (NPM) を構成します。 ここでは、ExpressRoute プライベート ピアリングと Microsoft ピアリング経由での監視について説明します。
documentationcenter: na
services: expressroute
author: cherylmc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: expressroute
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 06/28/2018
ms.author: cherylmc
ms.openlocfilehash: 47f219b7319e4d2bbadf03954f7bd7f6f39da3b4
ms.sourcegitcommit: 5892c4e1fe65282929230abadf617c0be8953fd9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2018
ms.locfileid: "37128981"
---
# <a name="configure-network-performance-monitor-for-expressroute"></a>ExpressRoute に使用する Network Performance Monitor の構成

Network Performance Monitor (NPM) は、Azure クラウド デプロイとオンプレミス拠点 (支社など) との間の接続性を監視するクラウドベースのネットワーク監視ソリューションです。 NPM は Log Analytics の一部です。 NPM は、ExpressRoute 用の拡張機能を提供して、プライベート ピアリングまたは Microsoft ピアリングを使用するように構成された ExpressRoute 回線上のネットワーク パフォーマンスを監視できるようにします。 ExpressRoute に対して NPM を構成することにより、特定して排除すべきネットワークの問題を検出することができます。 このサービスは、Azure Government Cloud でも使用可能です。

次のようにすることができます。

* 各種 VNet 間の損失と待ち時間を監視し、アラートを設定する

* ネットワーク上のすべてのパス (冗長パスを含む) を監視する

* 再現が難しい、ネットワークに関する一過性の問題と特定時点の問題をトラブルシューティングする

* パフォーマンス低下の原因となっている特定のセグメントをネットワーク上で見つけ出す

* 仮想ネットワークごとのスループットを把握する (各 VNet にエージェントがインストールされている場合)

* 過去の時点の ExpressRoute システム状態を確認する

## <a name="workflow"></a>ワークフロー

監視エージェントは、複数のサーバー (オンプレミスと Azure の両方) にインストールされます。 これらのエージェントは互いに通信を行いますが、データは送信せず、TCP ハンドシェイク パケットを送信します。 エージェント間の通信によって、Azure は、トラフィックが通過する可能性のある経路とネットワーク トポロジとをマッピングすることができます。

1. NPM ワークスペースを作成します。 これは、OMS ワークスペースと同じです。
2. ソフトウェア エージェントをインストールして構成します。 
    * オンプレミス サーバーと Azure VM に監視エージェントをインストールします (プライベート ピアリングの場合)。
    * 監視エージェントが通信を行うことができるように、監視エージェント サーバー上の設定を構成します  (ファイアウォール ポートを開放するなど)。
3. Azure VM にインストールされている監視エージェントがオンプレミスの監視エージェントと通信を行うことができるようにネットワーク セキュリティ グループ (NSG) 規則を構成します。
4. 監視の設定を行います。NPM で表示可能なネットワークを自動検出して管理します。

既に Network Performance Monitor を使用して他のオブジェクトやサービスを監視しており、かつワークスペースが既に、サポートされているいずれかのリージョンに存在する場合は、手順 1. と手順 2. を省略し、手順 3. で構成を始めてください。

## <a name="configure"></a>手順 1. ワークスペースを作成する

ExpressRoute 回線への VNet リンクを含んだサブスクリプションにワークスペースを作成します。

1. ExpressRoute 回線に VNET がピアリングされているサブスクリプションを [Azure Portal](https://portal.azure.com) で選択します。 **[Marketplace]** のサービス一覧で "Network Performance Monitor" を検索します。 検索結果で **[Network Performance Monitor]** をクリックしてそのページを開きます。

   >[!NOTE]
   >新しいワークスペースを作成するか、既存のワークスペースを使用することができます。 既存のワークスペースを使用する場合は、ワークスペースが新しいクエリ言語に移行されていることを確認する必要があります。 [詳細情報...](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-search-upgrade)
   >

   ![ポータル](.\media\how-to-npm\3.png)<br><br>
2. **[Network Performance Monitor]** メイン ページの一番下にある **[作成]** をクリックして **[Network Performance Monitor - 新しいソリューションの作成]** ページを開きます。 **[OMS ワークスペース - ワークスペースを選択します]** をクリックしてワークスペース ページを開きます。 **[+ 新しいワークスペースの作成]** をクリックしてワークスペース ページを開きます。
3. **[OMS ワークスペース]** ページの **[新規作成]** を選択し、次の設定を構成します。

  * [OMS ワークスペース] - ワークスペースの名前を入力します。
  * [サブスクリプション] - 複数のサブスクリプションがある場合は、新しいワークスペースに関連付けるサブスクリプションを 1 つ選択します。
  * [リソース グループ] - リソース グループを作成するか、既存のリソース グループを使用します。
  * [場所] - この場所は、エージェント接続ログに使用されるストレージ アカウントの場所を指定するために使用します。
  * [価格レベル] - 価格レベルを選択します。
  
    >[!NOTE]
    >ExpressRoute 回線は、世界のどこに配置されていてもかまいません。 ワークスペースと同じリージョンに存在する必要はありません。
    >
  
    ![ワークスペース](.\media\how-to-npm\4.png)<br><br>
4. 設定テンプレートを保存してデプロイするには、**[OK]** をクリックします。 テンプレートの検証後、**[作成]** をクリックしてワークスペースをデプロイします。
5. ワークスペースがデプロイされたら、作成した **[NetworkMonitoring(<名前>)]** リソースに移動します。 設定を確認して、**[このソリューションにはさらに構成が必要です]** をクリックします。

   ![追加の構成](.\media\how-to-npm\5.png)

## <a name="agents"></a>手順 2. エージェントをインストールして構成する

### <a name="download"></a>2.1. エージェントのセットアップ ファイルをダウンロードする

1. リソースの **[ネットワーク パフォーマンス モニターの構成]** ページの **[共通設定]** タブに移動します。 **[OMS エージェントをインストールする]** セクションでサーバーのプロセッサに対応するエージェントをクリックし、セットアップ ファイルをダウンロードします。
2. 次に、**[ワークスペース ID]** と **[主キー]** をメモ帳にコピーします。
3. **[TCP プロトコルを使用して OMS エージェントを監視用に構成します]** セクションで、Powershell スクリプトをダウンロードします。 この PowerShell スクリプトは、TCP トランザクションに必要なファイアウォール ポートを開くのに役立ちます。

  ![PowerShell スクリプト](.\media\how-to-npm\7.png)

### <a name="installagent"></a>2.2: (監視対象となるすべての VNET の) 各監視サーバーに監視エージェントをインストールする

冗長性のため、ExpressRoute 接続の両側に、少なくとも 2 つのエージェントをインストールすることをお勧めします (たとえば、オンプレミス、Azure VNET)。 エージェントは Windows Server (2008 SP1 以降) にインストールする必要があります。 Windows デスクトップ OS や Linux OS を使用した ExpressRoute 回線の監視はサポートされていません。 次の手順を使用してエージェントをインストールします。
   
  >[!NOTE]
  >SCOM でプッシュされるエージェント ([MMA](https://technet.microsoft.com/library/dn465154(v=sc.12).aspx) を含む) は、Azure でホストされている場合に場所を一貫して検出できないことがあります。 ExpressRoute を監視するために Azure VNET でこれらのエージェントを使用しないことをお勧めします。
  >

1. ExpressRoute の監視に使用する各サーバーに対し、**セットアップ**を実行してエージェントをインストールします。 監視に使用するサーバーとしては、VM とオンプレミスとがあり、どちらもインターネット アクセスが必須です。 エージェントは、オンプレミスに少なくとも 1 つインストールすると共に、Azure で監視する各ネットワーク セグメントにつき 1 つインストールする必要があります。
2. **[ようこそ]** ページで **[次へ]** をクリックします。
3. **[ライセンス条項]** ページの記述内容を確認し、**[同意する]** をクリックします。
4. **[インストール先フォルダー]** ページで、既定のインストール フォルダーを変更するか、そのまま使用して、**[次へ]** をクリックします。
5. **[エージェントのセットアップ オプション]** ページで、Azure Log Analytics または Operations Manager にエージェントを接続することを選択できます。 また、エージェントを後から構成する場合は、この選択肢を空欄にしておいてもかまいません。 必要な選択を行ったら、**[次へ]** をクリックします。

  * **Azure Log Analytics** に接続することを選んだ場合は、前のセクションでメモ帳にコピーしておいた**ワークスペース ID** と**ワークスペース キー** (主キー) を貼り付けます。 次に、 **[次へ]** をクリックします。

    ![ID とキー](.\media\how-to-npm\8.png)
  * **Operations Manager** に接続することを選んだ場合は、**[管理グループの構成]** ページで **[管理グループ名]**、**[管理サーバー]**、**[管理サーバー ポート]** に入力します。 次に、 **[次へ]** をクリックします。

    ![Operations Manager](.\media\how-to-npm\9.png)
  * **[エージェント アクション アカウント]** ページで、**[ローカル システム]** アカウントまたは **[ドメインまたはローカル コンピューターのアカウント]** を選択します。 次に、 **[次へ]** をクリックします。

    ![アカウント](.\media\how-to-npm\10.png)
6. **[インストールの準備完了]** ページで、設定内容を確認し、**[インストール]** をクリックします。
7. **[構成は正常に終了しました]** ページで **[完了]** をクリックします。
8. 完了すると、コントロール パネルに Microsoft Monitoring Agent が表示されます。 そこでは構成を検証して、エージェントが Azure Log Analytics (OMS) に接続されていることを確認できます。 接続されると、"**Microsoft Monitoring Agent は Microsoft Operations Management Suite サービスに正常に接続しました**" というメッセージがエージェントにより表示されます。

9. 監視対象となるすべての VNET に対してこの手順を繰り返します。

### <a name="proxy"></a>2.3. プロキシ設定の構成 (省略可能)

Web プロキシを使用してインターネットにアクセスしている場合、以下の手順を使用して、Microsoft Monitoring Agent のプロキシ設定を構成します。 これらの手順は、各サーバーに対して実行してください。 構成が必要なサーバーの数が多い場合には、このプロセスを自動化するスクリプトを使った方が作業が簡単に済むことも考えられます。 その場合は、「[スクリプトを使って Microsoft Monitoring Agent のプロキシ設定を構成するには](../log-analytics/log-analytics-windows-agent.md)」を参照してください。

コントロール パネルを使って Microsoft Monitoring Agent のプロキシ設定を構成するには:

1. **コントロール パネル**を開きます。
2. **[Microsoft Monitoring Agent]** を開きます。
3. **[プロキシ設定]** タブをクリックします。
4. **[プロキシ サーバーを使用する]** をオンにして、URL と (必要に応じて) ポート番号を入力します。 プロキシ サーバーで認証が必要な場合には、プロキシ サーバーにアクセスするためのユーザー名とパスワードを入力します。

  ![proxy](.\media\how-to-npm\11.png)

### <a name="verifyagent"></a>2.4. エージェントの接続を確認する

エージェントが通信できているかどうかは簡単に確認できます。

1. 監視エージェントがインストールされているサーバーの**コントロール パネル**を開きます。
2. **[Microsoft Monitoring Agent]** を開きます。
3. **[Azure Log Analytics]** タブをクリックします。
4. **[状態]** 列に、エージェントが Log Analytics に正常に接続されていることが表示されます。

  ![status](.\media\how-to-npm\12.png)

### <a name="firewall"></a>2.5. 監視エージェント サーバーのファイアウォール ポートを開放する

TCP プロトコルを使用するには、ファイアウォール ポートを開放して、監視エージェントを確実に通信可能な状態にする必要があります。

PowerShell スクリプトを実行して、Network Performance Monitor に必要なレジストリ キーを作成できます。 また、このスクリプトにより、監視エージェントが互いに TCP 接続を作成することを許可する Windows ファイアウォール規則も作成されます。 スクリプトによって作成されたレジストリ キーは、デバッグ ログを記録するかどうかと、ログ ファイルのパスを指定します。 また、通信で使用されるエージェント TCP ポートを定義します。 これらのキーの値は、スクリプトによって自動的に設定されます。 これらのキーを手動で変更しないでください。

ポート 8084 は既定で開放されます。 パラメーター "portNumber" をスクリプトに指定することでカスタム ポートを使用できます。 ただし、その場合は、スクリプトの実行対象となるすべてのサーバーで同じポートを指定する必要があります。

>[!NOTE]
>PowerShell スクリプト "EnableRules" によって Windows ファイアウォール規則を構成できるのは、スクリプトを実行したコンピューターだけです。 ネットワーク ファイアウォールがある場合、ネットワーク パフォーマンス モニターによって使用されている TCP ポート宛てのトラフィックを必ず許可する必要があります。
>
>

エージェント サーバー上で、管理特権で PowerShell ウィンドウを開きます。 あらかじめダウンロードしておいた PowerShell スクリプト [EnableRules](https://aka.ms/npmpowershellscript) を実行します。 パラメーターは一切使用しません。

![PowerShell_Script](.\media\how-to-npm\script.png)

## <a name="opennsg"></a>手順 3. ネットワーク セキュリティ グループ規則を構成する

Azure 内のエージェント サーバーを監視するには、NPM の代理トランザクションに使用されるポートの TCP トラフィックを許可するようにネットワーク セキュリティ グループ (NSG) 規則を構成する必要があります。 既定のポートは 8084 です。 これにより、Azure VM にインストールされている監視エージェントが、オンプレミスの監視エージェントと通信できるようになります。

NSG の詳細については、[ネットワーク セキュリティ グループ](../virtual-network/virtual-networks-create-nsg-arm-portal.md)に関するページを参照してください。

>[!NOTE]
>この手順に進む前に、エージェント (オンプレミス サーバー エージェントと Azure サーバー エージェントの両方) がインストール済みであること、また PowerShell スクリプトを実行済みであることを確認してください。
>

## <a name="setupmonitor"></a>手順 4: ピアリング接続を検出する

1. **[すべてのリソース]** ページに移動し、ホワイトリストに登録された NPM ワークスペースをクリックして、Network Performance Monitor の概要タイルに移動します。

  ![npm ワークスペース](.\media\how-to-npm\npm.png)
2. **[Network Performance Monitor]** の概要タイルをクリックしてダッシュボードを表示します。 ダッシュボード内の ExpressRoute ページに、ExpressRoute が "未構成状態" であることが示されます。 **[機能のセットアップ]** をクリックして Network Performance Monitor の構成ページを開いてください。

  ![機能のセットアップ](.\media\how-to-npm\npm2.png)
3. 構成ページの左側のパネルにある [ExpressRoute ピアリング] タブに移動します。 次に、**[Discover Now]\(今すぐ検出する\)** をクリックします。

  ![検出](.\media\how-to-npm\13.png)
4. 検出が完了すると、次の項目を含む一覧が表示されます。
  * このサブスクリプションに関連付けられている ExpressRoute 回線のすべての Microsoft ピアリング接続。
  * このサブスクリプションに関連付けられている VNet に接続するすべてのプライベート ピアリング接続。
            
## <a name="configmonitor"></a>手順 5: モニターを構成する

このセクションでは、モニターを構成します。 監視するピアリングの種類 (**プライベート ピアリング** または **Microsoft ピアリング**) に対応する手順に従ってください。

### <a name="private-peering"></a>プライベート ピアリング

プライベート ピアリングの場合、検出が完了すると、一意の**回線名**と **VNet 名**の規則が表示されます。 初期状態では、これらの規則は無効になっています。

![規則](.\media\how-to-npm\14.png)

1. **[このピアリングを監視する]** チェック ボックスをオンにします。
2. **[このピアリングの正常性監視を有効にする]** チェック ボックスをオンにします。
3. 監視条件を選択します。 しきい値を入力して、正常性イベントを生成するカスタムしきい値を設定できます。 選択したネットワーク ペア/サブネットワーク ペアに対して選択したしきい値を条件の値が上回ると、正常性イベントが生成されます。
4. [ON-PREM エージェント] の **[エージェントの追加]** ボタンをクリックして、プライベート ピアリング接続を監視するために使用するオンプレミス サーバーを追加します。 手順 2 のセクションで指定した Microsoft サービス エンドポイントに接続できるエージェントのみを選択してください。 オンプレミスのエージェントは、ExpressRoute 接続を使用してエンドポイントに到達できる必要があります。
5. 設定を保存します。
6. 規則を有効にして監視対象の値とエージェントを選択した後、30 ～ 60 分ほど待つと、値が反映され始め、**[ExpressRoute の監視]** タイルが利用できる状態になります。

### <a name="microsoft-peering"></a>Microsoft ピアリング

Microsoft ピアリングの場合は、監視する Microsoft ピアリング接続をクリックし、設定を構成します。

1. **[このピアリングを監視する]** チェック ボックスをオンにします。 
2. (省略可能) ターゲットの Microsoft サービス エンドポイントを変更できます。 NPM の既定では、Microsoft サービス エンドポイントがターゲットとして選択されます。 NPM では、ExpressRoute を介してオンプレミス サーバーからこのターゲット エンドポイントへの接続が監視されます。 
    * このターゲット エンドポイントを変更するには、**[ターゲット:]** の **[(編集)]** リンクをクリックし、URL の一覧から別の Microsoft サービス ターゲット エンドポイントを選択します。
      ![ターゲットを編集する](.\media\how-to-npm\edit_target.png)<br>

    * カスタムの URL または IP アドレスを使用できます。 このオプションは、Microsoft ピアリングを使用してパブリック IP アドレスで提供されている Azure PaaS サービス (Azure Storage、SQL データベース、Websites など) への接続を確立する場合に特に適しています。 これを行うには、URL の一覧の下部にあるリンク **[(カスタム URL または IP アドレスを代わりに使用する)]** をクリックし、ExpressRoute Microsoft ピアリングによって接続されている Azure PaaS サービスのパブリック エンドポイントを入力します。
    ![カスタム URL](.\media\how-to-npm\custom_url.png)<br>

    * これらのオプション設定を使用している場合は、ここで Microsoft サービス エンドポイントのみが選択されていることを確認してください。 エンドポイントは、ExpressRoute に接続されていて、オンプレミス エージェントから到達可能である必要があります。
3. **[このピアリングの正常性監視を有効にする]** チェック ボックスをオンにします。
4. 監視条件を選択します。 しきい値を入力して、正常性イベントを生成するカスタムしきい値を設定できます。 選択したネットワーク ペア/サブネットワーク ペアに対して選択したしきい値を条件の値が上回ると、正常性イベントが生成されます。
5. [ON-PREM エージェント] の **[エージェントの追加]** ボタンをクリックして、Microsoft ピアリング接続を監視するために使用するオンプレミス サーバーを追加します。 手順 2 のセクションで指定した Microsoft サービス エンドポイントに接続できるエージェントのみを選択してください。 オンプレミスのエージェントは、ExpressRoute 接続を使用してエンドポイントに到達できる必要があります。
6. 設定を保存します。
7. 規則を有効にして監視対象の値とエージェントを選択した後、30 ～ 60 分ほど待つと、値が反映され始め、**[ExpressRoute の監視]** タイルが利用できる状態になります。

## <a name="explore"></a>手順 6. 監視タイルを表示する

監視中のタイルが表示されていれば、ExpressRoute 回線と接続リソースが NPM によって監視されています。 Microsoft ピアリングのタイルをクリックすると、Microsoft ピアリング接続の正常性をドリルダウンできます。

![監視タイル](.\media\how-to-npm\15.png)

### <a name="dashboard"></a>[Network Performance Monitor] ページ

NPM ページには、ExpressRoute に関して、その回線とピアリングの正常性を大まかに示したページが表示されます。

![ダッシュボード](.\media\how-to-npm\dashboard.png)

### <a name="circuits"></a>回線の一覧

監視対象の全 ExpressRoute 回線の一覧を表示するには、**[ExpressRoute 回線]** タイルをクリックします。 いずれかの回線を選択すると、その正常性状態のほか、パケット損失、帯域幅使用率、待ち時間の各トレンド グラフを表示できます。 これらのグラフは対話操作が可能です。 グラフのプロット対象となる時間枠を自分で選んでカスタマイズすることができます。 グラフ上の領域でマウスをドラッグすることによってデータ ポイントを拡大し、細かく表示することができます。

![回線一覧](.\media\how-to-npm\circuits.png)

#### <a name="trend"></a>パケット損失、待ち時間、スループットのトレンド

帯域幅、待ち時間、損失の各グラフは対話操作が可能です。 これらのグラフの任意のセクションをマウス操作で拡大することができます。 また、左上の [アクション] ボタンの下にある **[日付/時刻]** をクリックすることによって、帯域幅、待ち時間、損失データの表示対象間隔を変更することもできます。

![トレンド](.\media\how-to-npm\16.png)

### <a name="peerings"></a>ピアリング一覧

プライベート ピアリング上の仮想ネットワークに対するすべての接続の一覧を表示するには、ダッシュボードの **[プライベート ピアリング]** タイルをクリックします。 ここでいずれかの仮想ネットワークの接続を選択すると、その正常性状態のほか、パケット損失、帯域幅使用率、待ち時間の各トレンド グラフを表示できます。

![回線一覧](.\media\how-to-npm\peerings.png)

### <a name="nodes"></a>ノード ビュー

選択した ExpressRoute ピアリング接続のオンプレミス ノードと Azure VM/Microsoft サービス エンドポイント間のすべてのリンクの一覧を表示するには、**[ノード リンクの表示]** をクリックします。 各リンクの正常性状態、およびそれらに関連付けられた損失および待ち時間の傾向を表示できます。

![ノード ビュー](.\media\how-to-npm\nodes.png)

### <a name="topology"></a>回線トポロジ

回線トポロジを表示するには、**[トポロジ]** タイルをクリックします。 この操作により、選択した回線またはピアリングのトポロジ ビューが表示されます。 トポロジ ダイアグラムには、ネットワーク上の各セグメントの待ち時間が表示されます。 各レイヤー 3 ホップがダイアグラムのノードで表現されます。 いずれかのホップをクリックすると、そのホップについてのさらに詳しい情報が表示されます。

**[フィルター]** の下のスライダー バーを動かすことで、視認性を高めて表示範囲をオンプレミスのホップにまで広げることができます。 スライダー バーを左右に動かすと、トポロジ グラフに表示されるホップ数が増減します。 各セグメントの待ち時間が視覚的に確認できるので、ネットワーク上のセグメントの中で、待ち時間の長いセグメントを短時間で切り分けることができます。

![filters](.\media\how-to-npm\topology.png)

#### <a name="detailed-topology-view-of-a-circuit"></a>回線の詳細なトポロジ ビュー

このビューは、VNet 接続を示しています。
![詳細なトポロジ](.\media\how-to-npm\17.png)