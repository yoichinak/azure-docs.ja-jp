---
title: Azure 仮想マシンのバックアップ エラーのトラブルシューティング
description: Azure 仮想マシンのバックアップと復元のトラブルシューティング
services: backup
author: trinadhk
manager: shreeshd
ms.service: backup
ms.topic: conceptual
ms.date: 01/21/2018
ms.author: trinadhk
ms.openlocfilehash: a5828b4e4f42c349246845bd003e874fb0352bae
ms.sourcegitcommit: e0a678acb0dc928e5c5edde3ca04e6854eb05ea6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/13/2018
ms.locfileid: "39008078"
---
# <a name="troubleshoot-azure-virtual-machine-backup"></a>Azure 仮想マシンのバックアップのトラブルシューティング
次の表に示す情報を使って、Azure Backup の使用中に発生したエラーのトラブルシューティングを行うことができます。

| エラーの詳細 | 対処法 |
| --- | --- |
| VM が存在しないため、操作を実行できませんでした。 - バックアップ データを削除しないで、仮想マシンの保護を停止してください。 詳細については、http://go.microsoft.com/fwlink/?LinkId=808124 をご覧ください。 |これは、プライマリ VM が削除されているのに、バックアップ ポリシーによってバックアップする VM が検索され続ける場合に発生します。 このエラーを解決するには、次の手順に従います。 <ol><li> 同じ名前と同じリソース グループ名 [クラウド サービス名] を使用して仮想マシンを作成し直します。<br>(または)</li><li> バックアップ データを削除して、または削除しないで、仮想マシンの保護を停止します。 [詳細](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| 仮想マシンがネットワークに接続していないためにスナップショット操作が失敗した - VM がネットワークにアクセスできることを確認してください。 スナップショットを成功させるには、Azure データセンターの IP 範囲をホワイトリストに追加するか、プロキシ サーバーをネットワーク アクセス用にセットアップします。 詳細については、http://go.microsoft.com/fwlink/?LinkId=800034 を参照してください。 既にプロキシ サーバーを使用している場合は、プロキシ サーバー設定が正しく構成されていることを確認してください | このエラーは、仮想マシンで送信インターネット接続を拒否している場合にスローされます。 インターネット接続は、VM スナップショット拡張機能で仮想マシンの基になるディスクのスナップショットを取得するために必要です。 ネットワーク アクセスのブロックによるスナップショットのエラーを修正する方法については、[こちら](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine)を参照してください。 |
| VM エージェントが Azure Backup サービスと通信できません。 - VM がネットワークに接続でき、最新の VM エージェントが実行されていることを確認します。 詳細については、http://go.microsoft.com/fwlink/?LinkId=800034 をご覧ください。 |VM エージェントに問題があるか、Azure インフラストラクチャへのネットワーク アクセスが何らかの原因でブロックされている場合に、このエラーがスローされます。 VM のスナップショットに関する問題のデバッグについては、[こちら](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#vm-agent-unable-to-communicate-with-azure-backup)を参照してください。<br> VM エージェントで問題が発生していない場合は、VM を再起動してください。 VM の状態が正しくないため問題が発生する場合があります。その場合は、VM を再起動すると、この "正しくない状態" がリセットされます。 |
| VM はプロビジョニングに失敗した状態です - VM を再起動して、バックアップのために VM が実行中またはシャットダウンの状態になっていることを確認してください | これは、いずれかの拡張機能が失敗して、VM の状態がプロビジョニングに失敗した状態になる場合に発生します。 拡張機能の一覧に移動し、失敗した拡張機能があるかどうかを確認して、それを削除し、仮想マシンを再起動してみます。 すべての拡張機能が実行状態になっている場合は、VM エージェント サービスが実行されているかどうかを確認してください。 されていない場合は、VM エージェント サービスを再起動します。 | 
| マネージド ディスクの VMSnapshot の拡張操作に失敗しました - バックアップ操作を再試行してください。 問題が繰り返し発生する場合は、'http://go.microsoft.com/fwlink/?LinkId=800034' の手順に従ってください。 それでもエラーになる場合は、Microsoft サポートに問い合わせてください | このエラーは、Azure Backup サービスがスナップショットのトリガーに失敗した場合に発生します。 VM のスナップショットに関する問題のデバッグについては、[こちら](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#vmsnapshot-extension-operation-failed)を参照してください。 |
| 仮想マシンのスナップショットをコピーできませんでした。ストレージ アカウントに十分な空き領域がありません - ストレージ アカウントに、仮想マシンに接続されているプレミアム ストレージ ディスクにあるデータと同じ量の空き領域があることを確認してください | VM バックアップ スタック V1 の Premium VM の場合、スナップショットがストレージ アカウントにコピーされます。 これは、スナップショット上で動作するバックアップ管理トラフィックが、プレミアム ディスクを使用するアプリケーションで利用できる IOPS の数を制限しないようにするためです。 Azure Backup サービスが、スナップショットをストレージ アカウントにコピーし、ストレージ アカウント内のこのコピーされた場所からコンテナーにデータを転送できるように、ストレージ アカウントの合計領域の 50% (17.5 TB) のみを割り当てることをお勧めします。 | 
| VM エージェントが応答していないため、この操作を実行できません |VM エージェントに問題があるか、Azure インフラストラクチャへのネットワーク アクセスが何らかの原因でブロックされている場合に、このエラーがスローされます。 Windows VM の場合は、サービスで VM エージェントのサービスの状態を確認し、コントロール パネルのプログラムにエージェントが表示されているかどうかを調べます。 コントロール パネルからプログラムを削除し、[下記の手順](#vm-agent)に従ってエージェントを再インストールしてみてください。 エージェントを再インストールした後で、確認のためにアドホック バックアップをトリガーします。 |
| Recovery Services 拡張機能の操作に失敗しました。 - 仮想マシンに最新の仮想マシン エージェントが存在し、エージェント サービスが実行されていることを確認してください。 バックアップ操作を再試行し、失敗した場合は、Microsoft サポートにお問い合わせください。 |このエラーは、VM エージェントが古い場合にスローされます。 次の「VM エージェントの更新」を参照して、VM エージェントを更新してください。 |
| 仮想マシンが存在しません。 - 仮想マシンが存在するかどうかを確認するか、別の仮想マシンを選択してください。 |これは、プライマリ VM が削除されているのに、バックアップ ポリシーによってバックアップを実行する VM が検索され続ける場合に発生します。 このエラーを解決するには、次の手順に従います。 <ol><li> 同じ名前と同じリソース グループ名 [クラウド サービス名] を使用して仮想マシンを作成し直します。<br>(または)<br></li><li>バックアップ データを削除しないで、仮想マシンの保護を停止します。 [詳細](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| コマンドの実行に失敗しました。 - 現在、この項目で別の操作が実行中です。 前の操作が完了するまで待ってから、やり直してください。 |VM で既存のバックアップ ジョブが実行されている場合、そのジョブの実行中に新しいジョブを開始することはできません。 |
| バックアップ資格情報コンテナーからの VHD のコピーがタイムアウトしました - 数分以内に操作をやり直してください。 問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | これは、ストレージ側で一時的なエラーが発生しているか、バックアップ サービスが、VM をホストするストレージ アカウントから、タイムアウト期間内にデータをコンテナーに転送するための IOPS を十分に得られていないときに発生します。 [ベスト プラクティス](backup-azure-vms-introduction.md#best-practices)に従ってバックアップを設定したかどうかを確認してください。 読み込まれていない別のストレージ アカウントに VM を移動して、バックアップを再度実行してみます。|
| バックアップ操作は内部エラーのため失敗しました - 数分以内に操作をやり直してください。 問題が解決しない場合は、Microsoft サポートにお問い合わせください。 |このエラーが発生する原因には次の 2 つが考えられます。 <ol><li> VM ストレージにアクセスするときに一時的な問題が発生する。 [Azure の状態](https://azure.microsoft.com/status/)を調べて、リージョンのコンピューティング、ストレージ、またはネットワークに関連する問題が発生していないかどうかを確認します。 問題が解決したら、バックアップ ジョブを再試行します。 <li>元の VM が削除されているため、復旧ポイントを取得できない。 削除された VM のバックアップ データを保持しながら、バックアップ エラーを削除するには、VM の保護を解除し、データを保持するオプションを選択します。 この操作によって、スケジュールされたバックアップ ジョブが停止され、エラー メッセージが繰り返し表示されるのを回避できます。 |
| 選択した項目に Azure Recovery Services 拡張機能をインストールできませんでした - VM エージェントは、Azure Recovery Services 拡張機能の前提条件です。 Azure VM エージェントをインストールしてから、登録操作をやり直してください。 |<ol> <li>VM エージェントが正しくインストールされていることを確認します。 <li>VM 構成のフラグが正しく設定されていることを確認します。</ol> VM エージェントのインストール方法と、VM エージェントのインストールを検証する方法については、[こちら](#validating-vm-agent-installation)を参照してください。 |
| "COM+: Microsoft 分散トランザクション コーディネーターと通信できませんでした" というエラーで拡張機能のインストールが失敗しました。 |通常、これは、COM + サービスが実行されていないことを意味します。 この問題の修正については、Microsoft サポートにお問い合わせください。 |
| スナップショットの操作は、"このドライブは、BitLocker ドライブ暗号化でロックされています。 コントロール パネルからドライブのロックを解除してください。" という VSS 操作エラーで失敗しました。 |VM 上のすべてのドライブで BitLocker をオフにして、VSS の問題が解決されたかどうかを確認します。 |
| VM はバックアップできる状態ではありません。 |<ul><li>VM が "実行中" と "シャットダウン" の間の一時的な状態にないかどうかを確認してください。 一時的な状態の場合は、VM の状態がいずれかの状態になるのを待ち、再度バックアップをトリガーします。 <li> VM が Linux VM で、[Security Enhanced Linux] カーネル モジュールが使用されている場合は、Linux エージェントのパス (_/var/lib/waagent_) をセキュリティ ポリシーから除外して、バックアップ拡張機能が確実にインストールされるようにします。  |
| Azure 仮想マシンが見つかりません。 |これは、プライマリ VM が削除されているのに、バックアップ ポリシーによってバックアップを実行する VM が検索され続ける場合に発生します。 このエラーを解決するには、次の手順に従います。 <ol><li>同じ名前と同じリソース グループ名 [クラウド サービス名] を使用して仮想マシンを作成し直します。 <br>(または) <li> バックアップ ジョブが作成されないように、この VM の保護を無効にします。 </ol> |
| 仮想マシン エージェントが仮想マシン上に存在しません - 前提条件である項目と VM エージェントをインストールしてから、操作をやり直してください。 |[こちら](#vm-agent) を参照してください。 |
| VSS ライターの状態が正しくないため、スナップショット操作に失敗しました |状態が正しくない VSS (ボリューム シャドウ コピー サービス) ライターを再起動する必要があります。 これを実現するには、管理者特権でのコマンド プロンプトから、_vssadmin list writers_ を実行します。 出力には、すべての VSS ライターとそれらの状態が含まれています。 "[1] 安定" 状態ではない VSS ライターすべてに対して、管理者特権でのコマンド プロンプトから次のコマンドを実行して、VSS ライターを再起動します。<br> _net stop serviceName_ <br> _net start serviceName_|
| 構成の解析に失敗したため、スナップショット操作に失敗しました |これは、次の MachineKeys ディレクトリでアクセス許可が変更されたことで発生します。_%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys。_ <br>次のコマンドを実行し、MachineKeys ディレクトリのアクセス許可が既定のものであることを確認してください。<br>_icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys_ <br><br> 既定のアクセス許可は、次のとおりです。<br>Everyone:(R,W) <br>BUILTIN\Administrators:(F)<br><br>MachineKeys ディレクトリで既定以外のアクセス許可が表示される場合は、以下の手順に従い、アクセス許可の修正、証明書の削除、バックアップのトリガーを行ってください。<ol><li>MachineKeys ディレクトリのアクセス許可を修正します。<br>ディレクトリで Explorer のセキュリティ プロパティやセキュリティの詳細設定を使用して、アクセス許可を既定値にリセットし、ディレクトリに追加 (既定値以外) のユーザー オブジェクトがある場合は削除し、次の項目で "Everyone" アクセス許可に特殊なアクセス許可が設定されていることを確認します。<br>- フォルダーの一覧、データの読み取り <br>- 属性の読み取り <br>- 拡張属性の読み取り <br>- ファイルの作成、データの書き込み <br>-フォルダーの作成、データの追加<br>- 属性の書き込み<br>- 拡張属性の書き込み<br>- アクセス許可の読み取り<br><br><li>"発行先" フィールドが [Windows Azure Service Management for Extensions] または [Windows Azure CRP Certificate Generator] になっている証明書をすべて削除します。<ul><li>[証明書 (ローカル コンピューター) コンソールを開く](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx)<li>[個人用] -> [証明書] の "発行先" フィールドが [Windows Azure Service Management for Extensions] または [Windows Azure CRP Certificate Generator] になっている証明書をすべて削除します。</ul><li>VM のバックアップをトリガーします。 </ol>|
| Azure Backup サービスには、暗号化された仮想マシンのバックアップ用 Key Vault に対する十分な権限がありません。 |[PowerShell ドキュメント](backup-azure-vms-automation.md)の「**バックアップの有効化**」セクションの手順に従い、PowerShell を使って Backup サービスに適切なアクセス許可を付与する必要があります。 |
|"COM+ が Microsoft 分散トランザクション コーディネーターと通信できませんでした" というエラーでスナップショット拡張機能のインストールが失敗しました | Windows サービス "COM+ システム アプリケーション" を起動してみてください (管理者特権のコマンド プロンプトで _net start COMSysApp_ を実行します)。 <br>起動中に失敗した場合は、以下の手順に従ってください。<ol><li> サービスのログオン アカウントが "分散トランザクション コーディネーター" または "ネットワーク サービス" であることを確認します。 そうでない場合は、"ネットワーク サービス" に変更してサービスを再度起動し、"COM+ システム アプリケーション" サービスを起動してみてください。<li>それでも起動できない場合は、以下の手順に従って、"分散トランザクション コーディネーター" サービスのアンインストールとインストールを行ってください。<br> - MSDTC サービスを停止します<br> - コマンド プロンプト (cmd) を開きます <br> - コマンド “msdtc -uninstall” を実行します <br> - コマンド “msdtc -install” を実行します <br> - MSDTC サービスを起動します<li>Windows サービスの "COM + システム アプリケーション" を起動し、サービスが起動されたら、ポータルからバックアップをトリガーします。</ol> |
|  COM+ エラーが発生したため、スナップショット操作に失敗しました | 推奨される操作は、Windows サービス "COM+ System Application" を再起動 (管理者特権でのコマンド プロンプトから _net start COMSysApp_ を実行) することです。 問題が解決しない場合は、VM を再起動します。 VM を再起動しても問題が解決しない場合は、[VMSnapshot 拡張機能を削除](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#cause-3-the-backup-extension-fails-to-update-or-load)してバックアップを手動でトリガーしてみてください。 |
| ファイル システムの一貫性のあるスナップショットの取得で VM の 1 つまたは複数のマウント ポイントをフリーズできませんでした | 次の手順に従います。 <ol><li>_'tune2fs'_ コマンドを使用して、マウントされているすべてのデバイスのファイル システムの状態を確認します。<br> Eg: tune2fs -l /dev/sdb1 \| grep "Filesystem state" <li>ファイル システムの状態がクリーンではないデバイスを、_'umount'_ コマンドを使用してマウント解除します。 <li> これらのデバイスで、_'fsck'_ コマンドを使用して FileSystemConsistency チェックを実行します。 <li> デバイスを再度マウントして、バックアップをやり直します。</ol> |
| セキュリティで保護されたネットワーク通信チャネルを作成できないため、スナップショット操作が失敗しました | <ol><Li> 管理者特権モードで regedit.exe を実行してレジストリ エディターを開きます。 <li> システムに存在するすべてのバージョンの .NetFramework を識別します。 それらは、レジストリ キーの階層 "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft" の下にあります。 <li> レジストリ キー内に存在する各 .NetFramework に対して、次のキーを追加します。 <br> "SchUseStrongCrypto"=dword:00000001 </ol>|
| Visual Studio 2012 用の Visual C++ 再配布可能プログラムをインストールできないため、スナップショット操作が失敗しました | C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion に移動し、vcredist2012_x64 をインストールします。 このサービスのインストールを許可するレジストリ キー値が正しい値に設定されていることを確認します。つまり、_HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver_ は  4 ではなく 3 に設定されている必要があります。 インストールに関する問題が解消されない場合は、管理者特権でコマンド プロンプトから _MSIEXEC /UNREGISTER_ と _MSIEXEC /REGISTER_ を続けて実行して、インストール サービスを再起動します。  |


## <a name="jobs"></a>[ジョブ]
| エラーの詳細 | 対処法 |
| --- | --- |
| このジョブの種類では取り消しがサポートされていません - ジョブが完了するまでお待ちください。 |なし |
| ジョブが取り消しできる状態にありません - ジョブが完了するまでお待ちください。 <br>または<br> 選択したジョブは取り消しできる状態にありません - ジョブが完了するまでお待ちください。 |多くの場合、ジョブはほぼ完了しています。 ジョブが完了するまでお待ちください。|
| 進行中ではないためジョブを取り消すことができません - 取り消しがサポートされているのは、進行中のジョブだけです。 進行中のジョブの取り消しを試してください。 |これは一時的な状態が原因で発生しています。 しばらく待ってから取り消し操作をやり直してください。 |
| ジョブを取り消すことができませんでした - ジョブが終了するまでお待ちください。 |なし |

## <a name="restore"></a>Restore
| エラーの詳細 | 対処法 |
| --- | --- |
| クラウドの内部エラーの復元に失敗しました |<ol><li>復元を試みているクラウド サービスが DNS 設定で構成されています。 次の内容をチェックすることができます。 <br>$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings<br>構成済みのアドレスがある場合は、DNS 設定が構成済みです。<br> <li>復元を試みているクラウド サービスが ReservedIP で構成されていて、クラウド サービスの既存の VM が停止状態になっています。<br>次の PowerShell コマンドレットを使用して、クラウド サービスに予約済み IP があることを確認できます。<br>$deployment = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName <br><li>次の特殊なネットワーク構成の仮想マシンを同じクラウド サービスに復元しようとしています。 <br>- ロード バランサー構成 (内部および外部の) での仮想マシン<br>- 複数の予約済み IP を持つ仮想マシン<br>- 複数の NIC を持つ仮想マシン<br>UI で新しいクラウド サービスを選択するか、特殊なネットワーク構成の VM の[復元に関する考慮事項](backup-azure-arm-restore-vms.md#restore-vms-with-special-network-configurations)を参照してください。</ol> |
| 選択した DNS 名は既に使用されています - 別の DNS 名を指定してからやり直してください。 |この場合、DNS 名はクラウド サービス名 (通常、末尾に cloudapp.net が付いています) を表します。 これは一意である必要があります。 このエラーが発生した場合は、復元中に別の VM の名前を選択する必要があります。 <br><br> このエラーは Azure Portal のユーザーのみに表示されます。 PowerShell による復元操作は、ディスクを復元するだけで、VM を作成しないため、成功します。 ディスクの復元操作後に VM を明示的に作成すると、このエラーが発生します。 |
| 指定された仮想ネットワークの構成が正しくありません - 別の仮想ネットワークの構成を指定してからやり直してください。 |なし |
| 指定したクラウド サービスでは、復元対象の仮想マシンの構成と一致しない予約済み IP が使用されています。予約済み IP を使用していない別のクラウド サービスを指定するか、復元元に別の回復ポイントを選択してください。 |なし |
| クラウド サービスが入力エンドポイントの数に制限に達しました - 別のクラウド サービスを指定するか既存のエンドポイントを使用して、操作をやり直してください。 |なし |
| バックアップ資格情報コンテナーと対象のストレージ アカウントが 2 つの異なるリージョンに存在します - 復元操作で指定したストレージ アカウントが、バックアップ資格情報コンテナーと同じ Azure リージョンに存在するようにしてください。 |なし |
| 復元操作に指定されたストレージ アカウントがサポートされていません - サポートされているのは、ローカル冗長レプリケーションまたは geo 冗長レプリケーションの設定が指定された Basic または Standard ストレージ アカウントのみです。 サポートされているストレージ アカウントを選択してください。 |なし |
| 復元操作に指定されたストレージ アカウントの種類がオンラインではありません - 復元操作で指定したストレージ アカウントがオンラインであることを確認してください。 |これは、Azure Storage の一時的なエラーや障害が原因で発生する可能性があります。 別のストレージ アカウントを選択してください。 |
| リソース グループのクォータに達しました - Azure ポータルの一部のリソース グループを削除するか、Azure サポートに問い合わせて上限を引き上げてください。 |なし |
| 選択したサブネットが存在しません - 存在するサブネットを選択してください。 |なし |
| Backup サービスは、サブスクリプション内のリソースへのアクセスが承認されていません。 |これを解決するには、「[VM の復元構成の選択](backup-azure-arm-restore-vms.md#choose-a-vm-restore-configuration)」の**バックアップされたディスクの復元**に関するセクションで説明されている手順に従って、最初にディスクを復元します。 その後、「[復元されたディスクからの VM の作成](backup-azure-vms-automation.md#create-a-vm-from-restored-disks)」で説明されている PowerShell の手順を使用して、復元されたディスクから完全な VM を作成します。 |

## <a name="backup-or-restore-taking-time"></a>バックアップまたは復元に要する時間
バックアップが 12 時間以上、または復元が 6 時間以上かかる場合は、次のことを行います。
* [バックアップ時間に影響する要因](backup-azure-vms-introduction.md#total-vm-backup-time)と[復元時間に影響する要因](backup-azure-vms-introduction.md#total-restore-time)を把握します。
* [バックアップのベスト プラクティス](backup-azure-vms-introduction.md#best-practices)に従っていることを確認します。 

## <a name="vm-agent"></a>VM エージェント
### <a name="setting-up-the-vm-agent"></a>VM エージェントの設定
通常、VM エージェントは、Azure ギャラリーから作成された仮想マシン内に既に存在しています。 しかし、オンプレミスのデータセンターから移行された仮想マシンには VM エージェントがインストールされていません。 このような VM については、VM エージェントを明示的にインストールする必要があります。

Windows VM の場合:

* [エージェント MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)をダウンロードしてインストールします。 インストールを実行するには、管理者特権が必要です。
* 従来の仮想マシンの場合は、[VM のプロパティを更新](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)して、エージェントがインストールされたことを示します。 この手順は、Resource Manager 仮想マシンの場合は必要ありません。

Linux VM の場合:

* ディストリビューション リポジトリから最新版をインストールします。 ディストリビューション リポジトリを通してのみエージェントをインストールすることを**強くお勧め**します。 パッケージ名の詳細については、[Linux エージェント リポジトリ](https://github.com/Azure/WALinuxAgent)を参照してください。 
* 従来の VM の場合は、[VM のプロパティを更新](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)して、エージェントがインストールされたことを示します。 この手順は、Resource Manager 仮想マシンの場合は必要ありません。

### <a name="updating-the-vm-agent"></a>VM エージェントの更新
Windows VM の場合:

* VM エージェントを更新するには、単純に [VM エージェント バイナリ](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)を再インストールします。 ただし、VM エージェントの更新中にバックアップ操作が実行されないようにする必要があります。

Linux VM の場合:

* [Linux VM エージェントの更新](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)に関する手順に従ってください。
ディストリビューション リポジトリを通してのみエージェントを更新することを**強くお勧め**します。 エージェントのコードを直接 GitHub からダウンロードして、更新することは推奨されません。 最新のエージェントがお使いのディストリビューションで使用できない場合、最新のエージェントをインストールする方法の手順についてディストリビューション サポートに連絡してください。 GitHub リポジトリで [Windows Azure Linux エージェント](https://github.com/Azure/WALinuxAgent/releases)の最新情報を確認できます。

### <a name="validating-vm-agent-installation"></a>VM エージェントのインストールの検証
Windows VM 上で VM エージェントのバージョンを確認する方法:

1. Azure 仮想マシンにログオンし、フォルダー *C:\WindowsAzure\Packages* に移動します。 WaAppAgent.exe ファイルを探します。
2. このファイルを右クリックして **[プロパティ]** をクリックし、**[詳細]** タブを選択します。[製品バージョン] が 2.6.1198.718 以上であることを確認します。

## <a name="troubleshoot-vm-snapshot-issues"></a>VM スナップショットに関する問題のトラブルシューティング
VM のバックアップは、基礎をなすストレージへのスナップショット コマンドの発行に依存します。 ストレージにアクセスできなかったり、スナップショット タスクの実行が遅延したりすると、バックアップ ジョブが失敗することがあります。 次の場合にスナップショットのタスクが失敗することがあります。

1. NSG を使用してストレージへのネットワーク アクセスがブロックされています<br>
    IP のホワイトリスト登録またはプロキシ サーバーを使用してストレージへの[ネットワーク アクセスを有効にする](backup-azure-arm-vms-prepare.md#establish-network-connectivity)方法の詳細を参照してください。
2. SQL Server のバックアップが構成されている VM はスナップショット タスクの遅延を引き起こすことがあります  <br>
   既定では、VM バックアップは Windows VM に対する VSS フル バックアップを発行します。 SQL Server を実行している VM で、SQL Server のバックアップが構成されている場合、スナップショットの実行に遅延が発生する可能性があります。 スナップショットに関する問題によりバックアップが失敗する場合は、次のレジストリ キーを設定してください。

   ```
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```
3. VM が RDP でシャットダウンされているため、VM の状態が正しく報告されません。  <br>
   RDP で仮想マシンをシャットダウンした場合は、ポータルに戻って VM の状態が正しく反映されていることを確認してください。 正しくない場合は、VM ダッシュボードの [シャットダウン] オプションを使用して、ポータルの VM をシャットダウンしてください。
4. 5 つ以上の VM が同じクラウド サービスを共有している場合は、5 つ以上の VM のバックアップが同時に開始されないように、バックアップの時間を段階的に設定する複数のバックアップ ポリシーを構成します。 ポリシー間でバックアップの開始時刻を 1 時間ずつ離すようにしてください。
5. VM の CPU/メモリの使用率が高くなっています。<br>
   仮想マシンの CPU またはメモリの使用率が高くなる (90% 以上) と、スナップショット タスクがキューに配置されて遅延し、最終的にはタイムアウトします。このような状況では、オンデマンド バックアップをお試しください。

<br>

## <a name="networking"></a>ネットワーク
Backup 拡張機能は、他の拡張機能と同様に、パブリックなインターネットへのアクセスが必要です。 パブリック インターネットにアクセスできない場合、さまざまな問題が発生する可能性があります。

* 拡張機能のインストールが失敗する
* ディスク スナップショットなどのバックアップ操作が失敗する
* バックアップ操作の状態を表示できない

パブリックなインターネット アドレスを解決する必要性については、 [この記事](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx)をご覧ください。 VNET 用の DNS 構成を確認し、Azure の URI が解決できることを確認する必要があります。

名前解決が正しく実行された後で、Azure IP へのアクセスも提供する必要があります。 Azure インフラストラクチャへのアクセスのブロックを解除するには、次のいずれかの手順に従います。

1. Azure データ センターの IP 範囲をホワイトリストに登録する。
   * ホワイトリストに登録する [Azure データセンター IP](https://www.microsoft.com/download/details.aspx?id=41653) の一覧を取得します。
   * [New-NetRoute](https://docs.microsoft.com/powershell/module/nettcpip/new-netroute) コマンドレットを使用して、IP アドレスのブロックを解除します。 管理者特権の PowerShell ウィンドウ (管理者として実行) で、Azure VM 内でこのコマンドレットを実行します。
   * 規則を NSG に追加して IP にアクセスできるようにします (NSG を使用している場合)。
2. フローに対する HTTP トラフィック用のパスを作成する
   * 何らかのネットワーク制限 (ネットワーク セキュリティ グループなど) を設定している場合は、トラフィックをルーティングするための HTTP プロキシ サーバーをデプロイします。 HTTP プロキシ サーバーをデプロイする手順は、[こちら](backup-azure-arm-vms-prepare.md#establish-network-connectivity)を参照してください。
   * 規則を NSG に追加して HTTP プロキシからインターネットにアクセスできるようにします (NSG を使用している場合)。

> [!NOTE]
> IaaS VM Backup が正しく機能するためには、ゲスト内で DHCP が有効になっている必要があります。  静的プライベート IP が必要な場合は、プラットフォームを通じて構成する必要があります。 VM 内の DHCP オプションは有効のままにしておいてください。
> 詳細については、 [静的内部プライベート IP の設定](../virtual-network/virtual-networks-reserved-private-ip.md)に関する記事をご覧ください。
>
>
