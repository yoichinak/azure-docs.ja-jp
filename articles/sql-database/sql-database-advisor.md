---
title: パフォーマンスに関する推奨事項 - Azure SQL Database | Microsoft Docs
description: Azure SQL Database は、現在のクエリのパフォーマンスを向上できる、SQL Database 向けの推奨事項を提供します。
services: sql-database
author: danimir
manager: craigg
ms.service: sql-database
ms.custom: monitor & tune
ms.topic: conceptual
ms.date: 04/01/2018
ms.author: v-daljep
ms.reviewer: carlrab
ms.openlocfilehash: 2f29326f54a90d79532529175a94b1afc1920bea
ms.sourcegitcommit: 9819e9782be4a943534829d5b77cf60dea4290a2
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/06/2018
ms.locfileid: "39520998"
---
# <a name="performance-recommendations-for-sql-database"></a>SQL Database のパフォーマンスに関する推奨事項

Azure SQL Database は、ご使用のアプリケーションを学習して適応します。 これは、SQL データベースのパフォーマンスを最大限に引き出すことができるカスタマイズされた推奨事項を提供します。 SQL Database は、ご使用の SQL データベースの試用履歴の調査と分析を続けます。 推奨事項はデータベース固有のワークロード パターンに基づき、そのパフォーマンス改善を支援します。

> [!TIP]
> [自動チューニング](sql-database-automatic-tuning.md)は、推奨されるパフォーマンス調整方法です。 [Intelligent Insights](sql-database-intelligent-insights.md) は、推奨されるパフォーマンス監視方法です。 
>

## <a name="create-index-recommendations"></a>インデックスの作成に関する推奨事項
SQL Database は、実行されるクエリを継続的に監視し、パフォーマンスを改善する可能性があるインデックスを特定します。 特定のインデックスが欠落していることが確実になると、新しい**インデックスの作成**推奨事項が作成されます。

 Azure SQL Database は、一定の期間後にインデックスがもたらすパフォーマンス増加を見積もることで確信度を高めます。 見積もられたパフォーマンス増加に基づき、推奨事項は高、中、低で分類されます。 

推奨事項を利用して作成されたインデックスには常に auto_created というフラグが設定されます。 sys.indexes ビューを見ることでどのインデックスが auto_created であるか確認できます。 自動作成されたインデックスは ALTER/RENAME コマンドをブロックしません。 

auto-created インデックスが設定されている列を削除しようとすると、コマンドは成功します。 auto-created インデックスもこのコマンドによって削除されます。 通常のインデックスは、インデックスが付けられた列の ALTER/RENAME コマンドをブロックします。

インデックスの作成に関する推奨事項が適用されると、Azure SQL Database はクエリのパフォーマンスをベースライン パフォーマンスと比較します。 新しいインデックスによってパフォーマンスが向上した場合、推奨事項が成功したというフラグが設定され、影響レポートが生成されます。 インデックスによってパフォーマンスが向上しなかった場合、インデックスは自動的に元に戻されます。 SQL Database は、このプロセスを使用して、推奨事項が確実にデータベース パフォーマンスを向上するようにします。

**インデックスの作成**に関する推奨事項にはバックオフ ポリシーがあります。データベースまたはプールのリソース使用率が高すぎる場合、推奨事項は適用されません。 バックオフ ポリシーでは、CPU、データ IO、ログ IO、および使用可能な記憶領域が考慮されます。 

CPU、データ IO、ログ IO が直前の 30 分間で 80% を超えている場合、インデックス作成の推奨事項は延期されます。 インデックスの作成により使用可能な記憶領域が 10% を下回る場合は、推奨事項がエラー状態に変わります。 数日後に自動チューニングを行ってインデックスが有効であると示される場合には、プロセスが再び開始します。 

このプロセスは、インデックスの作成に十分な使用可能領域がある限り、またはインデックスが有効でないと見なさるまで繰り返されます。

## <a name="drop-index-recommendations"></a>インデックスの削除に関する推奨事項
足りないインデックスの検出だけでなく、SQL Database は既存インデックスのパフォーマンスを継続的に分析します。 インデックスが使用されない場合、Azure SQL Database はその削除を推奨します。 インデックスの削除は 2 つの場合に推奨されます。
* インデックスが別のインデックスと重複している場合 (同じインデックスを付けて追加された列、パーティション スキーマ、フィルター)
* インデックスが長期間 (93 日) 使用されていない場合

インデックスの削除に関する推奨事項は、実施後に検証も通過します。 パフォーマンスが改善されると、影響レポートが入手可能になります。 パフォーマンスが低下すると、推奨事項が元に戻されます。


## <a name="parameterize-queries-recommendations"></a>クエリのパラメーター化に関する推奨事項
継続的に再コンパイルされてはいるもののクエリ実行プランが同じままのクエリが 1 つ以上あると、*クエリのパラメーター化*に関する推奨事項が表示されます。 この条件によって、強制パラメーター化を適用する機会が生成されます。 強制パラメーター化では、クエリ プランをキャッシュして将来再利用できるようになり、パフォーマンスが向上し、リソース使用率が削減されます。 

SQL Server に対して発行されたすべてのクエリは、実行プランの生成のために、最初にコンパイルされる必要があります。 生成された各プランがプラン キャッシュに追加されます。 同じクエリのその後の実行では、キャッシュからプランを再利用できるため、追加のコンパイルの必要がなくなります。 

パラメーター化されていない値を含むクエリは、パフォーマンスのオーバーヘッドにつながる可能性があります。パラメーター化されていない値が異なるたびに、実行プランが再コンパイルされるためです。 多くの場合、パラメーター値の異なる同じクエリによって同一の実行プランが生成されます。 しかし、これらのプランは個別にプラン キャッシュに追加されます。 

実行プランを再コンパイルするプロセスにより、データベース リソースが消費され、クエリ実行時間の増加とプラン キャッシュのオーバーフローが発生します。 このようなイベントは、プランがキャッシュから削除される原因となります。 SQL Server のこの動作は、データベースで強制パラメーター化のオプションを設定することにより変更できます。 

推奨事項が与える影響の予測に役立つよう、実際の CPU 使用率、および予測される CPU 使用率 (推奨事項が適用されたと仮定した場合) の比較が提供されます。 この推奨事項は、CPU 使用率を抑えるために役立ちます。 また、クエリ期間の短縮と、プラン キャッシュのオーバーヘッドの削減にも役立ちます。つまり、キャッシュに残って再利用されるプランが増加することになります。 **[適用]** コマンドを選択して、迅速にこの推奨事項を適用できます。 

この推奨事項を適用すると、数分以内にデータベースで強制パラメーター化が有効になります。 監視プロセスが開始され、約 24 時間続きます。 この期間が終了すると検証レポートを表示できます。 このレポートは、推奨事項の適用前後 24 時間のデータベースの CPU 使用率を示します。 SQL Database Advisor は、パフォーマンスの不具合が検出された場合に、推奨事項の適用を自動的に元に戻す安全メカニズムを備えています。

## <a name="fix-schema-issues-recommendations-preview"></a>スキーマの問題の修正に関する推奨事項 (プレビュー)

> [!IMPORTANT]
> Microsoft は、現在、"スキーマの問題の修正" に関する推奨事項を廃止しているところです。 かつて "スキーマの問題の修正" 推奨事項で扱っていたスキーマの問題を含め、データベース パフォーマンスの問題を監視するには、[Intelligent Insights](sql-database-intelligent-insights.md) の使用をお勧めします。
> 

SQL Database サービスが、ご使用の SQL データベースで発生したスキーマ関連の SQL エラー数が異常であることを検出すると、**[スキーマの問題の修正]** 推奨事項が表示されます。 この推奨事項は、通常、データベースでスキーマ関連のエラー (無効な列名、無効なオブジェクト名など) が 1 時間に複数件発生した場合に表示されます。

"スキーマの問題" は SQL Server での構文エラーの一種です。 SQL クエリの定義とデータベース スキーマの定義が合っていないときに発生します。 たとえば、クエリで想定される列の 1 つがターゲット テーブルで見つからない、あるいはその逆の場合です。 

Azure SQL Database サービスが、ご使用の SQL データベースで発生したスキーマ関連の SQL エラー数が異常であることを検出すると、[スキーマの問題の修正] 推奨事項が表示されます。 下の表は、スキーマの問題に関連したエラーを示しています。

| SQL エラー コード | Message |
| --- | --- |
| 201 |プロシージャまたは関数 '*' にはパラメーター '*' が必要ですが、指定されませんでした。 |
| 207 |列名 '*' が無効です。 |
| 208 |オブジェクト名 '*' が無効です。 |
| 213 |列名または指定された値の数がテーブルの定義と一致しません。 |
| 2812 |ストアド プロシージャ '*' が見つかりませんでした。 |
| 8144 |プロシージャまたは関数 * に指定された引数が多すぎます。 |

## <a name="next-steps"></a>次の手順
推奨事項を監視し、引き続きパフォーマンスの調整対象とします。 データベースのワークロードは動的であり、継続的に変化します。 SQL Database Advisor では、お使いのデータベースのパフォーマンスを向上させる可能性がある推奨事項の監視と提供を継続します。 

* データベース インデックスとクエリ実行プランの自動チューニングについては、[Azure SQL Database の自動チューニング](sql-database-automatic-tuning.md)に関するページを参照してください。
* パフォーマンスの問題の自動診断および根本原因分析を含むデータベース パフォーマンスの自動監視については、[Azure SQL Intelligent Insights](sql-database-intelligent-insights.md) に関するページを参照してください。
*  Azure Portal でパフォーマンス推奨事項を使用する方法については、[Azure Portal のパフォーマンス推奨事項](sql-database-advisor-portal.md)に関するページを参照してください。
* よく使用されるクエリによるパフォーマンスへの影響を確認する方法については、[クエリ パフォーマンスの洞察](sql-database-query-performance.md)に関する記事をご覧ください。


