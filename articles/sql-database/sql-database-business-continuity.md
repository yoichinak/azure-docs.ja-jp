---
title: クラウド ビジネス継続性 - データベース復旧 - SQL Database | Microsoft Docs
description: Azure SQL Database がどのようにクラウド ビジネス継続性とデータベース復旧をサポートし、ミッション クリティカルなクラウド アプリケーションの実行を維持できるようにするかについて説明します。
keywords: ビジネス継続性, クラウド ビジネス継続性, データベースの障害復旧, データベース復旧
services: sql-database
author: anosov1960
manager: craigg
ms.service: sql-database
ms.custom: business continuity
ms.topic: conceptual
ms.workload: On Demand
ms.date: 07/25/2018
ms.author: sashan
ms.reviewer: carlrab
ms.openlocfilehash: 46ab4a177cc7d86e5d967ff8e219dae96f82a0dc
ms.sourcegitcommit: a5eb246d79a462519775a9705ebf562f0444e4ec
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/26/2018
ms.locfileid: "39263148"
---
# <a name="overview-of-business-continuity-with-azure-sql-database"></a>Azure SQL Database によるビジネス継続性の概要

この概要では、Azure SQL Database に用意されているビジネス継続性と障害復旧の機能について説明し、 データ損失につながる、またはデータベースやアプリケーションを使用不能状態に追い込む破壊的なイベントから復旧するためのオプション、推奨事項、およびチュートリアルについて説明します。 ユーザーまたはアプリケーション エラーがデータ整合性に影響を及ぼすとき、Azure リージョンでシステム停止が発生したとき、あるいはアプリケーションにメンテナンスが必要なときの対処方法について説明します。

## <a name="sql-database-features-that-you-can-use-to-provide-business-continuity"></a>ビジネス継続性を提供するときに使用できる SQL Database の機能

SQL Database には、自動バックアップ、オプションのデータベース レプリケーションなど、ビジネス継続性の機能がいくつか用意されており、 推定復旧時間 (ERT) と、最近のトランザクションに対する潜在的なデータ損失の特徴が、それぞれ異なります。 オプションについて理解したら、その中から適切なものを選択できます。これらのオプションは、ほとんどの場合、さまざまなシナリオに対して組み合わせて使用できます。 ビジネス継続性計画を開発するときは、破壊的なイベントが発生してから、アプリケーションが完全に復旧するまでの最大許容時間について理解する必要があります。これが目標復旧時間 (RTO) です。 さらに、破壊的なイベントの発生後、復旧中にアプリケーションが損失を許容できる最大データ更新 (期間) 量についても理解しなければなりません。これは目標復旧時点 (RPO) です。

次の表では、最も一般的な 3 つのシナリオについて、各サービス レベルの ERT と RPO を比較しています。

| 機能 | Basic | 標準 | Premium  | 汎用 | Business Critical
| --- | --- | --- | --- |--- |--- |
| バックアップからのポイントインタイム リストア |7 日間以内のあらゆる復元ポイント |35 日間以内のあらゆる復元ポイント |35 日間以内のあらゆる復元ポイント |構成済み期間内の任意の復元ポイント (最大 35 日間)|構成済み期間内の任意の復元ポイント (最大 35 日間)|
| Geo レプリケーション バックアップからの geo リストア |ERT < 12 時間、RPO < 1 時間 |ERT < 12 時間、RPO < 1 時間 |ERT < 12 時間、RPO < 1 時間 |ERT < 12 時間、RPO < 1 時間|ERT < 12 時間、RPO < 1 時間|
| SQL の長期保有からの復元 |ERT < 12 時間、RPO < 1 週間 |ERT < 12 時間、RPO < 1 週間 |ERT < 12 時間、RPO < 1 週間 |ERT < 12 時間、RPO < 1 週間|ERT < 12 時間、RPO < 1 週間|
| アクティブ geo レプリケーション |ERT < 30 秒、RPO < 5 秒 |ERT < 30 秒、RPO < 5 秒 |ERT < 30 秒、RPO < 5 秒 |ERT < 30 秒、RPO < 5 秒|ERT < 30 秒、RPO < 5 秒|

### <a name="use-point-in-time-restore-to-recover-a-database"></a>ポイントインタイム リストアを使用して、データベースを復旧します

SQL Database は、データ損失からビジネスを守るために、データベースの完全バックアップ (毎週)、データベースの差分バックアップ (1 時間ごと)、およびトランザクション ログのバックアップ (5 ～ 10 分ごと) を組み合わせて自動的に実行します。 [DTU ベースの購入モデル](sql-database-service-tiers-dtu.md)を使用する場合、これらのバックアップは、Standard および Premium サービス レベルのデータベースについては 35 日間、Basic サービス レベルのデータベースについては 7 日間、RA-GRS ストレージに格納されます。 サービス階層のリテンション期間がビジネス要件を満たしていない場合、リテンション期間を長くするには、[サービス階層を変更](sql-database-single-database-scale.md)します。 [仮想コアベースの購入モデルを使用している場合](sql-database-service-tiers-vcore.md)、General Purpose および Business Critical サービス レベルでは、バックアップ リテンション期間は最大 35 日に設定できます。 データベースの完全バックアップと差分バックアップは、データ センターの停止に対する保護のために[ペアのデータ センター](../best-practices-availability-paired-regions.md)にもレプリケートされます。 詳細については、[データベースの自動バックアップ](sql-database-automated-backups.md)に関するページをご覧ください。

サポートされているポイントインタイム リストア (PITR) リテンション期間がアプリケーションにとって十分でない場合は、データベースの長期リテンション期間 (LTR) ポリシーを構成することで、リテンション期間を拡張できます。 詳細については、「[自動バックアップに関する記事](sql-database-automated-backups.md)」と「[長期バックアップ リテンション期間に関する記事](sql-database-long-term-retention.md)」を参照してください。

これらのデータベースの自動バックアップを使用して、さまざまな中断イベントから、データ センター内または別のデータ センターにデータベースを回復することができます。 データベースの自動バックアップでの復旧時間は、同じリージョン内で同時に復旧するデータベースの合計数、データベースのサイズ、トランザクション ログのサイズ、ネットワーク帯域幅など、複数の要因によって異なりますが、 通常は 12 時間もかかりません。 非常に大規模な、またはアクティブなデータベースの復旧には時間がかかることがあります。 復旧時間の詳細については、[データベースの復旧時間](sql-database-recovery-using-backups.md#recovery-time)に関するページを参照してください。 他のデータ リージョンに復旧する場合は、geo 冗長ストレージで 1 時間ごとにデータベースの差分バックアップが実行されるため、潜在的なデータ損失が 1 時間分の量を超えることはありません。

> [!IMPORTANT]
> 自動バックアップを使って復旧するには、SQL Server の共同作業者ロールのメンバーまたはサブスクリプション所有者である必要があります。「[RBAC: 組み込みのロール](../role-based-access-control/built-in-roles.md)」をご覧ください。 復旧には、Azure ポータル、PowerShell、または REST API を使用できます。 Transact-SQL は使用できません。
>

次のようなアプリケーションについては、ビジネス継続性と復旧メカニズムとして自動バックアップを使用します。

* ミッション クリティカルではない。
* 拘束力のある SLA がない。24 時間以上のダウンタイムで財務責任が課せられることがない。
* データ変更率 (1 時間あたりのトランザクション数など) が低く、最大 1 時間分の変更に対するデータ損失を許容できる。
* コスト重視である。

迅速に復旧する必要がある場合は、後述する [アクティブ geo レプリケーション](sql-database-geo-replication-overview.md)を使用してください。 35 日より前の期間のデータを回復する能力が必要な場合は、[長期リテンション期間](sql-database-long-term-retention.md)を使用します。 

### <a name="use-active-geo-replication-and-auto-failover-groups-to-reduce-recovery-time-and-limit-data-loss-associated-with-a-recovery"></a>アクティブ geo レプリケーションと自動フェールオーバー グループを使用して、復旧時間を短縮し、復旧に伴うデータ損失を抑える

ビジネス中断が発生した場合、データベース バックアップを使用してデータベースを復旧するほか、[アクティブ geo レプリケーション](sql-database-geo-replication-overview.md)を使用して、最大 4 つの読み取り可能なセカンダリ データベースが任意のリージョンに作成されるように、データベースを構成することもできます。 このセカンダリ データベースは、非同期レプリケーション メカニズムを使用して、プライマリ データベースと同期し続けます。 この機能は、データ センター停止が発生した場合、またはアプリケーションのアップグレード中のビジネス中断を防ぐために使用されます。 また、アクティブ geo レプリケーションを使用して、地理的に分散したユーザーの読み取り専用クエリのパフォーマンスを高めることもできます。

自動的かつ透過的なフェールオーバーを有効にするには、SQL Database の[自動フェールオーバー グループ](sql-database-geo-replication-overview.md)機能を使用して、geo レプリケートされたデータベースをグループにまとめる必要があります。

プライマリ データベースが予期せずオフラインになった場合、またはメンテナンスのためにプライマリ データベースをオフラインにする必要がある場合は、セカンダリ データベースをすばやくプライマリに昇格し ("フェールオーバー" とも呼ばれます)、プライマリに昇格したデータベースに接続されるようにアプリケーションを構成できます。 アプリケーションがフェールオーバー グループ リスナーを使用してデータベースに接続している場合は、SQL 接続文字列構成をフェールオーバーの後で変更する必要がありません。 計画フェールオーバーの場合、データ損失は発生しません。 計画されていないフェールオーバーについては、非同期レプリケーションの性質上、最近のトランザクションのデータが多少失われます。 自動フェールオーバー グループを使用すると、フェールオーバー ポリシーをカスタマイズしてデータ損失の可能性を最小限に抑えることができます。 フェールオーバー後は、後でフェールバックできます。このフェールバックは、計画に従って、またはデータ センターがオンラインに戻ったときに行います。 いずれにしても、ユーザーのダウンタイムはわずかで、再接続が必要です。

> [!IMPORTANT]
> アクティブ geo レプリケーションと自動フェールオーバー グループを使用するには、サブスクリプション所有者であるか、SQL Server の管理アクセス許可を持っている必要があります。 Azure ポータル、PowerShell、または REST API で構成およびフェールオーバーを行う場合は、Azure サブスクリプションのアクセス許可を使用できます。Transact-SQL で行う場合は、SQL Server のアクセス許可を使用できます。
> 

アクティブ geo レプリケーションと自動フェールオーバー グループは、アプリケーションが次のいずれかの条件を満たす場合に使用します。

* ミッション クリティカルである。
* サービス レベル アグリーメント (SLA) で 24 時間以上のダウンタイムが許可されていない。
* ダウンタイムによって財務責任が発生する。
* データ変更率が高く、1 時間分のデータの損失が許容されない。
* アクティブ geo レプリケーションの追加コストが、潜在的な財務責任と関連するビジネス損失を下回る。

> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Azure-SQL-Database-protecting-important-DBs-from-regional-disasters-is-easy/player]
>

## <a name="recover-a-database-after-a-user-or-application-error"></a>ユーザーまたはアプリケーション エラーの発生後にデータベースを復旧する

ミスをしない人など存在しません。 一部のデータ、重要なテーブル、そしてデータベース全体さえも、うっかり削除してしまう場合があります。 アプリケーションの欠陥で、正しいデータが不良データによって誤って上書きされることもあります。

ここでは、このような場合の復旧オプションを紹介します。

### <a name="perform-a-point-in-time-restore"></a>ポイントインタイム リストアを実行する
自動バックアップを使用すると、データベースのコピーを、データベース リテンション期間内の既知の適切な時点まで遡って復旧できます。 データベースを復元したら、元のデータベースを復元したデータベースに置き換えるか、復元したデータから必要なデータを元のデータベースにコピーできます。 データベースでアクティブ geo レプリケーションが使用されている場合は、復元されたコピーから元のデータベースに必要なデータをコピーすることをお勧めします。 元のデータベースを復元したデータベースに置き換える場合は、アクティブ geo レプリケーションを再構成して再同期する必要があります (大きなデータベースの場合はかなり時間がかかることがあります)。 これにより、データベースは利用可能な最新のポイント イン タイムまでリストアされますが、geo セカンダリの任意のポイント イン タイムへのリストアは現在サポートされていません。

詳細情報、および Azure ポータルまたは PowerShell を使用してデータベースを特定の時点に復元する詳細な手順については、「 [ポイントインタイム リストア](sql-database-recovery-using-backups.md#point-in-time-restore)」をご覧ください。 Transact-SQL を使用して回復することはできません。

### <a name="restore-a-deleted-database"></a>削除されたデータベースの復元
データベースだけが削除され、論理サーバーが削除されていない場合は、削除されたデータベースを、そのデータベースが削除された時点に戻すことができます。 この場合、データベースが削除された論理 SQL サーバーに、データベース バックアップが復元されます。 このデータベースの復元は元の名前を使用して実行することも、復元したデータベースに新しいに名前を付けることもできます。

詳細情報、および削除されたデータベースを Azure ポータルまたは PowerShell を使用して復元する詳細な手順については、 [削除されたデータベースの復元](sql-database-recovery-using-backups.md#deleted-database-restore)に関するページをご覧ください。 Transact-SQL を使用して復元することはできません。

> [!IMPORTANT]
> 論理サーバーが削除された場合、削除されたデータベースは回復できません。


### <a name="restore-backups-from-long-term-retention"></a>長期リテンション期間からのバックアップの復元

自動化されたバックアップの現在のリテンション期間外にデータの損失が発生したとき、お使いのデータベースが Azure Blob Storage を使った長期保有用に構成されている場合は、Azure Blob Storage の完全バックアップから、新しいデータベースにデータを復元できます。 この時点で、元のデータベースを復元したデータベースに置き換えるか、復元したデータベースから必要なデータを元のデータベースにコピーできます。 アプリケーションのメジャー アップグレードの前の古いバージョンのデータベースを取得し、監査担当者からの要求または法律上の要請に対応する必要がある場合は、Azure Blob Storage に保存されている完全バックアップを使用してデータベースを作成することができます。  詳細については、「[長期保存](sql-database-long-term-retention.md)」をご覧ください。

## <a name="recover-a-database-to-another-region-from-an-azure-regional-data-center-outage"></a>Azure リージョン データ センターが停止した場合にデータベースを別のリージョンで回復する
<!-- Explain this scenario -->

まれではありますが、Azure データ センターが停止することもあります。 停止が発生すると、ビジネスが中断します。この中断はわずか数分で解消されることもありますが、数時間に及ぶ場合もあります。

* オプションの 1 つは、データ センターの停止が終了し、データベースがオンラインに戻るのを待つことです。 このオプションは、オフラインのデータベースが許容されるアプリケーションで有効です。 たとえば、常時作業する必要のない開発プロジェクトや無料試用版がこれに該当します。 また、データ センターが停止したときに、復旧までの時間を予測できないため、当面はデータベースが必要ない場合にのみ使用できます。
* もう 1 つは、アクティブ geo レプリケーションを使用して別のデータ リージョンにフェールオーバーするか、geo 冗長データベース バックアップ (geo リストア) を使用してデータベースを復旧するオプションです。 フェールオーバーの所要時間はわずか数秒ですが、バックアップからデータベースが復旧する場合は数時間かかります。

アクションを実行するタイミング、復旧にかかる時間、および発生するデータ損失の量は、ビジネス継続性機能をアプリケーションでどのように使用するかによって異なります。 実際は、アプリケーションの要件に応じて、データベース バックアップとアクティブ geo レプリケーションを組み合わせて使用できます。 ビジネス継続性機能を使用したスタンドアロン データベースおよびエラスティック プール用アプリケーション設計に関する考慮事項については、[クラウド ディザスター リカバリー用のアプリケーション設計](sql-database-designing-cloud-solutions-for-disaster-recovery.md)に関するページと [Elastic Pool のディザスター リカバリー戦略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)に関するページをご覧ください。

以下のセクションでは、データベース バックアップまたは アクティブ geo レプリケーションのいずれかを使用して復旧する手順の概要について説明します。 要件の計画、復旧後の手順、障害をシミュレートしてディザスター リカバリー訓練を実施する方法など、詳細な手順については、[障害からの SQL Database 復旧](sql-database-disaster-recovery.md)に関するページをご覧ください。

### <a name="prepare-for-an-outage"></a>障害に備える
使用するビジネス継続性機能に関係なく、次の操作を行う必要があります。

* サーバー レベルのファイアウォール規則、ログイン、マスター データベース レベルのアクセス許可など、ターゲット サーバーを特定して準備します。
* クライアントとクライアント アプリケーションを、新しいサーバーにリダイレクトする方法を決めます
* 監査の設定、アラートなど、他の依存関係を文書化します

準備が不十分な状態で、フェールオーバーまたはデータベースの復旧後にアプリケーションをオンラインにすると、余計な時間がかかり、負荷がかかったときにトラブルシューティングが必要になる場合があります。良くない組み合わせです。

### <a name="fail-over-to-a-geo-replicated-secondary-database"></a>geo レプリケートされたセカンダリ データベースにフェールオーバーする
アクティブ geo レプリケーションと自動フェールオーバー グループを復旧メカニズムとして使用している場合は、自動フェールオーバー ポリシーを構成するか[手動フェールオーバー](sql-database-disaster-recovery.md#fail-over-to-geo-replicated-secondary-server-in-the-failover-group)を使用できます。 いったん開始すると、フェールオーバーによってセカンダリは新しいプライマリになり、新しいトランザクションを記録してクエリに応答できるようになります。失われるのは、レプリケートされなかった最小限のデータだけです。 フェールオーバー プロセスの設計については、[クラウド障害復旧用のアプリケーション設計](sql-database-designing-cloud-solutions-for-disaster-recovery.md)に関するページをご覧ください。

> [!NOTE]
> データ センターがオンラインに戻ると、古いプライマリは自動的に新しいプライマリに再接続し、セカンダリ データベースになります。 プライマリを元のリージョンに再配置する場合は、計画されたフェールオーバーを手動で開始することができます (フェールバック)。 
> 

### <a name="perform-a-geo-restore"></a>geo リストアを実行する
Geo 冗長ストレージ レプリケーションによる自動バックアップを復旧メカニズムとして使用している場合は、[geo リストアを使用してデータベース復旧を開始](sql-database-disaster-recovery.md#recover-using-geo-restore)します。 ほとんどの場合、12 時間以内に復旧が実行され、最大 1 時間分のデータ損失が発生します。これは 1 時間ごとの差分バックアップによって、最後のバックアップが実行およびレプリケートされたタイミングによって決まります。 復旧処理が完了するまで、データベースは、トランザクションを記録したり、クエリに応答したりすることはできません。 これにより、データベースは利用可能な最新のポイント イン タイムまでリストアされますが、geo セカンダリの任意のポイント イン タイムへのリストアは現在サポートされていません。

> [!NOTE]
> 復旧されたデータベースにアプリケーションを切り替える前に、データ センターがオンラインに戻った場合は、復旧をキャンセルすることができます。  
>
>

### <a name="perform-post-failover--recovery-tasks"></a>フェールオーバー後のタスク/復旧タスクを実行する
復旧にどちらのメカニズムを使ったとしても、ユーザーおよびアプリケーションの動作を元に戻す前に、次の追加タスクを実行する必要があります。

* クライアントとクライアント アプリケーションを、新しいサーバーおよび復元されたサーバーにリダイレクトする
* ユーザーが接続できるように、適切なサーバー レベルのファイアウォール規則が適用されていることを確認する (または [データベース レベルのファイアウォール](sql-database-firewall-configure.md#creating-and-managing-firewall-rules)を使用する)
* 適切なログインとマスター データベース レベルのアクセス許可が適切に指定されていることを確認する (または [包含ユーザー](https://msdn.microsoft.com/library/ff929188.aspx)を使用する)
* 必要に応じて、監査を構成する
* 必要に応じて、アラートを構成する

## <a name="upgrade-an-application-with-minimal-downtime"></a>最小のダウンタイムでアプリケーションをアップグレードする
アプリケーションのアップグレードなど、計画されたメンテナンスのために、アプリケーションをオフラインにしなければならないことがあります。 [アプリケーション アップグレードの管理](sql-database-manage-application-rolling-upgrade.md) に関するページでは、アクティブ geo レプリケーションを使用してクラウド アプリケーションのローリング アップグレードを有効化し、アップグレード中のダウンタイムを最小限に抑え、問題が発生した場合の復旧パスを提供する方法について説明します。 

## <a name="next-steps"></a>次の手順
スタンドアロン データベースおよびエラスティック プール用アプリケーション設計に関する考慮事項については、[クラウド ディザスター リカバリー用のアプリケーション設計](sql-database-designing-cloud-solutions-for-disaster-recovery.md)に関するページと [Elastic Pool のディザスター リカバリー戦略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)に関するページをご覧ください。
