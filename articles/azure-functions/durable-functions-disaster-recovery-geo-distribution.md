---
title: Durable Functions のディザスター リカバリーと地理的分散 - Azure
description: Durable Functions のディザスター リカバリーと地理的分散について説明します。
services: functions
author: MS-Santi
manager: cfowler
editor: ''
tags: ''
keywords: ''
ms.service: functions
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: multiple
ms.workload: na
ms.date: 04/25/2018
ms.author: azfuncdf
ms.openlocfilehash: bbfbf351b8976f4140b6dd98a9a54ba982c3d865
ms.sourcegitcommit: d4c076beea3a8d9e09c9d2f4a63428dc72dd9806
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/01/2018
ms.locfileid: "39399399"
---
# <a name="disaster-recovery-and-geo-distribution"></a>ディザスター リカバリーと地理的分散

## <a name="overview"></a>概要
Azure Durable Functions では、すべての状態は Azure Storage に永続的に保持されます。 [タスク ハブ](durable-functions-task-hubs.md)は、オーケストレーションに使用される Azure Storage リソースの論理コンテナーです。 オーケストレーター関数とアクティビティ関数は、同じタスク ハブに属しているときに限り、情報をやり取りすることができます。
説明されているシナリオでは、ディザスター リカバリー中の可用性を向上し、ダウンタイムを最小限に抑える展開オプションが提案されています。
これらのシナリオでは、Azure Storage の使用を前提としたアクティブ/パッシブ構成が使用されていることに注意してください。 このパターンは、異なるリージョンに、バックアップ (パッシブ) 関数アプリを展開することで構成されます。 Traffic Manager では、プライマリ (アクティブ) 関数アプリの可用性を監視します。 プライマリに障害が発生した場合、バックアップ関数アプリにフェールオーバーします。 詳細については、「[Traffic Manager](https://azure.microsoft.com/services/traffic-manager/) での[優先順位によるトラフィック ルーティング方法の構成](../traffic-manager/traffic-manager-routing-methods.md#a-name--priorityapriority-traffic-routing-method)」をご覧ください。


>[!NOTE]
>- 提案されているアクティブ/パッシブ構成では、クライアントは常に HTTP 経由で新しいオーケストレーションをトリガーできます。 ただし、2 つの関数アプリが同じストレージを共有するため、バックグラウンド処理が 2 つの関数アプリに分散され、同じキュー上のメッセージに対する競合状態が発生します。 この構成では、セカンダリ関数アプリの追加のエグレス コストが発生します。
>- 基になるストレージ アカウントとタスク ハブは、プライマリ リージョンで作成され、2 つの関数アプリによって共有されます。
>- 冗長的に展開されているすべての関数アプリが、HTTP 経由でアクティブ化されている場合、同じ関数アクセス キーを共有する必要があります。 関数ランタイムでは、コンシューマー がプログラミングによって関数キーを追加、削除、および更新を有効化できるよう、[管理 API](https://github.com/Azure/azure-functions-host/wiki/Key-management-API) を使用します。

## <a name="scenario-1---load-balanced-compute-with-shared-storage"></a>シナリオ 1: 共有ストレージを使用して負荷分散されたコンピューティング
Azure のコンピューティング インフラストラクチャに障害が発生した場合、関数アプリが使用できなくなる危険性があります。 このようなダウンタイムの危険性を最小限に抑えるため、このシナリオでは、異なるリージョンに展開された 2 つの関数アプリを使用します。 Traffic Manager は、プライマリ関数アプリの問題を検出し、自動的にセカンダリ リージョンにある関数アプリにトラフィックをリダイレクトするように構成されます。 この関数アプリは、タスク ハブと同じ Azure Storage アカウントを共有します。 これにより、関数アプリの状態の損失が防止され、作業が正常に再開できます。 プライマリ リージョンの正常性が復元されると、Azure Traffic Manager はその関数アプリへのルーティング要求を自動的に開始します。


![図は、シナリオ 1 を表します。](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario01.png)

この展開シナリオを使用する利点は、いくつかあります。
- コンピューティング インフラストラクチャで障害が発生した場合、別のリージョンにフェールオーバーするため、状態を損失することなく作業を再開できます。
- Traffic Manager によって、正常な関数アプリへの自動フェールオーバーが自動的に実行されます。
- 障害から復旧すると、Traffic Manager によってプライマリ関数アプリへのトラフィックが自動的に再確立されます。

ただし、このシナリオを使用する場合は、以下の点を検討してください。
- 専用の App Service プランを使用して関数アプリを展開している場合には、フェールオーバー データ センター内のコンピューティング インフラストラクチャをレプリケートするとコストが増加します。
- このシナリオでは、コンピューティング インフラストラクチャの障害には対応できますが、ストレージ アカウントが関数アプリの単一障害点であることに変わりはありません。 ストレージで障害が発生した場合、アプリケーションではダウンタイムが発生します。
- 関数アプリがフェールオーバーしても、リージョンを超えてストレージ アカウントにアクセスするため、待機時間は増加します。
- ストレージが存在するリージョンと異なるリージョンからストレージ サービスにアクセスすると、ネットワーク エグレス トラフィックのため、コストが増加します。
- このシナリオは、Traffic Manager に依存します。 [Traffic Manager のしくみ](../traffic-manager/traffic-manager-how-it-works.md)を考えると、Durable Function を使用するクライアント アプリケーションが 関数アプリのアドレスを Traffic Manager から再取得するまで時間がかかる可能性があります。 


## <a name="scenario-2---load-balanced-compute-with-regional-storage"></a>シナリオ 2: リージョンのストレージを使用して負荷分散されたコンピューティング
上記のシナリオでは、コンピューティング インフラストラクチャの障害の場合のみ対応できます。 ストレージ サービスで障害が発生すると、関数アプリのダウンタイムが発生します。
Durable Functions の運用を続けるため、このシナリオでは、関数アプリが展開されている各リージョンのローカル ストレージ アカウントを使用します。

![図は、シナリオ 2 を表します。](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario02.png)

この方法は、前述のシナリオを改善します。
- 関数アプリで障害が発生した場合、Traffic Manager によって、セカンダリ リージョンにフェールオーバーします。 ただし、関数アプリは専用のストレージを使用しているため、Durable Functions は実行され続けます。
- 関数アプリとストレージ アカウントは同じリージョンにあるため、フェイル オーバー中、フェールオーバーするリージョンでの待機時間は増加しません。
- ストレージ層で障害が発生すると Durable Functions が失敗し、これによりフェールオーバー リージョンへのリダイレクトが開始されます。 この場合も、関数アプリとストレージは異なるリージョンにあるため、Durable Functions の実行は継続されます。
 
このシナリオの重要な注意事項を以下に示します。
- 専用の App Service プランを使用して関数アプリを展開している場合には、フェールオーバー データ センター内のコンピューティング インフラストラクチャをレプリケートするとコストが増加します。
- 現在の状態がフェールオーバーされていない場合は、チェックポイントの関数の実行が失敗します。 作業の再試行/再起動はクライアント アプリケーションが実行する必要があります。

## <a name="scenario-3---load-balanced-compute-with-grs-shared-storage"></a>シナリオ 3: GRS 共有ストレージを使用した負荷分散
このシナリオは最初のシナリオの変形版で、共有ストレージ アカウントを実装します。 主な違いは、geo レプリケーションを有効にしてストレージ アカウントが作成されることです。
機能的には、このシナリオにはシナリオ 1 と同じ利点がありますが、データ復旧という利点が追加されます。
- 読み取りアクセス GRS (RA-GRS) アクセスおよび geo 冗長ストレージ (GRS) は、ストレージ アカウントの可用性を最大化します。
- ストレージ サービスのリージョンで障害が発生した場合、データ センターの運用方法によって、ストレージをセカンダリ リージョンにフェールオーバーするかどうかが決定される可能性があります。 この場合、ストレージ アカウントへのアクセスは、ユーザーが介入する必要なく、透過的にストレージ アカウントのジオレプリケートされたコピーにリダイレクトされます。
- この場合、Durable Functions の状態は、数分ごとに実行されるストレージ アカウントのレプリケーションの最近のレプリケーションまで保存されます。
他のシナリオと同様、このシナリオにも重要な注意事項があります。
- レプリカへのフェールオーバーはデータ センター オペレーターによって実行され、時間がかかる場合があります。 それまでは、関数アプリのダウンタイムが発生します。
- geo レプリケートされたストレージ アカウントを使用するには追加のコストがかかります。
- GRS は、非同期的に実行されます。 レプリケーション処理の遅延のため、最近のトランザクションが失われている危険性があります。

![図は、シナリオ 3 を示します。](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario03.png)


## <a name="next-steps"></a>次の手順

詳細については、「[RA-GRS を使用した高可用性アプリケーションの設計](../storage/common/storage-designing-ha-apps-with-ragrs.md)」を参照してください。
