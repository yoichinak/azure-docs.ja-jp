---
title: Azure AD アプリケーション プロキシ コネクタを理解する | Microsoft Docs
description: Azure AD アプリケーション プロキシ コネクタの基本について説明します。
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 06/28/2018
ms.author: barbkess
ms.reviewer: harshja
ms.custom: it-pro
ms.openlocfilehash: 23bf9d5fb26ee3a0f224f7a8acc2b0539a5c1607
ms.sourcegitcommit: f86e5d5b6cb5157f7bde6f4308a332bfff73ca0f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/31/2018
ms.locfileid: "39364612"
---
# <a name="understand-azure-ad-application-proxy-connectors"></a>Azure AD アプリケーション プロキシ コネクタを理解する

コネクタとは、Azure AD アプリケーション プロキシを実行可能にするもののことです。 コネクタはシンプルで、デプロイと管理が簡単なうえに、非常に強力です。 この記事では、コネクタの詳細と動作、およびデプロイを最適化する方法の推奨事項について説明します。 

## <a name="what-is-an-application-proxy-connector"></a>アプリケーション プロキシ コネクタとは

コネクタは、オンプレミスにある軽量エージェントで、アプリケーション プロキシ サービスへの送信接続を容易にします。 コネクタは、バックエンド アプリケーションへのアクセス権を持つ Windows Server にインストールする必要があります。 コネクタはコネクタ グループに編成でき、各グループが特定のアプリケーションへのトラフィックを処理します。 コネクタは自動的に負荷分散し、ネットワーク構成を最適化するために役立ちます。 

## <a name="requirements-and-deployment"></a>要件とデプロイ

アプリケーション プロキシを正常にデプロイするには、少なくとも 1 つのコネクタが必要ですが、回復性向上のために 2 つ以上のコネクタを使うことをお勧めします。 Windows Server 2012 R2 または 2016 コンピューターにコネクタをインストールします。 コネクタは、アプリケーション プロキシ サービスおよび公開するオンプレミス アプリケーションと通信できる必要があります。 

コネクタ サーバーのネットワーク要件の詳細については、[アプリケーション プロキシの概要とコネクタのインストール](application-proxy-enable.md)に関するページをご覧ください。

## <a name="maintenance"></a>メンテナンス 
コネクタとサービスは、高可用性のすべてのタスクに対処します。 コネクタは動的に追加したり削除できます。 新しい要求は、受信するたびにその時点で使用できるコネクタのいずれかにルーティングされます。 コネクタは、一時的に使用できない場合はトラフィックに応答しません。

コネクタはステートレスであり、コンピューター上に構成データはありません。 保存されているデータは、サービスに接続するための設定とその認証証明書のみです。 サービスに接続すると、すべての必要な構成データをプルして、数分ごとに更新します。

また、コネクタはサーバーをポーリングして、新しいバージョンのコネクタがあるかどうかを調べます。 新しいバージョンが見つかると、コネクタは自身を更新します。

イベント ログとパフォーマンス カウンターを使用して、コネクタを実行しているコンピューターからコネクタを監視することができます。 または、Azure Portal のアプリケーション プロキシ ページからその状態を表示できます。

 ![Azure AD アプリケーション プロキシ コネクタ](./media/application-proxy-connectors/app-proxy-connectors.png)

使用されていないコネクタを手動で削除する必要はありません。 コネクタが動作してサービスに接続すると、アクティブな状態が保たれます。 使用していないコネクタは_非アクティブ_としてタグ付けされ、非アクティブな状態が 10 日間続くと削除されます。 コネクタをアンインストールする場合は、コネクタ サービスと更新サービスの両方をサーバーからアンインストールします。 コンピューターを再起動して、サービスを完全に削除します。

## <a name="automatic-updates"></a>自動更新

Azure AD では、デプロイしたすべてのコネクタの自動更新を提供します。 アプリケーション プロキシ コネクタ アップデーター サービスを実行している限り、コネクタは自動更新されます。 サーバーにコネクタ アップデーター サービスが見つからない場合は、[コネクタを再インストール](application-proxy-enable.md)して更新プログラムを取得する必要があります。 

お使いのコネクタの番まで自動更新を待てない場合は、手動アップグレードを実行できます。 コネクタが配置されたサーバーの[コネクタ ダウンロード ページ](https://download.msappproxy.net/subscription/d3c8b69d-6bf7-42be-a529-3fe9c2e70c90/connector/download)に移動し、**[ダウンロード]** を選択します。 このプロセスによって、ローカル コネクタのアップグレードが開始されます。 

複数のコネクタを持つテナントの場合、環境でのダウンタイムを避けるために、自動更新では各グループで一度に 1 つのコネクタが対象となります。 

コネクタの更新を行う際、次のような場合ダウンタイムが生じることがあります。  
- コネクタが 1 つしかない場合:  このようなダウンタイムを回避して可用性を改善するには、2 つめのコネクタをインストールして[コネクタ グループを作成する](application-proxy-connector-groups.md)ことをお勧めします。  
- 更新の開始時にコネクタがトランザクションの処理中であった場合:  初期トランザクションは失われますが、ブラウザーにより自動で操作が再試行されます。ページを更新しても構いません。 要求が再送信されると、トラフィックはバックアップ コネクタへルーティングされます。

## <a name="creating-connector-groups"></a>コネクタ グループの作成

コネクタ グループは、特定のアプリケーションに対応する特定のコネクタを割り当てることのできる機能です。 多数のコネクタを 1 つにグループ化したうえで、それぞれのアプリケーションをグループに割り当てることができます。 

コネクタ グループによって大規模なデプロイが管理しやすくなります。 また、ローカル アプリケーションにのみサービスを提供する位置ベースのコネクタ グループを作成できるため、さまざまなリージョンでアプリケーションのホストとなっているテナントの待ち時間が改善されます。 

コネクタ グループの詳細については、「[コネクタ グループを使用して別のネットワークや場所にアプリケーションを発行する](application-proxy-connector-groups.md)」をご覧ください。

## <a name="capacity-planning"></a>容量計画 

コネクタでは、コネクタ グループ内で自動的に負荷が分散されますが、予想されるトラフィック ボリュームを確実に処理できるよう十分な容量をコネクタ間で計画することも重要です。 一般的に、ユーザー数が多いほど、大きなマシンが必要になります。 以下の表は、さまざまなマシンが処理できるボリュームの概要を示しています。 使用パターンはさまざまで、負荷の予測には使用できないため、この数値は、ユーザーあたりのトランザクション数ではなく、1 秒あたりのトランザクション数 (TPS) に基づいていることに注意してください。  また、応答のサイズとバックエンド アプリケーションの応答時間によっても、違いが出てきます。応答のサイズが大きく、応答時間が遅くなると、最大 TPS は少なくなります。

|コア|RAM|予想される待機時間 (ミリ秒) - P99|最大 TPS|
| ----- | ----- | ----- | ----- |
|2|8|325|586|
|4|16|320|1150|
|8|32|270|1190|
|16|64|245|1200*|
\* このマシンの接続制限は 800 です。 他のすべてのマシンで、既定の 200 接続制限を使用しました。
 
>[!NOTE]
>4、8、および 16 コアのマシンの間で、最大 TPS に大きな違いはありません。 これらのマシンで主に違うのは、予想される待機時間です。  

## <a name="security-and-networking"></a>セキュリティとネットワーク

コネクタは、アプリケーション プロキシ サービスに要求を送信することを許可するネットワーク上の任意の場所にインストールできます。 ただし、コネクタを実行するコンピューターもアプリにアクセスできる必要があります。 企業ネットワーク内またはクラウドで実行されている仮想マシンにもコネクタをインストールできます。 コネクタは非武装地帯 (DMZ) 内で実行できますが、すべてのトラフィックは送信であり、ネットワークはセキュリティで保護された状態が保たれるため、これは必須ではありません。

コネクタは送信要求を送信するだけです。 送信トラフィックは、アプリケーション プロキシ サービスと公開済みアプリケーションに送信されます。 セッションが確立するとトラフィックは両方向に流れるため、受信ポートを開く必要はありません。 コネクタ間で負荷分散を設定したり、ファイアウォール経由で受信アクセスを構成したりする必要はありません。 

送信トラフィックのファイアウォール規則を構成する方法の詳細については、「[既存のオンプレミス プロキシ サーバーと連携する](application-proxy-configure-connectors-with-proxy-servers.md)」をご覧ください。


## <a name="performance-and-scalability"></a>パフォーマンスと拡張性

アプリケーション プロキシ サービスではスケールについてユーザーが気にする必要はありませんが、コネクタに関してはスケールが重要な要因になります。 ピーク時のトラフィックを処理するには十分なコネクタが必要です。 ただし、コネクタ グループ内のすべてのコネクタが自動的に負荷分散するため、負荷分散を構成する必要はありません。

コネクタはステートレスであるため、ユーザー数やセッション数の影響を受けません。 その代わりに、要求数やペイロード サイズに反応します。 標準的な Web トラフィックの場合、平均的なコンピューターでは 1 秒間に数千件の要求を処理されます。 具体的な容量は、実際のコンピューターの特性によって異なります。 

コネクタのパフォーマンスは、CPU とネットワークの制約を受けます。 SSL による暗号化と暗号化解除には CPU のパフォーマンスが必要であり、Azure でアプリケーションとオンライン サービスへの高速接続を実現するにはネットワークが重要です。

これに対し、コネクタにとってメモリはあまり重要ではありません。 処理の大半はオンライン サービスによって行われ、すべての認証されていないトラフィックが処理されます。 クラウドでできることはすべてクラウドで実行しています。 

負荷分散は、特定のコネクタ グループのコネクタ間で発生します。 ラウンド ロビンのバリエーションによって、グループのどのコネクタが、特定の要求を実行しているかを判断し、 何らかの理由でコネクタまたはマシンが利用できなくなったら、トラフィックはグループ内の他のコネクトに移動し始めます。 この回復性も、複数のコネクタを推奨する理由です。

パフォーマンスに関するその他の要因としては、コネクタと次の項目間のネットワークの品質が挙げられます。 

* **オンライン サービス**: Azure のアプリケーション プロキシ サービスへの接続が遅いまたは待機時間が長いと、コネクタのパフォーマンスに影響します。 最高のパフォーマンスを実現するには、Express Route を使用して組織を Azure に接続します。 それ以外の場合は、ネットワーク チームに、Azure への接続が可能な限り効率的に処理されるように依頼してください。 
* **バックエンド アプリケーション:** コネクタとバックエンド アプリケーション間にプロキシが追加されていて、接続が遅くなったり、接続できなくなったりする場合があります。 このシナリオをトラブルシューティングするには、コネクタ サーバーからブラウザーを開き、アプリケーションにアクセスします。 コネクタを Azure で実行し、アプリケーションはオンプレミスで実行している場合は、ユーザーが期待するほどのエクスペリエンスが得られないことがあります。
* **ドメイン コントローラー:** Kerberos の制約付き委任を使用して SSO を実行する場合、コネクタは、バックエンドに要求を送信する前にドメイン コントローラーに接続します。 コネクタには Kerberos チケットのキャッシュがありますが、ビジー状態では、ドメイン コントローラーの応答性がパフォーマンスに影響することがあります。 こうした問題は、コネクタを Azure で実行していながらオンプレミスのドメイン コントローラーと通信している場合によく見られます。 

ネットワークの最適化の詳細については、「[Azure Active Directory アプリケーション プロキシを使用する場合のネットワーク トポロジに関する注意事項](application-proxy-network-topology.md)」をご覧ください。

## <a name="domain-joining"></a>ドメイン参加

コネクタは、ドメインに参加していないコンピューターで実行できます。 ただし、統合 Windows 認証 (IWA) を使用するアプリケーションへのシングル サインオン (SSO) を行う場合は、ドメイン参加済みのコンピューターが必要です。 この場合、コネクタを実行するコンピューターは、公開済みアプリケーションのユーザーの代わりに [Kerberos](https://web.mit.edu/kerberos) の制約付き委任を実行できるドメインに参加する必要があります。

コネクタは、部分的な信頼関係のあるドメインやフォレスト、または読み取り専用ドメイン コントローラーに参加することもできます。

## <a name="connector-deployments-on-hardened-environments"></a>制限の厳しい環境でのコネクタのデプロイ

通常、コネクタのデプロイはとても簡単で、特別な構成は必要ありません。 ただし、考慮すべき特別な条件がいくつかあります。

* 送信トラフィックを制限している組織では、[必要なポートを開く](application-proxy-enable.md#open-your-ports)必要があります。
* FIPS に準拠しているコンピューターは、コネクタ プロセスが証明書を生成して保存することを許可するよう、構成を変更する必要のある場合があります。
* ネットワーク要求を発行するプロセスに基づいて環境をロック ダウンしている組織では、コネクタ サービスとコネクタ アップデーター サービスの両方が、すべての必要なポートと IP アドレスにアクセスできることを確認する必要があります。
* 場合によっては、送信/転送プロキシにより証明書の双方向認証が中断されて、通信に失敗することがあります。

## <a name="connector-authentication"></a>コネクタの認証

セキュリティで保護されたサービスを提供する場合、コネクタはサービスに対して認証を行い、サービスはコネクタに対して認証を行う必要があります。 この認証を実行するには、コネクタが接続を開始するときにクライアント証明書とサーバー証明書を使用します。 こうすることで、管理者のユーザー名とパスワードがコネクタを実行するコンピューターに保存されることはありません。

使用する証明書は、アプリケーション プロキシ サービス固有のものです。 これらの証明書は新規登録時に作成され、コネクタによって数か月ごとに自動で更新されます。 

コネクタが数か月間サービスに接続していないと、証明書の有効期限が切れることがあります。 このような場合は、コネクタをアンインストールしてから再インストールして、登録をトリガーします。 次の PowerShell コマンドを実行できます。

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

## <a name="under-the-hood"></a>コネクタの性能

コネクタは Windows Server の Web アプリケーション プロキシをベースとしているため、Windows イベント ログや

 ![イベント ビューアーを使用したイベント ログの管理](./media/application-proxy-connectors/event-view-window.png)

Windows パフォーマンス カウンターなど、同じ管理ツールのほとんどが備わっています。 

 ![パフォーマンス モニターを使用したコネクタへのカウンターの追加](./media/application-proxy-connectors/performance-monitor.png)

コネクタには管理者ログとセッション ログがあります。 管理者ログには主要なイベントとそのエラーが含まれます。 セッション ログには、すべてのトランザクションとその処理の詳細が含まれます。 

ログを参照するには、イベント ビューアーに移動し、**[表示]** メニューで、**[分析およびデバッグ ログの表示]** を有効にする必要があります。 次に、ログを有効にしてイベントの収集を開始します。 コネクタはより新しいバージョンに基づいているため、Windows Server 2012 R2 の Web アプリケーション プロキシでは管理者ログとセッション ログは表示されません。

[サービス] ウィンドウでサービスの状態を確認することができます。 コネクタは、コネクタそのものと更新を処理するサービスの、2 つの Windows サービスで構成されています。 この両方を常に実行する必要があります。

 ![AzureAD サービスのローカル](./media/application-proxy-connectors/aad-connector-services.png)

## <a name="next-steps"></a>次の手順


* [コネクタ グループを使用して別のネットワークや場所にアプリケーションを発行する](application-proxy-connector-groups.md)
* [既存のオンプレミス プロキシ サーバーと連携する](application-proxy-configure-connectors-with-proxy-servers.md)
* [アプリケーション プロキシの問題とエラー メッセージのトラブルシューティング](application-proxy-troubleshoot.md)
* [Azure AD アプリケーション プロキシ コネクタをサイレント インストールする方法](application-proxy-register-connector-powershell.md)

