---
title: Azure AD アプリ ギャラリーから OpenID/OAuth アプリケーションを構成する手順 | Microsoft Docs
description: Azure AD アプリ ギャラリーから OpenID/OAuth アプリケーションを構成する手順。
services: active-directory
documentationCenter: na
author: jeevansd
manager: femila
ms.assetid: eedebb76-e78c-428f-9cf0-5891852e79fb
ms.service: active-directory
ms.component: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/25/2018
ms.author: jeedes
ms.openlocfilehash: 69e9d66458409bbc744416a58ceb508349418a76
ms.sourcegitcommit: 0fa8b4622322b3d3003e760f364992f7f7e5d6a9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2018
ms.locfileid: "37019555"
---
# <a name="steps-to-configure-an-openidoauth-application-from-azure-ad-app-gallery"></a>Azure AD アプリ ギャラリーから OpenID/OAuth アプリケーションを構成する手順

## <a name="process-of-open-id-application-addition-from-gallery"></a>ギャラリーから Open ID アプリケーションを追加するプロセス

1. **[Azure Portal](https://portal.azure.com)** の左側のナビゲーション ウィンドウで、**[Azure Active Directory]** アイコンをクリックします。 

    ![Azure Active Directory のボタン](./media/openidoauth-tutorial/tutorial_general_01.png)

2. **[エンタープライズ アプリケーション]** に移動します。 次に、**[すべてのアプリケーション]** に移動します。

    ![[エンタープライズ アプリケーション] ブレード](./media/openidoauth-tutorial/tutorial_general_02.png)

3. 新しいアプリケーションを追加するには、ダイアログの上部にある **[新しいアプリケーション]** をクリックします。

    ![[新しいアプリケーション] ボタン](./media/openidoauth-tutorial/tutorial_general_03.png)

4. 検索ボックスに、**アプリケーション名**を入力し、検索パネルから**目的のアプリケーション**を選択して、アプリケーションにサインアップします。

    ![アプリケーションの追加](./media/openidoauth-tutorial/addfromgallery.png)

    > [!NOTE]
    > Open ID Connect と OAuth アプリでは、[追加] ボタンは既定で無効になっています。 ここでテナント管理者は、**[サインアップ]** ボタンをクリックして、アプリケーションに同意する必要があります。 これにより、アプリケーションが顧客テナントに追加され、明示的に追加する必要がなくなり、構成が実行されます。

    ![[追加] ボタン](./media/openidoauth-tutorial/addbutton.png)

5. サインアップ リンクをクリックすると、ログイン資格情報の Azure AD ページにリダイレクトされます。

6. 認証に成功した後、同意ページから同意する必要があります。その後、アプリケーションのホームページが表示されます。

    > [!NOTE]
    > アプリケーションのインスタンスは 1 つだけ追加することができます。 既に 1 つ追加しており、再び同意を試みた場合は、再度テナントに追加されることはありません。 そのため論理的には、テナント内で使用できるのは 1 つのアプリ インスタンスのみです。

## <a name="authentication-flow-using-openid-connect"></a>OpenID Connect を使用する認証フロー

最も基本的なサインイン フローには次の手順が含まれています。各手順についてはこの後詳しく説明します。

![OpenID Connect を使用する認証フロー](./media/openidoauth-tutorial/authenticationflow.png)

* **マルチテナント アプリケーション** - マルチテナント アプリケーションは、1 つの組織ではなく、多数の組織で使用することを目的としています。 通常、これらは独立系ソフトウェア ベンダー (ISV) によって作成された SaaS (サービスとしてのソフトウェア) アプリケーションです。 マルチテナント アプリケーションは、アプリケーションが使用される各ディレクトリにプロビジョニングする必要があります。アプリケーションを登録するには、ユーザーまたは管理者の同意が必要です。 この同意プロセスは、アプリケーションをディレクトリに登録し、Graph API または別の Web API へのアクセス権を付与するときに開始されます。 別の組織のユーザーまたは管理者がアプリケーションを使用するためにサインアップすると、アプリケーションに必要なアクセス許可を示すダイアログが表示されます。 ユーザーまたは管理者がアプリケーションに同意すると、アプリケーションは定められたデータへのアクセスが許可され、最終的にディレクトリに登録されます。

    > [!NOTE]
    > 複数のディレクトリ内のユーザーがアプリケーションを使用できるようにする場合、ユーザーが属するテナントを特定するメカニズムが必要です。 シングル テナント アプリケーションでは、独自のディレクトリでユーザーを探すだけで済みますが、マルチテナント アプリケーションでは、Azure AD のすべてのディレクトリから特定のユーザーを識別する必要があります。 このタスクを実行するために、Azure AD には、テナント固有のエンドポイントの代わりに、マルチテナント アプリケーションがサインイン要求を送信できる共通の認証エンドポイントが用意されています。 このエンドポイントは Azure AD のすべてのディレクトリで [https://login.microsoftonline.com/common](https://login.microsoftonline.com/common) ですが、テナント固有のエンドポイントは [https://login.microsoftonline.com/contoso.onmicrosoft.com](https://login.microsoftonline.com/contoso.onmicrosoft.com) の場合があります。 サインイン、サインアウト、およびトークンの検証時に複数のテナントに対応するためのロジックが必要となるため、アプリケーションを開発するときは、共通のエンドポイントを考慮することが特に重要です。

Azure AD チームは、既定で、マルチテナント アプリケーションを推進しています。これは、さまざまな組織間でのアクセスや、同意した後の使用が容易であるためです。

## <a name="what-is-consent-framework"></a>同意フレームワークとは。

Azure AD の同意フレームワークを使用すると、マルチテナントの Web クライアント アプリケーションやネイティブ クライアント アプリケーションを簡単に開発できます。 こうしたアプリケーションには、登録されている Azure AD テナントとは異なるテナントのユーザー アカウントを使ってサインインできます。 また、独自の Web API に加えて、Microsoft Graph API (Azure Active Directory、Intune、および Office 365 のサービスへのアクセスに使用する API) をはじめとする Microsoft サービスの API など、各種の Web API にもアクセスが必要になることがあります。 このフレームワークの根底には、ディレクトリのデータにアクセスする可能性があるためにディレクトリへの登録を要求しているアプリケーションに対して同意を与えるユーザーまたは管理者が存在します。 同意が与えられると、クライアント アプリケーションがユーザーに代わって Microsoft Graph API を呼び出し、必要に応じて情報を利用できるようになります。

[Microsoft Graph API](https://graph.microsoft.io/) は、Office 365 のデータ (Exchange の予定表とメッセージ、SharePoint のサイトとリスト、OneDrive のドキュメント、OneNote のノートブック、Planner のタスク、Excel のブックなど)、Azure AD のユーザーとグループなど、Microsoft クラウド サービスのさまざまなデータ オブジェクトにアクセスするための API です。

以下の手順は、アプリケーションの開発者とユーザーにとっての同意エクスペリエンスがどのようなものになるかを示したものです。

1. 何らかのリソース/API にアクセスするために一定のアクセス許可を要求する必要がある Web クライアント アプリケーションがあると仮定しましょう。 Azure Portal は、構成時にアクセス許可要求を宣言するために使用されます。 この設定は他の構成設定と同じく、アプリケーションを Azure AD に登録する作業の一環として行います。

    ![Graph API](./media/openidoauth-tutorial/graphapi.png)

2. 現在、アプリケーションの更新が終わって、アプリケーションが実行中になり、これからユーザーが初めてアプリケーションを使用するところだとします。 アプリケーションではまず、Azure AD の /authorize エンドポイントから認証コードを取得する必要があります。 取得した認証コードは、後でアクセス トークンと更新トークンの取得に使用します。

3. ユーザーの認証がまだであれば、Azure AD の /authorize エンドポイントによりサインイン画面が表示されます。

    ![認証](./media/openidoauth-tutorial/authentication.png)

4. ユーザーのサインインが終わると、そのユーザーに対して同意ページを表示する必要があるかどうかが Azure AD により判定されます。 表示の要否の判定基準は、ユーザー (またはそのユーザーが所属する組織の管理者) がアプリケーションに既に同意を与えているかどうかです。 同意がまだであれば、Azure AD からユーザーに対して同意を求めるメッセージと、アプリケーションが機能するうえで必要なアクセス許可が表示されます。 同意ダイアログに表示されるアクセス許可は、Azure Portal の [委任されたアクセス許可] で選択したものと同じになります。

    ![同意ページ](./media/openidoauth-tutorial/consentpage.png)

アクセス許可には、通常のユーザーが同意できるものと、テナント管理者の同意が必要なものがあります。

## <a name="whats-the-difference-between-admin-consent-and-user-consent"></a>管理者の同意とユーザーの同意の違いについて。

管理者であれば、テナント内のユーザー全員に代わってアプリケーションの委任されたアクセス許可に同意することもできます。 管理者が同意すると、そのテナントのユーザーには同意ダイアログが表示されなくなります。この同意は、管理者ロールが与えられたユーザーが Azure Portal で実行できます。 アプリケーションの [設定] ページで、[必要なアクセス許可]、[アクセス許可の付与] の順にクリックしてください。

![アクセス許可の付与](./media/openidoauth-tutorial/grantpermission.png)

> [!NOTE]
> ADAL.js を使用するシングル ページ アプリケーション (SPA) では現在、[アクセス許可の付与] ボタンを使用して明示的に同意する必要があります。 そうしないと、アクセス トークンが要求されたときにアプリケーションでエラーが発生します。

アプリケーション専用アクセス許可では、常にテナント管理者の同意が必要になります。 アプリケーションがアプリケーション専用アクセス許可を要求する場合に、ユーザーがそのアプリケーションにサインインしようとすると、このユーザーは同意できないことを示すエラー メッセージが表示されます。

アプリケーションで管理者の同意が必要なアクセス許可を使用する場合、ジェスチャ (管理者がアクションを開始できるボタンやリンク) を設定する必要があります。 通常、この操作に対してアプリケーションから送信される要求は OAuth2/OpenID Connect 承認要求ですが、この要求には prompt=admin_consent クエリ文字列パラメーターも含まれています。 管理者が同意し、ユーザーのテナントにサービス プリンシパルが作成されると、以降のサインイン要求では prompt=admin_consent パラメーターは不要になります。 管理者は要求されたアクセス許可を許容可能と判断しているため、その時点からは、テナント内の他のユーザーが同意を求められることはありません。 テナント管理者は、通常ユーザーによるアプリケーションへの同意を無効にすることができます。 通常ユーザーによる同意が無効化された場合、テナントでアプリケーションを使用するには常に管理者の同意が必要になります。 エンド ユーザーによる同意を無効化した状態でアプリケーションをテストするには、[Azure Portal](https://portal.azure.com/) の **[エンタープライズ アプリケーション]** の [[ユーザー設定]](https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/UserSettings/menuId/) セクションにある構成スイッチを使用できます

prompt=admin_consent パラメーターは、管理者の同意を必要としないアクセス許可を要求するアプリケーションでも使用できます。 この方法が使用される例として、アプリケーションで、テナント管理者が一度 "サインアップ" すると、その時点から他のユーザーが同意を求められないエクスペリエンスを必要とする場合があります。

アプリケーションが管理者の同意を必要とし、管理者はサインインしたが、prompt=admin_consent パラメーターが送信されない場合、管理者がアプリケーションへの同意に成功すると、自分のユーザー アカウントについてのみ適用されます。 通常のユーザーは、アプリケーションへのサインインも同意も実行できないままです。 この機能は、他のユーザーのアクセスを許可する前に、テナント管理者がアプリケーションを調査できるようにしたい場合に役立ちます。