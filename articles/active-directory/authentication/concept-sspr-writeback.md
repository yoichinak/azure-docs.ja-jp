---
title: オンプレミスでのパスワード ライトバックと Azure AD SSPR の統合
description: クラウドのパスワードがオンプレミスの AD インフラストラクチャに書き戻されるようにする
services: active-directory
ms.service: active-directory
ms.component: authentication
ms.topic: conceptual
ms.date: 07/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: sahenry
ms.openlocfilehash: 78c0864a8edd8380d30cbf0fa2284e47f3217b01
ms.sourcegitcommit: 1478591671a0d5f73e75aa3fb1143e59f4b04e6a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/19/2018
ms.locfileid: "39163701"
---
# <a name="what-is-password-writeback"></a>パスワード ライトバックとは

クラウド ベースのパスワードのリセット ユーティリティは優れていますが、ほとんどの企業には、ユーザーが存在するオンプレミスのディレクトリがまだあります。 Microsoft では、従来のオンプレミスの Active Directory (AD) とクラウドでのパスワード変更の同期をどのように保っているのでしょうか。 パスワード ライトバックは、[Azure AD Connect](./../connect/active-directory-aadconnect.md) で有効になっている機能で、クラウド内でのパスワード変更を既存のオンプレミスのディレクトリにリアルタイムで書き戻せるようにします。

パスワード ライトバックは、以下を使用する環境でサポートされます。

* [Active Directory フェデレーション サービス (AD FS)](../connect/active-directory-aadconnect-federation-management.md)
* [パスワード ハッシュの同期](../connect/active-directory-aadconnectsync-implement-password-hash-synchronization.md)
* [パススルー認証](/../connect/active-directory-aadconnect-pass-through-authentication.md)

パスワード ライトバックは以下の機能を提供します。

* **オンプレミスの Active Directory パスワード ポリシーの強制**: ユーザーが自分のパスワードをリセットするとき、パスワードがオンプレミスの Active Directory ポリシーに準拠していることを確認してから、そのディレクトリにコミットします。 この確認には、履歴、複雑さ、年齢、パスワード フィルター、ローカル Active Directory で定義された他のパスワード制限のチェックが含まれます。
* **ゼロ遅延フィードバック**: パスワード ライトバックは同期操作です。 ユーザーのパスワードがポリシーに合わなかった場合や、何らかの理由でリセットまたは変更できなかった場合は、すぐにユーザーに通知します。
* **アクセス パネルと Office 365 からのパスワード変更のサポート**: フェデレーション ユーザーかパスワード ハッシュ同期されたユーザーが有効期限切れ、または有効期限切れでないパスワードを変更すると、これらのパスワードはローカル Active Directory 環境に書き戻されます。
* **管理者が Azure portal でパスワードをリセットするときのパスワード ライトバックのサポート**: 管理者が [Azure portal](https://portal.azure.com) でユーザーのパスワードをリセットするときに、そのユーザーがフェデレーションまたはパスワード ハッシュ同期されている場合は、パスワードがオンプレミスで書き戻されます。 現在、この機能は Office 管理ポータルではサポートされていません。
* **受信ファイアウォール規則は不要**: パスワード ライトバックは、基盤の通信チャネルとして Azure Service Bus リレーを使います。 すべての通信はポート 443 経由で送信されます。

> [!Note]
> オンプレミスの Active Directory の保護グループ内に存在するユーザー アカウントをパスワード ライトバックに使用することはできません。 保護グループについて詳しくは、「[Protected Accounts and Groups in Active Directory (Active Directory の保護アカウントとグループ)](https://technet.microsoft.com/library/dn535499.aspx)」をご覧ください。

## <a name="licensing-requirements-for-password-writeback"></a>パスワード ライトバックに必要なライセンス

**オンプレミスの書き戻しによるセルフサービスのパスワードのリセット/変更/ロック解除は、Azure AD の Premium 機能です**。 ライセンスの詳細については、[Azure Active Directory の価格サイト](https://azure.microsoft.com/pricing/details/active-directory/)を参照してください。

パスワード ライトバックを使用するには、次のいずれかのライセンスがご自分のテナントに割り当てられている必要があります。

* Azure AD Premium P1
* Azure AD Premium P2
* Enterprise Mobility + Security E3 または A3
* Enterprise Mobility + Security E5 または A5
* Microsoft 365 E3 または A3
* Microsoft 365 E5 または A5
* Microsoft 365 F1

> [!WARNING]
> スタンドアロンの Office 365 ライセンス プランは、*パスワード ライトバックをサポートしていません*。この機能を動作させるには、上記プランのいずれかが必要になります。
>

## <a name="how-password-writeback-works"></a>パスワード ライトバックのしくみ

フェデレーション ユーザーまたはパスワード ハッシュ同期されたユーザーがクラウドで自分のパスワードをリセットまたは変更しようとした場合は、次のアクションが実行されます。

1. ユーザーのパスワードの種類のチェックが実行されます。 パスワードがオンプレミスで管理されている場合:
   * ライトバック サービスが稼働しているかどうかのチェックが実行されます。 稼働している場合、ユーザーは続行できます。
   * ライトバック サービスがダウンしている場合は、パスワードを今すぐにはリセットできないことがユーザーに通知されます。
2. 次に、ユーザーが適切な認証ゲートを通過すると、**[パスワードのリセット]** ページが表示されます。
3. ユーザーは新しいパスワードを選択して確認します。
4. ユーザーが **[送信]** を選ぶと、プレーンテキスト パスワードがライトバックのセットアップ プロセス時に作成された対称キーを使って暗号化されます。
5. 暗号化されたパスワードは、HTTPS チャネル経由でテナント固有の Service Bus Relay (ライトバックのセットアップ中に設定される) に送信されるペイロードに含められます。 このリレーは、オンプレミスのインストールのみを認識するランダムに生成されたパスワードによって保護されます。
6. メッセージが Service Bus に到達した後、パスワード リセット エンドポイントが自動的にアクティブになり、保留中のリセット要求があるかどうかが確認されます。
7. サービスは、クラウドのアンカー属性を使ってユーザーを探します。 この検索が成功するには:

   * Active Directory コネクタ スペースにユーザー オブジェクトが存在している必要があります。
   * ユーザー オブジェクトが対応するメタバース (MV) オブジェクトにリンクされている必要があります。
   * ユーザー オブジェクトが対応する Azure Active Directory コネクタ オブジェクトにリンクされている必要があります。
   * Active Directory コネクタ オブジェクトから MC へのリンク上に、同期ルール `Microsoft.InfromADUserAccountEnabled.xxx` が存在する必要があります。 <br> <br>
   クラウドからの呼び出しがあると、同期エンジンは **cloudAnchor** 属性を使って Azure Active Directory コネクタ スペース オブジェクトを検索します。 その後、リンクをたどって MV オブジェクトに戻り、さらにリンクをたどって Active Directory オブジェクトに戻ります。 同じユーザーに対して複数の Active Directory オブジェクト (マルチ フォレスト) がある可能性があるため、同期エンジンは `Microsoft.InfromADUserAccountEnabled.xxx` のリンクに基づいて正しいユーザー アカウントを選びます。

   > [!Note]
   > このロジックの結果、パスワード ライトバックが動作するには、Azure AD Connect がプライマリ ドメイン コントローラー (PDC) エミュレーターと通信できる必要があります。 これを手動で有効にする必要がある場合は、PDC エミュレーターに Azure AD Connect を接続できます。 Active Directory 同期コネクタの **[プロパティ]** を右クリックし、**[configure directory partitions]\(ディレクトリ パーティションの構成\)** を選びます。 そこで、**[domain controller connection settings]\(ドメイン コントローラーの接続の設定\)** セクションを探して、**[only use preferred domain controllers]\(優先ドメイン コントローラーのみを使用する\)** チェック ボックスをオンにします。 優先ドメイン コントローラーが PDC エミュレーターではない場合、Azure AD Connect はパスワード ライトバックのために PDC へのアクセスを試行します。

8. ユーザー アカウントが見つかると、適切な Active Directory フォレスト内で直接パスワードのリセットが試行されます。
9. パスワードの設定操作に成功すると、ユーザーにパスワードが変更されたことが通知されます。
   > [!NOTE]
   > ユーザーのパスワード ハッシュがパスワード ハッシュ同期を使って Azure AD に同期される場合、オンプレミスのパスワード ポリシーが、クラウドのパスワード ポリシーと比べて厳密ではない可能性があります。 この場合は、オンプレミスのポリシーが適用されます。 このポリシーにより、パスワード ハッシュ同期やフェデレーションによるシングル サインオンを提供していたとしても、クラウドでオンプレミスのポリシーが確実に適用されます。

10. パスワード設定操作が失敗した場合、ユーザーにもう一度試すように求めるエラーが表示されます。 次の理由により、操作が失敗することがあります。
   * サービスがダウンしていた。
   * 選択したパスワードが組織のポリシーを満たしていなかった。
   * ローカル Active Directory でユーザーが見つからない。

    エラー メッセージはユーザーにガイダンスを提供するので、ユーザーは管理者の介入なしに解決を試みることができます。

## <a name="password-writeback-security"></a>パスワード ライトバックのセキュリティ

パスワード ライトバックは、安全性の高いサービスです。 ユーザーの情報を確実に保護するために、次に説明するように 4 層のセキュリティ モデルが有効になります。

* **テナント固有の Service Bus Relay**
   * サービスを設定すると、Microsoft でもアクセスできない、ランダムに生成された強力なパスワードで保護されたテナント固有の Service Bus Relay が設定されます。
* **ロックダウンされ、暗号強度の高いパスワード暗号化キー**
   * Service Bus Relay が作成されると、強力な非対称キーが作成され、ネットワーク経由でパスワードが渡されるときに暗号化に使用されます。 このキーは、クラウド内の会社のシークレット ストアのみに存在し、厳重にロックダウンされ、ディレクトリ内の他のパスワードと同様に監査されます。
* **業界標準のトランスポート層セキュリティ (TLS)**
   1. クラウド内でパスワードのリセットや変更操作が行われる場合は、プレーンテキスト パスワードが公開キーを使用して暗号化されます。
   2. 暗号化されたパスワードが HTTPS メッセージに配置され、Microsoft の SSL 証明書を使って暗号化されたチャネルを介して Service Bus Relay に送信されます。
   3. Service Bus にメッセージが到着すると、オンプレミスのエージェントが起動され、以前に生成された強力なパスワードを使用して Service Bus に認証します。
   4. オンプレミスのエージェントは、暗号化されたメッセージを取得し、秘密キーを使用して復号化します。
   5. オンプレミスのエージェントは、AD DS SetPassword API を使用して、パスワードの設定を試行します。 この手順に従うと、クラウドで Active Directory のオンプレミスのパスワード ポリシー (複雑さ、年齢、履歴、フィルターなど) を適用できます。
* **メッセージの有効期限ポリシー**
   * オンプレミスのサービスがダウンしているためメッセージが Service Bus に残っている場合はタイムアウトになり、数分後に削除されます。 タイムアウトとメッセージの削除により、セキュリティがさらに強化されます。

### <a name="password-writeback-encryption-details"></a>パスワード ライトバックの暗号化の詳細

ユーザーがパスワードのリセットを送信した後、リセット要求はオンプレミスの環境に届く前に、いくつかの暗号化ステップを通過します。 これらの暗号化ステップにより、サービスの最大限の信頼性とセキュリティが保証されます。 暗号化ステップの説明を次に示します。

* **ステップ 1: 2048 ビット RSA キーによるパスワードの暗号化**: ユーザーが、オンプレミスに書き戻すパスワードを送信すると、送信されたパスワードそのものが 2048 ビット RSA キーを使って暗号化されます。
* **ステップ 2: AES-GCM によるパッケージ レベルの暗号化**: AES-GCM を使って、パッケージ全体 (パスワードと必要なメタデータ) が暗号化されます。 この暗号化により、ServiceBus チャネルに直接アクセスできる人物による内容の表示または改ざんを防止します。
* **ステップ 3: すべての通信が TLS/SSL 経由で行われる**: ServiceBus でのすべての通信は、SSL/TLS チャネルで実行されます。 この暗号化により、権限がないサード パーティに対してコンテンツが保護されます。
* **半年ごとの自動キー ロールオーバー**: 半年ごとに、または Azure AD Connect でパスワード ライトバックが無効化されて再び有効化されるたびに、すべてのキーがロールオーバーされ、最大限のサービスのセキュリティと安全性が確保されます。

### <a name="password-writeback-bandwidth-usage"></a>パスワード ライトバックの帯域幅の使用

パスワード ライトバックは帯域幅の低いサービスで、次の状況でのみ要求をオンプレミスのエージェントに戻します。

* Azure AD Connect を通じて機能が有効または無効にされると、2 つのメッセージが送信されます。
* サービスのハートビートとして 5 分おきに 1 回 1 つのメッセージが、サービスを実行している間中、送信されます。
* 新しいパスワードが送信されるたびに 2 つのメッセージが送信されます。
   * 1 番目のメッセージは操作の実行を要求します。
   * 2 番目のメッセージには操作の結果が含まれ、次の状況で送信されます。
      * ユーザーのセルフサービスのパスワードのリセット時に新しいパスワードが送信された場合
      * ユーザーのパスワード変更操作時に新しいパスワードが送信された場合
      * 管理者によるユーザー パスワードのリセット時に新しいパスワードが送信された場合 (Azure 管理ポータルからのみ)

#### <a name="message-size-and-bandwidth-considerations"></a>メッセージ サイズと帯域幅に関する考慮事項

前に説明した各メッセージのサイズは、通常 1 KB 未満です。 負荷が大きい場合でも、パスワード ライトバック サービス自体で 1 秒間に数キロビットの帯域幅しか消費されないことを意味します。 各メッセージは、パスワードの更新操作で必要になった場合にのみリアルタイムで送信されるため、またメッセージのサイズが非常に小さいため、ライトバック機能の帯域幅は非常に小さく、測定可能な影響を及ぼすには至りません。

## <a name="supported-writeback-operations"></a>サポートされるライトバック操作

パスワードは次の状況で書き戻されます。

* **サポートされるエンドユーザーの操作**
   * エンド ユーザーによる自発的なパスワード変更
   * エンドユーザーによる強制的なパスワード変更 (パスワードの期限切れなど)
   * エンドユーザーにより、[パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行されたセルフサービスによるパスワードのリセット
* **サポートされる管理者の操作**
   * 管理者による自発的なパスワード変更
   * 管理者による強制的なパスワード変更 (パスワードの期限切れなど)
   * 管理者により[パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行された管理者によるセルフサービスによるパスワードのリセット
   * [Azure Portal](https://portal.azure.com) から管理者が開始したエンドユーザーのパスワードのリセット

## <a name="unsupported-writeback-operations"></a>サポートされないライトバック操作

パスワードの書き戻しは、次の状況では*実行されません*。

* **サポートされないエンドユーザーの操作**
   * PowerShell バージョン 1、バージョン 2、または Azure AD Graph API を使った、エンドユーザーによるパスワードのリセット
* **サポートされない管理者の操作**
   * [Office 管理ポータル](https://portal.office.com)から管理者が開始したエンドユーザーのパスワードのリセット
   * PowerShell バージョン 1、バージョン 2、または Azure AD Graph API から管理者が開始したエンド ユーザーのパスワードのリセット

## <a name="next-steps"></a>次の手順

チュートリアル: 「[Enabling password writeback (パスワード ライトバックの有効化)](tutorial-enable-writeback.md)」を使用してパスワード ライトバックを有効にする