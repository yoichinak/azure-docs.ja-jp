---
title: Azure Storage を使用して Azure のメトリック データとログ データをアーカイブする
description: Azure 内で生成されたログ データとメトリック データをストレージ アカウントにアーカイブします。
author: johnkemnetz
services: azure-monitor
ms.service: azure-monitor
ms.topic: tutorial
ms.date: 09/25/2017
ms.author: johnkem
ms.custom: mvc
ms.component: metrics
ms.openlocfilehash: f6b7b9fe73f5e815e08bbf4f6493ee181a0c692b
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37918273"
---
# <a name="archive-azure-monitoring-data"></a>Azure 監視データをアーカイブする

Azure 環境内の複数のレイヤーで生成されるログ データとメトリック データを、Azure ストレージ アカウントにアーカイブすることができます。 このようにすると、Log Analytics または Azure Monitor でのこれらのデータのリテンション期間が過ぎた後も、低コストで検索対象外のストアに過去の監視データの履歴を保持できます。 このチュートリアルでは、データをストレージ アカウントにアーカイブするように Azure 環境を構成する手順について説明します。

> [!div class="checklist"]
> * 監視データを保持するストレージ アカウントを作成する
> * サブスクリプション ログをストレージ アカウントにルーティングする
> * リソース データをストレージ アカウントにルーティングする
> * 仮想マシン (ゲスト OS) のデータをストレージ アカウントにルーティングする
> * ストレージ アカウントの監視データを表示する
> * リソースをクリーンアップする

Azure サブスクリプションをお持ちでない場合は、開始する前に[無料](https://azure.microsoft.com/free/)アカウントを作成してください。

## <a name="sign-in-to-the-azure-portal"></a>Azure ポータルにサインインします。

[Azure Portal](https://portal.azure.com/) にサインインします。

## <a name="create-a-storage-account"></a>ストレージ アカウントの作成

最初に、監視データをアーカイブするストレージ アカウントを設定する必要があります。 それには、[こちらの手順に従います](../storage/common/storage-create-storage-account.md)。

## <a name="route-subscription-logs-to-the-storage-account"></a>サブスクリプション ログをストレージ アカウントにルーティングする

監視データをストレージ アカウントにルーティングするように Azure 環境を設定する作業を始める準備が整いました。 最初に、ストレージ アカウントにルーティングする (Azure アクティビティ ログに含まれる) サブスクリプション レベルのデータを構成します。 [**Azure アクティビティ ログ**](monitoring-overview-activity-logs.md)は、Azure でのサブスクリプション レベルのイベントの履歴を提供します。 Azure Portal でこのログを参照し、"*誰*" が、"*いつ*"、"*どのような*" リソースを作成、更新、削除したかを確認できます。

1. 左側のナビゲーション一覧の **[モニター]** ボタンをクリックし、**[アクティビティ ログ]** をクリックします。

   ![[アクティビティ ログ] セクション](media/monitor-tutorial-archive-monitoring-data/activity-log-home.png)

2. 表示される [アクティビティ ログ] セクションで、**[エクスポート]** ボタンをクリックします。

3. 表示される **[アクティビティ ログのエクスポート]** セクションで、**[ストレージ アカウントにエクスポート]** チェック ボックスをオンにし、**[ストレージ アカウントを選択します]** をクリックします。

   ![アクティビティ ログのエクスポート](media/monitor-tutorial-archive-monitoring-data/activity-log-export.png)

4. 表示されるセクションの **[ストレージ アカウント]** ボックスの一覧を使って、前の「**ストレージ アカウントの作成**」ステップで作成したストレージ アカウントの名前を選び、**[OK]** をクリックします。

   ![ストレージ アカウントの選択](media/monitor-tutorial-archive-monitoring-data/activity-log-storage.png)

5. **[リテンション期間 (日数)]** スライダーを 30 に設定します。 このスライダーは、監視データをストレージ アカウントに保持する日数を設定します。 Azure Monitor は、指定した日数より古いデータを自動的に削除します。 リテンション期間を 0 にすると、データは無期限に保存されます。

6. **[保存]** をクリックして、このセクションを閉じます。

サブスクリプションからの監視データが、ストレージ アカウントに送られるようになります。

## <a name="route-resource-data-to-the-storage-account"></a>リソース データをストレージ アカウントにルーティングする

次に、**リソースの診断設定**をセットアップすることにより、ストレージ アカウントにルーティングされるリソース レベルのデータ (リソース メトリックと診断ログ) を構成します。

1. 左側のナビゲーション一覧の **[モニター]** ボタンをクリックし、**[診断設定]** をクリックします。 サブスクリプションに含まれ Azure Monitor で監視データを生成するすべてのリソースの一覧が表示されます。 この一覧にリソースが表示されない場合は、[ロジック アプリを作成](../logic-apps/quickstart-create-first-logic-app-workflow.md)してリソースを用意してから、診断設定の構成に進むことができます。

2. 一覧でリソースをクリックし、**[診断をオンにする]** をクリックします。

   ![診断の有効化](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-turn-on.png)

   構成済みの設定が既にある場合は、代わりに、既存の設定と、**診断設定を追加する**ためのボタンが表示されます。 このボタンをクリックします。

   リソースの診断設定では、"*どの*" 監視データを特定のリソースからルーティングして、"*どこ*" にその監視データを格納するかを定義します。

3. 表示されるセクションで、設定の **[名前]** を指定し、**[ストレージ アカウントへのアーカイブ]** チェック ボックスをオンにします。

   ![[診断設定] セクション](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-home.png)

4. **[ストレージ アカウントへのアーカイブ]** の下にある **[構成]** ボタンをクリックし、前のセクションで作成したストレージ アカウントを選びます。 Click **OK**.

   ![診断設定のストレージ アカウント](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-storage.png)

5. **[ログ]** と **[メトリック]** の下のすべてのボックスをオンにします。 リソースの種類によっては、どちらかのオプションしかないこともあります。 これらのチェック ボックスは、そのリソースの種類で使用可能なログ データとメトリック データのカテゴリのうち、選んだアーカイブ先 (この例ではストレージ アカウント) に送られるものを制御します。

   ![診断設定のカテゴリ](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-categories.png)

6. **[リテンション期間 (日数)]** スライダーを 30 に設定します。 このスライダーは、監視データをストレージ アカウントに保持する日数を設定します。 Azure Monitor は、指定した日数より古いデータを自動的に削除します。 リテンション期間を 0 にすると、データは無期限に保存されます。

7. **[Save]** をクリックします。

リソースからの監視データが、ストレージ アカウントに送られるようになります。

> [!NOTE]
> 診断設定を使用した多ディメンション メトリックの送信は現在サポートされていません。 ディメンションを含むメトリックは、ディメンション値間で集計され、フラット化された単一ディメンションのメトリックとしてエクスポートされます。
>
> *例*: イベント ハブの "受信メッセージ" メトリックは、キュー単位のレベルで調査およびグラフ化できます。 ただし、診断設定を使用してエクスポートすると、メトリックは、イベント ハブ内のすべてのキューのすべての受信メッセージとして表されます。
>
>

## <a name="route-virtual-machine-guest-os-data-to-the-storage-account"></a>仮想マシン (ゲスト OS) のデータをストレージ アカウントにルーティングする

1. サブスクリプションに仮想マシンがまだない場合は、[仮想マシンを作成](../virtual-machines/windows/quick-create-portal.md)します。

2. ポータルの左側のナビゲーション一覧で、**[Virtual Machines]** をクリックします。

3. 表示される仮想マシンの一覧で、作成した仮想マシンをクリックします。

4. 表示されるセクションの左側のナビゲーションで、**[診断設定]** をクリックします。 このセクションでは、Azure Monitor の、仮想マシンに対してすぐに使用できる監視拡張機能を設定し、Windows または Linux によって生成されたデータをストレージ アカウントにルーティングすることができます。

   ![診断設定への移動](media/monitor-tutorial-archive-monitoring-data/guest-navigation.png)

5. 表示されるセクションで **[ゲスト レベルの監視を有効にする]** をクリックします。

   ![診断設定の有効化](media/monitor-tutorial-archive-monitoring-data/guest-enable.png)

6. 診断設定の保存が正常に行われると、**[概要]** タブに収集されるデータと格納場所の一覧が表示されます。 **[パフォーマンス カウンター]** セクションをクリックし、収集される一連の Windows パフォーマンス カウンターを確認します。

   ![パフォーマンス カウンターの設定](media/monitor-tutorial-archive-monitoring-data/guest-perf-counters.png)

7. **[ログ]** タブをクリックし、アプリケーション ログとシステム ログの **[情報]** レベル ログのチェック ボックスをオンにします。

   ![ログの設定](media/monitor-tutorial-archive-monitoring-data/guest-logs.png)

8. **[エージェント]** タブをクリックし、**[ストレージ アカウント]** の下に表示されるストレージ アカウントの名前をクリックします。

   ![ストレージ アカウントの更新](media/monitor-tutorial-archive-monitoring-data/guest-storage-home.png)

9. 表示されるセクションで、前の「**ストレージ アカウントの作成**」ステップで作成したストレージ アカウントを選びます。

10. **[Save]** をクリックします。

仮想マシンからの監視データが、ストレージ アカウントに送られるようになります。

## <a name="view-the-monitoring-data-in-the-storage-account"></a>ストレージ アカウントの監視データを表示する

> [!WARNING]
> ストレージ アカウント内のログ データの形式は、2018 年 11 月 1 日より JSON Lines に変更されます。 [この記事では、この変更による影響と、新しい形式に対応するツールに更新する方法について説明します。](./monitor-diagnostic-logs-append-blobs.md) 
>
> 

上記の手順に従って構成した場合、データがストレージ アカウントに送られるようになっています。

1. アクティビティ ログなどの一部のデータの種類では、ストレージ アカウントでイベントを生成する何らかのアクティビティが必要です。 アクティビティ ログでアクティビティを生成するには、[こちらの手順](./monitor-quick-audit-notify-action-in-subscription.md)に従ってください。 ストレージ アカウントにイベントが表示されるまで、最大で 5 分間待つ必要があります。

2. ポータルの左側のナビゲーション バーで探して、**[ストレージ アカウント]** セクションに移動します。

3. 前のセクションで作成したストレージ アカウントをクリックします。

4. **[BLOB]** をクリックし、**insights-operational-logs** というラベルのコンテナーをクリックし、最後に **name=default** というラベルのコンテナーをクリックします。 これは、アクティビティ ログが格納されているコンテナーです。 監視データは、最初にリソース ID (アクティビティ ログの場合はサブスクリプション ID のみ) 別、次に日時別に分類されて、コンテナーに格納されます。 これらの BLOB の完全な形式は次のとおりです。

   insights-operational-logs/name=default/resourceId=/SUBSCRIPTIONS/{サブスクリプション ID}/y={4 桁の年数値}/m={2 桁の月数値}/d={2 桁の日数値}/h={2 桁の 24時制の時間数値}/m=00/PT1H.json

5. リソース ID、日付、時刻のコンテナーをクリックして、PT1H.json ファイルに移動します。 PT1H.json ファイルをクリックして、**[ダウンロード]** をクリックします。 各 PT1H.json BLOB には、BLOB の URL で指定された時間内に発生したイベントの JSON BLOB が含まれます (例: h = 12)。 現在の時間内にイベントが発生すると、PT1H.json ファイルにイベントが追加されます。 ログ イベントは 1 時間ごとに個々の BLOB に分類されるため、分の値 (m = 00) は常に 00 です。

   ストレージ アカウントに保存されている JSON イベントを表示できるようになります。 リソース診断ログの BLOB の形式は次のとおりです。

   insights-logs-{ログ カテゴリ名}/resourceId=/{リソース ID}/y={4 桁の年数値}/m={2 桁の月数値}/d={2 桁の日数値}/h={2 桁の 24 時制の時間数値}/m=00/PT1H.json

6. ゲスト OS の監視データは、テーブルに格納されます。 ストレージ アカウントのホームに戻り、**[テーブル]** をクリックします。 メトリック、パフォーマンス カウンター、およびイベント ログのテーブルがあります。

これで、ストレージ アカウントへの監視データのアーカイブを正常に設定できました。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

1. 前の「**サブスクリプション ログをストレージ アカウントにルーティングする**」ステップから **[アクティビティ ログのエクスポート]** セクションに戻り、**[リセット]** をクリックします。

2. **[診断設定]** セクションに移動し、前の「**リソース データをストレージ アカウントにルーティングする**」ステップで診断設定を作成したリソースをクリックします。作成した設定を探して **[設定の編集]** ボタンをクリックし、**[削除]** をクリックします。

3. 前の「**仮想マシン (ゲスト OS) のデータをストレージ アカウントにルーティングする**」ステップで構成した仮想マシンの **[診断設定]** セクションに移動し、**[エージェント]** タブの **[削除]** (**[Azure 診断エージェントの削除]** セクションの下) をクリックします。

4. 前の「**ストレージ アカウントの作成**」ステップで作成したストレージ アカウントに移動し、**[ストレージ アカウントの削除]** をクリックします。 ストレージ アカウントの名前を入力して、**[削除]** をクリックします。

5. 前の手順で仮想マシンまたはロジック アプリを作成した場合は、それらも削除します。

## <a name="next-steps"></a>次の手順

このチュートリアルでは、Azure 環境 (サブスクリプション、リソース、ゲスト OS) の監視データがストレージ アカウントにアーカイブされるように設定する方法を説明しました。


> [!div class="checklist"]
> * 監視データを保持するストレージ アカウントを作成する
> * サブスクリプション ログをストレージ アカウントにルーティングする
> * リソース データをストレージ アカウントにルーティングする
> * 仮想マシン (ゲスト OS) のデータをストレージ アカウントにルーティングする
> * ストレージ アカウントの監視データを表示する
> * リソースをクリーンアップする

データからさらに情報を取り出して洞察を得るには、Log Analytics にもデータを送ってください。

> [!div class="nextstepaction"]
> [Log Analytics の起動と開始](../log-analytics/log-analytics-get-started.md)
