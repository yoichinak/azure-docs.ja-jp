---
title: マルチビットレートのストリームを作成するオンプレミス エンコーダーを使用したライブ ストリーミング - Azure | Microsoft Docs
description: このトピックでは、オンプレミスのエンコーダーからマルチビットレートのライブ ストリームを受信するチャネルの設定方法について説明します。 次にストリームは、1 つ以上のストリーミング エンドポイントを介して、HLS、スムーズ ストリーミング、DASH のいずれかを使用してクライアントの再生アプリケーションに配信できます。
services: media-services
documentationcenter: ''
author: Juliako
manager: cfowler
editor: ''
ms.assetid: d9f0912d-39ec-4c9c-817b-e5d9fcf1f7ea
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 04/12/2017
ms.author: cenkd;juliako
ms.openlocfilehash: d08ac9f2cbdf98493b3132fa9dd3a3e973576451
ms.sourcegitcommit: d7725f1f20c534c102021aa4feaea7fc0d257609
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/29/2018
ms.locfileid: "37098819"
---
# <a name="live-streaming-with-on-premises-encoders-that-create-multi-bitrate-streams"></a>マルチビットレートのストリームを作成するオンプレミス エンコーダーを使用したライブ ストリーミング

> [!NOTE]
> 2018 年 5 月 12日以降は、ライブ チャネルで RTP/MPEG-2 トランスポート ストリーム取り込みプロトコルがサポートされなくなります。 RTP/MPEG-2 から RTMP またはフラグメント化 MP4 (Smooth Streaming) 取り込みプロトコルに移行してください。

## <a name="overview"></a>概要
Azure Media Services では、"*チャネル*" は、ライブ ストリーミング コンテンツを処理するためのパイプラインを表します。 チャネルは、次の 2 つの方法のいずれかでライブ入力ストリームを受信します。

* オンプレミスのライブ エンコーダーは、マルチビットレート RTMP またはスムーズ ストリーミング (フラグメント化 MP4) のストリームを、Media Services によるライブ エンコードの実行が無効なチャネルに送信します。 取り込まれたストリームは、追加の処理なしでチャネルを通過します。 この方式は、 *パススルー*と呼ばれます。 ライブ エンコーダーは、ライブ エンコードが有効になっていないチャネルにシングルビットレート ストリームを送信することもできますが、これはお勧めしません。 Media Services は、要求した顧客にストリームを配信します。

  > [!NOTE]
  > パススルー方式を使用することが、ライブ ストリーミングを行う最も経済的な方法です。


* オンプレミスのライブ エンコーダーは、RTMP かスムーズ ストリーミング (Fragmented MP4) 形式で、シングル ビットレート ストリームを Media Services によるライブ エンコードが有効なチャネルに送信します。 次に、受信したシングルビットレート ストリームのマルチビットレート (アダプティブ) ビデオ ストリームへのライブ エンコードがチャネルで実行されます。 Media Services は、要求した顧客にストリームを配信します。

Media Services 2.10 リリース以降では、チャネルを作成するときに、チャネルで入力ストリームを受信する方法を指定できます。 また、そのチャネルでストリームのライブ エンコードを実行するかどうかも指定できます。 2 つのオプションがあります。

* **パススルー**: マルチビットレート ストリーム (パススルー ストリーム) を出力として返すオンプレミスのライブ エンコーダーを使用する場合は、この値を指定します。 この場合、受信ストリームはエンコードなしで出力に渡されます。 これは、2.10 リリースより前のチャネルの動作です。 この記事では、この種類のチャネルの操作について詳しく説明します。
* **Live Encoding**: Media Services を使用して、シングルビットレートのライブ ストリームをマルチビットレート ストリームにエンコードする場合に、この値を選択します。 ライブ エンコード チャネルを**実行中**の状態のままにすると課金されます。 余分な時間料金を課されないようにするために、ライブ ストリーミング イベントが完了したら、チャネルの実行をすぐに停止することをお勧めします。 Media Services は、要求した顧客にストリームを配信します。

> [!NOTE]
> この記事では、ライブ エンコードの実行が無効なチャネルの属性について説明します。 ライブ エンコードの実行が有効なチャネルの操作については、「 [Azure Media Services を使用して Live Encoding の実行が有効なチャネルを操作する](media-services-manage-live-encoder-enabled-channels.md)」をご覧ください。
>
>推奨されるオンプレミスのエンコーダーの詳細については、「[Recommended on-prem encoders (推奨されるオンプレミス エンコーダー)](media-services-recommended-encoders.md)」をご覧ください。

次の図は、オンプレミスのライブ エンコーダーを使用してマルチビットレートの RTMP やフラグメント化 MP4 (スムーズ ストリーミング) ストリームを出力として返すライブ ストリーミング ワークフローを表しています。

![ライブ ワークフロー][live-overview]

## <a id="scenario"></a>一般的なライブ ストリーミング シナリオ
次の手順では、一般的なライブ ストリーミング アプリケーションの作成に関連するタスクを示します。

1. ビデオ カメラをコンピューターに接続します。 マルチビットレートの RTMP やフラグメント化 MP4 (スムーズ ストリーミング) ストリームを出力として返すオンプレミスのライブ エンコーダーを起動して構成します。 詳しくは、「 [Azure Media Services RTMP サポートおよびライブ エンコーダー](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。

    この手順は、チャネルを作成した後でも実行できます。
2. チャネルを作成し、起動します。

3. チャネルの取り込み URL を取得します。

    取り込み URL は、ライブ エンコーダーがチャネルにストリームを送信する際に使用されます。
4. チャネルのプレビュー URL を取得します。

    この URL を使用して、チャネルがライブ ストリームを正常に受信できることを確認します。
5. プログラムを作成します。

    Azure Portal を使用する場合、プログラムを作成すると資産も作成されます。

    .NET SDK または REST を使用する場合は、資産を作成し、プログラムを作成するときにその資産を使用するように指定する必要があります。
6. プログラムに関連付けられた資産を発行します。   

    >[!NOTE]
    >Azure Media Services アカウントの作成時に、**既定**のストリーミング エンドポイントが自分のアカウントに追加され、**停止**状態になっています。 コンテンツのストリーミング元のストリーミング エンドポイントは、**実行中**状態である必要があります。

7. ストリーミングとアーカイブを開始する準備ができたらプログラムを開始します。

8. 必要に応じて、ライブ エンコーダーは、広告の開始を信号通知できます。 広告が出力ストリームに挿入されます。

9. イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。

10. プログラムを削除し、必要に応じて資産を削除します。     

## <a id="channel"></a>チャネルとその関連コンポーネントの説明
### <a id="channel_input"></a>チャネル入力 (取り込み) の構成
#### <a id="ingest_protocols"></a>取り込みストリーミング プロトコル
Media Services は、ストリーミング プロトコルとして、マルチビットレートのフラグメント化 MP4 とマルチビットレートの RTMP を使用してライブ フィードの取り込みをサポートします。 RTMP のインジェスト ストリーミング プロトコルが選択されている場合、そのチャンネルに 2 つのインジェスト (入力) エンドポイントが作成されます。

* **プライマリ URL**: チャネルのプライマリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。
* **セカンダリ URL** : チャネルのセカンダリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。

特に次のようなシナリオで、インジェスト ストリームの持続性とフォールト トレランスや、エンコーダーのフェールオーバーとフォールト トレランスを向上させるには、セカンダリ URL を使用します。

- 1 つのエンコーダーがプライマリとセカンダリの両方の URL に二重にプッシュする

    このシナリオの主な目的は、ネットワークの変動やジッターの復元性を高めることです。 一部の RTMP エンコーダーでは、ネットワーク切断を正しく処理できません。 ネットワーク切断が発生すると、エンコーダーでエンコードが停止され、再接続されたときにバッファー内のデータが送信されません。 これにより、不連続性とデータ損失が発生します。 ネットワーク切断は、Azure 側のネットワークやメンテナンスが不適切なために発生する場合があります。 プライマリ/セカンダリ URL は、ネットワークの問題を軽減し、制御されたアップグレード プロセスを提供します。 スケジュールされたネットワーク切断が発生するたびに、Media Services はプライマリとセカンダリの切断を管理し、2 つの間の切断を遅延させます。 エンコーダーは、そのときデータを送信し続ける余裕ができ、再度接続します。 切断の順序はランダムにできますが、プライマリ/セカンダリまたはセカンダリ/プライマリ URL 間には常に遅延が発生します。 このシナリオでは、エンコーダーは単一障害点になっています。

- 複数のエンコーダーの各エンコーダーが専用のポイントにプッシュする

    このシナリオは、両方のエンコーダーと取り込みの冗長性を提供します。 このシナリオでは、encoder1 がプライマリ URL にプッシュし、encoder2 がセカンダリ URL にプッシュします。 エンコーダーが失敗した場合、もう一方のエンコーダーからデータを送信し続けることができます。 Media Services はプライマリ URL とセカンダリ URL を同時に切断しないため、データの冗長性は維持されます。 このシナリオでは、エンコーダーは時間を同期し、全く同じデータを提供するものとします。  

- 複数のエンコーダーがプライマリとセカンダリの両方の URL に二重にプッシュする

    このシナリオでは、両方のエンコーダーがプライマリとセカンダリの両方の URL にデータをプッシュします。 これは、データの冗長性だけでなく、最高の信頼性とフォールト トレランスを提供します。 このシナリオは、両方のエンコーダーの障害に対応でき、1 つのエンコーダーが動作しなくなった場合でも切断できます。 このシナリオでは、エンコーダーは時間を同期し、全く同じデータを提供するものとします。  

RTMP ライブ エンコーダーの詳細については、「 [Azure Media Services の RTMP サポートとライブ エンコーダー (ブログの投稿)](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。

#### <a name="ingest-urls-endpoints"></a>取り込み URL (エンドポイント)
チャネルは、ライブ エンコーダーで指定した入力エンドポイント (取り込み URL) を提供するため、エンコーダーはご使用のチャネルにストリームをプッシュできます。   

取り込み URL は、チャネルの作成時に取得できます。 これらの URL を取得するには、チャネルが**実行中**状態である必要はありません。 データをチャネルにプッシュする準備ができたときに、チャネルが**実行中**状態である必要があります。 チャネルがデータの取り込みを開始すると、プレビュー URL 経由でストリームをプレビューできます。

フラグメント化 MP4 (スムーズ ストリーミング) のライブ ストリームを、SSL 接続で取り込むこともできます。 SSL 経由で取り込むには、取り込み URL を HTTPS に更新する必要があります。 現時点では、SSL 経由で RTMP を取り込むことはできません。

#### <a id="keyframe_interval"></a>キーフレームの間隔
オンプレミスのライブ エンコーダーを使用してマルチビットレートのストリームを生成する場合、キーフレームの間隔はその外部エンコーダーで使用される画像グループ (GOP) の期間を指定します。 チャネルがこの受信ストリームを受信したら、スムーズ ストリーミング、Dynamic Adaptive Streaming over HTTP (DASH)、HTTP ライブ ストリーミング (HLS) の任意の形式でライブ ストリームをクライアントの再生アプリケーションに配信できます。 ライブ ストリーミングの実行中、HLS は常に動的にパッケージ化されます。 既定では、Media Services は自動的に HLS セグメントのパッケージ率 (セグメントあたりのフラグメント) を、ライブ エンコーダーから受信したキーフレームの間隔に基づいて計算します。

次の表は、セグメントの期間の計算方法を示しています。

| キーフレームの間隔 | HLS セグメントのパッケージ率 (FragmentsPerSegment) | 例 |
| --- | --- | --- |
| 3 秒以下 |3:1 |KeyFrameInterval (または GOP) が 2 秒間の場合、既定の HLS セグメント パッケージ率は 3 : 1 です。 これによって、6 秒の HLS セグメントが作成されます。 |
| 3～5 秒 |2:1 |KeyFrameInterval (または GOP) が 4 秒間の場合、既定の HLS セグメント パッケージ率は 2 : 1 です。 これによって、8 秒の HLS セグメントが作成されます。 |
| 5 秒を超える |1:1 |KeyFrameInterval (または GOP) が 6 秒間の場合、既定の HLS セグメント パッケージ率は 1 : 1 です。 これによって、6 秒の HLS セグメントが作成されます。 |

セグメントあたりのフラグメント率は、チャネルの出力を構成して ChannelOutputHls の FragmentsPerSegment を設定すると変更できます。

また、キーフレームの間隔の値は、ChanneInput の KeyFrameInterval プロパティを設定すると変更できます。 KeyFrameInterval を明示的に設定すると、HLS セグメントのパッケージ率 FragmentsPerSegment は、前述の規則を使用して計算されます。  

KeyFrameInterval と FragmentsPerSegment の両方を明示的に設定すると、Media Services は設定された値を使用します。

#### <a name="allowed-ip-addresses"></a>許可された IP アドレス
このチャネルにビデオを発行できる IP アドレスを定義できます。 使用できる IP アドレスは、次のいずれかとして指定できます。

* 単一の IP アドレス (例: 10.0.0.1)
* IP アドレスと CIDR のサブネット マスクを使用する IP 範囲 (例: 10.0.0.1/22)
* IP アドレスとピリオド区切りのサブネット マスクを使用する IP 範囲 (例: 10.0.0.1(255.255.252.0))

IP アドレスが指定されておらず、規則の定義もない場合は、どの IP アドレスも許可されません。 すべての IP アドレスを許可するには、規則を作成し、0.0.0.0/0 に設定します。

### <a name="channel-preview"></a>チャネルのプレビュー
#### <a name="preview-urls"></a>プレビュー URL
ストリームをさらに処理して配信する前にプレビューできるプレビュー エンドポイント (プレビュー URL) がチャネルから提供されます。

プレビュー URL は、チャネルの作成時に取得できます。 URL を取得するには、チャネルが**実行中**状態である必要はありません。 チャネルがデータの取り込みを開始した後、ストリームをプレビューできます。

現在、プレビュー ストリームを配信できるのは、指定された入力タイプに関係なく、フラグメント化 MP4 (スムーズ ストリーミング) 形式のみです。 スムーズ ストリーミングのテストには、[スムーズ ストリーミング ヘルス モニター](http://playready.directtaps.net/smoothstreaming/) プレーヤーを使用できます。 また、Azure Portal でホストされているプレーヤーを使用してストリームを表示することもできます。

#### <a name="allowed-ip-addresses"></a>許可された IP アドレス
プレビューのエンドポイントへの接続を許可する IP アドレスを定義できます。 IP アドレスを指定しない場合、すべての IP アドレスが許可されます。 使用できる IP アドレスは、次のいずれかとして指定できます。

* 単一の IP アドレス (例: 10.0.0.1)
* IP アドレスと CIDR のサブネット マスクを使用する IP 範囲 (例: 10.0.0.1/22)
* IP アドレスとピリオド区切りのサブネット マスクを使用する IP 範囲 (例: 10.0.0.1(255.255.252.0))

### <a name="channel-output"></a>チャネルの出力
チャネルの出力の詳細については、「[キーフレームの間隔](#keyframe_interval)」のセクションを参照してください。

### <a name="channel-managed-programs"></a>チャネルで管理されるプログラム
チャネルは、ライブ ストリームのセグメントの発行と保存を管理できるプログラムに関連付けられています。 プログラムはチャネルによって管理されます。 チャネルとプログラムの関係は、従来のメディアと似ています。チャネルが絶えずコンテンツのストリームを配信するのに対し、プログラムは、そのチャネル上で決まった時間に生じるイベントです。

プログラムの **アーカイブ ウィンドウ** の長さを設定することで、録画されたコンテンツの保持時間を指定できます。 この値は、最小 5 分から最大 25 時間までの範囲で設定できます。 クライアントが現在のライブ位置からさかのぼって検索できる最長時間も、Archive Window (アーカイブ ウィンドウ) の長さによって決まります。 プログラムの放送は、指定された期間継続しますが、ArchiveWindowLength を過ぎたコンテンツは絶えず破棄されていきます。 さらに、このプロパティの値によって、クライアント マニフェストが肥大した場合の最大サイズも決まります。

各プログラムは、ストリーミングされたコンテンツを格納する資産に関連付けられます。 資産は Azure ストレージ アカウント内のブロック BLOB コンテナーにマップされ、資産内のファイルは BLOB としてそのコンテナーに格納されます。 プログラムを発行して顧客がストリームを表示できるようにするには、関連付けられた資産の OnDemand ロケーターを作成する必要があります。 このロケーターを作成すると、クライアントに提供できるストリーミング URL を構築できます。

チャネルは、最大 3 つの同時実行プログラムをサポートするため、同じ受信ストリームのアーカイブを複数作成できます。 これにより、1 つのイベントのさまざまな部分を必要に応じて発行したりアーカイブしたりできます。 たとえば、ビジネス要件によって 1 つのプログラムの 6 時間分をアーカイブする一方、最後の 10 分間のみをブロードキャストすると仮定します。 これを実現するには、2 つの同時実行プログラムを作成する必要があります。 1 つのプログラムは 6 時間分のイベントをアーカイブするように設定しますが、プログラムは発行されません。 もう 1 つのプログラムは 10 分間のアーカイブを行うように設定します。このプログラムは発行されます。

新しいイベントには既存のプログラムを再使用できません。 代わりに、イベントごとに新しいプログラムを作成します。 ストリーミングとアーカイブを開始する準備ができたらプログラムを開始します。 イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。

アーカイブ済みコンテンツを削除するには、プログラムを停止して削除し、次に、関連付けられた資産を削除します。 プログラムで使用されている資産は削除できません。 まずプログラムを削除する必要があります。

プログラムを停止して削除した後も、資産を削除するまでは、アーカイブ済みコンテンツをオンデマンドでのビデオとしてストリームできます。 アーカイブ済みコンテンツを保持したいが、ストリーミングには使用したくない場合は、ストリーミング ロケーターを削除します。

## <a id="states"></a>チャネルの状態と課金
現在のチャネルの状態に使用される値は次のとおりです。

* **停止中**: これは、チャネル作成後の初期状態です。 この状態で、チャネルのプロパティを更新できますが、ストリーミングは許可されていません。
* **開始中**: チャネルを開始しています。 この状態の場合、更新やストリーミングはできません。 エラーが発生した場合は、チャネルは**停止中**の状態に戻ります。
* **実行中**: チャネルはライブ ストリームを処理できます。
* **停止中**: チャネルを停止しています。 この状態の場合、更新やストリーミングはできません。
* **削除中**: チャネルを削除しています。 この状態の場合、更新やストリーミングはできません。

次の表は、チャネルの状態と課金モードとの対応を示しています。

| チャネルの状態 | ポータル UI インジケーター | 課金対象 |
| --- | --- | --- | --- |
| **開始中** |**開始中** |いいえ (遷移状態) |
| **実行中** |**準備完了** (実行中プログラムなし)<p><p>or<p>**ストリーミング** (実行中プログラムが最低 1 つ存在) |[はい] |
| **停止中** |**停止中** |いいえ (遷移状態) |
| **Stopped** |**Stopped** |いいえ  |

## <a id="cc_and_ads"></a>クローズド キャプションと広告の挿入
次の表は、サポートされているクローズド キャプションや広告挿入の標準を示しています。

| 標準 | メモ |
| --- | --- |
| CEA-708 と EIA-608 (708/608) |CEA-708 と EIA-608 は、米国とカナダのクローズド キャプションの標準です。<p><p>現時点では、キャプションがサポートされるのはエンコードされた入力ストリームに含まれる場合のみです。 Media Services に送信されるエンコードされたストリームに 608 または 708 キャプションを挿入できるライブ メディア エンコーダーを使用する必要があります。 Media Services はキャプションが挿入されたコンテンツをユーザーに配信します。 |
| .ismt (スムーズ ストリーミング テキスト トラック) 内の TTML |Media Services のダイナミック パッケージ機能では、クライアントが DASH、HLS、スムーズ ストリーミングの任意の形式でコンテンツをストリームできます。 ただし、.ismt (スムーズ ストリーミング テキスト トラック) 内のキャプションのあるフラグメント化 MP4 を取り込む場合は、スムーズ ストリーミング クライアントに対してのみストリーミングを配信できます。 |
| SCTE-35 |SCTE-35 は、広告の挿入のキューに使用されるデジタル信号システムです。 ダウンストリームの受信側は信号を使用して、割り当てられた時間のストリームに広告をスプライスします。 SCTE 35 は、入力ストリームのスパース トラックとして送信する必要があります。<p><p>現時点では、広告信号の伝送がサポートされている入力ストリーム形式はフラグメント化 MP4 (スムーズ ストリーミング) のみです。 サポートされている出力形式も、スムーズ ストリーミングのみです。 |

## <a id="considerations"></a>考慮事項
オンプレミスのライブ エンコーダーを使用してマルチビットレートのストリームをチャネルに送信する際は、次の考慮事項が該当します。

* 取り込みポイントにデータを送信するための十分な空きのインターネット接続があるかどうかを確認します。
* セカンダリの取り込み URL を使用する際は、追加の帯域幅が必要です。
* 受信するマルチビットレート ストリームには、最大 10 のビデオ品質レベル (層) と、最大 5 つのオーディオ トラックを含めることができます。
* ビデオ品質レベルの最高の平均ビットレートは、10 Mbps 以下である必要があります。
* すべてのビデオとオーディオ ストリームの平均ビットレートの合計は、25 Mbps である必要があります。
* チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。 別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。
* チャネルにシングル ビットレートを取り込むことができます。 ただし、チャネルでストリームを処理できないため、クライアント アプリケーションでシングル ビットレート ストリームも受信します  (ただし、このオプションは推奨されません)。

チャネルと関連コンポーネントの作業に関するその他の考慮事項は次のとおりです。

* ライブ エンコーダーを再構成する際は、毎回チャネルで **Reset** メソッドを呼び出します。 チャネルをリセットする前に、プログラムを停止する必要があります。 チャネルをリセットしたら、プログラムを再起動します。

  > [!NOTE]
  > プログラムを再起動したら、新しいアセットに関連付けて、新しいロケーターを作成する必要があります。 
  
* チャネルを停止できるのは、チャネルが**実行中**の状態で、チャネルのすべてのプログラムが停止しているときのみです。
* 既定では、Media Services アカウントに追加できるチャネルは 5 つのみです。 詳細については、「[クォータと制限](media-services-quotas-and-limitations.md)」をご覧ください。
* チャネルが**実行中**状態のときにのみ課金されます。 詳細については、「[チャネルの状態と課金](media-services-live-streaming-with-onprem-encoders.md#states)」をご覧ください。

## <a name="media-services-learning-paths"></a>Media Services のラーニング パス
[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="feedback"></a>フィードバック
[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]

## <a name="related-topics"></a>関連トピック
[Recommended on-prem encoders (推奨のオンプレミス エンコーダー)](media-services-recommended-encoders.md)

[Azure Media Services の Fragmented MP4 ライブ インジェスト仕様](media-services-fmp4-live-ingest-overview.md)

[Azure Media Services の概要と一般的なシナリオ](media-services-overview.md)

[Media Services の概念](media-services-concepts.md)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png
