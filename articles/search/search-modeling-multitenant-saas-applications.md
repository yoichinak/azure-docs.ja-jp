---
title: Azure Search でのマルチテナント機能のモデル化 | Microsoft Docs
description: Azure Search の使用時のマルチテナント SaaS アプリケーションの一般的な設計パターンについて説明します。
manager: jlembicz
author: ashmaka
services: search
ms.service: search
ms.devlang: NA
ms.topic: conceptual
ms.date: 07/30/2018
ms.author: ashmaka
ms.openlocfilehash: 54646a7d4962c5dfe255d28bdb91d272062530dd
ms.sourcegitcommit: f86e5d5b6cb5157f7bde6f4308a332bfff73ca0f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/31/2018
ms.locfileid: "39364276"
---
# <a name="design-patterns-for-multitenant-saas-applications-and-azure-search"></a>マルチテナント SaaS アプリケーションと Azure Search の設計パターン
マルチテナント アプリケーションとは、他のテナントのデータを表示したり共有したりできない多数のテナントに同じサービスと機能を提供するアプリケーションです。 このドキュメントでは、Azure Search を使用して構築されたマルチテナント アプリケーションのテナント分離戦略について説明します。

## <a name="azure-search-concepts"></a>Azure Search の概念
Search-as-a-service (サービスとしての検索) ソリューションである Azure Search を使用すると、開発者はインフラストラクチャを管理したり、情報取得のエキスパートになったりしなくても、豊富な検索機能をアプリケーションに追加できます。 データはこのサービスにアップロードされた後、クラウドに保存されます。 Azure Search API への簡単な要求を使用して、データの変更や検索を行うことができます。 このサービスの概要については、 [こちらの記事](http://aka.ms/whatisazsearch)をご覧ください。 設計パターンについて説明する前に、Azure Search のいくつかの概念を理解しておく必要があります。

### <a name="search-services-indexes-fields-and-documents"></a>検索サービス、インデックス、フィールド、ドキュメント
Azure Search を使用する場合、" *検索サービス*" にサブスクライブします。 データは、Azure Search にアップロードされると、検索サービス内の " *インデックス* " に格納されます。 1 つのサービス内に多数のインデックスを作成できます。 データベースのなじみのある概念に照らし合わせた場合、検索サービスはデータベースに例えることができ、サービス内のインデックスはデータベース内のテーブルに例えることができます。

検索サービス内の各インデックスは、カスタマイズ可能な多数の " *フィールド*" によって定義された独自のスキーマを持ちます。 データは、個々の " *ドキュメント*" の形で Azure Search インデックスに追加されます。 各ドキュメントは特定のインデックスにアップロードする必要があり、そのインデックスのスキーマに適合する必要があります。 Azure Search を使用してデータを検索するときは、特定のインデックスに対してフルテキスト検索クエリが発行されます。  これらの概念をデータベースの概念と照らし合わせた場合、フィールドはテーブル内の列に例えることができ、ドキュメントは行に例えることができます。

### <a name="scalability"></a>スケーラビリティ
Standard [価格レベル](https://azure.microsoft.com/pricing/details/search/) の Azure Search サービスは、ストレージと可用性の 2 つのディメンションで拡張できます。

* *パーティション* " を追加すると、検索サービスのストレージを増やすことができます。
* *レプリカ* " を追加すると、検索サービスが処理できる要求のスループットを向上させることができます。

パーティションとレプリカを自由に追加および削除することで、アプリケーションに必要なデータとトラフィックの量に合わせて検索サービスの容量を調整できます。 検索サービスが読み取り [SLA](https://azure.microsoft.com/support/legal/sla/search/v1_0/)を実現するには、2 つのレプリカが必要です。 サービスが読み取り/書き込み [SLA](https://azure.microsoft.com/support/legal/sla/search/v1_0/)を実現するには、3 つのレプリカが必要です。

### <a name="service-and-index-limits-in-azure-search"></a>Azure Search におけるサービスとインデックスの制限
Azure Search には数種類の[価格レベル](https://azure.microsoft.com/pricing/details/search/)があり、レベルごとに[制限とクォータ](search-limits-quotas-capacity.md)が異なります。 サービス レベルの制限、インデックス レベルの制限、パーティション レベルの制限があります。

|  | Basic | Standard1 | Standard2 | Standard3 | Standard3 HD |
| --- | --- | --- | --- | --- | --- |
| サービスあたりの最大レプリカ数 |3 |12 |12 |12 |12 |
| サービスあたりの最大パーティション数 |1 |12 |12 |12 |3 |
| サービスあたりの最大検索ユニット数 (レプリカ * パーティション) |3 |36 |36 |36 |36 (最大 3 個のパーティション) |
| サービスあたりの最大ストレージ容量 |2 GB |300 GB |1.2 TB |2.4 TB |600 GB |
| パーティションあたりの最大ストレージ容量 |2 GB |25 GB |100 GB |200 GB |200 GB |
| サービスあたりの最大インデックス数 |5 |50 |200 |200 |3000 (最大 1000 個のインデックス/パーティション) |

#### <a name="s3-high-density"></a>S3 高密度
Azure Search の S3 価格レベルには、マルチテナント シナリオ専用に設計された高密度 (HD) モードのオプションがあります。 多くの場合、1 つのサービスで小さなテナントを多数サポートして、簡潔性とコスト効率のメリットを実現する必要があります。

S3 HD では、パーティションを使ってインデックスをスケールアウトするのではなく、1 つのサービスでより多くのインデックスをホストすることで、1 つの Search サービスで小さな多数のインデックスをまとめて管理できます。

具体的には、S3 サービスで使用できるインデックス数は 1 ～ 200 個で、最大 14 億のドキュメントをまとめてホストできます。 一方、S3 HD では、インデックスあたりのドキュメント数は最大でも 100 万ドキュメントにすぎませんが、パーティションあたり 1,000 個 (サービスあたり 3000 個) のインデックスを処理できるため、パーティションあたりの合計ドキュメント数は 2 億 (サービスあたり 6 億) になります。

## <a name="considerations-for-multitenant-applications"></a>マルチテナント アプリケーションに関する考慮事項
マルチテナント アプリケーションでは、さまざまなテナント間である程度のプライバシーを維持しながら、各テナントにリソースを効果的に分配する必要があります。 このようなアプリケーションのアーキテクチャを設計するときには、考慮事項がいくつかあります。

* *テナントの分離:* " アプリケーション開発者は、テナントが他のテナントのデータに対して未承認のアクセスや望ましくないアクセスを実行できないように対策を講じる必要があります。 テナント分離戦略では、データのプライバシーの観点を超えて、共有リソースを効果的に管理し、ノイジー ネイバーから保護する必要があります。
* *クラウド リソースのコスト:* " 他のアプリケーションと同様に、ソフトウェア ソリューションは、マルチテナント アプリケーションのコンポーネントとしてコスト競争力を維持する必要があります。
* *運用の容易さ:* " マルチテナント アーキテクチャを開発するときには、アプリケーションの運用と複雑さへの影響が重要な考慮事項となります。 Azure Search には、[99.9% の SLA](https://azure.microsoft.com/support/legal/sla/search/v1_0/) が適用されます。
* *グローバル展開:* " マルチテナント アプリケーションは、世界中に分散するテナントに効果的にサービスを提供することが必要な場合があります。
* *スケーラビリティ:* " アプリケーション開発者は、アプリケーションの複雑さを低レベルで維持することと、テナント数とテナントのデータやワークロードのサイズに合わせてスケーリングできるアプリケーションを設計することを両立させる方法を検討する必要があります。

Azure Search は、テナントのデータとワークロードの分離に使用できる複数の境界を提供します。

## <a name="modeling-multitenancy-with-azure-search"></a>Azure Search を使用したマルチテナント機能のモデル化
マルチテナント シナリオの場合、アプリケーション開発者は 1 つ以上の検索サービスを利用し、サービス、インデックス、またはその両方でテナントを分けます。 Azure Search には、マルチテナント シナリオをモデル化する際の一般的なパターンがいくつかあります。

1. *テナントごとのインデックス:* " 各テナントは、他のテナントと共有する検索サービス内に独自のインデックスを持ちます。
2. 
  *テナントごとのサービス:* " テナントはそれぞれ専用の Azure Search サービスを使用することで、データとワークロードの最高レベルの分離を実現します。
3. *両パターンの組み合わせ:* " 大規模でアクティブなテナントには専用のサービスを割り当て、小規模なテナントには共有サービス内の個々のインデックスを割り当てます。

## <a name="1-index-per-tenant"></a>1.テナントごとのインデックス
![テナントごとのインデックス モデルの図](./media/search-modeling-multitenant-saas-applications/azure-search-index-per-tenant.png)

テナントごとのインデックス モデルでは、複数のテナントが 1 つの Azure Search サービスを使用し、各テナントがサービス内に独自のインデックスを持ちます。

検索要求とドキュメントの操作はすべて Azure Search のインデックス レベルで発行されるため、テナントはデータの分離を実現します。 アプリケーション層では、さまざまなテナントのトラフィックを適切なインデックスに送信すると同時に、すべてのテナントにわたってサービス レベルでリソースを管理する必要性が認識されています。

テナントごとのインデックス モデルの主な特性は、アプリケーション開発者がアプリケーションのテナント間で検索サービスの容量をオーバーサブスクライブできることです。 テナントにワークロードが不均等に分配されている場合は、非常にアクティブでリソースを集中的に使用する多数のテナントに対応すると同時に、ロングテールのあまりアクティブではないテナントにもサービスを提供するために、検索サービスのインデックスにテナントの最適な組み合わせを割り当てることができます。 このモデルのトレードオフは、各テナントが同時に非常にアクティブである状況には対応できないことです。

テナントごとのインデックス モデルは、最初に Azure Search サービス全体を購入し、その後サービスがテナントでいっぱいになるという、可変コスト モデルの基礎となります。 これにより、未使用の容量を試用版や無料アカウント用に指定することが可能になります。

グローバル展開されているアプリケーションでは、テナントごとのインデックス モデルが最も効率的とは言えない場合があります。 アプリケーションのテナントが世界中に分散している場合、それぞれのテナントでコストが重複する可能性のあるリージョンごとに個別のサービスが必要になることがあります。

Azure Search では、個々のインデックスとインデックスの総数の両方を拡張できます。 適切な価格レベルが選択されていれば、ストレージまたはトラフィックの観点からサービス内の個々のインデックスが肥大化したときに、検索サービス全体にパーティションとレプリカを追加できます。

1 つのサービスのインデックスの総数が増えすぎた場合は、新しいテナントに対応するためにサービスをもう 1 つプロビジョニングする必要があります。 新しいサービスを追加したときに、検索サービス間でインデックスを移動する必要がある場合、Azure Search ではインデックスを移動することはできないため、インデックスのデータをインデックス間で手動でコピーする必要があります。

## <a name="2-service-per-tenant"></a>2.テナントごとのサービス
![テナントごとのサービス モデルの図](./media/search-modeling-multitenant-saas-applications/azure-search-service-per-tenant.png)

テナントごとのサービス アーキテクチャでは、各テナントが独自の検索サービスを使用します。

このモデルでは、アプリケーションはテナントの最高レベルの分離を実現します。 各サービスには、検索要求と個々の API キーを処理するための専用のストレージとスループットが含まれます。

各テナントが大きなフットプリントを持つアプリケーションや、テナント間でワークロードのばらつきがほとんどないアプリケーションの場合、さまざまなテナントのワークロード間でリソースが共有されないため、テナントごとのサービス モデルが効果的な選択肢となります。

また、テナントごとのサービス モデルには、予測可能な固定コスト モデルというメリットもあります。 テナントでいっぱいになるまで検索サービス全体への先行投資は不要ですが、テナントごとのインデックス モデルよりもテナントあたりのコストが高くなります。

テナントごとのサービス モデルは、グローバル展開されているアプリケーションにとって効率的な選択肢です。 テナントが地理的に分散していても、適切なリージョンに各テナントのサービスを簡単に配置できます。

個々のテナントがサービスを拡大しすぎると、このパターンのスケーリングの問題が発生します。 Azure Search では、検索サービスの価格レベルのアップグレードは現在サポートされていないので、すべてのデータを新しいサービスに手動でコピーする必要があります。

## <a name="3-mixing-both-models"></a>手順 3.両方のモデルの組み合わせ
マルチテナント機能をモデル化する際のもう 1 つのパターンは、テナントごとのインデックスとテナントごとのサービスの 2 つの戦略を組み合わせたものです。

2 つのパターンを組み合わせることで、アプリケーションの最大規模のテナントは専用のサービスを占有することができ、ロングテールのあまりアクティブではない小規模なテナントは共有サービス内のインデックスを占有できます。 このモデルでは、最大規模のテナントがサービスの高いパフォーマンスを常に維持できると同時に、小規模なテナントをノイジー ネイバーから保護することもできます。

ただし、この戦略の実装は、専用のサービスを必要とするテナントと共有サービス内のインデックスを必要とするテナントを予測する先見性に依存します。 2 つのマルチテナント機能モデルの両方を管理する必要があるので、アプリケーションの複雑さが増します。

## <a name="achieving-even-finer-granularity"></a>さらに細かい粒度の実現
Azure Search でマルチテナント シナリオをモデル化する前述の設計パターンは、各テナントがアプリケーションのインスタンス全体であるという一貫したスコープを前提としています。 しかし、アプリケーションが多数の小さなスコープに対応できる場合もあります。

テナントごとのサービス モデルとテナントごとのインデックス モデルが十分に小さなスコープではない場合は、さらに細かい粒度を実現するインデックスをモデル化することができます。

1 つのインデックスの動作をクライアント エンドポイントごとに異なるものにするには、考えられるクライアントごとに特定の値を指定したフィールドをインデックスに追加します。 クライアントが Azure Search を呼び出してインデックスを照会したり、変更したりするたびに、クライアント アプリケーションのコードでクエリ時に Azure Search の [フィルター](https://msdn.microsoft.com/library/azure/dn798921.aspx) 機能を使用して、そのフィールドに適切な値を指定します。

この方法を使用すると、個別のユーザー アカウント、個別のアクセス許可レベル、完全に別個のアプリケーションの機能を実現できます。

> [!NOTE]
> 上記の方法を使用して、複数のテナントに対応するように 1 つのインデックスを構成すると、検索結果の関連性に影響を及ぼします。 検索の関連性スコアは、テナント レベルのスコープではなく、インデックス レベルのスコープで計算されるので、すべてのテナントのデータが、関連性スコアの基になる統計 (語句の頻度など) に組み込まれます。
> 
> 

## <a name="next-steps"></a>次の手順
Azure Search は、多くのアプリケーションにとって魅力的な選択肢です。このサービスの信頼性の高い機能の詳細については、[こちら](http://aka.ms/whatisazsearch)をご覧ください。 マルチテナント アプリケーションの各種設計パターンを評価するときは、[さまざまな価格レベル](https://azure.microsoft.com/pricing/details/search/)とそれぞれの[サービスの制限](search-limits-quotas-capacity.md)を検討して、あらゆる規模のアプリケーション ワークロードやアーキテクチャに合わせて Azure Search を最適に調整してください。

Azure Search とマルチテナント シナリオに関するご質問があれば、azuresearch_contact@microsoft.com までお問い合わせください。

