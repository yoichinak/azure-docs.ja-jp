---
title: Azure Cosmos DB を使用した世界規模のマルチマスター | Microsoft Docs
description: ''
services: cosmos-db
author: rimman
manager: kfile
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 05/07/2018
ms.author: rimman
ms.openlocfilehash: 4911a302bf9055948827a72f2e631663b8be741e
ms.sourcegitcommit: a5eb246d79a462519775a9705ebf562f0444e4ec
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/26/2018
ms.locfileid: "39267120"
---
# <a name="multi-master-at-global-scale-with-azure-cosmos-db"></a>Azure Cosmos DB を使用した世界規模のマルチマスター 
 
世界中でデータの一貫したビューを維持しながら、ローカル待機時間に対応するグローバル分散アプリケーションの開発は困難な課題です。 お客様は、データ アクセスの待機時間の短縮、データの高可用性の確保、ディザスター リカバリーの確実な保証を実現し、ビジネス要件を満たす必要があるため、グローバル分散データベースを使用します。 Azure Cosmos DB のマルチマスターは、高レベルの可用性 (99.999%)、1 桁ミリ秒のデータ書き込み待機時間、組み込みの包括的かつ柔軟な競合解決のサポートによるスケーラビリティを提供します。 これらの機能により、グローバル分散アプリケーションの開発が大幅に簡素化されます。 グローバル分散アプリケーションでは、マルチマスター サポートが不可欠です。 

![マルチマスター アーキテクチャ](./media/multi-region-writers/multi-master-architecture.png)

Azure Cosmos DB のマルチマスター サポートにより、世界各地に分散したデータのコンテナー (コレクション、グラフ、テーブルなど) で書き込みを実行できます。 データベース アカウントに関連付けられている任意のリージョンでデータを更新できます。 これらのデータ更新は非同期に伝達できます。 マルチマスターは、データへの高速アクセスと書き込み待機時間を提供するだけでなく、フェールオーバーや負荷分散の問題に対応する実用的なソリューションも提供します。 まとめると、Azure Cosmos DB では、世界のどこでも、99 パーセンタイルでの 10 ミリ秒未満の書き込み待機時間と 99.999% の書き込み/読み取り可用性が得られ、書き込みスループットと読み取りスループットの両方をスケーリングできます。   

> [!IMPORTANT]
> マルチマスター サポートはプライベート プレビュー段階にあります。今すぐ[新規登録](#sign-up-for-multi-master-support)し、プレビュー版をご利用ください。

## <a name="sign-up-for-multi-master-support"></a>マルチマスター サポートの新規登録

Azure サブスクリプションを既にお持ちの場合は、Azure Portal でマルチマスター プレビュー プログラムに新規登録して参加できます。 Azure を利用するのが初めての場合は、[無料試用版](https://azure.microsoft.com/free)に新規登録してください。Azure Cosmos DB に 12 か月間無料でアクセスできます。 次の手順を実行して、マルチマスター プレビュー プログラムへのアクセスを要求します。

1. [Azure Portal](https://portal.azure.com) で、**[リソースの作成]** > **[データベース]** > **[Azure Cosmos DB]** の順にクリックします。  

2. [新しいアカウント] ページに Azure Cosmos DB アカウントの名前を入力し、API、サブスクリプション、リソース グループ、場所を選択します。  

3. 次に、[マルチ マスター プレビュー] フィールドで **[今すぐプレビューにサインアップ]** を選択します。  

   ![マルチマスター プレビューの新規登録](./media/multi-region-writers/sign-up-for-multi-master-preview.png)

4. **[今すぐプレビューにサインアップ]** ウィンドウで、**[OK]** をクリックします。 要求を送信すると、[アカウントの作成] ウィンドウの状態が **[承認待ち]** に変わります。  

要求の送信後、要求が承認されたことを知らせる電子メール通知が届きます。 大量の要求があるため、通知の受信には 1 週間ほどかかることがあります。 要求を行うためにサポート チケットを作成する必要はありません。 要求は受信された順序で確認されます。

## <a name="a-simple-multi-master-example--content-publishing"></a>単純なマルチマスターの例 - コンテンツ発行  

Azure Cosmos DB でマルチマスター サポートを使用する方法を示す実際のシナリオを見てみましょう。 Azure Cosmos DB 上に構築されたコンテンツ発行プラットフォームがあるとします。 発行者とコンシューマーの両方の優れたユーザー エクスペリエンスを実現するために、このプラットフォームが満たす必要のある要件がいくつかあります。 

* 作成者と購読者はどちらも世界中に分散しています。  

* 作成者はローカル (最も近い) リージョンに記事を発行する (書き込む) 必要があります。  

* 作成者には、世界中に分散した記事の閲覧者/購読者がいます。  

* 新しい記事が発行されたときに、購読者に通知する必要があります。  

* 購読者はローカル リージョンから記事を読み取ることができる必要があります。 また、これらの記事にレビューを追加することもできる必要があります。  

* 記事の作成者を含めたすべてのユーザーが、記事に添付されたすべてのレビューをローカル リージョンから表示できる必要があります。  

数百万人のコンシューマーと発行者が存在し、数十億件の記事があると想定すると、アクセスのローカリティを保証すると共に、スケールの問題に速やかに対処する必要があります。 このようなユース ケースは、Azure Cosmos DB のマルチマスターの最適な候補となります。 

## <a name="benefits-of-having-multi-master-support"></a>マルチマスター サポートの利点 

マルチマスター サポートは、グローバル分散アプリケーションに不可欠です。 マルチマスターは、write-anywhere モデル (アクティブ/アクティブ パターン) に同等に関与する[複数のマスター リージョン](distribute-data-globally.md)で構成されます。マルチマスターを使用すると、必要な場所でいつでもデータを利用できます。 個々のリージョンに対して行われた更新は、他のすべてのリージョン (それぞれがマスター リージョンになります) に非同期に伝達されます。 マルチマスター構成でマスター リージョンとして稼働する Azure Cosmos DB リージョンは、すべてのレプリカのデータを集約し、[グローバルな整合性とデータ整合性](consistency-levels.md)を確保するために自動的に動作します。 次の図は、シングルマスターとマルチマスターの読み取り/書き込みレプリケーションを示しています。

![シングルマスターとマルチマスター](./media/multi-region-writers/single-vs-multi-master.png)

マルチマスターを独自に実装すると、開発者の負担が増します。 マルチマスターを独自に実装しようとしている大規模なお客様は、世界規模のマルチマスターの構成とマルチマスター構成のテストに何百時間も費やす可能性があり、多くのお客様が、マルチマスター レプリケーションの監視と管理を担当する専任のエンジニア チームを持っています。 マルチマスター セットアップを独自に作成して管理すると、アプリケーション自体のイノベーションのための時間とリソースが奪われ、コストが大幅に増加します。 Azure Cosmos DB は "すぐに使える" マルチマスター サポートを提供し、開発者のこのオーバーヘッドを解消します。  

まとめると、マルチマスターには次の利点があります。

* **ディザスター リカバリー、書き込み可用性、フェールオーバーの向上** - マルチマスターを使用すると、ミッション クリティカルなデータベースの高可用性をかなり保持できます。 たとえば、システム停止やリージョンの障害によってプライマリ リージョンが使用できなくなった場合に、マルチマスター データベースでは、あるリージョンからフェールオーバー リージョンにデータをレプリケートできます。 このようなフェールオーバー リージョンは、完全に機能するマスター リージョンとしてアプリケーションをサポートします。 マルチマスターでは、残りのリージョンで 99.999% を超える書き込み可用性が保証された地理的に異なるマルチマスターを利用できるため、自然災害、停電、妨害に関して優れた "存続可能性" 保護が実現されます。 

* **エンド ユーザーの書き込み待機時間の短縮** - 提供するデータがエンド ユーザーに近いほど、エクスペリエンスが向上します。 たとえば、ユーザーはヨーロッパにいるが、データベースは米国またはオーストラリアにある場合、それぞれのリージョンで約 140 ミリ秒、300 ミリ秒の待機時間が追加されます。 多くの人気ゲーム、銀行取引要件、または対話型アプリケーション (Web またはモバイル) では、開始時の遅延は許容できません。 待機時間は、高品質のエクスペリエンスに対する顧客の認識において大きな部分を占めており、ユーザーの行動にかなりの影響を及ぼすことが証明されています。 テクノロジが進歩し、臨場感あふれるリアルなエクスペリエンスを必要とする AR、VR、MR が登場したことで、開発者は待機時間要件の厳しいソフトウェア システムを生み出すことが必要になっています。 そのため、利用可能なアプリケーションとデータ (アプリのコンテンツ) をローカルに用意する重要性が高まっています。 Azure Cosmos DB のマルチマスターを使用すると、パフォーマンスが通常のローカルの読み取り/書き込みと同様に高速になり、地理的分散によってグローバルに強化されます。  

* 
  **書き込みのスケーラビリティと書き込みスループットの向上** - マルチマスターでは、正確性が保証され、SLA に裏付けられた複数の整合性モデルが提供され、スループットと使用率が向上します。 

  ![マルチ マスターによる書き込みスループットのスケーリング](./media/multi-region-writers/scale-write-throughput.png)

* **切断された環境 (エッジ デバイスなど) のサポートの向上** - マルチマスターを使用すると、ユーザーは切断された環境で、エッジ デバイスからすべてのデータまたはデータのサブセットを最も近いリージョンにレプリケートできます。 このシナリオは、個人のノート PC (切断されたデバイス) に個々の営業担当者に関連するデータのサブセットが保存される、営業支援システムでよく見られます。 世界のどこにでもあるクラウド内のマスター リージョンは、リモート エッジ デバイスからのコピーのターゲットとして動作することができます。  

* **負荷分散** - マルチマスターでは、負荷の高いリージョンから負荷が均等に分散されたリージョンにユーザー/ワークロードを移動することによって、アプリケーション全体の負荷を再調整することができます。 新しいリージョンを追加し、一部の書き込みをその新しいリージョンに切り替えることで、書き込み容量を簡単に拡張できます。 

* **プロビジョニング済みの容量の活用** - マルチマスターでは、書き込み負荷の高いワークロードと混合ワークロードについて、複数のリージョンでプロビジョニング済みの容量を飽和状態にすることができます。  場合によっては、読み取りと書き込みをさらに均等に再分配できるので、プロビジョニングする必要があるスループットが減り、コスト削減が促進されます。  

* **シンプルで回復性に優れたアプリ アーキテクチャ** - アプリケーションをマルチマスター構成に移行すると、データの復元性が保証されます。  Azure Cosmos DB はあらゆる複雑さを隠すため、アプリケーションの設計とアーキテクチャを大幅に簡素化できます。 

* **リスクのないフェールオーバー テスト** - フェールオーバー テストで書き込みスループットが低下することはありません。 マルチマスターでは、他のすべてのリージョンがフルマスターであるため、フェールオーバーが書き込みスループットに大きな影響を及ぼすことはありません。  

* **総保有コスト (TCO) の削減と DevOps** - スケーラビリティ、パフォーマンス、グローバル配布、目標復旧時間への対応は、高価なアドオンや障害が発生するまで休止しているバックアップ インフラストラクチャの維持により、多くの場合、コストがかかります。 業界トップレベルの SLA に裏付けられた Azure Cosmos DB のマルチマスターを使用すると、開発者は "バックエンド グルー ロジック" を自分で構築して管理する必要がなくなり、ミッション クリティカルなワークロードを安心して実行できます。 

## <a name="use-cases-where-multi-master-support-is-needed"></a>マルチマスター サポートが必要なユース ケース

Azure Cosmos DB には、マルチマスターの多数のユース ケースがあります。 

* **IoT** - Azure Cosmos DB のマルチマスターを使用すると、IoT データ処理の分散実装を簡素化できます。 CRDT (Conflict-free Replicated Data Type) を使用する地理的に分散したエッジ デプロイでは、多くの場合、複数の場所から時系列データを追跡する必要があります。 各デバイスは、最も近いリージョンのいずれかに属することができます。デバイスは移動する可能性があり (自動車など)、現在のリージョンから動的に移動して別のリージョンに書き込むことができます。  

* **e コマース** - e コマース シナリオで優れたユーザー エクスペリエンスを確保するには、高可用性と障害シナリオにおける回復性が必要です。 リージョンで障害が発生した場合、状態を失うことなく、ユーザー セッション、ショッピング カート、アクティブなウィッシュ リストを別のリージョンがシームレスに引き継ぐ必要があります。 その間に、ユーザーが行った更新を適切に処理しなければなりません (たとえば、ショッピング カートに追加された商品や削除された商品を転送する必要があります)。 マルチマスターでは、Azure Cosmos DB が、ユーザーの観点から一貫したビューを維持しながら、アクティブなリージョン間でのスムーズな移行によって、このようなシナリオを適切に処理できます。 

* **不正行為/異常の検出** - 多くの場合、ユーザー アクティビティやアカウント アクティビティを監視するアプリケーションはグローバルに分散しており、複数のイベントを同時に追跡する必要があります。 ユーザーのスコアを作成および維持するときに、さまざまな地理的リージョンからのアクションでスコアを同時に更新して、リスク メトリックをインラインに維持する必要があります。 Azure Cosmos DB では、開発者がアプリケーション レベルで競合シナリオに対応する必要がないことが保証されます。 

* **コラボレーション** - 販売中の商品や使用されるメディアなどの記事の人気度に基づいてランク付けするアプリケーションでは、特に、ロイヤリティを支払う必要がある場合やリアルタイムの広告を決定する場合に、複数の地理的リージョンにわたる人気度の追跡は複雑になる可能性があります。 Azure Cosmos DB を使用して、世界中の多数のリージョンでランキング、並べ替え、レポート作成をリアルタイムで実行することで、開発者は待機時間の面で妥協することなく、わずかな労力で機能を提供できます。 

* **計測** - 使用量 (API 呼び出し回数、1 秒あたりのトランザクション数、使用時間 (分) など) のカウントと調整は、Azure Cosmos DB のマルチマスターを使用することで簡単にグローバルに実装できます。 組み込みの競合解決により、カウントの精度と調整の両方がリアルタイムで保証されます。 

* **パーソナル化** - ロイヤリティ ポイントの授与などのアクションをトリガーする地理的に分散したカウンターを保持する場合も、パーソナル化されたユーザー セッション ビューを実装する場合も、Azure Cosmos DB で提供される高可用性と簡素化された地理的分散カウントにより、アプリケーションは高パフォーマンスを簡単に実現できます。 

## <a name="conflict-resolution-with-multi-master"></a>マルチマスターでの競合の解決 

マルチマスターでは、複数の異なるリージョンの異なるライターによって、同じレコードの 2 つ (以上) のレプリカが同時に更新される可能性があることがよく問題になります。 同時書き込みにより、同じレコードの 2 つの異なるバージョンが作成される可能性があります。競合の解決が組み込まれていない場合、アプリケーション自体が競合の解決を実行して、この不整合を解決する必要があります。  

**例** - ショッピング カート アプリケーションの永続化ストアとして Azure Cosmos DB を使用しており、このアプリケーションが米国東部と米国西部の 2 つのリージョンにデプロイされているとします。  サンフランシスコのユーザーがショッピング カートに商品 (例: 書籍) を追加しました。ほぼ同時に、米国東部の在庫管理プロセスでは、リリース日が遅れているというサプライヤーからの通知に対応して、その同じユーザーのショッピング カートの別の商品 (例: 新しい携帯電話) を無効にしました。 時刻 T1 の時点で、2 つのリージョンのショッピング カート レコードは異なります。 データベースはレプリケーションと競合解決メカニズムを使用してこの不整合を解決し、最終的にショッピング カードの 2 つのバージョンのいずれかが選択されます。 マルチマスター データベースによって適用されることが多い競合解決ヒューリスティック (例: 最後の書き込みが有効) を使用すると、ユーザーまたはアプリケーションは、選択されるバージョンを予測できません。 どちらの場合も、データが失われるか、予期しない動作が発生する可能性があります。 東部リージョンのバージョンが選択された場合、ユーザーが選択した新たな購入商品 (書籍) が失われます。西部リージョンが選択された場合は、以前に選択された商品 (携帯電話) がカートに残されます。 どちらにしても情報は失われます。 最後に、時刻 T1 から T2 までの間にショッピング カートを検査するその他のプロセスでは、非決定論的な動作も発生することになります。 たとえば、フルフィルメント倉庫を選択し、カートの送料を更新するバックグラウンド プロセスでは、カートの最終的な内容と競合する結果が生成されます。 このプロセスが西部リージョンで実行され、代替 1 が実現された場合、カートの商品が間もなく 1 つだけになる可能性があっても (書籍)、2 つの商品の送料が計算されます。 

Azure Cosmos DB は、データベース エンジン内で競合する書き込みを処理するためのロジックを実装しています。 Azure Cosmos DB では、自動 (CRDT (Conflict-free Replicated Data Type))、Last Write Wins (LWW)、自動競合解決のためのカスタム (ストアド プロシージャ) など、複数の競合解決モデルを提供することによって、**包括的かつ柔軟な競合解決をサポート**します。 競合解決モデルでは、正確性と整合性を保証し、geo フェールオーバーやリージョンをまたがる書き込みの競合の下で、整合性、可用性、パフォーマンス、レプリケーションの待機時間、イベントの複雑な組み合わせについて考えなければならないという開発者の負担を解消します。  

  ![マルチマスターの競合の解決](./media/multi-region-writers/multi-master-conflict-resolution-blade.png)

Azure Cosmos DB には、3 種類の競合解決モデルが用意されています。 これらの競合解決モデルのセマンティクスは次のとおりです。 

**自動** - これが既定の競合解決ポリシーです。 このポリシーを選択すると、Azure Cosmos DB は競合する更新をサーバー側で自動的に解決し、厳密な/最終的な整合性の保証を提供します。 内部的には、Azure Cosmos DB は、データベース エンジン内で CRDT (Conflict-free Replicated Data Type) を活用して自動競合解決を実装しています。  

**Last-Write-Wins (LWW)** - このポリシーを選択すると、システム定義の同期タイムスタンプ プロパティまたはレコードの競合するバージョンで定義されたカスタム プロパティに基づいて競合を解決できます。 競合の解決はサーバー側で行われ、最新のタイムスタンプを持つバージョンが有効なバージョンとして選択されます。  

**カスタム** - ストアド プロシージャを登録することによって、アプリケーション定義の競合解決ロジックを登録できます。 データベース トランザクションの支援によって更新の競合が検出されると、ストアド プロシージャがサーバー側で呼び出されます。 このオプションを選択し、ストアド プロシージャの登録に失敗した場合 (または、ストアド プロシージャが実行時に例外をスローした場合)、Conflicts フィードを介して競合するすべてのバージョンにアクセスし、それらを個別に解決できます。  

## <a name="next-steps"></a>次の手順  

この記事では、Azure Cosmos DB でグローバル分散マルチマスターを使用する方法を説明しました。 次に、以下のリソースをご覧ください。 

* [Azure Cosmos DB のグローバル配布のサポートについて確認する](distribute-data-globally.md)  

* [Azure Cosmos DB の自動フェールオーバーについて確認する](regional-failover.md)  

* [Azure Cosmos DB とのグローバルな整合性について確認する](consistency-levels.md)  

* Azure Cosmos DB - [SQL API](tutorial-global-distribution-sql-api.md)、[MongoDB API](tutorial-global-distribution-mongodb.md)、または [Table API](tutorial-global-distribution-table.md) を使用して複数のリージョンで開発する  
