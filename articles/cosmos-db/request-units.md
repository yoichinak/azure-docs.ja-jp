---
title: 要求ユニットとスループットの推定 - Azure Cosmos DB | Microsoft Docs
description: Azure Cosmos DB の要求ユニット要件を確認、指定、推定する方法について説明します。
services: cosmos-db
author: rimman
manager: kfile
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 06/26/2018
ms.author: rimman
ms.openlocfilehash: 160ff4e09f70036fd261c07fa59e13772bc00660
ms.sourcegitcommit: 0c490934b5596204d175be89af6b45aafc7ff730
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2018
ms.locfileid: "37053329"
---
# <a name="request-units-in-azure-cosmos-db"></a>Azure Cosmos DB の要求ユニット

[Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db/) は、Microsoft が提供するグローバルに分散されたマルチモデル データベースです。 Azure Cosmos DB では、仮想マシンのレンタル、ソフトウェアのデプロイ、データベースの監視などを自分で行う必要はありません。 Microsoft のトップ エンジニアによって運用され、継続的な監視が行われる Azure Cosmos DB は、卓越した可用性、パフォーマンス、データ保護を提供します。 [SQL](documentdb-introduction.md) API、[MongoDB](mongodb-introduction.md) API、[Table](table-introduction.md) API のほか、[Gremlin API](graph-introduction.md) を介したグラフなど、お好きな API を利用してデータへアクセスできます。 すべての API が完全にネイティブでサポートされています。 

Azure Cosmos DB の通貨は "*要求ユニット (RU)*" です。 要求ユニットが使用されるので、読み取り/書き込み容量を予約したり、CPU、メモリ、IOPS をプロビジョニングしたりする必要はありません。 Azure Cosmos DB は、単純な読み取りと書き込みから複雑なグラフのクエリまで、さまざまな操作を行うための API を幅広くサポートしています。 すべての要求が同等とは限らないので、要求には、それを処理するために必要な計算量に基づいて、正規化された要求ユニットの量が割り当てられます。 操作に使用される要求ユニットの数は決定論的であり、 Azure Cosmos DB 内の操作によって消費される要求ユニットの数は、応答ヘッダーを介して追跡することができます。 

予測可能性を高めるには、100 RU/秒単位でスループットを予約してください。 Azure Cosmos DB の[要求ユニット計算ツール](https://www.documentdb.com/capacityplanner)を使って、[スループットのニーズを推定する](request-units.md#estimating-throughput-needs)ことができます。

![Throughput calculator][5]

この記事を読むと、次の質問に回答できるようになります。

* Azure Cosmos DB の要求ユニットと要求の使用量とは何ですか。
* Azure Cosmos DB の 1 つのコンテナーまたは一連のコンテナーの要求ユニットの容量はどのように指定しますか。
* アプリケーションの要求ユニットのニーズをどのように推定しますか。
* Azure Cosmos DB の 1 つのコンテナーまたは一連のコンテナーの要求ユニットの容量を超えた場合はどうなりますか。

Azure Cosmos DB は複数モデルのデータベースです。この記事は、Azure Cosmos DB のすべてのデータ モデルと API に適用されることに注意してください。 この記事では、コレクションやグラフの総称としての "*コンテナー*" や、テーブル、ドキュメント、ノード、エンティティの総称としての "*アイテム*" など、一般的な用語を使っています。

## <a name="request-units-and-request-charges"></a>要求ユニットと要求の使用量

Azure Cosmos DB を使用して、アプリケーションのスループット ニーズを満たすリソースを予約することで、高速の予測可能なパフォーマンスが得られます。 アプリケーションの負荷とアクセス パターンは時間と共に変化します。 Azure Cosmos DB には、アプリケーションから利用できる予約済みスループットの量を簡単に増減できる機能が備わっています。

Azure Cosmos DB では、1 秒で処理する要求ユニットで、予約済みスループットを指定します。 要求ユニットはスループットの通貨と考えてください。 アプリケーションで利用できる保証された要求ユニット量を秒単位で予約します。 ドキュメントの作成、クエリの実行、ドキュメントの更新など、Azure Cosmos DB での各操作は、CPU、メモリ、IOPS を消費します。 つまり、それぞれの操作により、要求の使用量が発生し、それが要求ユニットで表されます。 要求ユニット使用量に影響を及ぼす要因とアプリケーションのスループット要件を理解しておくと、できるだけコスト効率の高い方法でアプリケーションを実行できます。 

次のビデオでは、Azure Cosmos DB プログラム マネージャーの Andrew Liu が要求ユニットについてわかりやすく説明しています (ビデオの要求ユニットの例には小さな誤りがあります。 1 KB のデータが 100,000 レコードあると、ストレージの合計は 100 GB ではなく 100 MB です)。 <br /><br />

> [!VIDEO https://www.youtube.com/embed/stk5WSp5uX0]
> 
> 

## <a name="throughput-isolation-in-globally-distributed-databases"></a>グローバルな分散型データベースのスループット分離

データベースを複数のリージョンにレプリケートした場合、Azure Cosmos DB はスループット分離を提供することで、あるリージョンの要求ユニットの使用が、別のリージョンの要求ユニットの使用状況に影響を及ぼさないようにします。 たとえば、あるリージョンにデータを書き込み、別のリージョンからデータを読み取る場合、リージョン A の書き込み操作に使用される要求ユニットが、リージョン B の読み取り操作に使用される要求ユニットから奪われることはありません。データベースのデプロイ先となった各リージョンの境界を越えて要求ユニットが分割されることはありません。 データベースがレプリケートされた各リージョンには、すべての要求ユニットがプロビジョニングされます。 グローバル レプリケーションの詳細については、「[Azure Cosmos DB を使用してデータをグローバルに分散させる方法](distribute-data-globally.md)」をご覧ください。

## <a name="request-unit-considerations"></a>要求ユニットの考慮事項
プロビジョニングする要求ユニット数を推定するときは、以下の変動要素を考慮することが重要です。

* **アイテムのサイズ**。 サイズが増大すると、データの読み取りまたは書き込みに使用される要求ユニット数も増加します。
* **アイテム プロパティの数**。 すべてのプロパティに既定でインデックスが作成されると想定すると、プロパティ数の増加に伴って、ドキュメント、ノード、エンティティの書き込みに使用される単位が増加します。
* **データ整合性**。 Strong または Bounded Staleness のデータの整合性モデルを使用すると、アイテムの読み取りに使用される要求ユニットが増加します。
* **インデックス付きプロパティ**。 各コンテナーのインデックス ポリシーによって、既定でインデックスが作成されるプロパティが決まります。 インデックス付きプロパティの数を制限するか、非同期インデックス作成を有効にして、書き込み操作に使用する要求ユニットを削減できます。
* **ドキュメントのインデックス作成**。 既定では、アイテムごとにインデックスが自動的に作成されます。 一部のアイテムにインデックスを作成しないようにすると、使用される要求ユニットが少なくなります。
* **クエリのパターン**。 クエリの複雑さは、操作で消費される要求ユニット数に影響します。 クエリ結果の件数、述語の数、述語の特性、ユーザー定義関数の数、ソース データのサイズ、プロジェクションのすべてが、クエリ操作のコストに影響します。
* **スクリプトの使用**。 クエリと同様に、ストアド プロシージャとトリガーは、実行する操作の複雑さに基づいて要求ユニットを使用します。 アプリケーションを開発するときは、要求使用量ヘッダーを調べて、各操作で使用される要求ユニットの量を詳しく把握するようにしてください。

## <a name="estimating-throughput-needs"></a>スループットのニーズの推定
要求単位は、要求の処理コストを標準化した測定単位です。 1 つの要求ユニットは、10 個の一意のプロパティ値 (システム プロパティを除く) で構成される 1 KB のアイテムの読み取り (self リンクまたは ID による) に必要な処理能力を表します。 同じアイテムを作成 (挿入)、置換、または削除する要求では、必要になるサービスの処理が多くなるため、必要な要求ユニットも多くなります。 

> [!NOTE]
> 1 KB のアイテムに対する 1 つの要求ユニットのベースラインは、アイテムのセルフ リンクまたは ID による単純な GET に対応します。
> 
> 

たとえば、次の表は、3 種類のサイズのアイテム (1 KB、4 KB、64 KB) を 2 種類のパフォーマンス レベル (500 読み取り/秒 + 100 書き込み/秒と、500 読み取り/秒 + 500 書き込み/秒) でプロビジョニングした場合の要求ユニット数を示しています。 この例では、データの一貫性が "**セッション**" に設定され、インデックス作成ポリシーは "**なし**" に設定されています。

| アイテムのサイズ | 読み取り/秒 | 書き込み数/秒 | 要求ユニット
| --- | --- | --- | --- |
| 1 KB | 500 | 100 | (500 * 1) + (100 * 5) = 1,000 RU/秒
| 1 KB | 500 | 500 | (500 * 1) + (500 * 5) = 3,000 RU/秒
| 4 KB | 500 | 100 | (500 * 1.3) + (100 * 7) = 1,350 RU/秒
| 4 KB | 500 | 500 | (500 * 1.3) + (500 * 7) = 4,150 RU/秒
| 64 KB | 500 | 100 | (500 * 10) + (100 * 48) = 9,800 RU/秒
| 64 KB | 500 | 500 | (500 * 10) + (500 * 48) = 29,000 RU/秒


### <a name="use-the-request-unit-calculator"></a>要求ユニット計算ツールの使用
スループットを緻密に推定できるよう、Web ベースの[要求ユニット計算ツール](https://www.documentdb.com/capacityplanner)をご利用ください。 たとえば以下に示す標準的な操作で必要になる要求ユニットを見積もることができます。

* アイテムの作成 (書き込み)
* アイテムの読み取り
* アイテムの削除
* アイテムの更新

このツールには、指定したサンプル アイテムに基づいたデータ ストレージ ニーズの見積もりのサポートも含まれています。

ツールの使用手順は次のとおりです。

1. 代表的なアイテム (サンプルの JSON ドキュメントなど) を少なくとも 1 つアップロードします。
   
    ![要求ユニット計算ツールへのアイテムのアップロード][2]
2. データ ストレージの要件を見積もるには、格納する項目 (ドキュメント、行、頂点など) の総数を入力します。
3. 作成、読み取り、更新、削除に関して必要な操作数 (毎秒あたり) を入力します。 アイテムの更新操作の要求ユニットの料金を見積もるには、手順 1. のサンプル アイテムのうち、代表的なフィールドの更新が含まれているアイテムのコピーをアップロードします。 たとえば、アイテムの更新では、通常、*lastLogin* と *userVisits* という 2 つのプロパティだけを変更する場合は、サンプル項目をコピーし、その 2 つのプロパティの値を更新して、コピーした項目をアップロードします。
   
    ![Enter throughput requirements in the request unit calculator][3]
4. **[計算]** を選択して結果を確認します。
   
    ![Request unit calculator results][4]

> [!NOTE]
> アイテムの種類によって、サイズとインデックス付きプロパティの数が大きく異なる場合は、それぞれの "*種類*" における代表的なアイテムのサンプルをツールにアップロードしたうえで、結果を計算してください。
> 
> 

### <a name="use-the-azure-cosmos-db-request-charge-response-header"></a>Azure Cosmos DB の "要求の使用量" 応答ヘッダーの使用
Azure Cosmos DB サービスからの各応答には、特定の要求で使用される要求ユニットを含むカスタム ヘッダー (`x-ms-request-charge`) が付きます。 このヘッダーには、Azure Cosmos DB SDK を介してアクセスすることもできます。 .NET SDK では、**RequestCharge** は **ResourceResponse** オブジェクトのプロパティです。 Azure Portal の Azure Cosmos DB データ エクスプローラーは、実行されたクエリに関する要求の使用量情報を示します。 異なるマルチモデル API を使用してスループットを取得および設定する方法については、「[Azure Cosmos DB コンテナーおよびデータベースのスループットを設定および取得する](set-throughput.md)」をご覧ください。

アプリケーションに必要な予約済みスループットの量を推定するには、アプリケーションが使用する代表的なアイテムに基づいて、典型的な操作の実行に関連する要求ユニット使用量を記録します。 そのうえで、予想される毎秒操作数を推定してください。 さらに、通常のクエリと Azure Cosmos DB スクリプトの使用も忘れずに測定し、考慮に入れます。

> [!NOTE]
> アイテムの種類によって、サイズとインデックス付きプロパティの数が大きく異なる場合は、典型的なアイテムの "*種類*" ごとに、適用可能な操作の要求ユニット使用量を記録してください。
> 
> 

たとえば以下の手順が考えられます。

1. 典型的なアイテム作成 (挿入) の要求ユニット使用量を記録します。 
2. 典型的なアイテム読み取りの要求ユニット使用量を記録します。
3. 典型的なアイテム更新の要求ユニット使用量を記録します。
4. 典型的な共通アイテムのクエリの要求ユニット使用量を記録します。
5. アプリケーションが使用するカスタム スクリプト (ストアド プロシージャ、トリガー、ユーザー定義関数) の要求ユニット使用量を記録します。
6. 予想される 1 秒あたりの操作実行数の推定値に基づいて、必要な要求ユニットを計算します。

## <a name="a-request-unit-estimate-example"></a>要求ユニット推定の例
次のドキュメントを考えてみます。サイズは約 1 KB です。

```json
{
 "id": "08259",
  "description": "Cereals ready-to-eat, KELLOGG, KELLOGG'S CRISPIX",
  "tags": [
    {
      "name": "cereals ready-to-eat"
    },
    {
      "name": "kellogg"
    },
    {
      "name": "kellogg's crispix"
    }
  ],
  "version": 1,
  "commonName": "Includes USDA Commodity B855",
  "manufacturerName": "Kellogg, Co.",
  "isFromSurvey": false,
  "foodGroup": "Breakfast Cereals",
  "nutrients": [
    {
      "id": "262",
      "description": "Caffeine",
      "nutritionValue": 0,
      "units": "mg"
    },
    {
      "id": "307",
      "description": "Sodium, Na",
      "nutritionValue": 611,
      "units": "mg"
    },
    {
      "id": "309",
      "description": "Zinc, Zn",
      "nutritionValue": 5.2,
      "units": "mg"
    }
  ],
  "servings": [
    {
      "amount": 1,
      "description": "cup (1 NLEA serving)",
      "weightInGrams": 29
    }
  ]
}
```

> [!NOTE]
> ドキュメントは Azure Cosmos DB で縮小されるため、システムで計算される上記ドキュメントのサイズは 1 KB をわずかに下回ります。
> 
> 

次の表は、このアイテムに対する典型的な操作に要する、大まかな要求ユニット使用量を示しています  (大まかな要求ユニット使用量は、アカウント一貫性レベルが "**セッション**" に設定され、すべてのアイテムに自動でインデックス作成が行われることを想定しています)。

| 操作 | 要求ユニット使用量 |
| --- | --- |
| アイテムを作成する |～15 RU |
| アイテムの読み取り |～1 RU |
| ID でのアイテムのクエリ |～2.5 RU |

次の表では、アプリケーションで通常使用されるクエリについて、大まかな要求ユニット使用量を示しています。

| クエリ | 要求ユニット使用量 | 返されるアイテム数 |
| --- | --- | --- |
| ID で食品を選択 |～2.5 RU |1 |
| 製造者で食品を選択 |～7 RU |7 |
| 食品グループで選択し、重量順に配列 |～70 RU |100 |
| 食品グループの上位 10 食品を選択 |～10 RU |10 |

> [!NOTE]
> 要求ユニット使用量は返されるアイテムの数により異なります。
> 
> 

この情報があれば、予測される 1 秒あたりの操作数とクエリ数に基づいて、このアプリケーションに必要な要求ユニット要件を推定できます。

| 操作/クエリ | 1 秒あたりの推定数 | 必要な要求ユニット |
| --- | --- | --- |
| アイテムを作成する |10 |150 |
| アイテムの読み取り |100 |100 |
| 製造者で食品を選択 |25 |175 |
| 食品グループで選択 |10 |700 |
| 上位 10 を選択 |15 |合計 150 |

この例では、平均スループット要件を 1,275 RU/秒と想定しています。 100 の位で丸めると、このアプリケーションのコンテナー (または一連のコンテナー) に 1,300 RU/秒をプロビジョニングすることになります。

## <a id="RequestRateTooLarge"></a> Azure Cosmos DB での予約されたスループット上限の超過
要求ユニットの消費は、1 秒あたりのレートとして評価されます。 プロビジョニング済み要求ユニット レートを超過したアプリケーションの場合、レートがプロビジョニング済みスループット レベルを下回るまで、要求のレートが制限されます。 要求のレートが制限される場合、サーバーはいち早く `RequestRateTooLargeException` (HTTP 状態コード 429) で要求を終了させ、`x-ms-retry-after-ms` ヘッダーを返します。 このヘッダーは、ユーザーが要求の試行を再開できるまでに待機しなければならない時間をミリ秒で示します。

    HTTP Status 429
    Status Line: RequestRateTooLarge
    x-ms-retry-after-ms :100

.NET クライアント SDK と LINQ クエリ使用していると、ほとんどの場合は、この例外に対処する必要がありません。 最新バージョンの .NET クライアント SDK は暗黙的にこの応答を取得し、サーバーが規定した retry-after ヘッダーを考慮して、自動的に要求を再試行します。 アカウントに複数のクライアントが同時アクセスしている状況でなければ、次回の再試行は成功します。

複数のクライアントが上述の要求レートで累積的に操作を実行している場合は、既定の再試行動作では十分な結果が得られず、クライアントは状態コード 429 で `DocumentClientException` をアプリケーションにスローします。 こうした場合は、再試行動作とアプリケーションのエラー処理ルーチンのロジックを制御するか、対象の 1 つのコンテナー (または一連のコンテナー) に対してプロビジョニングされたスループットを増やすことを検討します。

## <a name="next-steps"></a>次の手順
 
- Azure portal および SDK を使用して [Azure Cosmos DB のスループットを設定および取得する](set-throughput.md)方法について確認します。
- [Azure Cosmos DB のパフォーマンスとスケールのテスト](performance-testing.md)について確認します。
- Azure Cosmos DB データベースの予約済みスループットの詳細については、「[Azure Cosmos DB の価格](https://azure.microsoft.com/pricing/details/cosmos-db/)」および [Azure Cosmos DB でのデータのパーティション分割](partition-data.md)に関するページを参照してください。
- Azure Cosmos DB の詳細については、[Azure Cosmos DB のドキュメント](https://azure.microsoft.com/documentation/services/cosmos-db/)を参照してください。 

[2]: ./media/request-units/RUEstimatorUpload.png
[3]: ./media/request-units/RUEstimatorDocuments.png
[4]: ./media/request-units/RUEstimatorResults.png
[5]: ./media/request-units/RUCalculator2.png

