---
title: Azure での仮想マシン スケール セットのメンテナンス通知の処理 | Microsoft Docs
description: Azure で実行されている仮想マシン スケール セットのメンテナンス通知を表示し、セルフサービス メンテナンスを開始します。
services: virtual-machine-scale-sets
documentationcenter: ''
author: shants123
editor: ''
tags: azure-service-management,azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/09/2018
ms.author: shants
ms.openlocfilehash: 4ce984686c2bb320d5d32771d31b81cdec1153af
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/11/2018
ms.locfileid: "38506259"
---
# <a name="handling-planned-maintenance-notifications-for-virtual-machine-scale-sets"></a>仮想マシン スケール セットに対する計画済みメンテナンスの通知の処理

Azure は、定期的に更新を行い、仮想マシンのホスト インフラストラクチャの信頼性、パフォーマンス、セキュリティの向上に努めています。 更新とは、ホスティング環境の修正、ハードウェアのアップグレードや使用停止などの変更のことです。 これらの更新のほとんどは、ホストされている仮想マシンに影響を及ぼすことなく実行されます。 ただし、更新による影響が生じる場合もあります。

- Azure では、再起動を伴わないメンテナンスの場合、インプレース移行を使用して、ホストの更新中に VM を一時的に停止させます。 これらの再起動を伴わないメンテナンス操作は障害ドメインごとに適用され、警告の正常性シグナルを受信した場合、進行が停止します。

- 再起動を伴うメンテナンスの場合は、メンテナンスの予定日時が知らされます。 このような場合は、都合に応じて自分自身でメンテナンスを開始できる時間枠が与えられます。


再起動が必要な計画済みメンテナンスは、段階的にスケジュールされます。 各段階のスコープ (リージョン) はそれぞれ異なります。

- 段階はお客様への通知で始まります。 既定では、サブスクリプションの所有者と共同所有者に通知が送信されます。 Azure [アクティビティ ログ アラート](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md)を使用して、通知の受信者、および電子メール、SMS、webhook などのメッセージング オプションを通知に追加できます。  
- 通知の時点で、"*セルフサービス期間*" が使用できるようになります。 この期間中は、この段階に含まれている仮想マシンを確認し、自身のスケジュールのニーズに従って、プロアクティブにメンテナンスを開始できます。
- セルフサービス期間が過ぎると、"*予定メンテナンス期間*" が始まります。 この期間のある時点で、Azure は、仮想マシンに対して必要なメンテナンスをスケジュールし、適用します。 

2 つの期間を用意した目的は、Azure によってメンテナンスが自動的に開始される時期を把握した上で、メンテナンスを開始して仮想マシンを再起動するのに必要な時間を十分に確保できるようにすることにあります。


Azure ポータル、PowerShell、REST API、CLI を使用して、仮想マシン スケール セット VM のメンテナンス期間のクエリを実行し、セルフサービス メンテナンスを開始することができます。

  
## <a name="should-you-start-maintenance-during-the-self-service-window"></a>セルフ サービス期間中にメンテナンスを開始する必要があるかどうか  

次のガイドラインは、この機能を使用して、ご自身のタイミングでメンテナンスを開始する必要があるかどうかを判断するうえで役立ちます。

> [!NOTE] 
> セルフサービス メンテナンスは、一部の VM には使用できない場合があります。 ご自身の VM にプロアクティブな再デプロイを使用できるかどうかを確認するには、メンテナンス状態で **[今すぐ開始]** を探します。 セルフサービス メンテナンスは、現在、Cloud Services (Web/worker ロール)、および Service Fabric では使用できません。


セルフサービス メンテナンスは、**可用性セット**を使用したデプロイにはお勧めしません。可用性セットは高可用性セットアップであるため、常に 1 つの更新ドメインしか影響を受けないためです。 

- Azure がメンテナンスをトリガーします。 再起動が必要なメンテナンスでは、更新ドメインごとにメンテナンスが行われますが、更新ドメインが連続してメンテナンスを受信するとは限らないため、更新ドメイン間に 30 分間の一時停止があることに注意してください。
- 一部の容量の一時的な損失 (1/更新ドメイン数) が問題になる場合は、メンテナンス期間中に追加インスタンスを割り当てることで簡単に補正できます。
- 再起動が不要なメンテナンスの場合、更新プログラムは障害ドメイン レベルで適用されます。 
    
セルフサービス メンテナンスは、次のシナリオでは使用**しない**でください。 

- 手動で、DevTest Labs を使用して、自動シャットダウンを使用して、またはスケジュールに従って、VM を頻繁にシャットダウンする場合。これにより、メンテナンス状態が元に戻り、追加のダウンタイムが発生する可能性があります。
- VM の有効期間が短く、メンテナンス段階の終了前に削除されることがわかっている場合。 
- ワークロードの状態の多くが、更新時に保持する必要があるローカル (一時) ディスクに格納されている場合。 
- VM のサイズを頻繁に変更する場合。変更により、メンテナンス状態が元に戻る可能性があります。 
- メンテナンス シャットダウンの開始 15 分前に、ワークロードのプロアクティブなフェールオーバーやグレースフル シャットダウンを有効にする、スケジュールされたイベントを使用している場合。

予定メンテナンス フェーズ中に中断なく VM を実行する場合、また、上記の使用しないシナリオの説明に該当するものがない場合は、セルフサービス メンテナンスを**使用します**。 

セルフサービス メンテナンスは、次の場合に使用することをお勧めします。

- 正確なメンテナンス期間を、管理担当またはエンド ユーザーのお客様に伝える必要がある。 
- 日時を指定して、メンテナンスを完了する必要がある。 
- メンテナンスのシーケンスを制御する必要がある (安全な復旧を保証する多層アプリケーションなど)。
- 2 つの更新ドメイン (UD) の間に30 分を超える VM 復旧時間が必要である。 更新ドメイン間の時間を制御するには、一度に 1 つの更新ドメイン (UD) で、VM に対してメンテナンスをトリガーする必要があります。

 
## <a name="view-virtual-machine-scale-sets-impacted-by-maintenance-in-the-portal"></a>ポータルでメンテナンスの影響を受ける仮想マシン スケール セットを表示する

計画メンテナンス ウェーブをスケジュールする際、Azure portal を使って今後のメンテナンス ウェーブの影響を受ける仮想マシン スケール セットの一覧を表示できます。 

1. [Azure Portal](https://portal.azure.com) にサインインします。
2. 左側のナビゲーションで **[All services] (すべてのサービス)** を選択し、**[仮想マシン スケール セット]** を選択します。
3. **[仮想マシン スケール セット]** ページの上部にある **[列の編集]** オプションを選択し、使用できる列の一覧を開きます。
4. **[Available columns section] (使用可能な列) セクション**で **[Self-service maintenance] (セルフサービス メンテナンス)** 項目を選択し、矢印ボタンを使用して **[Selected columns] (選択された列)** リストに移動します。 **[Available columns] (使用可能な列)** セクションのドロップダウン リストを **[All] (すべて)** から **[Properties] (プロパティ)** に切り替えると、**[Self-service maintenance] (セルフサービス メンテナンス)** 項目を簡単に見つけることができます。 **[Selected columns] (選択された列)** セクションに **[Self-service maintenance] (セルフサービス メンテナンス)** 項目が入ったら、ページの下部にある **[Apply] (適用)** ボタンを選択します。 

上記の手順を実行すると、仮想マシン スケール セットの一覧に **[Self-service maintenance] (セルフサービス メンテナンス)** 列が表示されます。 各仮想マシン スケール セットのセルフサービス メンテナンスの列の値は、次のいずれかの値をとることができます。

| 値 | 説明 |
|-------|-------------|
| [はい] | 仮想マシン スケール セット内の少なくとも 1 つの仮想マシンがセルフ サービス期間内です。 このセルフサービス期間中は、いつでもメンテナンスを開始することができます。 | 
| いいえ  | 影響を受ける仮想マシン スケール セットには、セルフサービス期間内の仮想マシンはありません。 | 
| - | 仮想マシン スケール セットは、計画済みメンテナンス ウェーブの一部ではありません。| 

## <a name="notification-and-alerts-in-the-portal"></a>ポータルの通知とアラート

Azure は、サブスクリプション所有者と共同所有者グループに電子メールを送信することで、計画済みメンテナンスのスケジュールを伝えます。 Azure アクティビティ ログ アラートを作成して、この通信にその他の受信者とチャネルを追加することができます。 詳細については、「[Azure アクティビティ ログでサブスクリプション アクティビティを監視する] (../monitoring-and-diagnostics/monitoring-overview-activity-logs.md) 」を参照してください。

1. [Azure Portal](https://portal.azure.com) にサインインします。
2. 左側のメニューで **[監視]** を選択します。 
3. **[Monitor - Alerts (classic)] (監視 - アラート (クラシック))** ウィンドウで、**[+ アクティビティ ログ アラートの追加]** をクリックします。
4. **[アクティビティ ログ アラートの追加]** ページに情報を入力し、**[Criteria] (条件)** で以下を設定したかどうかを確認します。
   - **イベント カテゴリ**: サービスの正常性
   - **サービス**: 仮想マシン スケール セットおよび仮想マシン
   - **タイプ**: 定期的なメンテナンス 
    
アクティビティ ログ アラートの構成方法については、「[アクティビティ ログ アラートの作成](../monitoring-and-diagnostics/monitoring-activity-log-alerts.md)」を参照してください。
    
    
## <a name="start-maintenance-on-your-virtual-machine-scale-set-from-the-portal"></a>ポータルから仮想マシン スケール セットのメンテナンスを開始する

仮想マシン スケール セットの概要を見ているときに、メンテナンスに関連する詳細情報をさらに表示することができます。 仮想マシン スケール セット内の少なくとも 1 つの仮想マシンが計画済みメンテナンス ウェーブに含まれる場合は、ページの上部にある新しい通知リボンが追加されます。 通知リボンをクリックして **[Maintenance] (メンテナンス)** ページに移動すると、どの仮想マシン インスタンスが計画メンテナンスの影響を受けるかを確認できます。 

そこから、影響を受ける仮想マシンに対応するボックスをチェックして **[Start maintenance] (メンテナンスの開始)** オプションをクリックすることで、メンテナンスを開始できます。

メンテナンスを開始すると、影響を受ける仮想マシン スケール セットの仮想マシンがメンテナンス対象になり、一時的に利用できなくなります。 セルフサービス ウィンドウを閉じてしまった場合でも、Azure で仮想マシン スケール セットをメンテナンスするときにウィンドウを表示することができます。
 
## <a name="check-maintenance-status-using-powershell"></a>PowerShell を使用してメンテナンスの状態を確認する

Azure Powershell を使用して、仮想マシン スケール セット内の VM のメンテナンスの予定を確認することができます。 計画メンテナンスに関する情報は、[Get-AzureRmVmss](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmss) コマンドレットに `-InstanceView` パラメーターを指定することで取得できます。
 
計画メンテナンスがある場合にのみ、メンテナンス情報が返されます。 VM インスタンスに影響を及ぼすメンテナンスがスケジュールされていない場合、コマンドレットはメンテナンス情報を返しません。 

```powershell
Get-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -InstanceView
```

MaintenanceRedeployStatus では、次のプロパティが返されます。 
| 値 | 説明   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | この時点で VM に対してメンテナンスを開始できるかどうかを示します。 ||
| PreMaintenanceWindowStartTime         | VM に対してメンテナンスを開始できる場合、メンテナンスのセルフサービス期間の始まりです。 ||
| PreMaintenanceWindowEndTime           | VM に対してメンテナンスを開始できる場合、メンテナンスのセルフサービス期間の終わりです。 ||
| MaintenanceWindowStartTime            | Azure が VM に対してメンテナンスを開始する、予定メンテナンスの始まりです。 ||
| MaintenanceWindowEndTime              | Azure が VM に対してメンテナンスを開始する、予定メンテナンス期間の終わりです。 ||
| LastOperationResultCode               | VM に対して最後にメンテナンスを試みたときの結果です。 ||



### <a name="start-maintenance-on-your-vm-instance-using-powershell"></a>PowerShell を使用して VM インスタンスに対するメンテナンスを開始する

**IsCustomerInitiatedMaintenanceAllowed** が true に設定されている場合、[Set-AzureRmVmss](/powershell/module/azurerm.compute/set-azurermvmss) コマンドレットと `-PerformMaintenance` パラメーターを使用して VM のメンテナンスを開始できます。

```powershell
Set-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -PerformMaintenance 
```

## <a name="check-maintenance-status-using-cli"></a>CLI を使用してメンテナンスの状態を確認する

計画メンテナンス情報は、[az vmss list-instances](/cli/azure/vmss?view=azure-cli-latest#az-vmss-list-instances) を使用して確認できます。
 
計画メンテナンスがある場合にのみ、メンテナンス情報が返されます。 VM インスタンスに影響を及ぼすメンテナンスがスケジュールされていない場合、コマンドはメンテナンス情報を返しません。 

```azure-cli
az vmss list-instances -g rgName -n vmssName --expand instanceView
```

MaintenanceRedeployStatus では、各 VM インスタンスについて次のプロパティが返されます。 
| 値 | 説明   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | この時点で VM に対してメンテナンスを開始できるかどうかを示します。 ||
| PreMaintenanceWindowStartTime         | VM に対してメンテナンスを開始できる場合、メンテナンスのセルフサービス期間の始まりです。 ||
| PreMaintenanceWindowEndTime           | VM に対してメンテナンスを開始できる場合、メンテナンスのセルフサービス期間の終わりです。 ||
| MaintenanceWindowStartTime            | Azure が VM に対してメンテナンスを開始する、予定メンテナンスの始まりです。 ||
| MaintenanceWindowEndTime              | Azure が VM に対してメンテナンスを開始する、予定メンテナンス期間の終わりです。 ||
| LastOperationResultCode               | VM に対して最後にメンテナンスを試みたときの結果です。 ||


### <a name="start-maintenance-on-your-vm-instance-using-cli"></a>CLI を使用して VM インスタンスに対するメンテナンスを開始する

`IsCustomerInitiatedMaintenanceAllowed` が true に設定されている場合、次の呼び出しによって VM インスタンスに対するメンテナンスが開始されます。

```azure-cli
az vmss perform-maintenance -g rgName -n vmssName --instance-ids id
```

## <a name="faq"></a>FAQ


**Q: 仮想マシンを今すぐ再起動する必要があるのはなぜですか?**

**A:** Azure プラットフォームの更新とアップグレードの大半は仮想マシンの可用性に影響を及ぼしませんが、Azure でホストされている仮想マシンの再起動を避けられない場合があります。 累積された複数の変更があり、サーバーを再起動する必要がある場合、仮想マシンを再起動することになります。

**Q: 可用性セットを使用して高可用性に関する推奨事項に従えば安全ですか?**

**A:** 可用性セットまたは仮想マシン スケール セットにデプロイされた仮想マシンには、更新ドメイン (UD) の概念があります。 メンテナンスを実行するときに、Azure では UD の制約が遵守され、(同じ可用性セット内の) 別の UD の仮想マシンは再起動されません。  また、Azure は仮想マシンの次のグループに移行する前に少なくとも 30 分待機します。 

高可用性の詳細については、「[Azure の仮想マシンのリージョンと可用性について](../virtual-machines/windows/regions-and-availability.md)」を参照してください。

**Q: 計画済みメンテナンスに関する通知を受け取るにはどうすればよいですか?**

**A:** 計画済みメンテナンス ウェーブは、1 つ以上の Azure リージョンにスケジュールを設定することで開始されます。 開始直後に、電子メール通知がサブスクリプションの所有者に送信されます (サブスクリプションごとに 1 メール)。 この通知の追加のチャネルと受信者は、アクティビティ ログ アラートを使用して構成できます。 計画済みメンテナンスが既にスケジュールされているリージョンに仮想マシンをデプロイした場合、通知を受け取ることはできないため、その VM のメンテナンスの状態を確認する必要があります。

**Q: ポータル、PowerShell、または CLI に計画済みメンテナンスの情報が表示されません。何がおかしいのでしょうか?**

**A:** 計画済みメンテナンスに関する情報は、計画済みメンテナンス ウェーブ中にのみ、影響を受ける VM に提供されます。 つまり、データが表示されない場合、メンテナンス ウェーブが既に完了している (または、まだ開始されていない) か、更新されたサーバーで仮想マシンが既にホストされていると考えられます。

**Q: 仮想マシンが影響を受けるのはいつであるかを正確に把握する方法はありますか?**

**A:** スケジュールを設定するときに、数日間の時間枠が設けられています。 ただし、この時間枠内でのサーバー (および VM) の正確な優先順位付けは不明です。 VM の正確な時間を把握したいお客様は、仮想マシン内から[スケジュールされたイベント](../virtual-machines/windows/scheduled-events.md)とクエリを使用し、VM が再起動される 15 分前に通知を受け取ることができます。

**Q: 仮想マシンの再起動にはどれくらいの時間がかかりますか?**

**A:** セルフサービス メンテナンス期間中、VM のサイズによっては、再起動に最大数分かかることがあります。 予定メンテナンス期間中の Azure によって開始される再起動の場合は、再起動に通常約 25 分かかります。 Cloud Services (Web/worker ロール)、VM Scale Sets、または可用性セットを使用している場合、予定メンテナンス期間中は VM の各グループ (UD) 間に 30 分の間隔が空けられます。 

**Q: VM のメンテナンス情報が表示されません。何が問題だったのでしょうか?**

**A:** VM のメンテナンス情報が表示されない理由はいくつかあります。
   - Microsoft 社内としてマークされたサブスクリプションを使用している。
   - VM のメンテナンスがスケジュールされていない。 メンテナンス ウェーブが終了しているか、取り消しまたは変更が行われたため、VM が影響を受けなくなっていると考えられます。
   - VM リスト ビューに **[メンテナンス]** 列が追加されていない。 この列は既定のビューに追加されていますが、既定以外の列を表示するように構成しているお客様は、VM リスト ビューに **[メンテナンス]** 列を手動で追加する必要があります。

**Q: VM の 2 回目のメンテナンスがスケジュールされています。なぜですか?**

**A:** メンテナンスの再デプロイが既に完了した後に、VM のメンテナンスがスケジュールされるユース ケースがいくつかあります。
   - メンテナンス ウェーブが取り消され、別のペイロードで再開された場合。 エラーが発生したペイロードが検出されたため、Microsoft が追加のペイロードをデプロイする必要があったと考えられます。
   - ハードウェア障害により、VM が別のノードに "*サービス復旧*" された場合。
   - お客様が VM を停止 (割り当てを解除) し、再起動することを選択した場合。
   - お客様が VM の**自動シャットダウン**を有効にした場合。

## <a name="next-steps"></a>次の手順

[スケジュールされたイベント](../virtual-machines/windows/scheduled-events.md) を使用して VM でメンテナンス イベントを登録する方法を説明します。
