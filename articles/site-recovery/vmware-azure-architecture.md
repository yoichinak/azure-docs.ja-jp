---
title: Azure Site Recovery での VMware から Azure へのレプリケーション アーキテクチャ | Microsoft Docs
description: この記事では、Azure Site Recovery を使ってオンプレミスの VMware VM を Azure にレプリケートするときに使われるコンポーネントとアーキテクチャの概要を説明します
author: rayne-wiselman
ms.service: site-recovery
ms.date: 07/06/2018
ms.author: raynew
ms.openlocfilehash: 48adf61dc0f1796b820e1e14ca509d4618c6256b
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37920569"
---
# <a name="vmware-to-azure-replication-architecture"></a>VMware から Azure へのレプリケーション アーキテクチャ

この記事では、[Azure Site Recovery](site-recovery-overview.md) を使ってオンプレミスの VMware サイトと Azure 間で VMware 仮想マシン (VM) をレプリケート、フェールオーバー、および復旧する場合に使われるアーキテクチャとプロセスについて説明します。


## <a name="architectural-components"></a>アーキテクチャ コンポーネント

次の表と図は、Azure への VMware レプリケーションに使用するコンポーネントの概要を示したものです。

**コンポーネント** | **要件** | **詳細**
--- | --- | ---
**Azure** | Azure サブスクリプション、Azure Storage アカウント、および Azure ネットワーク。 | オンプレミスの VM からレプリケートされたデータはストレージ アカウントに格納されます。 オンプレミスから Azure へのフェールオーバーを実行すると、そのレプリケートされたデータで Azure VM が作成されます。 Azure VM は、作成時に Azure 仮想ネットワークに接続します。
**構成サーバー マシン** | 単一のオンプレミス マシン。 ダウンロードした OVF テンプレートからデプロイできる VMware VM として実行することをお勧めします。<br/><br/> マシンは、構成サーバー、プロセス サーバー、マスター ターゲット サーバーなど、オンプレミスのすべての Site Recovery コンポーネントを実行します。 | **構成サーバー**: オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。<br/><br/> **プロセス サーバー**: 構成サーバーに既定でインストールされます。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM への Azure Site Recovery モビリティ サービスのインストールや、オンプレミスのマシンの自動検出も行います。 デプロイの拡大に合わせて、増大するレプリケーション トラフィックの処理を実行する独立したプロセス サーバーを追加できます。<br/><br/> **マスター ターゲット サーバー**: 構成サーバーに既定でインストールされます。 Azure からのフェールバック中にレプリケーション データを処理します。 大規模なデプロイでは、フェールバック用に別のマスター ターゲット サーバーを追加できます。
**VMware サーバー** | VMware VM は、オンプレミス vSphere ESXi サーバーでホストされています。 ホストの管理には vCenter サーバーをお勧めします。 | Site Recovery のデプロイ中には、VMware サーバーを Recovery Services コンテナーに追加します。
**レプリケートされたマシン** | レプリケートする各 VMware VM にモビリティ サービスがインストールされます。 | プロセス サーバーから自動的にインストールできるようにすることをお勧めします。 また、サービスを手動でインストールしたり、System Center Configuration Manager などの自動デプロイ方法を使用したりすることができます。

**VMware から Azure へのアーキテクチャ**

![コンポーネント](./media/vmware-azure-architecture/arch-enhanced.png)

## <a name="configuration-steps"></a>構成の手順

Azure のディザスター リカバリーまたは移行を行うために VMware をセットアップするための大まかな手順は次のとおりです。

1. **Azure コンポーネントをセットアップする**。 適切なアクセス許可を持つ Azure アカウント、Azure ストレージ アカウント、Azure 仮想ネットワーク、および Recovery Services コンテナーが必要です。 [詳細情報](tutorial-prepare-azure.md)。
2. **オンプレミスをセットアップする**。 これには、Site Recovery がレプリケートする VM を自動的に検出できるようにするための VMware サーバーでのアカウントの設定、レプリケートする VM にモビリティ サービス コンポーネントをインストールするために使用できるアカウントの設定、VMware サーバーと VM が前提条件を満たしていることの検証が含まれます。 必要に応じて、フェールオーバー後にこれらの Azure VM に接続するための準備も実行できます。 Site Recovery は、VM のデータを Azure ストレージ アカウントにレプリケートし、Azure へのフェールオーバーを実行するときにそのデータを使用する Azure VM を作成します。 [詳細情報](vmware-azure-tutorial-prepare-on-premises.md)。
3. **レプリケーションをセットアップする**。 レプリケート先の場所を選択します。 必要なオンプレミスの Site Recovery コンポーネントをすべて実行する単一のオンプレミスの VMware VM (構成サーバー) をセットアップすることで、ソース レプリケーション環境を構成します。 セットアップした後、構成サーバー マシンを Recovery Services コンテナーに登録します。 その後、ターゲットの設定を選択します。 [詳細情報](vmware-azure-tutorial.md)。
4. **レプリケーション ポリシーを作成する**。 レプリケーションの実行方法を指定するレプリケーション ポリシーを作成します。 
    - **RPO しきい値**: この監視設定は、指定した時間内にレプリケーションが実行されない場合は、アラートが (必要に応じて電子メールも) 発行されることを示します。 たとえば、RPO しきい値を 30 分に設定した場合、何らかの問題でレプリケーションが 30 分以内に実行されなければ、イベントが生成されます。 この設定は、レプリケーションには影響しません。 レプリケーションは継続され、数分ごとに復旧ポイントが作成されます。
    - **リテンション期間**: 復旧ポイントのリテンション期間は、Azure に復旧ポイントを保持する必要がある期間を指定します。 Premium Storage では、0 ～ 24 時間の値を指定でき、標準ストレージでは最大 72 時間まで指定できます。 最新の復旧ポイントにフェールオーバーするか、ゼロより大きい値を設定すれば、保存したポイントにフェールオーバーできます。 リテンション期間が経過すると、復旧ポイントは消去されます。
    - **クラッシュ整合スナップショット**: 既定では、Site Recovery は、クラッシュ整合スナップショットを作成し、それらを持つ復旧ポイントを数分ごとに作成します。 相互に関連するデータ コンポーネントのすべてで書き込み順序に整合性がある場合、スナップショットは復旧ポイントが作成された瞬間の状態であるため、復旧ポイントはクラッシュ整合になります。 理解を深めるために、停電や似たようなイベント発生後の PC のハード ドライブ上のデータの状態を想像してください。 データの不整合を発生させずにクラッシュから回復するようにアプリケーションが設計されている場合、通常はクラッシュ整合復旧ポイントで十分です。
    - **アプリ整合スナップショット**: この値が 0 でない場合は、VM で実行中のモビリティ サービスが、ファイル システム整合スナップショットと回復ポイントの生成を試みます。 最初のスナップショットは、初回のレプリケーションの完了後に作成されます。 その後は、指定された頻度でスナップショットが作成されます。 書き込み順序に整合性があることに加えて、実行中のアプリケーションがそれぞれの操作をすべて完了し、バッファーをディスクにフラッシュする (アプリケーションを休止する) 場合、復旧ポイントはアプリケーション整合になります。 アプリ整合復旧ポイントは、SQL、Oracle、Exchange などのデータベース アプリケーションで推奨されます。 クラッシュ整合スナップショットで十分な場合は、この値を 0 に設定できます。  
    - **複数の VM の整合**: 必要に応じて、レプリケーション グループを作成できます。 その後、レプリケーションを有効にするときに、VM をそのグループにまとめることができます。 レプリケーション グループ内の VM はまとめてレプリケートされ、フェールオーバー時にクラッシュ整合復旧ポイントとアプリ整合復旧ポイントを共有します。 複数のコンピューターでスナップショットを収集する必要があることで、ワークロードのパフォーマンスに与える可能性があるため、このオプションは慎重に使用する必要があります。 これは、VM が同じワークロードを実行していること、VM を整合させる必要があること、VM のチャーンが似ている場合のみ使用してください。 グループには、最大 8 つの VM を追加できます。 
5. **VM レプリケーションを有効にする**。 最後に、オンプレミスの VMware VM のレプリケーションを有効にします。 モビリティ サービスをインストールするためのアカウントを作成し、Site Recovery がプッシュ インストールを実行する必要があると指定した場合は、レプリケーションを有効にする各 VM にモビリティ サービスがインストールされます。 [詳細情報](vmware-azure-tutorial.md#enable-replication)。 複数の VM を整合させるためのレプリケーション グループを作成した場合は、そのグループに VM を追加できます。
6. **フェールオーバーをテストする**。 すべてをセットアップしたら、テスト フェールオーバーを実行して、VM が Azure に期待どおりにフェールオーバーすることをチェックできます。 [詳細情報](tutorial-dr-drill-azure.md)。
7. **フェールオーバーする**。 単に VM を Azure に移行する場合は、完全フェールオーバーを実行してそれを行います。 ディザスター リカバリーをセットアップしている場合は、必要があるときに完全フェールオーバーを実行できます。 完全なディザスター リカバリーでは、Azure にフェールオーバーし、それが利用可能なった後で、オンプレミス サイトにフェールバックできます。 [詳細情報](vmware-azure-tutorial-failover-failback.md)。

## <a name="replication-process"></a>レプリケーション プロセス

1. VM のレプリケーションを有効にすると、レプリケーション ポリシーに従ってレプリケーションが開始されます。 
2. トラフィックは、インターネット経由で Azure Storage のパブリック エンドポイントにレプリケートされます。 別の方法として、Azure ExpressRoute と[パブリック ピアリング](../expressroute/expressroute-circuit-peerings.md#azure-public-peering)を使用できます。 オンプレミス サイトから Azure へのサイト間仮想プライベート ネットワーク (VPN) を介したトラフィックのレプリケートはサポートされていません。
3. VM のデータの最初のコピーが Azure ストレージにレプリケートされます。
4. 初回のレプリケーションの終了後、Azure への差分変更のレプリケーションが開始されます。 マシンの追跡された変更は .hrl ファイルに保持されます。
5. 通信は、次のように行われます。

    - VM は、レプリケーション管理のために、受信ポート HTTPS 443 でオンプレミスの構成サーバーと通信します。
    - 構成サーバーは、送信ポート HTTPS 443 経由で Azure によるレプリケーションを調整します。
    - VM は、受信ポート HTTPS 9443 でレプリケーション データを (構成サーバー マシン上で実行されている) プロセス サーバーに送信します。 このポートは変更可能です。
    - プロセス サーバーは、レプリケーション データを受信し、データを最適化して暗号化し、送信ポート 443 経由で Azure ストレージに送信します。


**VMware から Azure へのレプリケーション プロセス**

![レプリケーション プロセス](./media/vmware-azure-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>フェールオーバーとフェールバックのプロセス

レプリケーションがセットアップされ、ディザスター リカバリーの訓練 (フェールオーバーのテスト) を実行してすべてが期待どおりに動作することを確認したら、必要に応じて、フェールオーバーとフェールバックを実行できます。

1. 単一のマシンをフェールオーバーするか、復旧計画を作成して複数の VM を同時にフェールオーバーします。 単一のマシンのフェールオーバーと比較した復旧計画の利点を次に示します。
    - アプリのすべての VM を 1 つの復旧プランに含めることで、アプリの依存関係をモデル化できます。
    - スクリプト、Azure Runbook、手動操作を行うための一時停止を追加できます。
2. 最初のフェールオーバーをトリガーするには、Azure VM から、ワークロードへのアクセスを開始するようコミットします。
3. プライマリ オンプレミス サイトが再び使用可能になったら、フェールバックを実行する準備を行うことができます。 フェールバックするためには、次のものを含むインフラストラクチャをセットアップする必要があります。

    * **Azure 内の一時的なプロセス サーバー**: Azure からフェールバックするために、Azure からのレプリケーションを処理するプロセス サーバーとして機能する Azure VM をセットアップする必要があります。 この VM は、フェールバックの完了後に削除できます。
    * **VPN 接続**: フェールバックするには、Azure ネットワークからオンプレミス サイトへの VPN 接続 (または ExpressRoute) が必要です。
    * **独立したマスター ターゲット サーバー**: 既定では、構成サーバーと共にオンプレミスの VMware VM にインストールされたマスター ターゲット サーバーが、フェールバックを処理します。 大量のトラフィックをフェールバックする必要がある場合は、その目的を果たすための独立したオンプレミスのマスター ターゲット サーバーをセットアップします。
    * **フェールバック ポリシー**: オンプレミスにもう一度レプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、オンプレミスから Azure へのレプリケーション ポリシーを作成したときに自動的に作成されます。
4. コンポーネントが配置された後、フェールバックは、次の 3 つのアクションを実行します。

    - 第 1 段階: Azure VM が Azure からオンプレミスの VMware VM へのレプリケートを開始するように、Azure VM を再保護します。
    -  第 2 段階: オンプレミス サイトでフェールオーバーを実行します。
    - 第 3 段階: ワークロードがフェールバックしたら、オンプレミス VM のレプリケーションを再び有効にします。
    
 
**Azure からの VMware フェールバック**

![フェールバック](./media/vmware-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>次の手順

VMware から Azure へのレプリケーションを有効にするには、[このチュートリアル](vmware-azure-tutorial.md)に従ってください。
