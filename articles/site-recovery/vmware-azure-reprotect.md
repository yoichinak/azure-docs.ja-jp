---
title: Azure からオンプレミス サイトに移行した VM を再保護する | Microsoft Docs
description: VM を Azure にフェールオーバーした後に、フェールバックを開始して VM をオンプレミスに戻すことができます。 フェールバックの前に再保護する方法について説明します。
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: rajanaki
ms.openlocfilehash: 1b410b2832d856f80d640aab2096fef270156c81
ms.sourcegitcommit: 30fd606162804fe8ceaccbca057a6d3f8c4dd56d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/30/2018
ms.locfileid: "39346681"
---
# <a name="reprotect-machines-from-azure-to-an-on-premises-site"></a>Azure からオンプレミス サイトに移行したマシンの再保護

オンプレミスの VMware VM または物理サーバーを Azure に[フェールオーバーした](site-recovery-failover.md)後、オンプレミス サイトにフェールバックする最初の手順は、フェールオーバー時に作成された Azure VM を再保護することです。 この記事では、その方法について説明します。 

概要を簡単に把握するために、Azure からオンプレミス サイトへのフェールオーバー方法に関する次の動画をご覧ください。<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="before-you-begin"></a>開始する前に

テンプレートを使用して仮想マシンを作成する場合は、各仮想マシンのディスクに独自の UUID が割り当てられていることを確認してください。 オンプレミスの仮想マシンとマスター ターゲットが同じテンプレートから作成されたためにその両方の UUID が衝突すると、再保護は失敗します。 同じテンプレートから作成されていない別のマスター ターゲットをデプロイします。 次の情報をメモしておきます。
- 代替の vCenter にフェールバックしようとしている場合は、新しい vCenter とマスター ターゲット サーバーが検出されることを確認してください。 典型的な症状は、データストアにアクセスできないか、データストアが **[再保護]** ダイアログ ボックスに表示されないことです。
- オンプレミスにレプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、順方向のポリシーを作成したときに自動的に作成されます。 次の情報をメモしておきます。
    - このポリシーは、作成時に構成サーバーに自動的に関連付けられます。
    - このポリシーは編集できません。
    - ポリシーの設定値は、RPO しきい値 = 15 分、復旧ポイントのリテンション期間 = 24 時間、アプリケーションの整合性スナップショットの取得頻度 = 60 分です。
- 再保護とフェールバック中には、オンプレミスの構成サーバーが実行中で接続状態である必要があります。
- vCenter サーバーがフェールバック先の仮想マシンを管理している場合は、vCenter サーバー上の VM の検出に[必要なアクセス許可](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)があることを確認してください。
- 再保護する前に、マスター ターゲット サーバー上のスナップショットを削除します。 スナップショットがオンプレミスのマスター ターゲットまたは仮想マシン上に存在する場合、再保護は失敗します。 仮想マシン上のスナップショットは、再保護ジョブ中に自動的にマージされます。
- レプリケーション グループのすべての仮想マシンは、同じオペレーティング システムの種類 (すべて Windows、またはすべて Linux) である必要があります。 現在、異種オペレーティング システムが混在するレプリケーション グループは、再保護およびオンプレミスへのフェールバックではサポートされていません。 これは、マスター ターゲットが仮想マシンと同じオペレーティング システムである必要があるためです。 レプリケーション グループのすべての仮想マシンには、同じマスター ターゲットが必要です。 
- フェールバックするときは、構成サーバーがオンプレミスに必要です。 フェールバック中、仮想マシンが構成サーバー データベースに存在している必要があります。 それ以外の場合、フェールバックは失敗します。 必ず、構成サーバーを定期的にバックアップするようスケジュールを設定します。 障害が発生した場合は、フェールバックが機能するように、同じ IP アドレスを持つサーバーを復元します。
- 再保護とフェールバックには、データをレプリケートするためのサイト間 (S2S) VPN が必要です。 Azure 内のフェールオーバーされた仮想マシンがオンプレミスの構成サーバーに到達 (ping を発行) できるようにネットワークを提供します。 フェールオーバーされた仮想マシンの Azure ネットワークにプロセス サーバーをデプロイすることもできます。 このプロセス サーバーも、オンプレミスの構成サーバーと通信できる必要があります。
- フェールオーバーとフェールバックのために以下のポートを開いておく必要があります。

    ![フェールオーバーおよびフェールバック用のポート](./media/vmware-azure-reprotect/failover-failback.png)

- [ポートと URL のホワイトリストの前提条件](vmware-azure-deploy-configuration-server.md#prerequisites)をすべて確認してください。

## <a name="deploy-a-process-server-in-azure"></a>Azure でプロセス サーバーをデプロイする

オンプレミス サイトにフェールバックする前に、Azure でプロセス サーバーが必要になることがあります。
- プロセス サーバーは、Azure の保護された仮想マシンからデータを受け取り、オンプレミス サイトにデータを送信します。
- プロセス サーバーと保護された仮想マシンとの間には、待ち時間が短いネットワークが必要です。 プロセス サーバーが Azure に必要かどうかを判断する場合、一般的に待機時間を考慮する必要があります。
    - Azure ExpressRoute 接続が設定されている場合は、仮想マシンとプロセス サーバーの間の待ち時間が短いため、オンプレミスのプロセス サーバーを使用してデータを送信できます。
    - ただし、S2S VPN しか使用していない場合は、Azure にプロセス サーバーをデプロイすることをお勧めします。
    - フェールバック中は Azure ベースのプロセス サーバーを使用することをお勧めします。 レプリケーションのパフォーマンスは、プロセス サーバーが、レプリケートしている仮想マシン (Azure 内のフェールオーバーされたマシン) に近いほど高くなります。 概念実証の場合、オンプレミスのプロセス サーバーと、プライベート ピアリングを使用した ExpressRoute を利用できます。

Azure でプロセス サーバーをデプロイするには:

1. Azure にプロセス サーバーをデプロイする必要がある場合は、「[フェールバックのために Azure でプロセス サーバーを設定する](vmware-azure-set-up-process-server-azure.md)」を参照してください。
2. Azure VM はレプリケーション データをプロセス サーバーに送信します。 Azure VM がプロセス サーバーに到達できるようにネットワークを構成します。
3. Azure からオンプレミスへのレプリケーションは、S2S VPN、または ExpressRoute ネットワークのプライベート ピアリングを介してのみ実行できることに注意してください。 そのネットワーク チャネルで十分な帯域幅を使用できることを確認してください。

## <a name="deploy-a-separate-master-target-server"></a>別のマスター ターゲット サーバーをデプロイする

マスター ターゲット サーバーは、フェールバック データを受信します。 既定で、マスター ターゲット サーバーは、オンプレミスの構成サーバー上で実行されます。 ただし、フェールバック トラフィックの量によっては、フェールバック用に別のマスター ターゲット サーバーを作成する必要があります。 作成手順は次のとおりです。

* Linux VM のフェールバック用に [Linux マスター ターゲット サーバーを作成](vmware-azure-install-linux-master-target.md)します。 これは必須です。
* 必要に応じて、Windows VM のフェールバック用に別のマスター ターゲット サーバーを作成します。 この場合、Unified Setup を再度実行し、マスター ターゲット サーバーの作成を選択します。 [詳細情報](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers)。

マスター ターゲット サーバーを作成したら、次のタスクを実行します。

- 仮想マシンが vCenter サーバー上でオンプレミスに存在する場合、マスター ターゲット サーバーにはオンプレミスの仮想マシンの仮想マシン ディスク (VMDK) ファイルへのアクセス権が必要です。 アクセス権は、レプリケートされたデータを仮想マシンのディスクに書き込むために必要です。 オンプレミスの仮想マシンのデータ ストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。
- 仮想マシンが vCenter サーバー上でオンプレミスに存在しない場合、Site Recovery サービスは、再保護中に新しい仮想マシンを作成する必要があります。 この仮想マシンは、マスター ターゲットを作成する ESX ホスト上に作成されます。 そのため、希望するホストにフェールバック仮想マシンが作成されるように、ESX ホストは慎重に選択します。
- マスター ターゲット サーバーに Storage vMotion を使用することはできません。 マスター ターゲット サーバーに Storage vMotion を使用すると、フェールバックが失敗する可能性があります。 ディスクが使用できないため、この仮想マシンは起動できません。 この問題の発生を防ぐには、vMotion の一覧からマスター ターゲット サーバーを除外します。
- マスター ターゲットで再保護の後に Storage vMotion タスクが実行される場合、そのマスター ターゲットに接続されている保護された仮想マシン ディスクは vMotion タスクのターゲットに移行されます。 この後にフェールバックしようとすると、ディスクが見つからないため、ディスクの取り外しは失敗します。 その後、ストレージ アカウントでディスクを見つけることは困難になります。 手動でディスクを見つけ、それを仮想マシンに接続する必要があります。 その後に、オンプレミスの仮想マシンを起動できます。
- 既存の Windows マスター ターゲット サーバーにリテンション ドライブを追加します。 新しいディスクを追加し、ドライブをフォーマットします。 リテンション ドライブは、仮想マシンがオンプレミス サイトにレプリケートされたときの特定の時点で停止するために使用します。 リテンション ドライブのいくつかの条件を次に示します。 これらの条件を満たさない場合、ドライブはマスター ターゲット サーバーに表示されません。
    - ボリュームが他のどの目的 (レプリケーションのターゲットなど) にも使用されていない。
    - ボリュームがロック モードではない。
    - ボリュームがキャッシュ ボリュームではない。 そのボリュームにマスター ターゲット インストールが存在してはいけません。 プロセス サーバーとマスター ターゲットのカスタム インストール ボリュームは、リテンション ボリュームになる資格がありません。 プロセス サーバーとマスター ターゲットがボリュームにインストールされている場合、そのボリュームがマスター ターゲットのキャッシュ ボリュームになります。
    - ボリュームのファイル システムの種類が FAT および FAT32 ではない。
    - ボリュームの容量がゼロ以外である。
    - Windows の既定のリテンション ボリュームは R ボリュームです。
    - Linux の既定のリテンション ボリュームは /mnt/retention/ です。
- 既存のプロセス サーバー/構成サーバー マシン、スケールまたはプロセス サーバー/マスター ターゲット サーバー マシンを使用している場合は、新しいドライブを追加する必要があります。 新しいドライブは、上記の要件を満たしている必要があります。 リテンション ドライブが存在しない場合、そのドライブは、ポータル上の選択ドロップダウン リストに表示されません。 オンプレミスのマスター ターゲットにドライブを追加した後、そのドライブがポータル上の選択リストに表示されるまでに最大 15 分かかります。 15 分経ってもドライブが表示されない場合は、構成サーバーを更新することもできます。
- マスター ターゲット サーバーに VMware ツールまたは open-vm-tools をインストールします。 ツールがない場合、マスター ターゲットの ESXi ホスト上のデータストアを検出できません。
- VMware でマスター ターゲット仮想マシンの構成パラメーターに `disk.EnableUUID=true` を設定します。 この行が存在しない場合は追加してください。 この設定は、一貫性のある UUID を VMDK に提供することで適切なマウントが実行されるようにするために必要です。
- マスター ターゲットが作成される ESX ホストには、少なくとも 1 つの仮想マシン ファイル システム (VMFS) データストアが接続されている必要があります。 VMFS データストアが接続されていない場合、再保護ページ上の**データストア**の入力が空になり、処理を続行できません。
- マスター ターゲット サーバーのディスクにはスナップショットが存在してはいけません。 スナップショットが存在する場合、再保護およびフェールバックは失敗します。
- 準仮想化 SCSI コントローラーをマスター ターゲットに割り当てることはできません。 LSI Logic コントローラー以外は使用できません。 LSI Logic コントローラがない場合、再保護は失敗します。
- どのインスタンスでもマスター ターゲットに接続できるディスクの最大数は 60 台です。 オンプレミスのマスター ターゲットに再保護される仮想マシンのディスクの合計数が 60 を超えると、マスター ターゲットへの再保護が失敗するようになります。 マスター ターゲットに十分な数のディスク スロットがあることを確認するか、マスター ターゲット サーバーを追加デプロイしてください。
    

## <a name="enable-reprotection"></a>再保護を有効にする

Azure 内の仮想マシンが起動した後、エージェントが構成サーバーに再度登録されるまでにある程度の時間 (最大 15 分) かかります。 この間は再保護を実行できないため、エージェントがインストールされていないというエラー メッセージが表示されます。 このような場合は、数分待ってから再保護を再試行してください。


1. **[コンテナー]** > **[レプリケートされたアイテム]** の順に選択します。 フェールオーバーされた仮想マシンを右クリックし、**[再保護]** を選択します。 または、コマンド ボタンからマシンを選択し、**[再保護]** を選択します。
2. 保護の方向として **[Azure からオンプレミスへ]** が選択されていることを確認します。
3. **[マスター ターゲット サーバー]** と **[プロセス サーバー]** で、オンプレミスのマスター ターゲット サーバーとプロセス サーバーを選択します。  
4. **[Datastore] \(データストア)** では、オンプレミスのディスクの復旧先のデータストアを選択します。 このオプションは、オンプレミスの仮想マシンを削除し、新しいディスクを作成する必要がある場合に使用します。 ディスクが既に存在する場合、このオプションは無視されます。 それでも値は指定しておく必要があります。
5. リテンション ドライブを選択します。
6. フェールバック ポリシーは自動的に選択されます。
7. **[OK]** を選択して再保護を開始します。 仮想マシンを Azure からオンプレミス サイトにレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。再保護が成功すると、仮想マシンは保護された状態になります。

次の情報をメモしておきます。
- 代わりの場所に復旧する (オンプレミスの仮想マシンが削除されている) 場合は、マスター ターゲット サーバー用に構成されているリテンション ドライブとデータストアを選択します。 オンプレミス サイトにフェールバックした場合、フェールバック保護計画の VMware 仮想マシンはマスター ターゲット サーバーと同じデータストアを使用します。 その後、新しい仮想マシンが vCenter に作成されます。
- Azure 上の仮想マシンを既存のオンプレミスの仮想マシン復旧する場合は、マスター ターゲット サーバーの ESXi ホストに対する読み取り/書き込みアクセス権を持つオンプレミスの仮想マシンのデータストアをマウントします。

    ![[再保護] ダイアログ ボックス](./media/vmware-azure-reprotect/reprotectinputs.png)

- また、復旧計画のレベルで再保護を実行することもできます。 レプリケーション グループは、復旧計画を使用してのみ再保護できます。 復旧計画を使用して再保護する場合は、すべての保護されたマシンの値を指定する必要があります。
- レプリケーション グループを再保護するには、同じマスター ターゲット サーバーを使用します。 異なるマスター ターゲット サーバーを使用してレプリケーション グループを再保護すると、サーバーは共通の時点を提供できません。
- 再保護の間、オンプレミスの仮想マシンは無効になります。 これは、レプリケーション中のデータの整合性を確保するのに役立ちます。 再保護が完了した後、仮想マシンを有効にしないでください。



## <a name="common-issues"></a>一般的な問題

- 現在、Site Recovery では、VMFS または vSAN データストアへのフェールバックのみをサポートしています。 NFS データストアはサポートしていません。 この制限のために、再保護画面上のデータストア選択の入力は NFS データストアの場合は空になるか、vSAN データストアが表示されますが、ジョブの実行中に失敗します。 フェールバックする予定がある場合は、VMFS データストアをオンプレミスに作成し、それにフェールバックできます。 このフェールバックによって、VMDK の完全なダウンロードが実行されます。
- 読み取り専用ユーザー vCenter の検出を実行し、仮想マシンを保護すると、適切に保護され、フェールオーバーが機能します。 再保護中は、データストアが検出できないため、フェールオーバーは失敗します。 再保護中はデータストアが一覧表示されないという現象が発生します。 この問題を解決するには、アクセス許可が割り当てられている適切なアカウントを使用して vCenter 資格情報を更新し、ジョブを再試行します。 
- Linux 仮想マシンをフェールバックし、それをオンプレミスで実行すると、ネットワーク マネージャー パッケージがマシンからアンインストールされていることを確認できます。 このアンインストールは、Azure で仮想マシンが復旧されるときに、ネットワーク マネージャー パッケージが削除されるために発生します。
- Linux 仮想マシンが静的 IP アドレスで構成されているときに Azure にフェールオーバーされると、IP アドレスは DHCP から取得されます。 オンプレミスにフェールオーバーすると、仮想マシンは、引き続き DHCP を使用して IP アドレスを取得します。 必要であれば、手動でマシンにサインインし、IP アドレスを静的アドレスに設定し直します。 Windows 仮想マシンは、同じ静的 IP アドレスを再度取得できます。
- ESXi 5.5 Free エディションまたは vSphere 6 Hypervisor Free エディションを使用すると、フェールオーバーは成功しますが、フェールバックが失敗します。 フェールバックを有効にするには、いずれかのプログラムの評価ライセンスにアップグレードしてください。
- プロセス サーバーから構成サーバーにアクセスできない場合は、Telnet を使用して、構成サーバーのポート 443 への接続を確認します。 プロセス サーバーから構成サーバーに対して ping を試すこともできます。 プロセス サーバーも、構成サーバーに接続されている場合、ハートビートを送信します。
- 物理オンプレミス サーバーとして保護されている Windows Server 2008 R2 SP1 サーバーは、Azure からオンプレミス サイトにフェールバックすることができません。
- 次のような状況ではフェールバックできません。
    - マシンを Azure に移行した。 [詳細情報](migrate-overview.md#what-do-we-mean-by-migration)。
    - 別のリソース グループに VM を移動した。
    - Azure VM を削除した。
    - VM の保護を無効にした。
    - 手動で Azure に VM を作成した。 マシンは、最初にオンプレミスで保護されていて、再保護の前に Azure にフェールオーバーされたものでなければなりません。
    - ESXi ホストにのみ、フェールバックすることができます。 VMware VM または物理サーバーを Hyper-V ホスト、物理マシン、または VMware ワークステーションにフェールバックすることはできません。


## <a name="next-steps"></a>次の手順

仮想マシンが保護された状態に入ったら、[フェールバックを開始](vmware-azure-failback.md)できます。 フェールバックによって Azure の仮想マシンがシャットダウンされ、オンプレミスの仮想マシンが起動されます。 アプリケーションのある程度のダウンタイムをみておいてください。 アプリケーションがダウンタイムを許容できるフェールバック用の時間を選択します。


