---
title: Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する |Microsoft Docs
description: Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する方法について説明します。
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 07/06/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 93626e6a8f199841b285fb8a6e302e6c3054db0d
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37918035"
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Azure にオンプレミス VMware VM のディザスター リカバリーを設定する

[Azure Site Recovery](site-recovery-overview.md) は、計画された停止や計画外の停止の際にビジネス アプリを実行し続け、使用できるようにすることで、ビジネス継続性とディザスター リカバリー (BCDR) 戦略に貢献します。 Site Recovery は、レプリケーション、フェールオーバー、フェールバックなど、オンプレミスのマシンと Azure Virtual Machines (VM) のディザスター リカバリーを管理し、調整します。


このチュートリアルでは、Azure Site Recovery を使用し、VMware VM のレプリケーションを設定して有効にする方法について説明します。 チュートリアルは、基本設定を備えた Site Recovery をデプロイする方法を示すように設計されています。 最も簡単なパスを使用し、すべてのオプションは表示しません。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * レプリケーションのソースとターゲットを入力します。
> * ソースのレプリケーション環境 (オンプレミスの Azure Site Recovery コンポーネントなど) と、ターゲットのレプリケーション環境を設定します。
> * レプリケーション ポリシーを作成します。
> * VM のレプリケーションを有効にします。

## <a name="before-you-start"></a>開始する前に

開始する前に、次のことを行うと役に立ちます。

- このディザスター リカバリー シナリオの[アーキテクチャを確認](vmware-azure-architecture.md)する。
- VMware VM のディザスター リカバリーを設定する方法の詳細について、次のリソースを確認する。
    - VMware のディザスター リカバリーに関する[よく寄せられる質問を確認する](vmware-azure-common-questions.md)。
    - VMware で何がサポートされ、何が必要であるかについて[確認する](vmware-physical-azure-support-matrix.md)。
-  **ハウツー ガイド**で次の VMware に関するすべてのデプロイ オプションを網羅する詳細な手順を確認する。
    - [レプリケーション ソース](vmware-azure-set-up-source.md)と[構成サーバー](vmware-azure-deploy-configuration-server.md)を設定する。
    - [レプリケーション ターゲット](vmware-azure-set-up-target.md)を設定する。
    - [レプリケーション ポリシー](vmware-azure-set-up-replication.md)を設定して、[レプリケーションを有効にする](vmware-azure-enable-replication.md)。


## <a name="select-a-protection-goal"></a>保護の目標を選択する

1. **[Recovery Services コンテナー]** で、コンテナー名を選択します。 このシナリオでは、**ContosoVMVault** を使います。
2. **[作業の開始]** で、[Site Recovery] を選択します。 次に、**[インフラストラクチャの準備]** を選択します。
3. **[保護の目標]** > **[マシンのある場所]** で、**[オンプレミス]** を選びます。
4. **[マシンをどこにレプリケートしますか]** で、**[To Azure]\(Azure\)** を選びます。
5. **[マシンは仮想化されていますか]** で、**[はい (VMware vSphere ハイパーバイザー の場合)]** を選びます。 **[OK]** をクリックします。


## <a name="plan-your-deployment"></a>デプロイを計画する

このチュートリアルでは、単一の VM をレプリケートする方法について説明し、**[デプロイ計画]** で **[はい、完了しました]** を選択します。 複数の VM をデプロイする場合は、この手順をスキップしないことをお勧めします。 [Deployment Planner ツール](https://aka.ms/asr-deployment-planner)が役に立ちます。 [こちら](site-recovery-deployment-planner.md) を参照してください。

## <a name="set-up-the-source-environment"></a>ソース環境をセットアップする

最初のデプロイ手順として、ソース環境をセットアップします。 オンプレミスの Site Recovery コンポーネントをホストするには、可用性の高いオンプレミスのマシンが 1 台必要です。 コンポーネントには、構成サーバー、プロセス サーバー、マスター ターゲット サーバーが含まれます。

- 構成サーバーは、オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。
- プロセス サーバーはレプリケーション ゲートウェイとして機能します。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM へのモビリティ サービスのインストールや、オンプレミスの VMware VM の自動検出も行います。
- マスター ターゲット サーバーは、Azure からのフェールバック中にレプリケーション データを処理します。

構成サーバーを高可用性 VMware VM としてセットアップするには、用意されている Open Virtualization Application (OVA) テンプレートをダウンロードし、そのテンプレートを VMware にインポートして VM を作成します。 構成サーバーをセットアップしたら、それをコンテナーに登録します。 登録すると、Site Recovery によってオンプレミスの VMware VM が検出されます。

> [!TIP]
> このチュートリアルでは、OVA テンプレートを使用して、構成サーバー VMware VM を作成します。 これを行うことができない場合、[構成サーバーを手動で設定](physical-manage-configuration-server.md)できます。

> [!TIP]
> このチュートリアルでは、Site Recovery が MySQL をダウンロードして構成サーバーにインストールします。 Site Recovery がこれを行わないようにするには、手動で設定します。 [詳細情報](vmware-azure-deploy-configuration-server.md#configure-settings)。


### <a name="download-the-vm-template"></a>VM テンプレートをダウンロードする

1. コンテナーで、**[インフラストラクチャの準備]** > **[ソース]** の順に移動します。
2. **[ソースの準備]** で **[+ 構成サーバー]** を選びます。
3. **[サーバーの追加]** で、**[サーバーの種類]** に **[VMware の構成サーバー]** が表示されていることを確認します。
4. 構成サーバー用の OVF テンプレートをダウンロードします。

 > [!TIP]
 >構成サーバー テンプレートの最新バージョンは、[Microsoft ダウンロード センター](https://aka.ms/asrconfigurationserver)から直接ダウンロードできます。

>[!NOTE]
OVF テンプレートに付属するライセンスは、180 日間有効な評価版ライセンスです。 Windows のライセンス認証は、入手済みのライセンスを使用してユーザーが行う必要があります。

## <a name="import-the-template-in-vmware"></a>VMware にテンプレートをインポートする

1. VMWare vSphere Client を使用して、VMware vCenter サーバーまたは vSphere ESXi ホストにサインインします。
2. **[File]\(ファイル\)** メニューの **[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** を選択し、**[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** ウィザードを起動します。 

     ![OVF テンプレート](./media/vmware-azure-tutorial/vcenter-wizard.png)

3. **[Select source]\(ソースの選択\)** で、ダウンロードした OVF の場所を入力します。
4. **[Review details]\(詳細の確認\)** で、**[Next]\(次へ\)** を選択します。
5. **[Select name and folder]\(名前とフォルダーの選択\)** および **[Select configuration]\(構成の選択\)** は、既定の設定のままにします。
6. **[Select storage]\(ストレージの選択\)** で、パフォーマンスを最大にするために、**[Select virtual disk format]\(仮想ディスクの形式の選択\)** の **[Thick Provision Eager Zeroed]\(シック プロビジョニング Eager Zeroed\)** を選びます。
7. ウィザードの残りのページでは、既定の設定をそのまま使います。
8. **[Ready to complete]\(完了の準備完了\)** で、既定の設定で VM をセットアップするには、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** > **[Finish]\(完了\)** の順に選択します。

    > [!TIP]
  別の NIC を追加する場合は、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** をオフにする > **[Finish]\(完了\)** を選択する、と操作します。 既定では、テンプレートには NIC が 1 つ含まれています。 デプロイ後にさらに NIC を追加することができます。

## <a name="add-an-additional-adapter"></a>さらにアダプターを追加する

構成サーバーにさらに NIC を追加する場合は、サーバーをコンテナーに登録する前に追加します。 登録後のアダプターの追加はサポートされていません。

1. vSphere Client インベントリで VM を右クリックし、**[Edit Settings]\(設定の編集\)** を選びます。
2. **[Hardware]\(ハードウェア\)** で、**[Add]\(追加\)** > **[Ethernet Adapter]\(イーサネット アダプター\)** の順に選択します。 次に、**[次へ]** を選択します。
3. アダプターの種類およびネットワークを選びます。 
4. VM がオンになったときに仮想 NIC を接続するには、**[Connect at power on]\(電源をオンにしたときに接続する\)** をオンにします。 **[次へ]** > **[完了]** の順に選択します。 **[OK]** をクリックします。


## <a name="register-the-configuration-server"></a>構成サーバーを登録する 

1. VMWare vSphere Client のコンソールで、VM をオンにします。
2. VM が Windows Server 2016 のインストール エクスペリエンスで起動します。 使用許諾契約書に同意し、管理者パスワードを入力します。
3. インストールの完了後に、管理者として VM にサインインします。
4. 初めてサインインすると、数秒後に Azure Site Recovery 構成ツールが起動します。
5. 構成サーバーを Site Recovery に登録するために使う名前を入力します。 次に、**[次へ]** を選択します。
6. このツールは、VM が Azure に接続できることを確認します。 接続が確立された後、**[サインイン]** を選択して、自分の Azure サブスクリプションにサインインします。 この資格情報は、構成サーバーを登録するコンテナーにアクセスできる必要があります。
7. ツールがいくつかの構成タスクを実行した後、再起動されます。
8. 再度マシンにサインインします。 数秒後に、構成サーバーの管理ウィザードが自動的に起動します。

### <a name="configure-settings-and-add-the-vmware-server"></a>設定を構成し、VMware サーバーを追加する

1. 構成サーバーの管理ウィザードで **[接続の設定]** を選択し、プロセス サーバーが VM からのレプリケーション トラフィックを受信するために使用する NIC を選択します。 次に、**[保存]** を選択します。 構成後、この設定を変更することはできません。
2. **[Recovery Services コンテナーを選択する]** で、Azure サブスクリプションと、関連するリソース グループおよびコンテナーを選びます。
3. **[サードパーティ製ソフトウェアのインストール]** でライセンス契約に同意します。 **[ダウンロードしてインストール]** を選択して MySQL サーバーをインストールします。 MySQL をパスに配置した場合、この手順はスキップされます。
4. **[VMware PowerCLI のインストール]** を選択します。 この操作を行う前に、すべてのブラウザー ウィンドウを閉じてください。 その後 **[続行]** を選択します。
5. **[アプライアンス構成の検証]** で、続行する前に前提条件が検証されます。
6. **[Configure vCenter Server/vSphere ESXi server]\(vCenter Server/vSphere ESXi サーバーの構成\)** で、レプリケートする VM が存在している vCenter サーバーまたは vSphere ホストの FQDN または IP アドレスを入力します。 サーバーがリッスンするポートを入力します。 コンテナーで VMware サーバーに使うフレンドリ名を入力します。
7. VMware サーバーに接続するために構成サーバーによって使われる資格情報を入力します。 Site Recovery はこれらの資格情報を使って、レプリケーションに利用できる VMware VM を自動的に検出します。 **[追加]**、**[続行]** の順に選択します。
8. **[仮想マシンの資格情報の構成]** で、レプリケーションが有効になったときにモビリティ サービスを VM に自動的にインストールするために使用されるユーザー名とパスワードを入力します。
    - Windows マシンの場合、このアカウントは、レプリケートするマシンに対するローカル管理者特権を持っている必要があります。
    - Linux の場合は、ルート アカウントの詳細を指定します。
9. **[構成の確定]** を選択して、登録を完了します。
10. 登録が完了したら、Azure Portal で、構成サーバーおよび VMware サーバーがコンテナーの **[ソース]** ページの一覧に表示されていることを確認します。 その後、**[OK]** を選択して、ターゲットの設定を構成します。


Site Recovery は指定された設定を使用して VMware サーバーに接続し、VM を検出します。

> [!NOTE]
> アカウント名がポータルに表示されるまでに 15 分以上かかることがあります。 すぐに更新するには、**[構成サーバー]** > ***[<サーバー名>]*** > **[サーバーを最新の情報に更新する]** の順に選択します。

## <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

ターゲット リソースを選択して確認します。

1. **[インフラストラクチャの準備]** > **[ターゲット]** の順に選択します。 使用する Azure サブスクリプションを選択します。 リソース マネージャー モデルを使用しています。
2. Site Recovery によって、互換性のある Azure ストレージ アカウントとネットワークが 1 つ以上あるかどうかが確認されます。 これらは、このシリーズのチュートリアルの[最初のチュートリアル](tutorial-prepare-azure.md)で、Azure のコンポーネントをセットアップしたときには存在している必要があります。

   ![[ターゲット] タブ](./media/vmware-azure-tutorial/storage-network.png)

## <a name="create-a-replication-policy"></a>レプリケーション ポリシーを作成する

1. [Azure Portal](https://portal.azure.com) を開いて **[すべてのリソース]** を選択します。
2. Recovery Services コンテナー (このチュートリアルでは **ContosoVMVault**) を選択します
3. レプリケーション ポリシーを作成するには、**[Site Recovery インフラストラクチャ]** > **[レプリケーション ポリシー]** > **[+ レプリケーション ポリシー]** の順に選択します。
4. **[レプリケーション ポリシーの作成]** で、ポリシー名を入力します。 **VMwareRepPolicy** を使用しています。
5. **[RPO しきい値]** では、既定値の 60 分が使用されます。 この値で、復旧ポイントの作成頻度を指定します。 継続的なレプリケーションがこの制限を超えると、アラートが生成されます。
6. **[復旧ポイントのリテンション期間]** で、各復旧ポイントがどれだけ長く保持されるかを指定します。 このチュートリアルでは 72 時間を使用しています。 レプリケートされた VM は、リテンション期間内の任意の時点に復旧できます。
7. **[アプリ整合性スナップショットの頻度]** で、アプリケーション整合性スナップショットの作成頻度を指定します。 既定の 60 分を使用しています。 **[OK]** を選択してポリシーを作成します。

   ![レプリケーション ポリシーの作成](./media/vmware-azure-tutorial/replication-policy.png)

- このポリシーは自動的に構成サーバーに関連付けられます。
- 既定でフェールバックの照合ポリシーが自動的に作成されます。 たとえば、レプリケーション ポリシーが **rep-policy** の場合、フェールバック ポリシーは **rep-policy-failback** になります。 このポリシーは、Azure からフェールバックを開始するまで使用されません。

## <a name="enable-replication"></a>レプリケーションを有効にする

レプリケーションの有効化は、次の手順で実行できます。

1. **[アプリケーションをレプリケートする]** > **[ソース]** を選択します。
2. **[ソース]** で、**[オンプレミス]** を選択し、**[ソースの場所]** の構成サーバーを選択します。
3. **[マシンの種類]** で、**[仮想マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor]\(vCenter/vSphere ハイパーバイザー\)** で、vSphere ホストまたは vCenter サーバーを管理するホストを選択します。
5. (構成サーバー VM に既定でインストールされる) プロセス サーバーを選択します。 **[OK]** をクリックします。
6. **[ターゲット]** で、サブスクリプションと、フェールオーバー対象の VM を作成するリソース グループを選択します。 Resource Manager デプロイ モデルを使用しています。 
7. データをレプリケートするために使用する Azure ストレージ アカウントと、フェールオーバー後に作成された Azure VM が接続する Azure ネットワークとサブネットを選択します。
8. **[選択したマシン用に今すぐ構成します。]** を選択し、レプリケーションを有効にするすべての VM にネットワーク設定を適用します。 マシンごとに Azure ネットワークを選択する場合は、**[後で構成する]** を選択します。
9. **[Virtual Machines]** > **[仮想マシンの選択]** で、レプリケートする各マシンを選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 **[OK]** をクリックします。
10. **[プロパティ]** > **[プロパティの構成]** で、モビリティ サービスをマシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。
11. **[レプリケーションの設定]** > **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。
12. **[レプリケーションを有効にする]** を選択します。 VM のレプリケーションを有効にすると、Site Recovery がモビリティ サービスをインストールします。
13. **[設定]** > **[ジョブ]** > **[Site Recovery ジョブ]** の順にクリックして、**保護の有効化**ジョブの進行状況を追跡できます。 **保護の最終処理**ジョブが実行されると、マシンはフェールオーバーできる状態になります。
- 変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。
- 追加する VM を監視するには、**[構成サーバー]** > **[最後の使用]** で VM の最終検出時刻を確認します。 定期検出を待たずに VM を追加するには、構成サーバーを強調表示し (選択しないでください)、**[更新]** を選択します。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [ディザスター リカバリーのテストを実行する](site-recovery-test-failover-to-azure.md)
