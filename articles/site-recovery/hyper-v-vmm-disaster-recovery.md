---
title: Azure Site Recovery を使用してオンプレミスのサイト間に Hyper-V VM のディザスター リカバリーを設定する | Microsoft Docs
description: Azure Site Recovery を使用してオンプレミス サイト間に Hyper-V VM のディザスター リカバリーを設定する方法について説明します。
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: raynew
ms.openlocfilehash: 4cc4da130d9253bf40e5d02806088a95b2195e7c
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/11/2018
ms.locfileid: "38531723"
---
# <a name="set-up-disaster-recovery-for-hyper-v-vms-to-a-secondary-on-premises-site"></a>セカンダリのオンプレミスのサイトに対して Hyper-V VM のディザスター リカバリーを設定する

[Azure Site Recovery](site-recovery-overview.md) サービスは、オンプレミスのコンピューターと Azure 仮想マシン (VM) のレプリケーション、フェールオーバー、およびフェールバックの管理と調整を行うことでディザスター リカバリー戦略に貢献します。

この記事では、System Center Virtual Machine Manager (VMM) クラウドで管理されるオンプレミスの Hyper-V VM で、セカンダリ サイトに対するディザスター リカバリーを設定する方法について説明します。 この記事では、次のことについて説明します:

> [!div class="checklist"]
> * オンプレミスの VMM サーバーと Hyper-V ホストを準備する
> * Site Recovery の Recovery Services コンテナーを作成する 
> * ソース レプリケーション環境とターゲット レプリケーション環境を設定する 
> * ネットワーク マッピングを設定する 
> * レプリケーション ポリシーを作成する
> * VM のレプリケーションを有効にする

## <a name="prerequisites"></a>前提条件

このシナリオを完了するには:

- [シナリオのアーキテクチャとコンポーネント](hyper-v-vmm-architecture.md)を確認する。
- VMM サーバーと Hyper-V ホストが[サポート要件](hyper-v-vmm-secondary-support-matrix.md)に準拠していることを確認する。
- レプリケートする VM が[レプリケートされるマシンのサポート要件](hyper-v-vmm-secondary-support-matrix.md#replicated-vm-support)に準拠していることを確認する。
- ネットワーク マッピング用に VMM サーバーを準備する

### <a name="prepare-for-network-mapping"></a>ネットワーク マッピングを準備する

[ネットワーク マッピング](hyper-v-vmm-network-mapping.md)は、ソース クラウドとターゲット クラウド内のオンプレミス VMM VM ネットワーク間をマップします。 マッピングでは次が行われます。

- フェールオーバー後に VM を適切なターゲット VM ネットワークに接続します。 
- ターゲット Hyper-V ホスト サーバーにレプリカ VM を適切に配置します。 
- ネットワーク マッピングを構成しない場合、レプリカ VM はフェールオーバー後に VM ネットワークに接続されません。

次のように VMM を準備します。

1. ソースおよびターゲット VMM サーバー上に [VMM 論理ネットワーク](https://docs.microsoft.com/system-center/vmm/network-logical)があることを確認します。
    - ソース サーバー上の論理ネットワークは、Hyper-V ホストが配置されているソース クラウドと関連付けられている必要があります。
    - ターゲット サーバーの論理ネットワークは、ターゲット クラウドと関連付けられている必要があります。
1. ソースおよびターゲット VMM サーバー上に [VM ネットワーク](https://docs.microsoft.com/system-center/vmm/network-virtual)があることを確認します。 VM ネットワークは、各場所の論理ネットワークにリンクされている必要があります。
2. ソース Hyper-V ホスト上の VM をソース VM ネットワークに接続します。 


## <a name="create-a-recovery-services-vault"></a>Recovery Services コンテナーを作成する

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]


## <a name="choose-a-protection-goal"></a>保護の目標を選択する

レプリケートの対象とレプリケート先を選択します。

1. **[Site Recovery]** > **[手順 1: インフラストラクチャを準備する]** > **[保護の目標]** の順にクリックします。
2. **[復旧サイトへ]** を選択し、**[Yes, with Hyper-V (はい、Hyper-V を使用します)]** を選択します。
3. **[はい]** を選択し、VMM を使用して Hyper-V ホストを管理することを指定します。
4. セカンダリ VMM サーバーがある場合は、**[はい]** を選択します。 単一の VMM サーバー上にあるクラウド間でレプリケーションをデプロイする場合は、**[いいえ]** をクリックします。 次に、 **[OK]** をクリックします


## <a name="set-up-the-source-environment"></a>ソース環境をセットアップする

Azure Site Recovery プロバイダーを VMM サーバーにインストールし、サーバーを検出してコンテナーに登録します。

1. **[インフラストラクチャの準備]**、 > **[ソース]** の順にクリックします。
2. **[ソースの準備]** で **[+ VMM]** をクリックして、VMM サーバーを追加します。
3. **[サーバーの追加]** で、**[System Center VMM サーバー]** に **[構成サーバー]** が表示されていることを確認します。
4. Azure Site Recovery プロバイダーのインストール ファイルをダウンロードします。
5. 登録キーをダウンロードします。 このキーは、プロバイダーをインストールする場合に必要になります。 キーは生成後 5 日間有効です。

    ![Set up source](./media/hyper-v-vmm-disaster-recovery/source-settings.png)

6. 各 VMM サーバーにプロバイダーをインストールします。 Hyper-V ホストには何も明示的にインストールする必要はありません。

### <a name="install-the-azure-site-recovery-provider"></a>Azure Site Recovery プロバイダーのインストール

1. 各 VMM サーバーでプロバイダーのセットアップ ファイルを実行します。 VMM がクラスターにデプロイされる場合、初回に、次のようにインストールします。
    -  プロバイダーをアクティブ ノードにインストールし、インストールを終了して VMM サーバーをコンテナーに登録します。
    - 次に、プロバイダーを他のノードにインストールします。 すべてのクラスター ノードが同じバージョンのプロバイダーを実行する必要があります。
2. セットアップではいくつかの前提条件チェックが実行され、VMM サービスを停止するアクセス許可が要求されます。 セットアップが完了すると、VMM サービスは自動的に再起動されます。 VMM クラスターにインストールしている場合は、クラスター ロールを停止するよう求められます。
3. **[Microsoft Update]** では、Microsoft Update ポリシーに従ってプロバイダーの更新プログラムがインストールされるように指定できます。
4. **[インストール]** で、既定のインストール先をそのまま使用するか、インストール先を変更して、**[インストール]** をクリックします。
5. インストールが完了したら、**[登録]** をクリックして、サーバーをコンテナーに登録します。

    ![インストール場所](./media/hyper-v-vmm-disaster-recovery/provider-register.png)
6. **[コンテナー名]** で、サーバーが登録されるコンテナーの名前を確認します。 **[次へ]** をクリックします。
7. **[プロキシ接続]** で、VMM サーバーで実行中のプロバイダーが Azure に接続する方法を指定します。
   - プロバイダーがインターネットに直接接続するかプロキシ経由で接続するかを指定できます。 必要な場合は、プロキシ設定を指定します。
   - プロキシを使用する場合、指定したプロキシの資格情報を使用して VMM RunAs アカウント (DRAProxyAccount) が自動的に作成されます。 このアカウントが正しく認証されるようにプロキシ サーバーを構成します。 RunAs アカウントの設定を変更できます (VMM コンソール> **[設定]** > **[セキュリティ]** > **[RunAs アカウント]**)。
   - VMM サービスを再起動して変更を更新します。
8. **[登録キー]** で、ダウンロードして VMM サーバーにコピーした登録キーを選択します。
9. 暗号化設定はこのシナリオには関係ありません。 
10. **[サーバー名]** に、コンテナーで VMM サーバーを識別する表示名を入力します。 クラスターで、VMM クラスターのロール名を指定します。
11. **[クラウドのメタデータの同期]** で、VMM サーバー上のすべてのクラウドのメタデータを同期するかどうかを選択します。 この操作は、各サーバーで 1 回のみ実行する必要があります。 すべてのクラウドを同期しない場合は、この設定をオフにしておきます。 VMM コンソールのクラウドのプロパティで、各クラウドを個々に同期することができます。
12. **[次へ]** をクリックしてプロセスを完了します。 登録後に、Site Recovery は VMM サーバーからメタデータを取得します。 サーバーは、コンテナーの **[サーバー]** > **[VMM サーバー]** に表示されます。
13. サーバーがコンテナーに表示されたら、**[ソース]** > **[ソースの準備]** で、VMM サーバーを選択し、Hyper-V ホストが配置されているクラウドを選択します。 次に、 **[OK]** をクリックします


## <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

次のようにして、ターゲット VMM サーバーとクラウドを選択します。

1. **[インフラストラクチャの準備]** > **[ターゲット]** の順にクリックし、ターゲット VMM サーバーを選択します。
2. Site Recovery と同期されている VMM クラウドが表示されます。 ターゲット クラウドを選択します。

   ![ターゲット](./media/hyper-v-vmm-disaster-recovery/target-vmm.png)


## <a name="set-up-a-replication-policy"></a>レプリケーション ポリシーを設定する

開始する前に、そのポリシーを使用するすべてのホストのオペレーティング システムが同じであることを確認します。 ホストで実行されている Windows Server のバージョンが複数ある場合は、複数のレプリケーション ポリシーが必要です。

1. 新しいレプリケーション ポリシーを作成するには、**[インフラストラクチャの準備]** > **[レプリケーションの設定]** > **[+ 作成と関連付け]** の順にクリックします。
2. **[ポリシーの作成と関連付け]** で、ポリシー名を指定します。 ソースとターゲットの種類は **Hyper-V**にする必要があります。
3. **[Hyper-V ホストのバージョン]** で、ホストで実行されているオペレーティング システムを選択します。
4. **[認証の種類]** と **[認証ポート]** で、プライマリおよび復旧用の Hyper-V ホスト サーバー間でトラフィックを認証する方法を指定します。
    - 動作している Kerberos 環境が既にある場合を除き、**[証明書]** を選択してください。 Azure Site Recovery は、HTTPS 認証に使用する証明書を自動的に構成します 手動では何も行う必要はありません。
    - 既定では、Hyper-V ホスト サーバーの Windows ファイアウォールで、ポート 8083 と 8084 (認証用) が開きます。
    - **Kerberos** を選択した場合は、ホスト サーバーの相互認証に Kerberos チケットが使用されます。 Kerberos は、Windows Server 2012 R2 以降で実行されている Hyper-V ホスト サーバーだけに関連します。
1. **[コピーの頻度]** で、初期レプリケーションの後、差分データをレプリケートする頻度 (30 秒ごと、5 分ごと、または 15 分ごと) を指定します。
2. **[復旧ポイントの保持期間]** で、各復旧ポイントのリテンション期間の長さ (時間単位) を指定します。 レプリケートされたマシンは期間内のどのポイントにも復旧できます。
3. **[アプリ整合性スナップショットの頻度]** で、アプリケーション整合性スナップショットを含む復旧ポイントの作成頻度 (1 - 12 時間) を指定します。 Hyper-V では、2 種類のスナップショットが使用されます。
    - **標準スナップショット**: 仮想マシン全体の増分スナップショットを提供します。
    - **アプリ整合性スナップショット**: VM 内でアプリケーション データのある時点のスナップショット ボリューム シャドウ コピー サービス (VSS) によって、スナップショットの作成時、アプリの整合性が維持されます。 アプリ整合性スナップショットを有効にすると、ソース VM のアプリ パフォーマンスに影響が出ます。 構成する追加の復旧ポイントより少ない値を設定してください。
4. **[データ転送の圧縮]** で、転送されるレプリケーション データを圧縮するかどうかを指定します。
5. ソース VM の保護を無効にする場合はレプリカ仮想マシンを削除するように指定するために、**[レプリカ VM の削除]** をオンにします。 この設定を有効にすると、ソース VM の保護を無効にしたときに、Site Recovery コンソールからのソース VM の削除、VMM コンソールからの VMM の Site Recovery 設定の削除、レプリカの削除が行われます。
6. ネットワーク経由でレプリケートする場合は、**[初期レプリケーションの方法]** で、初期レプリケーションを開始するかスケジュールを設定するかを指定します。 ネットワーク帯域幅を節約するために、トラフィックの多い時間帯を避けてスケジュールを設定することをお勧めします。 次に、 **[OK]** をクリックします

     ![Replication policy](./media/hyper-v-vmm-disaster-recovery/replication-policy.png)
     
7. 新しいポリシーは、自動的に VMM クラウドに関連付けられます。 **[レプリケーション ポリシー]** で **[OK]** をクリックします。 


## <a name="enable-replication"></a>レプリケーションを有効にする

1. **[アプリケーションをレプリケートする]** > **[ソース]** の順にクリックします。 
2. **[ソース]** で、VMM サーバーと、レプリケートする Hyper-V ホストが配置されているクラウドを選択します。 次に、 **[OK]** をクリックします
3. **[ターゲット]** で、セカンダリ VMM サーバーとクラウドを確認します。
4. **[仮想マシン]** で、保護する VM を一覧から選択します。


**[ジョブ]** > **[Site Recovery ジョブ]** の順にクリックして、**[保護を有効にする]** アクションの進行状況を追跡できます。 **[保護の最終処理]** ジョブが完了すると、初期レプリケーションが完了し、VM がフェールオーバーを実行できる状態になります。

## <a name="next-steps"></a>次の手順

[ディザスター リカバリーのテストを実行する](hyper-v-vmm-test-failover.md)
