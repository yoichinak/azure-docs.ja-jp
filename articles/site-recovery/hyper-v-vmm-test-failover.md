---
title: Azure Site Recovery を使用してセカンダリサイトに対して Hyper-V VM の DR ドリルを実行する | Microsoft Docs
description: Azure Site Recovery を使用して、セカンダリ データセンターに対して VMM クラウド内の Hyper-V VM の DR ドリルを実行する方法について説明します。
services: site-recovery
author: ponatara
manager: abhemraj
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: ponatara
ms.openlocfilehash: 03533af27ac6fd406b4639c31c3add0015a76f45
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37918800"
---
# <a name="run-a-dr-drill-for-hyper-v-vms-to-a-secondary-site"></a>セカンダリサイトに対して Hyper-V VM の DR ドリルを実行する


この記事では、[Azure Site Recovery](site-recovery-overview.md) を使用して、セカンダリ オンプレミス サイトに対して System Center Virtual Machine Manager V(MM) クラウドで管理されている Hyper-V VM のディザースター リカバリー (DR) ドリルを実行する方法について説明します。

テスト フェールオーバーを実行し、データの損失またはダウンタイムを発生させることなく、レプリケーション戦略の検証と DR ドリルを行います。 テスト フェールオーバーは、実行中のレプリケーションや運用環境に影響はありません。 

## <a name="how-do-test-failovers-work"></a>テスト フェールオーバーの機能

プライマリ サイトからセカンダリ サイトへのテスト フェールオーバーを実行します。 VM がフェールオーバーしているかどうかのみを確認する場合は、セカンダリ サイトに何も設定せずにテスト フェールオーバーを実行します。 アプリケーションのフェールオーバーが適切に動作するかどうかを確認するには、セカンダリの場所にネットワークとインフラストラクチャを設定する必要があります。
- 単一の VM、または[復旧計画](site-recovery-create-recovery-plans.md)でテスト フェールオーバーを実行できます。
- ネットワークを使用しない、既存のネットワークを使用する、または自動的に作成されたネットワークを使用するという条件でテスト フェールオーバーを実行できます。 これらのオプションの詳細については、以下の表を参照してください。
    - ネットワークを使用せずにテスト フェールオーバーを実行できます。 このオプションは、VM がフェールオーバーできることを確認するだけで、ネットワーク構成を確認することはできません。
    - 既存のネットワークでフェールオーバーを実行します。 運用ネットワークは使用しないことをお勧めします。
    - フェールオーバーを実行して、Site Recovery でテスト ネットワークを自動的に作成します。 この場合、Site Recovery でネットワークが自動的に作成され、テスト フェールオーバーが完了するとクリーン アップされます。
- テスト フェールオーバーのリカバリ ポイントを選択する必要があります。 
    - **[最後に処理があった時点]**: Site Recovery によって処理された最新の復旧ポイントに VM をフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
    - **[最新のアプリ整合性]**: Site Recovery によって処理されたアプリケーション整合性の最新の復旧ポイントに VM をフェールオーバーします。 
    - **最新**: このオプションは、Site Recovery サービスに送信されたすべてのデータを最初に処理して、各 VM の復旧ポイントを作成してから、それにフェールオーバーします。 このオプションは、フェールオーバー後に作成された VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
    - **最新のマルチ VM 処理**: マルチ VM 整合性が有効にされている 1 台または複数の VM を含む復旧計画で使用できます。 設定が有効にされている VM は、最新の共通マルチ VM 整合性復旧ポイントにフェールオーバーされます。 その他の VM は、最新の処理済み復旧ポイントにフェールオーバーされます。
    - **最新のマルチ VM アプリ整合性**: このオプションは、マルチ VM 整合性がオンになっている 1 台または複数の VM を含む復旧計画で使用できます。 レプリケーション グループに含まれる VM は、最新の共通マルチ VM アプリケーション整合性復旧ポイントにフェールオーバーされます。 その他の VM は、最新のアプリケーション整合性復旧ポイントにフェールオーバーされます。
    - **カスタム**: 特定の VM を特定の復旧ポイントにフェールオーバーする場合は、このオプションを使用します。



## <a name="prepare-networking"></a>ネットワークの準備

表にまとめられているように、テスト フェールオーバーの実行時には、テスト レプリカ マシン用のネットワーク設定を選択することが求められます。

**オプション** | **詳細** 
--- | --- 
**なし** | テスト VM は、レプリカ VM が存在するホストに作成されます。 クラウドには追加されず、ネットワークに接続されていません。<br/><br/> マシンの作成後に VM ネットワークに接続することはできません。
**[既存のものを使用]** | テスト VM は、レプリカ VM が存在するホストに作成されます。 クラウドには追加されません。<br/><br/>運用ネットワークから分離された VM ネットワークを作成します。<br/><br/>VLAN ベースのネットワークを使用する場合は、この目的用の独立した (運用環境で使用されない) 論理ネットワークを VMM で作成することをお勧めします。 この論理ネットワークは、テスト フェールオーバー用の VM ネットワークの作成に使用されます。<br/><br/>この論理ネットワークは、仮想マシンをホストしているすべての Hyper-V サーバーのネットワーク アダプターのうち少なくとも 1 つに関連付けする必要があります。<br/><br/>VLAN 論理ネットワークの場合、論理ネットワークに追加するネットワーク サイトは分離されている必要があります。<br/><br/>Windows ネットワーク仮想化ベースの論理ネットワークを使用している場合、分離された VM ネットワークが Azure Site Recovery によって自動的に作成されます。 
**ネットワークの作成** | 一時的なテスト ネットワークは、**論理ネットワーク**とそれに関連するネットワーク サイトで指定した設定に基づいて、自動的に作成されます。<br/><br/> フェールオーバーでは、VM が作成されることが確認されます。 |このオプションは、復旧計画で複数の VM ネットワークを使用する場合に使用します。<br/><br/> Windows ネットワーク仮想化ネットワークを使用する場合には、このオプションにより、レプリカ仮想マシンのネットワーク内に同じ設定 (サブネットおよび IP アドレス プール) を持つ VM ネットワークを自動的に作成できます。 これらの VM ネットワークは、テスト フェールオーバーの完了後に自動的にクリーンアップされます。<br/><br/> テスト VM は、レプリカ仮想マシンが存在するホスト上に作成されます。 クラウドには追加されません。

### <a name="best-practices"></a>ベスト プラクティス

- 運用環境のネットワークでテストを行うと、運用環境のワークロードでダウンタイムが発生します。 ディザスター リカバリー訓練の実施中は、ユーザーにアプリを使用しないように依頼してください。

- テスト ネットワークは、テスト フェールオーバーで使用される VMM 論理ネットワークの種類と一致する必要はありません。 ただし、いくつかの組み合わせは機能しません。

     - レプリカが DHCP と VLAN ベースの分離を使用する場合、レプリカの VM ネットワークには、静的 IP アドレス プールは必要ありません。 このため、Windows ネットワーク仮想化を使用してテスト フェールオーバーを実行しようとすると、使用できるアドレス プールがないため失敗します。 
        
     - レプリカ ネットワークが分離を使用せず、テスト ネットワークが Windows ネットワーク仮想化を使用する場合、テスト フェールオーバーは失敗します。 これは、分離なしのネットワークには、Windows ネットワーク仮想化ネットワークの作成に必要なサブネットがないためです。
        
- ネットワーク マッピング用に選択したネットワークはテスト フェールオーバーでは使用しないことをお勧めします。

- フェールオーバー後にマップされた VM ネットワークにレプリカ仮想マシンが接続される方法は、VMM コンソールでの VM ネットワークの構成方法によって異なります。


### <a name="vm-network-configured-with-no-isolation-or-vlan-isolation"></a>分離なしまたは VLAN 分離で構成された VM ネットワーク

VM ネットワーク内に VM ネットワークが分離なし、または VLAN 分離で構成されている場合は、次の点に注意してください。

- VM ネットワークに DHCP が定義されている場合、レプリカ仮想マシンは、関連する論理ネットワーク内のネットワーク サイトに指定されている設定を使用して、VLAN ID に接続されます。 仮想マシンは、使用可能は DHCP サーバーから IP アドレスを受け取ります。
- ターゲットの VM ネットワークに対して静的 IP アドレス プールを定義する必要はありません。 VM ネットワークに静的 IP アドレス プールが使用されている場合、レプリカ仮想マシンは、関連する論理ネットワーク内のネットワーク サイトに指定されている設定を使用して、VLAN ID に接続されます。
- 仮想マシンは、VM ネットワークに定義されているプールから IP アドレスを受け取ります。 静的 IP アドレス プールがターゲット VM ネットワーク上で定義されていない場合、IP アドレスの割り当ては失敗します。 IP アドレス プールは、保護と復旧に使用するソースとターゲットの両方の VMM サーバー上で作成します。

### <a name="vm-network-with-windows-network-virtualization"></a>Windows ネットワーク仮想化を使用する VM ネットワーク

Windows ネットワーク仮想化を使用して VM ネットワークを構成する場合は、次の点に注意してください。

- ソース VM ネットワークが DHCP または静的 IP アドレス プールを使用するように構成されているかどうかに関係なく、ターゲット VM ネットワークに対して静的プールを定義する必要があります。 
- DHCP を定義する場合、ターゲット VMM サーバーは、DHCP サーバーとして機能し、ターゲット VM ネットワークに対して定義されているプールから IP アドレスを提供します。
- ソース サーバーに静的 IP アドレス プールの使用が定義されている場合、ターゲット VMM サーバーは、プールから IP アドレスを割り当てます。 どちらの場合も、静的 IP アドレス プールが定義されていないと、IP アドレスの割り当ては失敗します。



## <a name="prepare-the-infrastructure"></a>インフラストラクチャの準備

VM がフェールオーバーできるかどうかのみを確認する場合は、インフラストラクチャなしでテスト フェールオーバーを実行できます。 アプリケーションのフェールオーバーをテストするために完全な DR ドリルを実行する場合は、セカンダリ サイトでインフラストラクチャを準備する必要があります。

- 既存のネットワークを使用してテスト フェールオーバーを実行する場合は、そのネットワーク内に Active Directory、DHCP、および DNS を準備します。
- VM ネットワークを自動的に作成するオプションを使用してテスト フェールオーバーを実行する場合は、テスト フェールオーバーを実行する前に、自動的に作成されたネットワークにインフラストラクチャ リソースを追加する必要があります。 復旧計画の場合、テスト フェールオーバーに使用する復旧計画の Group-1 の前に手動手順を追加することで、この処理を簡単にすることができます。 次に、テスト フェールオーバーを実行する前に自動的に作成されたネットワークにインフラストラクチャ リソースを追加します。


### <a name="prepare-dhcp"></a>DHCP の準備
テスト フェールオーバーに関係している仮想マシンが DHCP を使用する場合は、テスト フェールオーバー用の分離されたネットワーク内でテスト DHCP サーバーを作成します。


### <a name="prepare-active-directory"></a>Active Directory の準備
アプリケーションのテストのためにテスト フェールオーバーを実行するには、テスト環境内に Active Directory 運用環境のコピーが必要です。 詳細については、[Active Directory 用のテスト フェールオーバーの考慮事項](site-recovery-active-directory.md#test-failover-considerations)を参照してください。

### <a name="prepare-dns"></a>DNS の準備
次のように、テスト フェールオーバー用の DNS サーバーを準備します。

* **DHCP**: 仮想マシンが DHCP を使用する場合、テスト DHCP サーバーでテスト DNS の IP アドレスを更新する必要があります。 Windows ネットワーク仮想化のネットワーク タイプを使用している場合、VMM サーバーは DHCP サーバーとして機能します。 したがって、テスト フェールオーバー ネットワークの DNS の IP アドレスを更新する必要があります。 この場合、仮想マシンは関連する DNS サーバーに自身を登録します。
* **静的アドレス**: 仮想マシンが静的 IP アドレスを使用する場合、テスト フェールオーバー ネットワークでテスト DNS サーバーの IP アドレスを更新する必要があります。 場合によっては、テスト仮想マシンの IP アドレスを DNS に反映することも必要です。 この目的のために、次のサンプル スクリプトを使用することができます。

        Param(
        [string]$Zone,
        [string]$name,
        [string]$IP
        )
        $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
        $newrecord = $record.clone()
        $newrecord.RecordData[0].IPv4Address  =  $IP
        Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord



## <a name="run-a-test-failover"></a>テスト フェールオーバーの実行

この手順では、復旧計画のテスト フェールオーバーを実行する方法について説明します。 別の方法として、**[仮想マシン]** タブで、単一の仮想マシンに対するフェールオーバーを実行することもできます。

1. **[復旧計画]**  >  *recoveryplan_name* を選択します。 **フェールオーバー** > **Test フェールオーバー**で投稿してください。
2. **[テスト フェールオーバー]** ブレードで、テスト フェールオーバー後にレプリカ VM をネットワークに接続する方法を指定します。
3. **[ジョブ]** タブで、フェールオーバーの進行状況を追跡します。
4. フェールオーバーが完了したら、VM が正常に起動することを確認します。
5. 完了したら、復旧計画の **[テスト フェールオーバーのクリーンアップ]** をクリックします。 **[メモ]** を使用して、テスト フェールオーバーに関連する観察結果をすべて記録し、保存します。 この手順により、テスト フェールオーバー中に Site Recovery によって作成された VM とネットワークが削除されます。 

![[テスト フェールオーバー]](./media/hyper-v-vmm-test-failover/TestFailover.png)
 


> [!TIP]
> テスト フェールオーバー中に仮想マシンに指定された IP アドレスは、仮想マシンが計画されたフェールオーバーや計画されていないフェールオーバー中に受信するのと同じ IP アドレスです (IP アドレスはテスト フェールオーバー ネットワークで利用可能であることが前提)。 テスト フェールオーバー ネットワークで同じ IP が使用できない場合、仮想マシンは、テスト フェールオーバー ネットワークで利用できる別の IP を受信します。



### <a name="run-a-test-failover-to-a-production-network"></a>運用ネットワークに対してテスト フェールオーバーを実行する

ネットワーク マッピング中に指定した運用復旧サイト ネットワークに対してテスト フェールオーバーを実行しないことをお勧めします。 ただし、フェールオーバーされた VM でエンド ツー エンドのネットワーク接続を実際に検証する必要がある場合は、次の点に注意してください。

* テスト フェールオーバーを実行するときは、プライマリ VM がシャットダウンされていることを確認します。 そうしないと、同じ ID を持つ 2 つの仮想マシンが同じネットワークで同時に実行されることになります。 その場合、望ましくない結果になることがあります。
* テスト フェールオーバー VM に加えた変更は、テスト フェールオーバー VM をクリーンアップすると失われます。 これらの変更は、プライマリ VM にはレプリケートされません。
* このようなテスト方法では、運用アプリケーションのダウンタイムにつながります。 DR ドリルの実行中はアプリケーションのユーザーにアプリケーションを使用しないように指示してください。  


## <a name="next-steps"></a>次の手順
DR ドリルの実行に成功すると、[完全フェールオーバー](site-recovery-failover.md)を実行できます。



