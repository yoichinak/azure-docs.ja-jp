---
title: Azure Site Recovery での Hyper-V から Azure へのレプリケーション アーキテクチャ | Microsoft Docs
description: この記事では、(VMM を使用せずに) Azure Site Recovery サービスを使用してオンプレミスの Hyper-V VM を Azure にレプリケートするときに使用されるコンポーネントとアーキテクチャの概要を説明します。
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: raynew
ms.openlocfilehash: c5d31b6217d3afe8ddb3550c145820be5996c96a
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37920605"
---
# <a name="hyper-v-to-azure-replication-architecture"></a>Hyper-V から Azure へのレプリケーション アーキテクチャ


この記事では、[Azure Site Recovery](site-recovery-overview.md) サービスを使用してオンプレミスの Hyper-V ホストと Azure 間で Hyper-V 仮想マシン (VM) をレプリケート、フェールオーバー、および復旧する場合に使用されるアーキテクチャとプロセスについて説明します。

Hyper-V ホストは、必要に応じて System Center Virtual Machine Manager (VMM) プライベート クラウドで管理できます。



## <a name="architectural-components---hyper-v-without-vmm"></a>アーキテクチャのコンポーネント - Hyper-V (VMM なし)

次の表と図は、Hyper-V ホストを VMM で管理していない場合に Azure への Hyper-V レプリケーションに使用するコンポーネントの概要を示したものです。

**コンポーネント** | **要件** | **詳細**
--- | --- | ---
**Azure** | Azure サブスクリプション、Azure ストレージ アカウント、および Azure ネットワーク。 | オンプレミスの VM ワークロードからレプリケートされたデータはストレージ アカウントに格納されます。 オンプレミス サイトからのフェールオーバーが発生したときにそのレプリケートされたワークロード データで Azure VM が作成されます。<br/><br/> Azure VM は、作成時に Azure 仮想ネットワークに接続します。
**Hyper-V** | Site Recovery のデプロイ中には、Hyper-V サイトに Hyper-V ホストとクラスターを収集します。 Azure Site Recovery プロバイダーと Recovery Services エージェントは、各スタンドアロン Hyper-V ホスト、または各 Hyper-V クラスター ノードにインストールします。 | Site Recovery を使用したレプリケーションは、Site Recovery プロバイダーがインターネット経由で統制します。 Recovery Services エージェントは、データ レプリケーションを担います。<br/><br/> プロバイダーとエージェントの両方からの通信は、セキュリティで保護され、暗号化されます。 Azure Storage 内のレプリケートされたデータも暗号化されます。
**Hyper-V VM** | Hyper-V を実行する 1 つ以上の VM。 | VM に明示的にインストールする必要があるものはありません。


**Hyper-V から Azure へのアーキテクチャ (VMM なし)**

![アーキテクチャ](./media/hyper-v-azure-architecture/arch-onprem-azure-hypervsite.png)



## <a name="architectural-components---hyper-v-with-vmm"></a>アーキテクチャのコンポーネント - Hyper-V (VMM あり)

次の表と図は、Hyper-V ホストを VMM クラウドで管理している場合に Azure への Hyper-V レプリケーションに使用するコンポーネントの概要を示したものです。

**コンポーネント** | **要件** | **詳細**
--- | --- | ---
**Azure** | Azure サブスクリプション、Azure ストレージ アカウント、および Azure ネットワーク。 | オンプレミスの VM ワークロードからレプリケートされたデータはストレージ アカウントに格納されます。 オンプレミス サイトからのフェールオーバーが発生したときにそのレプリケートされたデータで Azure VM が作成されます。<br/><br/> Azure VM は、作成時に Azure 仮想ネットワークに接続します。
**VMM サーバー** | VMM サーバーに、Hyper-V ホストを含むクラウドが 1 つ以上存在する。 | VMM サーバーで、Site Recovery プロバイダーをインストールして Site Recovery でレプリケーションを調整し、サーバーを Recovery Services コンテナーに登録します。
**Hyper-V ホスト** | VMM で管理されている 1 つ以上の Hyper-V ホスト/クラスター。 |  各 Hyper-V ホストまたはクラスター ノードに Recovery Services エージェントをインストールします。
**Hyper-V VM** | Hyper-V ホスト サーバー上で実行されている 1 つ以上の VM。 | VM に明示的にインストールする必要があるものはありません。
**ネットワーク** | VMM サーバー上に設定された論理ネットワークおよび VM ネットワーク。 VM ネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。 | VM ネットワークは、Azure 仮想ネットワークにマッピングされます。 Azure VM がフェールオーバー後に作成されると、VM ネットワークにマッピングされている Azure ネットワークに追加されます。

**Hyper-V から Azure へのアーキテクチャ (VMM あり)**

![コンポーネント](./media/hyper-v-azure-architecture/arch-onprem-onprem-azure-vmm.png)



## <a name="replication-process"></a>レプリケーション プロセス

![Hyper-V から Azure へのレプリケーション](./media/hyper-v-azure-architecture/arch-hyperv-azure-workflow.png)

**レプリケーションと回復プロセス**


### <a name="enable-protection"></a>保護を有効にする

1. Hyper-V VM の保護を有効にした後、Azure Portal またはオンプレミスで、**保護の有効化**が始まります。
2. このジョブは、マシンが前提条件を満たしていることを確認してから、構成された設定を使用してレプリケーションをセットアップするために、[CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx) を呼び出します。
3. ジョブが [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) メソッドを呼び出して初期レプリケーションを開始し、完全 VM レプリケーションを初期化して、VM の仮想ディスクを Azure に送信します。
4. ジョブは **[ジョブ]** タブで監視できます。    ![ジョブ一覧](media/hyper-v-azure-architecture/image1.png) ![[保護を有効にする] の詳細](media/hyper-v-azure-architecture/image2.png)


### <a name="initial-data-replication"></a>初期データ レプリケーション

1. 初期レプリケーションがトリガーされると、[Hyper-V VM スナップショット](https://technet.microsoft.com/library/dd560637.aspx)が作成されます。
2. VM の仮想ハード ディスクは、すべてが Azure にコピーされるまで、1 つずつレプリケートされます。 VM サイズとネットワーク帯域幅によっては、しばらく時間がかかる場合があります。 ネットワーク帯域幅を広げる方法を[確認](https://support.microsoft.com/kb/3056159)してください。
3. 初期レプリケーションの進行中にディスクの変更が発生した場合、Hyper-V レプリカ レプリケーション トラッカーはそれらの変更を Hyper-V レプリケーション ログ (.hrl) として追跡します。 これらのログ ファイルは、ディスクと同じフォルダーに配置されます。 各ディスクには関連付けられた .hrl ファイルが存在し、これらはセカンダリ ストレージに送信されます。 初期レプリケーションの進行中は、スナップショットおよびログ ファイルによってディスク リソースが消費されます。
4. 初期レプリケーションが完了すると、VM スナップショットは削除されます。
5. ログの差分ディスク変更は、親ディスクに同期され、マージされます。


### <a name="finalize-protection-process"></a>保護の最終処理プロセス

1. 初期レプリケーションが完了すると、 **仮想マシンでの保護の最終処理** ジョブが実行されます。 VM が保護されるようにネットワークとその他のレプリケーション後の設定を構成します。
2. この段階で、VM の設定をチェックして、フェールオーバーできる状態であるかどうかを確認できます。 VM のディザスター リカバリーの訓練 (フェールオーバーのテスト) を実行して、期待どおりにフェールオーバーされることを確認できます。 


## <a name="delta-replication"></a>差分レプリケーション

1. 初期レプリケーション後は、レプリケーション ポリシーに従って差分レプリケーションが開始されます。
2. Hyper-V レプリカのレプリケーション トラッカーは、仮想ハード ディスクへの変更を .hrl ファイルとして追跡します。 レプリケーション用に構成された各ディスクには、関連付けられた .hrl ファイルがあります。
3. ログは、お客様のストレージ アカウントに送信されます。 ログが Azure に送信される間、プライマリ ディスクでの変更は、同じフォルダー内の別のログ ファイルで追跡されます。
4. 初期レプリケーションおよび差分レプリケーション中は、Azure Portal で VM を監視できます。

### <a name="resynchronization-process"></a>再同期プロセス

1. 差分レプリケーションに失敗した場合、完全なレプリケーションが帯域幅または時間の観点からコスト高になるときは、VM に再同期のマークが付けられます。
    - たとえば、.hrl ファイルがディスク サイズの 50% に達した場合、VM には再同期のマークが付けられます。
    -  既定では再同期は業務時間外に自動的に実行するようにスケジュールされます。
1.  再同期は、差分データのみを送信します。
    - ソースとターゲットの VM のチェックサムを計算して、送信されるデータ量を最小限に抑えます。
    - 再同期では、ソース ファイルとターゲット ファイルを固定チャンクに分割する固定ブロック チャンク アルゴリズムが使用されます。
    - 各チャンクのチェックサムが生成されます。 チェックサムを比較することによって、ソース側のどのブロックをターゲットに適用すべきかが判断されます。
2. 再同期が完了すると、通常の差分レプリケーションが再開されます。
3. 既定の業務時間外の再同期を待ちたくない場合は、VM を手動で再同期できます。 たとえば、障害が発生した場合などです。 そのためには、Azure Portal で VM を選択し、**[再同期]** を選択します。

    ![Manual resynchronization](./media/hyper-v-azure-architecture/image4-site.png)


### <a name="retry-process"></a>プロセスの再試行

レプリケーション エラーが発生した場合に備えて、組み込み再試行があります。 再試行は、表に示すように分類されます。

**カテゴリ** | **詳細**
--- | ---
**回復不可能なエラー** | 再試行は行われません。 VM の状態が **[重大]** になり、管理者による操作が必要になります。<br/><br/> たとえば、VHD チェーンの破損、レプリカ VM の無効な状態、ネットワーク認証エラー、承認エラー、VM 未検出エラー (スタンドアロン Hyper-V サーバーの場合) などのエラーがあります
**回復可能なエラー** | レプリケーション間隔ごとに、再試行が行われます。再試行の間隔は、最初の試行が開始された後、指数関数的バックオフを使用して、1、2、4、8、および 10 分ずつ長くなります。 エラーが解決しない場合は、30 分ごとに再試行してください。 このような例として、ネットワーク エラー、ディスク領域不足エラー、メモリ不足状態などがあります



## <a name="failover-and-failback-process"></a>フェールオーバーとフェールバックのプロセス

1. 計画または計画外フェールオーバーをオンプレミスの Hyper-V VM から Azure に実行できます。 予定されたフェールオーバーを実行する場合、データが決して失われないように、ソース側の VM はシャット ダウンされます。 プライマリ サイトにアクセスできない場合は、計画されていないフェールオーバーを実行します。
2. 単一のマシンをフェールオーバーするか、複数のマシンのフェールオーバーを調整するための復旧計画を作成することができます。
3. フェールオーバーを実行します。 フェールオーバーの第 1 段階が完了すると、Azure に作成されたレプリカ VM が表示されるようになります。 必要に応じて、VM にパブリック IP アドレスを割り当てることができます。
4. その後、フェールオーバーをコミットして、レプリカの Azure VM からワークロードへのアクセスを開始します。

オンプレミスのインフラストラクチャが再起動すると、フェールバックを行えます。 フェールバックは 3 段階で発生します。

1. Azure からオンプレミス サイトへの計画フェールオーバーを開始します。
    - **ダウンタイムを最小限に抑える**:このオプションを使用すると、Site Recovery はフェールオーバーする前にデータを同期します。 変更されたデータ ブロックをチェックし、オンプレミス サイトにそれらのデータ ブロックをダウンロードします。また、Azure VM は稼働し続け、ダウンタイムを最小限に抑えます。 フェールオーバーが完了しなければならないことを手動で指定した場合は、Azure VM がシャット ダウンされ、最後の差分変更がすべてコピーされ、フェールオーバーが開始されます。
    - **完全なダウンロード**: このオプションを使用すると、フェールオーバー中にデータが同期されます。 このオプションは、ディスク全体をダウンロードします。 チェックサムは計算されないため高速ですが、ダウンタイムが長くなります。 レプリカ Azure VM をしばらくの間稼働させていた場合や、オンプレミス VM が削除された場合は、このオプションを使用します。
    - **VM の作成**: 同じ VM または別の VM にフェールバックするように選択できます。 VM が存在しない場合は Site Recovery が VM を作成するように指定できます。

2. 初期同期が完了したら、フェールオーバーを完了するよう選択します。 これが完了したら、オンプレミス VM にログインして、すべてが期待どおりに動作していることを確認できます。 Azure Portal では、Azure VM が停止していることがわかります。
3.  その後、フェールオーバーをコミットして終了させ、オンプレミス VM からワークロードへのアクセスを開始します。
4. ワークロードがフェールバックされると、オンプレミス VM が再び Azure にレプリケートするように、レプリケーションの反転を有効にします。



## <a name="next-steps"></a>次の手順


Hyper-V から Azure へのレプリケーションの使用を開始するには、[このチュートリアル](tutorial-prepare-azure.md)に従ってください。


