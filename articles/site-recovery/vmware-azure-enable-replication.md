---
title: Azure Site Recovery を使用して Azure への VMware VM の レプリケーションを有効にする | Microsoft Docs
description: この記事では、Azure Site Recovery を使用して Azure への VMware VM のレプリケーションを設定する方法について説明します。
services: site-recovery
author: asgang
ms.service: site-recovery
ms.date: 07/06/2018
ms.topic: conceptual
ms.author: asgang
ms.openlocfilehash: 9a868b196a287b7a5121803136d3c0119f64d9fe
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37917025"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Azure への VMware VM のレプリケーションを有効にする


この記事では、Azure へのオンプレミス VMware VM のレプリケーションを有効にする方法について説明します。

## <a name="prerequisites"></a>前提条件

この記事では、以下のことを前提としています。

1.  [オンプレミスのソース環境の設定](vmware-azure-set-up-source.md)。
2.  [Azure でのターゲット環境の設定](vmware-azure-set-up-target.md)。


## <a name="before-you-start"></a>開始する前に
VMware 仮想マシンをレプリケートする場合:

* Azure ユーザー アカウントには、新しい仮想マシンを Azure にレプリケートできるようにするための特定の[アクセス許可](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines)が必要です。
* VMware VM の検出は 15 分ごとに行われます。 検出後、Azure Portal に表示されるまで 15 分以上かかることがあります。 同様に、新しい vCenter サーバーまたは vSphere ホストを追加したときも、検出に 15 分以上かかることがあります。
* 仮想マシンの環境の変更 (VMware ツールのインストールなど) 内容がポータルで更新されるまでには 15 分以上かかることがあります。
* **[構成サーバー]** ページにある vCenter サーバー/vSphere ホストの **[最後の使用]** フィールドで、VMware VM の最終検出時刻を確認できます。
* 定期検出を待たずにレプリケートするマシンを追加するには、構成サーバーを強調表示し (クリックしないでください)、**[更新]** ボタンをクリックします。
* レプリケーションを有効にした場合、マシンの準備が完了すると、プロセス サーバーではモビリティ サービスが自動的にインストールされます。


## <a name="enable-replication"></a>レプリケーションを有効にする

1. **[手順 2: アプリケーションをレプリケートする]** > **[ソース]** の順にクリックします。 レプリケーションを初めて有効にした後は、コンテナーで **[+ レプリケート]** をクリックして、追加のマシンのレプリケーションを有効にします。
2. **[ソース]** ページで **[ソース]** をクリックし、構成サーバーを選択します。
3. **[マシンの種類]** で、**[仮想マシン]** または **[物理マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。 物理マシンをレプリケートする場合、この設定は関係ありません。
5. プロセス サーバーを選択します。追加のプロセス サーバーを作成していない場合、これは構成サーバーの名前になります。 次に、 **[OK]** をクリックします

    ![レプリケーション ソースを有効にする](./media/vmware-azure-enable-replication/enable-replication2.png)

6. **[ターゲット]** で、フェールオーバー対象の仮想マシンを作成するサブスクリプションとリソース グループを選択します。 Azure で、フェールオーバーされた仮想マシンに使用するデプロイ モデルを選択します。

7. データのレプリケーションに使用する Azure Storage アカウントを選択します。 

    > [!NOTE]

    >   * Premium または Standard ストレージ アカウントを選択できます。 Premium アカウントを選択した場合は、継続的なレプリケーション ログ用に追加の Standard ストレージ アカウントを指定する必要があります。 アカウントは、Recovery Services コンテナーと同じリージョンに存在する必要があります。
    >   * 異なるストレージ アカウントを使用する場合は、[作成](../storage/common/storage-create-storage-account.md)できます。 Resource Manager を使用してストレージ アカウントを作成する場合は、**[新規作成]** をクリックします。 

8. フェールオーバー後に Azure VM がスピンアップされたときに接続する Azure ネットワークとサブネットを選択します。 ネットワークは、Recovery Services コンテナーと同じリージョンにある必要があります。 保護の対象として選択したすべてのマシンにネットワーク設定を適用する場合は、**[選択したマシン用に今すぐ構成します。]** を選択します。 マシンごとに Azure ネットワークを選択する場合は、**[後で構成する]** を選択します。 ネットワークがない場合は、[作成する](#set-up-an-azure-network)必要があります。 Resource Manager を使用してネットワークを作成する場合は、**[新規作成]** をクリックします。 該当する場合は、サブネットを選択し、**[OK]** をクリックします。

    ![レプリケーション ターゲットの設定を有効にする](./media/vmware-azure-enable-replication/enable-rep3.png)
9. **[Virtual Machines]** > **[仮想マシンの選択]** で、レプリケートする各マシンを選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 次に、 **[OK]** をクリックします

    ![[レプリケーションを有効にする] で仮想マシンを選択する](./media/vmware-azure-enable-replication/enable-replication5.png)
10. **[プロパティ]** > **[プロパティの構成]** で、モビリティ サービスをマシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。  
11. 既定では、すべてのディスクがレプリケートされます。 レプリケーションからディスクを除外するには、**[すべてのディスク]** をクリックし、レプリケートしないディスクをオフにします。  次に、 **[OK]** をクリックします 後で追加のプロパティを設定できます。 ディスクの除外の詳細については、[こちら](vmware-azure-exclude-disk.md)をご覧ください。

    ![[レプリケーションを有効にする] でプロパティを構成する](./media/vmware-azure-enable-replication/enable-replication6.png)

12. **[レプリケーションの設定]** > **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。 レプリケーション ポリシー設定を変更するには、**[設定]** > **[レプリケーション ポリシー]** > (ポリシー名) > **[設定の編集]** の順にクリックします。 ポリシーに適用した変更は、レプリケートしているマシンと新しいマシンにも適用されます。
13. マシンをレプリケーション グループにまとめる場合は、**[マルチ VM 整合性]** を有効にします。 グループの名前を指定し、**[OK]** をクリックします。 

    > [!NOTE]

    >    * レプリケーション グループのマシンはまとめてレプリケートされ、フェールオーバー時にクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを共有します。
    >    * VM と物理サーバーがワークロードをミラー化できるように、これらをまとめます。 マルチ VM 整合性を有効にすると、ワークロードのパフォーマンスに影響する場合があります。 複数のマシンが同じワークロードを実行していて、整合性を持たせる必要がある場合にのみ使用してください。

    ![レプリケーションを有効にする](./media/vmware-azure-enable-replication/enable-replication7.png)
14. **[レプリケーションを有効にする]** をクリックします。 **[設定]** > **[ジョブ]** > **[Site Recovery ジョブ]** の順にクリックして、**保護の有効化**ジョブの進行状況を追跡できます。 **保護の最終処理**ジョブが実行されると、マシンはフェールオーバーできる状態になります。

> [!NOTE]
> 保護が有効になっている場合、マシンでプッシュ インストールの準備が完了すると、モビリティ サービス コンポーネントがインストールされます。 コンポーネントがマシンにインストールされたら、保護ジョブが開始され、失敗します。 失敗後、各マシンを手動で再起動する必要があります。 再起動後に保護ジョブが再び開始され、初期レプリケーションが実行されます。
>
>

## <a name="view-and-manage-vm-properties"></a>VM プロパティを表示して管理する

次に、ソース マシンのプロパティを確認します。 Azure VM の名前は、[Azure 仮想マシンの要件](vmware-physical-azure-support-matrix.md#replicated-machines)に準拠している必要があります。

1. **[設定]** > **[レプリケートされたアイテム]** の順にクリックし、マシンを選択します。 **[要点]** ページにマシンの設定と状態に関する情報が表示されます。
2. **[プロパティ]** で、VM のレプリケーションとフェールオーバーの情報を確認できます。
3. **[コンピューティングとネットワーク]** > **[コンピューティングのプロパティ]** で、Azure VM の名前とターゲットのサイズを指定できます。 必要に応じて、Azure の要件に準拠するように名前を変更します。

    ![コンピューティングとネットワークのプロパティ](./media/vmware-azure-enable-replication/vmproperties.png)

4.  フェールオーバー後にマシンが属する[リソース グループ](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-resource-groups-guidelines)を選択できます。 この設定は、フェールオーバー前であればいつでも変更できます。 フェールオーバー後に、マシンを別のリソース グループに移行すると、マシンの保護設定が解除されます。
5. マシンがフェールオーバー後に[可用性セット](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-availability-sets-guidelines)に属する必要がある場合は、可用性セットを選択できます。 可用性セットを選択するときは、以下のことに注意してください。

    * 指定されたリソース グループに属している可用性セットだけが一覧表示されます。  
    * 異なる仮想ネットワークに属するマシンが同じ可用性セットに属することはできません。
    * 同じサイズの仮想マシンだけが同じ可用性セットに属することができます。
5. Azure VM に割り当てられるターゲット ネットワーク、サブネット、および IP アドレスに関する情報を表示および追加することもできます。
6. **[ディスク]** で、レプリケートされる VM のオペレーティング システム ディスクとデータ ディスクを確認できます。

### <a name="configure-networks-and-ip-addresses"></a>ネットワークと IP アドレスを構成する

- ターゲット IP アドレスを設定できます。 アドレスを指定しなかった場合、フェールオーバーされたマシンでは DHCP が使用されます。 フェールオーバーで使用できないアドレスを設定した場合、フェールオーバーは機能しません。 テスト フェールオーバー ネットワークでアドレスを利用できる場合、テスト フェールオーバーに同じターゲット IP アドレスを使用できます。
- ネットワーク アダプターの数は、次に示すように、ターゲット仮想マシンに指定したサイズによって異なります。
    - ソース マシン上のネットワーク アダプターの数が、ターゲット マシンのサイズに許可されているアダプターの数以下の場合、ターゲットのアダプターの数は、ソースと同じです。
    - ソース仮想マシン用のアダプターの数が、ターゲットのサイズに許可されている数を超える場合は、ターゲットの最大サイズが使用されます。
    たとえば、ソース マシンに 2 つのネットワーク アダプターがあり、ターゲット マシンのサイズでは 4 つまでサポートされている場合、ターゲット マシンのアダプターの数は、2 つになります。 ソース マシンに 2 つのアダプターがあり、サポートされているターゲット サイズでは 1 つしかサポートされていない場合、ターゲット マシンのアダプターは 1 つだけです。
    - 仮想マシンにネットワーク アダプターが複数ある場合、これらのアダプターはすべて同じネットワークに接続されます。 また、一覧で最初に表示されるアダプターが、Azure 仮想マシンの "*既定*" のネットワーク アダプターとなります。

### <a name="azure-hybrid-benefit"></a>Azure ハイブリッド特典

マイクロソフト ソフトウェア アシュランスのお客様は、Azure ハイブリッド特典を使用して、Azure に移行する Windows Server マシンのライセンス コストを節約したり、Azure をディザスター リカバリーに使用したりできます。 Azure ハイブリッド特典の利用資格がある場合は、フェールオーバー発生時に Azure Site Recovery によって作成される仮想マシンに、この特典が割り当てられるように指定できます。 これを行うには、次の手順を実行します。
- レプリケートされた仮想マシンの [コンピューティングとネットワーク] のプロパティ セクションに移動します。
- Azure ハイブリッド特典の利用資格がある Windows Server ライセンスを持っているかどうかの質問に答えます。
- チェック ボックスをオンにして、フェールオーバー発生時に作成されるマシンで、Azure ハイブリッド特典を適用するために使用できる、対象のソフトウェア アシュランス付き Windows Server ライセンスを持っていることを確認します。
- レプリケートされたマシンの設定を保存します。

Azure ハイブリッド特典の詳細については[こちら](https://aka.ms/azure-hybrid-benefit-pricing)をご覧ください。

## <a name="common-issues"></a>一般的な問題

* 各ディスクのサイズは 1 TB 未満である必要があります。
* OS ディスクは、ダイナミック ディスクではなく、ベーシック ディスクである必要があります。
* 第 2 世代/UEFI 対応仮想マシンでは、オペレーティング システム ファミリは Windows である必要があります。また、ブート ディスクは 300 GB 未満である必要があります。

## <a name="next-steps"></a>次の手順

保護を完了し、マシンが保護された状態になったら、[フェールオーバー](site-recovery-failover.md)を実行して、アプリケーションが Azure で動作するかどうかを確認できます。

保護を無効にする場合は、[登録と保護の設定をクリーンアップ](site-recovery-manage-registration-and-protection.md)する方法を確認します。
