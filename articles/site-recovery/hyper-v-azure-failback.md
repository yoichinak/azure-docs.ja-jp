---
title: Hyper-V 仮想マシンのオンプレミス サイトへのフェールバックの実行 | Microsoft Docs
description: Azure Site Recovery は、仮想マシンと物理サーバーのレプリケーション、フェールオーバー、回復を調整します。 Azure からオンプレミスのデータ センターにフェールバックする方法について説明します。
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: rajanaki
ms.openlocfilehash: fd171251ef465a28e4844901a529e0a3eaaf8f9d
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37920874"
---
# <a name="run-a-failback-for-hyper-v-vms"></a>Hyper-V VM のフェールバックの実行

この記事では、Site Recovery によって保護されている Hyper-V 仮想マシンをフェールバックする方法について説明します。

## <a name="prerequisites"></a>前提条件
1. [さまざまな種類のフェールバック](concepts-types-of-failback.md)とそれぞれの注意事項に関する詳細情報を既に読んだことを確認します。
1. プライマリ サイトの VMM サーバーまたは Hyper-V ホストサーバーが Azure に接続されていることを確認します。
2. 仮想マシンが**コミット**済みである必要があります。

## <a name="perform-failback"></a>フェールバックを実行する
プライマリからセカンダリの場所へのフェールオーバー後は、レプリケートされた仮想マシンは Site Recovery では保護されず、セカンダリの場所が "アクティブな場所" として機能するようになります。 復旧計画で VM をフェールバックするには、次のようにセカンダリ サイトからプライマリ サイトに対して計画されたフェールオーバーを実行します。 
1. **[復旧計画]**  >  *recoveryplan_name* を選択します。 **フェールオーバー** > **Planned フェールオーバー**で投稿してください。
2. **[計画されたフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。 フェールオーバーの方向に注意してください。 プライマリからのフェールオーバーが想定どおりに機能し、すべての仮想マシンがセカンダリの場所にある場合には、これは情報の提供のみを目的としています。
3. Azure からフェールバックする場合は、 **[データの同期 (Data Synchronization)]** で次の設定を選択してください。
    - **[フェールオーバーの前にデータを同期する (差分変更のみを同期する)]** - 仮想マシンをシャットダウンせずに同期するため、仮想マシンのダウンタイムが最小限に抑えられます。 この場合、次の手順を実行します。
        - フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
        - フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。 差分変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。

    - **[フェールオーバー中にのみデータを同期する (すべてダウンロードする)]** - このオプションのほうが高速です。
        - ほとんどのディスクを変更し、チェックサム計算に時間をかけたくない場合は、このオプションの方が高速です。 ディスクのダウンロードが実行されます。 また、オンプレミスの仮想マシンを削除した場合にも便利です。
        - Azure を長期間 (1 か月間以上) 実行している場合、またはオンプレミスの仮想マシンを削除した場合にこのオプションを使用することをお勧めします。 このオプションを選択しても、チェックサム計算は実行されません。


4. クラウドのデータ暗号化が有効になっている場合には、**[暗号化キー]** で、VMM サーバーへのプロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。
5. フェールオーバーを開始します。 フェールオーバーの進行状況は、 **[ジョブ]** タブで確認できます。
6. フェールオーバー前のデータを同期するオプションを選択した場合、初期データの同期が完了して、Azure で仮想マシンをシャットダウンする準備ができたら、**[ジョブ]**、[計画されたフェールオーバーのジョブ名]、**[フェールオーバーの実行]** の順にクリックします。 これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの VM が起動します。
7. これで仮想マシンにログオンして、それが想定どおりに使用できるかを検証できます。
8. 仮想マシンは、コミット保留中の状態になります。 **[コミット]** をクリックして、フェールオーバーをコミットします。
9. フェールバックを完了するために、 **[レプリケーションの反転]** をクリックして、プライマリ サイトの仮想マシンの保護を開始します。


元のプライマリ サイトにフェールバックするには、次の手順に従います。 この手順では、復旧計画の、計画されたフェールオーバーを実行する方法について説明します。 別の方法として、 **[仮想マシン]** タブで、単一の仮想マシンに対するフェールオーバーを実行することもできます。


## <a name="failback-to-an-alternate-location-in-hyper-v-environment"></a>Hyper-V 環境の別の場所にフェールバックする
[Hyper-V サイトと Azure](site-recovery-hyper-v-site-to-azure.md) の間での保護がデプロイされている場合は、Azure から別のオンプレミスの場所にフェールバックを実行できます。 これは、新しいオンプレミス ハードウェアを設定する必要がある場合に便利です。 これを行うには、次の手順を実行します。

1. 新しいハードウェアを設定する場合は、Windows Server 2012 R2 および Hyper-V のロールをサーバーにインストールします。
2. 元のサーバーに保存していたものと同じ名前を使用して、仮想ネットワーク スイッチを作成します。
3. フェールバックの対象を **[保護された項目]**  ->  **[保護グループ]**  ->  <ProtectionGroupName>  ->  <VirtualMachineName>で選択して、**[計画されたフェールオーバー]** を選択します。
4. **[計画されたフェールオーバーの確認]** select **[オンプレミスの仮想マシンが存在しない場合に作成 (Create on-premises virtual machine if it does not exist)]** で投稿してください。
5. [ホスト名] で、**仮想マシンを配置する、新しい Hyper-V ホスト サーバーを選択します。
6. [データの同期] で、オプション **[Synchronize the data before the failover]\(フェールオーバー前にデータを同期する\)** を選択することをお勧めします。 このオプションを指定すると、仮想マシンをシャットダウンせずに同期するため、ダウンタイムを最小限に抑えることができます。 その内容は次のとおりです。

    - フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
    - フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。 変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
    
7. チェックマークをクリックして、フェールオーバー (フェールバック) を開始します。
8. 初期の同期が終了し、Azure で仮想マシンをシャットダウンする準備ができたら、 **[ジョブ]** > <planned failover job> > **[フェールオーバーの実行]** で投稿してください。 これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの仮想マシンが起動します。
9. これでオンプレミスの仮想マシンにログオンして、すべてが想定どおりに動作するかどうかを検証できます。 **[コミット]** をクリックして、フェールオーバーを完了します。 コミットすることによって Azure 仮想マシンとそのディスクが削除され、再び VM が保護された状態になります。
10. **[レプリケーションの反転]** をクリックして、オンプレミス仮想マシンの保護を開始します。

    > [!NOTE]
    > "データの同期" 中にフェールバック ジョブを取り消した場合、オンプレミスの VM は破損状態となります。 データの同期によって Azure VM ディスクからオンプレミスのデータ ディスクに最新のデータがコピーされるので、同期が完了するまでは、ディスク データの一貫性が保たれていない可能性があるためです。 データの同期を取り消した後でオンプレミスの VM を起動する場合、その VM は起動しないおそれがあります。 フェールオーバーの再トリガーを行い、データの同期を完了してください。


## <a name="why-is-there-no-button-called-failback"></a>"フェールバック" という名前のボタンが存在しない理由
ポータルには、具体的に "フェールバック" という名称の付いた UI がありません。 フェールバックとは、退避した仮想マシンをプライマリ サイトに戻すための操作です。 定義上、フェールバックとは、仮想マシンを復旧からプライマリにフェールオーバーすることです。

フェールオーバーを開始すると、ブレードに仮想マシンの移動方向が表示されますが、方向が Azure からオンプレミスである場合、それがフェールバックです。

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a>計画されたフェールオーバーの UI 操作しかフェールバックには存在しない理由
Azure は高可用性環境であり、皆さんの仮想マシンはいつでも利用できる状態にあります。 フェールバックとは、退避したワークロードを再度オンプレミスで実行できるよう、わずかなダウンタイムを見込んで行う "計画された" 作業です。 この作業では、データの損失がないことが要求されます。 UI 操作として利用できるのが計画されたフェールオーバーのみであるのはそのためです。計画されたフェールオーバーで、Azure 内の VM を停止してから直近の変更をダウンロードし、データの損失を確実に防ぎます。

## <a name="do-i-need-a-process-server-in-azure-to-failback-to-hyper-v"></a>Azure では Hyper-V へのフェールバックのためにプロセス サーバーが必要ですか。
いいえ。プロセス サーバーは VMware 仮想マシンを保護する場合にのみ必要となります。 Hyper-V 仮想マシンの保護/フェールバックを行う場合、追加のコンポーネントをデプロイする必要はありません。


## <a name="time-taken-to-failback"></a>フェールバックにかかる時間
データの同期を完了させて、仮想マシンを起動するのにかかる時間は、さまざまな要因によって異なります。 必要な時間を理解できるように、データ同期中の処理内容を説明します。

データの同期では、仮想マシンのディスクのスナップショットが取得され、ブロックごとのチェックが開始され、そのチェックサムが計算されます。 算出されたチェックサムは、オンプレミスに送信され、オンプレミスにおける同じブロックのチェックサムと比較されます。 チェックサムが一致した場合、データ ブロックは転送されません。 チェックサムが一致しない場合、データ ブロックはオンプレミスに転送されます。 この転送に要する時間は、使用可能な帯域幅に依存します。 チェックサムの速度は、1 分あたり数 GB です。 

データのダウンロードにかかる時間を短縮するには、スレッドを増やしてダウンロードを並列処理するように MARS エージェントを構成します。 エージェントのダウンロード スレッドを変更する方法については、[こちらのドキュメント](https://support.microsoft.com/en-us/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)を参照してください。


## <a name="next-steps"></a>次の手順

**コミット**後、逆レプリケーション ("*レプリケーションの反転*") を開始できます。 この操作を境として、仮想マシンの保護の方向が再びオンプレミスから Azure となります。 このときにレプリケートされるのは、Azure で VM を停止した後に生じた変更のみです。つまり送信されるのは差分変更だけです。
