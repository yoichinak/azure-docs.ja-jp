---
title: Site Recovery でのフェールオーバー | Microsoft Docs
description: Azure Site Recovery は、仮想マシンと物理サーバーのレプリケーション、フェールオーバー、回復を調整します。 Azure またはセカンダリ データセンターへのフェールオーバーについて説明します。
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: ponatara
ms.openlocfilehash: 3ef52030f694b0f9ccf2bd10545918a4fae9f2ee
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37918307"
---
# <a name="failover-in-site-recovery"></a>Site Recovery でのフェールオーバー
この記事では、Site Recovery によって保護された仮想マシンと物理サーバーをフェールオーバーする方法について説明します。

## <a name="prerequisites"></a>前提条件
1. フェールオーバーを実行する前に、[テスト フェールオーバー](site-recovery-test-failover-to-azure.md)を行い、すべて想定どおりに実行されることを確認してください。
1. フェールオーバーの実行前にレプリケーション先の[ネットワークを準備](site-recovery-network-design.md)します。  

以下の表は、Azure Site Recovery に用意されているフェールオーバー オプションの説明です。 また、これらのオプションは、フェールオーバーのシナリオ別に示します。

| シナリオ | アプリケーションの復旧要件 | Hyper-V のワークフロー | VMware のワークフロー
|---|--|--|--|
|今後のデータセンター ダウンタイムのために計画されたフェールオーバー| 計画されたアクティビティが実行されるときに、アプリケーションのデータ損失がゼロ| Hyper-V の場合、ASR はユーザーが指定したコピー頻度でデータをレプリケートします。 計画されたフェールオーバーは、頻度をオーバーライドし、最終的な変更をレプリケートしてからフェールオーバーを開始するために使用します。 <br/> <br/> 1.  社内の変更管理プロセスに従って、メンテナンス期間を計画します。 <br/><br/> 2. ユーザーに次回のダウンタイムを通知します。 <br/><br/> 手順 3.ユーザー向けのアプリケーションをオフラインにします。<br/><br/>4. ASR ポータルを使用して計画されたフェールオーバーを開始します。 オンプレミスの仮想マシンは自動的にシャットダウンされます。<br/><br/>実質的なアプリケーションのデータ損失は 0 です <br/><br/>リテンション期間には、古い復旧ポイントを使用したいユーザー向けに、復旧ポイントのジャーナルも提供されます (Hyper-V のリテンション期間は 24 時間です)。| VMware の場合、ASR は CDP を使用して継続的にデータをレプリケートします。 フェールオーバーは、(アプリケーションのシャットダウン後を含む) 最新データにフェールオーバーするオプションをユーザーに与えます。<br/><br/> 1.変更管理プロセスに従って、メンテナンス期間を計画します <br/><br/>2. ユーザーに次回のダウンタイムを通知します <br/><br/>手順 3.  ユーザー向けのアプリケーションをオフラインにします。 <br/><br/>4.アプリケーションがオフラインになったら、ASR ポータルを使用して、最新ポイントへの計画されたフェールオーバーを開始します。 ポータルの [計画されていないフェールオーバー] オプションを使用して、最新のフェールオーバー ポイントを選択します。 オンプレミスの仮想マシンは自動的にシャットダウンされます。<br/><br/>実質的なアプリケーションのデータ損失は 0 です <br/><br/>リテンション期間には、古い復旧ポイントを使用したいユーザー向けに、復旧ポイントのジャーナルも提供されます (VMware のリテンション期間は 72 時間)。
|予定外のデータセンターのダウンタイムによるフェールオーバー (自然災害または IT 災害) | アプリケーションのデータ損失は最小限 | 1. 組織の BCP 計画を開始します <br/><br/>2.ASR ポータルを使用して、最新の時点またはリテンション期間 (ジャーナル) のポイントへの計画されていないフェールオーバーを開始します。| 1.組織の BCP 計画を開始します。 <br/><br/>2.ASR ポータルを使用して、最新の時点またはリテンション期間 (ジャーナル) のポイントへの計画されていないフェールオーバーを開始します。


## <a name="run-a-failover"></a>フェールオーバーの実行
この手順では、[復旧計画](site-recovery-create-recovery-plans.md)のフェールオーバーを実行する方法について説明します。 別の方法として 1 台の仮想マシン (または物理サーバー) を対象に、**[レプリケートされたアイテム]** ページからフェールオーバーを実行することもできます。


![フェールオーバー](./media/site-recovery-failover/Failover.png)

1. **[復旧計画]**  >  *recoveryplan_name* を選択します。 **[フェールオーバー]** をクリックします。
2. フェールオーバーで復旧するポイント (**[復旧ポイント]**) を **[フェールオーバー]** 画面で選択します。 次のいずれかのオプションを使うことができます。
    1.  **最新**(既定値): このオプションでは、Site Recovery サービスに送信されたすべてのデータを処理することからジョブを開始します。 データを処理すると、仮想マシンごとに復旧ポイントが作成されます。 この復旧ポイントは、フェールオーバー中に、仮想マシンによって使用されます。 このオプションは、フェールオーバー後に作成された仮想マシンが、フェールオーバーがトリガーされた時点で Site Recovery サービスにレプリケートされたすべてのデータを含むようになるので、最も低い RPO (目標復旧時点) を提供します。
    1.  **Latest processed (最新の処理済み)**: このオプションは、復旧計画のすべての仮想マシンを、Site Recovery サービスによって既に処理された最新の復旧ポイントにフェールオーバーします。 仮想マシンのテスト フェールオーバーを行っているときは、最新の処理済み復旧ポイントのタイムスタンプも表示されます。 復旧計画のフェールオーバーを行っている場合は、個別の仮想マシンに移動し、**[最新の復旧ポイント]** タイルを見てこの情報を取得できます。 未処理データの処理に時間は費やされないので、このオプションは低 RTO (目標復旧時間) のフェールオーバー オプションを提供します。
    1.  **Latest app-consistent (最新のアプリ整合性)**: このオプションは、復旧計画のすべての仮想マシンを、Site Recovery サービスによって既に処理された最新のアプリケーション整合性復旧ポイントにフェールオーバーします。 仮想マシンのテスト フェールオーバーを行っているときは、最新のアプリ整合性復旧ポイントのタイムスタンプも表示されます。 復旧計画のフェールオーバーを行っている場合は、個別の仮想マシンに移動し、**[最新の復旧ポイント]** タイルを見てこの情報を取得できます。
    1.  **Latest multi-VM processed (最新のマルチ VM 処理済み)**: このオプションは、マルチ VM 整合性がオンになっている 1 つ以上の仮想マシンを含む復旧計画でのみ使用できます。 レプリケーション グループに含まれる仮想マシンは、最新の共通マルチ VM 整合性復旧ポイントにフェールオーバーされます。 その他の仮想マシンは、最新の処理済み復旧ポイントにフェールオーバーされます。  
    1.  **Latest multi-VM app-consistent (最新のマルチ VM アプリ整合性)**: このオプションは、マルチ VM 整合性がオンになっている 1 つ以上の仮想マシンを含む復旧計画でのみ使用できます。 レプリケーション グループに含まれる仮想マシンは、最新の共通マルチ VM アプリケーション整合性復旧ポイントにフェールオーバーされます。 その他の仮想マシンは、最新のアプリケーション整合性復旧ポイントにフェールオーバーされます。
    1.  **Custom (カスタム)**: 仮想マシンのテスト フェールオーバーを行う場合は、このオプションを使って特定の復旧ポイントにフェールオーバーできます。

    > [!NOTE]
    > 復旧ポイントを選択するオプションは、フェールオーバー先が Azure である場合にのみ使用できます。
    >
    >


1. 前回の実行時に、復旧計画に含まれる一部の仮想マシンをフェールオーバー済みで、現在それらの仮想マシンが切り替え元と切り替え先の両方でアクティブになっている場合、**[方向の変更]** オプションを使用して、フェールオーバーの方向を変えることができます。
1. Azure にフェールオーバーし、クラウドのデータ暗号化が有効になっている場合には (VMM サーバーから Hyper-V 仮想マシンを保護した場合のみ)、**[暗号化キー]** で、VMM サーバーへのセットアップ中にデータ暗号化を有効にしたときに発行された証明書を選択します。
1. Site Recovery でフェールオーバーを開始する前にそのソース仮想マシンをシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** を選びます。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。  

    > [!NOTE]
    > Hyper-V 仮想マシンが保護されている場合、シャットダウン オプションを選ぶと、Site Recovery サービスへの送信が済んでいないオンプレミスのデータを同期するように、フェールオーバーの開始前に試行されます。
    >
    >

1. フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。 計画されていないフェールオーバーの実行中にエラーが発生しても、復旧計画は最後まで実行されることに注意してください。
1. フェールオーバーの実行後、仮想マシンにログインして検証します。 仮想マシンの別の復旧ポイントに切り替える場合は、**[復旧ポイントの変更]** を選びます。
1. 正常な状態に仮想マシンがフェールオーバーされたら、フェールオーバーを**コミット**することができます。 **サービスで利用できる復旧ポイントはコミット操作ですべて削除され**、それ以降 **[復旧ポイントの変更]** オプションは選択できなくなります。

## <a name="planned-failover"></a>計画されたフェールオーバー
Site Recovery を使用して保護されている仮想マシン/物理サーバーは、**計画されたフェールオーバー**もサポートしています。 計画されたフェールオーバーは、データの損失がまったく発生しないフェールオーバー方式です。 計画されたフェールオーバーを開始すると、まず、ソース仮想マシンがシャットダウンされ、最新のデータが同期されてから、フェールオーバーがトリガーされます。

> [!NOTE]
> オンプレミス サイト間で Hyper-V 仮想マシンをフェールオーバーしている間に、プライマリ オンプレミス サイトにフェールバックするには、まず仮想マシンをプライマリ サイトに逆レプリケーション (**レプリケーションの反転**) してからフェールオーバーを開始します。 プライマリ仮想マシンが利用できない場合は、**レプリケーションの反転**を実行する前に、バックアップから仮想マシンを復元してください。   
>
>
## <a name="failover-job"></a>フェールオーバー ジョブ

![フェールオーバー](./media/site-recovery-failover/FailoverJob.png)

フェールオーバーを開始すると次の手順が実行されます。

1. 前提条件チェック: フェールオーバーに必要な条件がすべて満たされていることが、この手順で確認されます。
1. フェールオーバー: この手順でデータが処理され、Azure 仮想マシンを作成する準備が整います。 復旧ポイントとして "**Latest (最新)**" を選択した場合は、Site Recovery サービスに送信済みのデータから復旧ポイントが作成されます。
1. 開始: 前の手順で処理されたデータを使って Azure 仮想マシンが作成されます。

> [!WARNING]
> **進行中のフェールオーバーはキャンセルしないでください**。仮想マシンのレプリケーションは、フェールオーバーが開始される前に停止されます。 進行中のジョブを**キャンセル**した場合、フェールオーバーは停止しますが、仮想マシンのレプリケートは開始されません。 二度とレプリケーションを開始できなくなります。
>
>

## <a name="time-taken-for-failover-to-azure"></a>Azure へのフェールオーバーにかかる時間

一部のケースでは、仮想マシンのフェールオーバーに、通常 8 ～ 10 分かかる特別な中間ステップが必要となります。 次の場合、フェールオーバーに要する時間は通常より長くなります。

* VMware 仮想マシンで使用されているモビリティ サービスのバージョンが 9.8 未満
* 物理サーバー
* VMware Linux 仮想マシン
* 物理サーバーとして保護されている Hyper-V 仮想マシン
* ブート ドライバーとして次のドライバーが存在していない VMware 仮想マシン
    * storvsc
    * vmbus
    * storflt
    * intelide
    * atapi
* DHCP サービス (DHCP と静的 IP アドレスのどちらでも可) が有効になっていない VMware 仮想マシン

その他すべてのケースでは、この中間ステップは不要であり、フェールオーバーに要する時間は短くなります。





## <a name="using-scripts-in-failover"></a>フェールオーバーでのスクリプト使用
フェールオーバーの実行中に特定の操作を自動化したい場合があります。 そのような場合は、[復旧計画](site-recovery-create-recovery-plans.md)の中でスクリプトまたは [Azure Automation Runbook](site-recovery-runbook-automation.md) を使用してください。

## <a name="post-failover-considerations"></a>フェールオーバー後の考慮事項
フェールオーバー後には、次の推奨事項を考慮することができます。
### <a name="retaining-drive-letter-after-failover"></a>フェールオーバー後のドライブ文字の維持
フェールオーバー後に仮想マシンのドライブ文字を維持するには、仮想マシンの **SAN ポリシー**を **OnlineAll** に設定します。 詳細については、[こちら](https://support.microsoft.com/en-us/help/3031135/how-to-preserve-the-drive-letter-for-protected-virtual-machines-that-are-failed-over-or-migrated-to-azure)を参照してください。



## <a name="next-steps"></a>次の手順

> [!WARNING]
> 仮想マシンのフェールオーバー後、オンプレミスのデータ センターが復旧したら、オンプレミス データ センターをレプリケーション先として、VMware 仮想マシンを[**再保護**](vmware-azure-reprotect.md)する必要があります。

Azure からオンプレミスに Hyper-V 仮想マシンを**フェールバック**するには、[**[計画されたフェールオーバー]**](hyper-v-azure-failback.md) オプションを使用します。

VMM サーバーによって管理された別のオンプレミス データ センターに Hyper-V 仮想マシンをフェールオーバーした後、プライマリ データ センターが稼働状態になった場合は、**[レプリケーションの反転]** オプションを使用して、プライマリ データ センターへの逆レプリケーションを開始してください。
