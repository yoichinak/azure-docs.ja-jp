---
title: Site Recovery を使用して Azure にレプリケートされた物理サーバーのフェールオーバーとフェールバック | Microsoft Docs
description: Azure Site Recovery を使用して、物理サーバーを Azure にフェールオーバーする方法と、オンプレミスにフェールバックする方法について説明します。
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 07/06/2018
ms.author: raynew
ms.openlocfilehash: 93f62bac3e2207caa265b3fca6634656d64b1491
ms.sourcegitcommit: a06c4177068aafc8387ddcd54e3071099faf659d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2018
ms.locfileid: "37918239"
---
# <a name="fail-over-and-fail-back-physical-servers-replicated-to-azure"></a>Azure にレプリケートされた物理サーバーのフェールオーバーとフェールバック

このチュートリアルでは、物理サーバーを Azure にフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったときにオンプレミス サイトにサーバーをフェールバックします。 

## <a name="preparing-for-failover-and-failback"></a>フェールオーバーとフェールバックを準備する

Site Recovery を使用して Azure にレプリケートされた物理サーバーは、VMware VM としてしかフェールバックできません。 フェールバックするには VMware インフラストラクチャが必要です。 

フェールオーバーとフェールバックには 4 つの段階があります。

1. **Azure にフェールオーバーする**: オンプレミス サイトのコンピューターを Azure にフェールオーバーします。
2. **Azure VM を再保護する**: Azure VM がオンプレミスの VMware VM へのレプリケートが開始されるように、Azure VM を再保護します。
3. **オンプレミスにフェールオーバーする**: フェールオーバーを実行して、Azure からフェールバックします。
4. **オンプレミス VM を再保護する**: データがフェールバックされたら、フェールバック先のオンプレミスの VMware VM を再保護します。これにより、オンプレミスの VMware VM は Azure へのレプリケートを開始できるようになります。

## <a name="verify-server-properties"></a>サーバーのプロパティを確認する

サーバーのプロパティで、サーバーが Azure VMの [Azure の要件](vmware-physical-azure-support-matrix.md#replicated-machines)に準拠していることを確認します。

1. **[保護されたアイテム]** で、**[レプリケートされたアイテム]** をクリックし、マシンを選びます。

2. **[レプリケートされたアイテム]** ウィンドウには、マシンの情報、正常性状態、および最新の使用可能な復旧ポイントの概要が表示されます。 **[プロパティ]** をクリックすると、詳細が表示されます。
3. **[コンピューティングとネットワーク]** で、Azure 名、リソース グループ、ターゲット サイズ、[可用性セット](../virtual-machines/windows/tutorial-availability-sets.md)、および[管理ディスクの設定](#managed-disk-considerations)を変更できます。
4. ネットワーク設定 (フェールオーバー後に Azure VM が配置されるネットワークやサブネット、割り当てられる IP アドレスなど) を表示および変更できます。
5. **[ディスク]** で、マシンのオペレーティング システム ディスクとデータ ディスクに関する情報を確認できます。

## <a name="run-a-failover-to-azure"></a>Azure へのフェールオーバーを実行する

1. **[設定]** > **[レプリケートされたアイテム]** で、[マシン] > **[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で、フェールオーバーする **[復旧ポイント]** を選択します。 次のいずれかのオプションを使うことができます。
   - **[最新]** (既定値): 最初に、Site Recovery に送信されるすべてのデータを処理します。 フェールオーバー後に作成された Azure VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
   - **[最後に処理があった時点]**: Site Recovery によって処理された最新の復旧ポイントに マシンをフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
   - **[最新のアプリ整合性]**: Site Recovery によって処理されたアプリ整合性の最新の復旧ポイントにマシンをフェールオーバーします。
   - **カスタム**: 復旧ポイントを指定します。

3. Site Recovery でフェールオーバーをトリガーする前にそのソース マシンをシャットダウンする場合は、**[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
4. Azure VM に接続する準備が完了したら、フェールオーバー後に接続して確認します。
5. 確認が完了したら、フェールオーバーを**コミット**します。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> 進行中のフェールオーバーを取り消さないでください。 フェールオーバーが開始する前にマシンのレプリケーションが停止します。 フェールオーバーを取り消すと、フェールオーバーは停止しますが、マシンが再びレプリケートしなくなります。
> 物理サーバーの場合、追加のフェールオーバー処理が完了するまでに 8 分から 10 分程度かかります。 

## <a name="create-a-process-server-in-azure"></a>Azure にプロセス サーバーを作成する

プロセス サーバーは、Azure VM からデータを受け取り、オンプレミス サイトにそのデータを送信します。 プロセス サーバーと保護されたマシンとの間には、待ち時間が短いネットワークが必要です。

- テスト目的の Azure ExpressRoute 接続がある場合は、構成サーバーに自動的にインストールされたオンプレミス プロセス サーバーを使用できます。
- VPN 接続がある場合、または運用環境でフェールバックを実行している場合、フェールバック用に Azure ベースのプロセス サーバーとして Azure VM を設定する必要があります。
- Azure でプロセス サーバーを設定するには、[この記事](vmware-azure-set-up-process-server-azure.md)の手順を実行してください。

## <a name="configure-the-master-target-server"></a>マスター ターゲット サーバーを構成する

既定では、マスター ターゲット サーバーは、フェールバック データを受信します。 これはオンプレミスの構成サーバーで実行します。

- VMware vCenter Server の管理対象の ESXi ホスト上に、フェールバック先の VMware VM がある場合、マスター ターゲット サーバーは、VM のデータストア (VMDK) へのアクセス権 (レプリケートされたデータを VM ディスクに書き込むアクセス権) を持っている必要があります。 VM データ ストアが、読み取りと書き込みアクセス権のあるマスター ターゲットのホストにマウントされていることを確認します。
- vCenter サーバーの管理対象ではない ESXi ホストの場合、再保護時に Site Recovery サービスによって新しい VM が作成されます。 この VM は、マスター ターゲット VM を作成する ESX ホスト上に作成されます。 VM のハード ディスクは、マスター ターゲット サーバーが実行されているホストからアクセスできるデータストア内に配置されている必要があります。
- フェールバックする物理マシンに関して、マシンを再保護する前に、マスター ターゲット サーバーが実行されているホストの検出を完了する必要があります。
- オンプレミス VM がフェールバックのために既に存在している場合、フェールバックを実行する前に削除するという選択肢もあります。 このようにすると、フェールバックにより、マスター ターゲット ESX ホストと同じホストに新しい VM が作成されます。 別の場所にフェールバックすると、オンプレミスのマスター ターゲット サーバーによって使用されるのと同じデータ ストアおよび同じ ESX ホストにデータは復元されます。
- マスター ターゲット サーバー上で Storage vMotion を使用することはできません。 Storage vMotion を使用しても、ディスクを使用できないため、フェールバックは動作しません。 そのため、vMotion の一覧からマスター ターゲット サーバーを除外してください。

## <a name="reprotect-azure-vms"></a>Azure VM を再保護する

この手順は、オンプレミス VM を使用できず、別の場所で再保護するという前提で説明します。

1. **[設定]** > **[レプリケートされたアイテム]** で、フェールオーバーした VM を右クリックし、**[再保護]** をクリックします。
2. **[再保護]** で、**[Azure からオンプレミスへ]** が選択されていることを確認します。
3. オンプレミス マスター ターゲット サーバーとプロセス サーバーを指定します。

4. **[データストア]** で、オンプレミスのディスクの復旧先のデータストアを選択します。 このオプションは、オンプレミスの VM を削除し、新しいディスクを作成する必要がある場合に使用します。 ディスクが既に存在する場合、この設定は無視されますが、値は指定しておく必要があります。
5. マスター ターゲットのリテンション ドライブを選択します。 フェールバック ポリシーは自動的に選択されます。
6. **[OK]** をクリックして再保護を開始します。 仮想マシンを Azure からオンプレミス サイトにレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。

> [!NOTE]
> Azure VM を既存のオンプレミスの VM に復旧する場合、マスター ターゲット サーバーの ESXi ホスト上で、読み取り/書き込みアクセス権のあるオンプレミスの仮想マシンのデータストアをマウントします。


## <a name="run-a-failover-from-azure-to-on-premises"></a>Azure からオンプレミスへのフェールオーバーを実行する

オンプレミスにレプリケートする場合、フェールバック ポリシーが使用されます。 このポリシーは、Azure へのレプリケーションのためにレプリケーション ポリシーを作成するときに、自動的に作成されます。

- このポリシーは自動的に構成サーバーに関連付けられます。
- このポリシーは変更できません。
- ポリシーの値は次のとおりです。
    - RPO しきい値 = 15 分
    - 復旧ポイントのリテンション期間 = 24 時間
    - アプリケーション整合性スナップショットの頻度 = 60 分

次のようにフェールオーバーを実行します。

1. **[レプリケートされたアイテム]** ページでマシンを右クリックし、**[計画されていないフェールオーバー]** をクリックします。
2. **[フェールオーバーの確認]** で、フェールオーバーの方向が Azure からであることを確認します。

3. フェールオーバーに使用する復旧ポイントを選択します。 アプリケーションと整合性が取れた最新の復旧ポイントは最新のポイントインタイムの前に発生するため、多少のデータ損失が発生します。 フェールオーバーが実行されると、Site Recovery は Azure VM をシャットダウンし、オンプレミスの VM を起動します。 ある程度のダウンタイムが発生するため、適切な時刻に実行してください。
4. マシンを右クリックし、**[コミット]** をクリックします。 Azure VM を削除するジョブがトリガーされます。
5. 予想どおりに Azure VM がシャットダウンされたことを確認します。


## <a name="reprotect-on-premises-machines-to-azure"></a>オンプレミスのマシンを Azure で再保護する

データはオンプレミス サイトに戻りましたが、Azure へのレプリケートは実行されていません。 Azure へのレプリケートを再開するには、次の手順を実行します。

1. コンテナーで **[設定]** >**[レプリケートされたアイテム]** の順にクリックして、フェールバックされた VM を選択し、**[再保護]** をクリックします。
2. レプリケートされたデータを Azure に送信するために使用するプロセス サーバーを選択し、**[OK]** をクリックします。

再保護が完了すると、VM が Azure にレプリケートされるので、必要に応じてフェールオーバーを実行できます。

