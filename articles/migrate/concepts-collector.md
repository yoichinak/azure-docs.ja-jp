---
title: Azure Migrate のコレクター アプライアンス | Microsoft Docs
description: コレクター アプライアンスの概要とその構成方法について説明します。
author: ruturaj
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 07/27/2018
ms.author: ruturajd
services: azure-migrate
ms.openlocfilehash: c99d0f74dbb8cc28cabebae60fe10645f4bdb3b6
ms.sourcegitcommit: cfff72e240193b5a802532de12651162c31778b6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/27/2018
ms.locfileid: "39308461"
---
# <a name="collector-appliance"></a>コレクター アプライアンス

[Azure Migrate](migrate-overview.md) は、オンプレミスのワークロードを評価することによって、Azure への移行を支援します。 この記事では、コレクター アプライアンスの使用方法について説明します。



## <a name="overview"></a>概要

Azure Migrate Collector は、オンプレミスの vCenter 環境の検出に使用できる軽量アプライアンスです。 このアプライアンスは、オンプレミスの VMware マシンを検出し、そのメタデータを Azure Migrate サービスに送信します。

コレクター アプライアンスは、Azure Migrate プロジェクトからダウンロードできる OVF です。 4 コア、8 GB の RAM、および 80 GB のディスク 1 台を装備した VMware 仮想マシンをインスタンス化します。 アプライアンスのオペレーティング システムは Windows Server 2012 R2 (64 ビット) です。

[コレクター VM の作成方法](tutorial-assessment-vmware.md#create-the-collector-vm)の手順を実行してコレクターを作成できます。

## <a name="collector-communication-diagram"></a>コレクターの通信ダイアグラム

![コレクターの通信ダイアグラム](./media/tutorial-assessment-vmware/portdiagram.PNG)


| コンポーネント      | 通信の対象   | 必要なポート                            | 理由                                   |
| -------------- | --------------------- | ---------------------------------------- | ---------------------------------------- |
| コレクター      | Azure Migrate サービス | TCP 443                                  | コレクターは、SSL ポート 443 経由でサービスと通信できる必要があります。 |
| コレクター      | vCenter Server        | 既定の 443                             | コレクターは、vCenter Server と通信できる必要があります。 既定では、443 経由で vCenter に接続します。 vCenter が別のポートをリッスンしている場合は、そのポートがコレクターの送信ポートとして使用可能である必要があります。 |
| コレクター      | RDP|   | TCP 3389 | RDP でコレクター マシンに接続できるようにするには |





## <a name="collector-pre-requisites"></a>コレクターの前提条件

コレクターが Azure Migrate サービスに接続し、検出されたデータをアップロードするためには、いくつかの前提条件チェックに合格する必要があります。 この記事では、各前提条件と、それが必要な理由について説明します。

### <a name="internet-connectivity"></a>インターネット接続

コレクター アプライアンスは、検出されたマシン情報を送信するためにインターネットに接続されている必要があります。 マシンは、次の 2 つの方法のいずれかで、インターネットに接続できます。

1. コレクターをインターネットに直接接続するよう構成することができます。
2. コレクターをプロキシ サーバー経由で接続するよう構成することができます。
    * プロキシ サーバーで認証が必要な場合は、接続設定でユーザー名とパスワードを指定できます。
    * プロキシ サーバーの IP アドレスまたは FQDN は、http://IPaddress または http://FQDN の形式である必要があります。 サポートされるのは HTTP プロキシのみです。

> [!NOTE]
> HTTPS ベースのプロキシ サーバーは、コレクターではサポートされていません。

#### <a name="whitelisting-urls-for-internet-connection"></a>インターネット接続用のホワイトリスト URL の作成

指定された設定を使用してコレクターがインターネットに接続できる場合は、前提条件のチェックに合格します。 接続チェックは、次の表に指定されている URL リストに接続することによって検証されます。 URL ベースのファイアウォール プロキシを使用して送信接続を制御している場合は、次の必須の URL を必ずホワイトリストに登録してください。

**URL** | **目的**  
--- | ---
*.portal.azure.com | Azure サービスとの接続性を確認し、時刻の同期の問題を検証するために必要です。

また、チェックでは次の URL への接続も検証されますが、アクセスできない場合もチェックは失敗しません。 次の URL のホワイトリストの作成は任意ですが、前提条件のチェックの工数を軽減するために手動の手順を実行する必要があります。

**URL** | **目的**  | **ホワイトリストを作成しない場合**
--- | --- | ---
*.oneget.org:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。
*.windows.net:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。
*.windowsazure.com:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。
*.powershellgallery.com:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。
*.msecnd.net:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。
*.visualstudio.com:443 | powershell ベースの vCenter PowerCLI モジュールをダウンロードするために必要です。 | PowerCLI のインストールが失敗します。 モジュールを手動でインストールします。

### <a name="time-is-in-sync-with-the-internet-server"></a>時刻がインターネットサーバーと同期されています

サービスに対する要求が認証されるには、コレクターはインターネット時刻サーバーと同期されている必要があります。 時刻を検証できるよう、portal.azure.com の URL にコレクターから接続できる必要があります。 マシンが同期していない場合は、次の手順を実行して、コレクター VM のクロックの時刻を現在の時刻と一致するよう変更する必要があります。

1. VM で管理者用のコマンド プロンプトを開きます。
1. タイム ゾーンを確認するには、w32tm /tz を実行します。
1. 時刻を同期するには、w32tm /resync を実行します。

### <a name="collector-service-should-be-running"></a>コレクター サービスを実行する必要があります

Azure Migrate Collector サービスが、マシンで実行されている必要があります。 このサービスは、マシンが起動したときに自動的に開始されます。 サービスが実行されていない場合は、コントロール パネルから *Azure Migrate Collector* サービスを開始できます。 コレクター サービスは、vCenter サーバーに接続し、マシンのメタデータとパフォーマンス データを収集し、サービスに送信します。

### <a name="vmware-powercli-65"></a>VMware PowerCLI 6.5

コレクターが vCenter server と通信し、マシンの詳細情報とパフォーマンス データを取得するためには、VMware PowerCLI powershell モジュールをインストールする必要があります。 Powershell モジュールは、前提条件のチェック中に、自動的にダウンロードされ、インストールされます。 自動ダウンロードでは、いくつかの URL がホワイトリスト化されている必要があり、ダウンロードに失敗した場合は、ホワイトリストに URL を追加してアクセスできるようにするか、モジュールを手動でインストールする必要があります。

次の手順を実行して、手動でモジュールをインストールします。

1. インターネットに接続せず PowerCli をコレクターにインストールするには、[このリンク](https://blogs.vmware.com/PowerCLI/2017/04/powercli-install-process-powershell-gallery.html)に記載されている手順を実行してください。
2. インターネットに接続された別のコンピューターに PowerShell モジュールをインストールしたら、そのマシンから、コレクターがインスト―ルされているマシンに VMware.* ファイルをコピーします。
3. 前提条件のチェックを再開し、PowerCLI がインストールされていることを確認します。

## <a name="connecting-to-vcenter-server"></a>vCenter Server への接続

コレクターは、vCenter Server に接続し、仮想マシン、メタデータ、およびパフォーマンス カウンターを取得できる必要があります。 このデータは、評価を計算するためにプロジェクトで使用されます。

1. vCenter Server に接続するには、以下の表に記載されているアクセス許可を持つ読み取り専用アカウントを使用して検出できます。

    |タスク  |必要なロールおよびアカウント  |アクセス許可  |
    |---------|---------|---------|
    |コレクター アプライアンスによる検出    | 少なくとも読み取り専用ユーザーが必要です。        |データ センター オブジェクト -> 子オブジェクトへのプロパゲート、ロール=読み取り専用         |

2. 指定された vCenter アカウントにアクセスできるデータ センターのみが検出できます。
3. vCenter サーバーに接続するには vCenter の FQDN または IP アドレスを指定する必要があります。 既定では、ポート 443 に接続します。 別のポート番号をリッスンするように vCenter が構成されている場合は、IPAddress:Port_Number または FQDN:Port_Number の形式でサーバー アドレスの一部として指定できます。
4. vCenter Server の統計情報の設定は、デプロイを始める前に、レベル 3 に設定する必要があります。 レベルが 3 未満の場合、検出は実行されますが、ストレージとネットワークのパフォーマンス データは収集されません。 この場合の推奨評価サイズは、CPU およびメモリのパフォーマンス データと、ディスクおよびネットワーク アダプターの構成データのみに基づいて計算されます。 収集されるデータ、およびそのデータの評価への影響について詳しくは、[詳細をお読み](./concepts-collector.md)ください。
5. コレクターには、vCenter サーバーにつながるネットワーク接続が必要です。

> [!NOTE]
> vCenter Server のバージョン 5.5、6.0、および 6.5 のみが公式にサポートされています。

> [!IMPORTANT]
> すべてのカウンターが正しく収集されるように、統計レベルを一般の最高レベル (3) に設定することをお勧めします。 vCenter を低いレベルに設定した場合、完全な形で収集できるカウンターがわずかになり、残りのカウンターがレベル 0 に設定したのと同じ結果になってしまう可能性があります。 その結果、評価が不完全なデータを示す場合があります。

### <a name="selecting-the-scope-for-discovery"></a>検出範囲の選択

vCenter に接続すると、検出範囲を選択できます。 検出範囲を選択すると、指定した vCenter インベントリ パスからすべての仮想マシンが検出されます。

1. 検出範囲には、データ センター、フォルダー、または ESXi ホストのいずれかを指定できます。
2. 一度に選択できる検出範囲は 1 つのみです。 より多くの仮想マシンを選択するには、1 つの検出を完了し、新しい検出範囲で検出プロセスを再開します。
3. 選択できるのは、"*仮想マシンが 1500 台未満*" の検出範囲のみです。

## <a name="specify-migration-project"></a>移行プロジェクトの指定

オンプレミスの vCenter に接続し、検出範囲を指定したら、検出および評価に使用する必要がある移行プロジェクトの詳細を指定できます。 プロジェクト ID とキーを指定し、接続します。

## <a name="start-discovery-and-view-collection-progress"></a>検出の開始と収集の進捗状況の表示

検出が開始されると、vCenter 仮想マシンが検出され、そのメタデータとパフォーマンス データがサーバーに送信されます。 進行状況では、次の ID も通知されます。

1. コレクター ID: コレクター マシンに指定されている一意の ID。 この ID は、異なる検出にまたがっても、特定のマシンについて一定です。 この ID は、Microsoft サポートに問題を報告するときに使用できます。
2. セッション ID: 実行中のコレクション ジョブの一意の ID。 検出ジョブが完了すると、ポータルで同じセッション ID を参照できます。 この ID は、コレクション ジョブごとに変更されます。 障害が発生した場合は、Microsoft サポートにこの ID を報告できます。

### <a name="what-data-is-collected"></a>どのデータが収集されますか。

コレクション ジョブでは、選択した仮想マシンに関する次の静的メタデータを検出します。

1. VM の表示名 (vCenter 上の)
2. VM のインベントリ パス (vCenter でのホスト/フォルダー)
3. IP アドレス
4. MAC アドレス
5. オペレーティング システム
5. コア、ディスク、NIC の数
6. メモリ サイズ、ディスク サイズ
7. 次の表に記載されている、VM、ディスク、およびネットワークのパフォーマンス カウンター。

次の表は、収集されるパフォーマンス カウンターと、特定のカウンターが収集されなかった場合に影響がある評価結果を示します。

|カウンター                                  |レベル    |デバイスごとのレベル  |評価の影響                               |
|-----------------------------------------|---------|------------------|------------------------------------------------|
|cpu.usage.average                        | 1       |該当なし                |推奨される VM サイズとコスト                    |
|mem.usage.average                        | 1       |該当なし                |推奨される VM サイズとコスト                    |
|virtualDisk.read.average                 | 2       |2                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.write.average                | 2       |2                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.numberReadAveraged.average   | 1       |3                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.numberWriteAveraged.average  | 1       |3                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|net.received.average                     | 2       |3                 |VM サイズとネットワーク コスト                        |
|net.transmitted.average                  | 2       |3                 |VM サイズとネットワーク コスト                        |

> [!WARNING]
> 統計レベルを高く設定した場合は、パフォーマンス カウンターを生成するのに最大 1 日かかります。 そのため、1 日経ってから検出を実行することをお勧めします。

### <a name="time-required-to-complete-the-collection"></a>収集を完了するために必要な時間

コレクターは、マシン データのみを検出し、プロジェクトに送信します。 プロジェクトによっては、ポータルに検出されたデータが表示され、評価の作成を開始できるまで時間がかかる場合があります。

選択された検出範囲にある仮想マシンの数によっては、プロジェクトに静的メタデータを送信するまで最大 15 分かかる場合があります。 静的メタデータがポータルに表示されると、ポータルにマシンの一覧が表示され、グループの作成を開始できます。 コレクション ジョブが完了し、プロジェクトでデータが処理されるまで、評価は作成できません。 選択された検出範囲にある仮想マシンの数によっては、コレクション ジョブがコレクターで完了してからポータルにパフォーマンス データが表示されるまで、最大 1 時間かかることがあります。

## <a name="locking-down-the-collector-appliance"></a>コレクター アプライアンスのロックダウン
コレクター アプライアンスでは、Windows 更新プログラムを継続的に実行することをお勧めします。 コレクターが 60 日間更新されていない場合、コレクターはマシンの自動シャット ダウンを開始します。 検出が実行中の場合は、60 日の期間を過ぎていたとしてもマシンはオフにされません。 検出ジョブの完了後、マシンはオフにされます。 45 日より長くコレクターを使用する予定であれば、Windows Update の実行によってマシンが常に更新され続けるようにすることをお勧めします。

また、次の手順に従ってアプライアンスをセキュリティで保護することをお勧めします
1. 管理者パスワードは、承認されていないパーティとの間で、共有したり誤って付与したりしないでください。
2. アプライアンスは、未使用時にはシャットダウンします。
3. アプライアンスはセキュリティで保護されたネットワークに配置します。
4. 移行作業が完了したら、アプライアンス インスタンスを削除します。 ディスクにはキャッシュされた vCenter 資格情報が存在する可能性があるため、ディスク バッキング ファイル (VMDK) も必ず削除します。

## <a name="how-to-upgrade-collector"></a>コレクターをアップグレードする方法

OVA を再度ダウンロードせずに、コレクターを最新バージョンにアップグレードできます。

1. 最新の[アップグレード パッケージ](https://aka.ms/migrate/col/upgrade_9_13) (バージョン 1.0.9.13) をダウンロードします。
2. ダウンロードした修正プログラムが安全であることを確認するために、管理者コマンド ウィンドウを開き、以下のコマンドを実行して、zip ファイルのハッシュを生成します。 生成されたハッシュは、その特定のバージョンのハッシュと一致する必要があります。

    ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```

    (たとえば、C:\>CertUtil -HashFile C:\AzureMigrate\CollectorUpdate_release_1.0.9.7.zip SHA256 のように使用します)
3. zip ファイルを Azure Migrate コレクター仮想マシン (コレクター アプライアンス) にコピーします。
4. zip ファイルを右クリックし、[すべて展開] を選択します。
5. Setup.ps1 を右クリックして [Run with PowerShell]\(PowerShell で実行\) を選択し、画面に指示に従って更新プログラムをインストールします。

### <a name="list-of-updates"></a>更新プログラムのリスト

#### <a name="upgrade-to-version-10913"></a>バージョン 1.0.9.13 へのアップグレード

アップグレード [パッケージ 1.0.9.13](https://aka.ms/migrate/col/upgrade_9_13) のハッシュ値

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | 739f588fe7fb95ce2a9b6b4d0bf9917e
SHA1 | 9b3365acad038eb1c62ca2b2de1467cb8eed37f6
SHA256 | 7a49fb8286595f39a29085534f29a623ec2edb12a3d76f90c9654b2f69eef87e

#### <a name="upgrade-to-version-10911"></a>バージョン 1.0.9.11 へのアップグレード

アップグレード [パッケージ 1.0.9.11](https://aka.ms/migrate/col/upgrade_9_11) のハッシュ値

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | 0e36129ac5383b204720df7a56b95a60
SHA1 | aa422ef6aa6b6f8bc88f27727e80272241de1bdf
SHA256 | 5f76dbbe40c5ccab3502cc1c5f074e4b4bcbf356d3721fd52fb7ff583ff2b68f

#### <a name="upgrade-to-version-1097"></a>バージョン 1.0.9.7 へのアップグレード

アップグレード [パッケージ 1.0.9.7](https://aka.ms/migrate/col/upgrade_9_7) のハッシュ値

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | 01ccd6bc0281f63f2a672952a2a25363
SHA1 | 3e6c57523a30d5610acdaa14b833c070bffddbff
SHA256 | e3ee031fb2d47b7881cc5b13750fc7df541028e0a1cc038c796789139aa8e1e6

## <a name="next-steps"></a>次の手順

[オンプレミスの VMware VM のアセスメントを設定する](tutorial-assessment-vmware.md)
