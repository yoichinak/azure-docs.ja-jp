---
title: Azure Migrate を使用したスケールの検出と評価 | Microsoft Docs
description: Azure Migrate サービスを使用して、多数のオンプレミス マシンを評価する方法について説明します。
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 07/03/2018
ms.author: raynew
ms.openlocfilehash: 4bcb6734c33d70e4045860a2c0f0acfedfa06eff
ms.sourcegitcommit: 248c2a76b0ab8c3b883326422e33c61bd2735c6c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/23/2018
ms.locfileid: "39215181"
---
# <a name="discover-and-assess-a-large-vmware-environment"></a>大規模な VMware 環境の検出と評価

Azure Migrate は 1 プロジェクトあたりのマシン数は 1,500 台に制限されていますが、この記事では、[Azure Migrate](migrate-overview.md) を使用して、多数のオンプレミスの仮想マシン (VM) を評価する方法について説明します。   

## <a name="prerequisites"></a>前提条件

- 
  **VMware**: 移行する予定の VM は、vCenter Server バージョン 5.5、6.0、または 6.5 で管理する必要があります。 また、コレクター VM を展開するために、バージョン 5.0 以降を稼働している ESXi ホストが 1 つ必要です。
- **vCenter アカウント**: vCenter Server にアクセスするために、読み取り専用アカウントが必要です。 Azure Migrate はこのアカウントを使ってオンプレミスの VM を検出します。
- **アクセス許可**: vCenter Server で、.OVA 形式でファイルをインポートして VM を作成するためのアクセス許可が必要です。
- **統計情報の設定**: デプロイを始める前に、vCenter Server の統計設定をレベル 3 に設定する必要があります。 レベルが 3 未満の場合、評価は機能しますが、ストレージとネットワークのパフォーマンス データが収集されません。 この場合の推奨サイズは、CPU とメモリのパフォーマンス データと、ディスクおよびネットワーク アダプターの構成データに基づきます。


### <a name="set-up-permissions"></a>アクセス許可の設定

Azure Migrate は、評価対象の VM を自動的に検出するために、VMware サーバーにアクセスする必要があります。 VMware アカウントには次のアクセス許可が必要です。

- ユーザーの種類: 読み取り専用以上
- アクセス許可: データ センター オブジェクト –> 子オブジェクトへの伝達、ロール=読み取り専用
- 詳細: ユーザーはデータセンター レベルで割り当てられ、データセンター内のすべてのオブジェクトに対してアクセス権を持ちます。
- アクセスを制限するには、子オブジェクトへの伝達特権を持つアクセスなしロールを子オブジェクト (vSphere ホスト、データストア、VM、ネットワーク) に割り当てます。

テナント環境にデプロイする場合、これを設定する 1 つの方法を以下に示します。

1.  テナントあたり 1 つのユーザーを作成し、[RBAC](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) を使用して、特定のテナントに属するすべての VM に読み取り専用のアクセス許可を割り当てます。 次にこれらの資格情報を使用して検出を行います。 RBAC により、対応する vCenter ユーザーが、テナント固有の VM のみにアクセスできるようになります。
2. 次の例でユーザー 1 とユーザー 2 について記載されているように、異なるテナント ユーザーに対して RBAC を設定します。

    - **[ユーザー名]** と **[パスワード]** に、コレクターが VM を検出するために使用する読み取り専用の資格情報を指定します。
    - Datacenter1 - ユーザー 1 とユーザー 2 に読み取り専用アクセス許可を付与します。 アクセス許可を個々の VM に設定するため、これらのアクセス許可をすべての子オブジェクトに反映しないようにします。

      - VM1 (テナント 1) (ユーザー 1 への読み取り専用アクセス許可)
      - VM2 (テナント 1) (ユーザー 1 への読み取り専用アクセス許可)
      - VM3 (テナント 2) (ユーザー 2 への読み取り専用アクセス許可)
      - VM4 (テナント 2) (ユーザー 2 への読み取り専用アクセス許可)

   - ユーザー 1 の資格情報を使用して検出を実行する場合、VM1 と VM2 のみが検出されます。

## <a name="plan-your-migration-projects-and-discoveries"></a>移行プロジェクトと検出を計画する

1 つの Azure Migrate コレクターは、複数の vCenter Server からの検出をサポートし (1 つずつ)、さらに複数の移行プロジェクトへの検出もサポートします (1 つずつ)。 コレクターはファイア アンド フォーゲット モデルで動作し、検出が完了すると、同じコレクターを使用して別の vCenter Server からデータを収集するか、別の移行プロジェクトにデータを送信できます。

以下の制限に基づいて、検出と評価を計画します。

| **エンティティ** | **マシンの制限** |
| ---------- | ----------------- |
| Project    | 1,500             |
| 探索  | 1,500             |
| 評価 | 1,500             |

このような計画の場合は、以下の事項を考慮してください。

- Azure Migrate コレクターを使用して検出を行う場合、検出範囲を vCenter Server フォルダー、データセンター、クラスター、またはホストに設定できます。
- 2 つ以上の検出を行うには、検出を行う VM が、マシンの数が 1500 台という制限に対応しているフォルダー、データセンター、クラスター、またはホスト内にあることを、vCenter Server で確認します。
- 評価を目的としている場合は、複数のマシンを同じプロジェクトと同じ評価内にまとめ、相互に依存関係にある状態にすることをお勧めします。 そして vCenter Server で、依存関係にあるマシンが評価のために同じフォルダー、データセンター、またはクラスター内にあることを確認してください。

シナリオに応じて、以下に示すように検出を分割することができます。

### <a name="multiple-vcenter-servers-with-less-than-1500-vms"></a>VM 数が 1,500 未満の複数の vCenter Server

ご使用の環境内に複数の vCenter Server があり、仮想マシンの合計数が 1,500 未満の場合は、1 つのコレクターと 1 つの移行プロジェクトを使用して、すべての vCenter Server 間ですべての仮想マシンを検出することができます。 コレクターは、一度に 1 つの vCenter Server を検出するため、すべての vCenter Server に対して同じコレクターを 1 つずつ実行し、そのコレクターを同じ移行プロジェクトにポイントできます。 すべての検出が完了すると、マシンの評価を作成できます。

### <a name="multiple-vcenter-servers-with-more-than-1500-vms"></a>VM 数が 1,500 を超える複数の vCenter Server

複数の vCenter Server がある場合、1 つの vCenter Server あたりの仮想マシン数は 1,500 未満であるが、すべての vCenter Serve では 1,500 を超えるときは、複数の移行プロジェクトを作成する必要があります (1 つの移行プロジェクトでは 1,500 台の VM しか保持できません)。 これを実現するには、vCenter Server ごとに移行プロジェクトを作成し、検出を分割します。 1 つのコレクターを使用して、各 vCenter Server を (1 つずつ) 検出できます。 検出を同時に開始する場合は、複数のアプライアンスをデプロイし、検出を並行して実行することもできます。

### <a name="more-than-1500-machines-in-a-single-vcenter-server"></a>1 つの vCenter Server に 1,500 を超えるマシンがある場合

1 つの vCenter Server に 1,500 を超える仮想マシンがある場合は、検出を複数の移行プロジェクトに分割する必要があります。 検出を分割するには、アプライアンスのスコープ フィールドを活用し、検出したいホスト、クラスター、フォルダーまたはデータセンターを指定することができます。 たとえば、vCenter Server に 2 つのフォルダーがあり、1 つに 1,000 の VM (Folder1) があり、もう 1 つに 800 の VM (Folder2) がある場合は、1 つのコレクターを使用して 2 つの検出を実行できます。 最初の検出では、スコープとして Folder1 を指定し、最初の移行プロジェクトにポイントすることができ、最初の検出が完了したら、同じコレクターを使用して、スコープを Folder2 に、また移行プロジェクトの詳細を 2 番目の移行プロジェクトに変更し、2 番目の検出を実行できます。

### <a name="multi-tenant-environment"></a>マルチテナント環境

テナント間で共有されている環境があり、別のテナントのサブスクリプションで 1 つのテナントの VM を検出したくない場合は、コレクター アプライアンスのスコープ フィールドを使用して、検出範囲を指定することができます。 テナントがホストを共有している場合は、特定のテナントに属する VM のみに読み取り専用アクセス権を持つ資格情報を作成してから、コレクター アプライアンスでこの資格情報を使用し、スコープをホストとして指定して検出を実行します。 または、vCenter Server で共有ホストの下にフォルダー (tenant1 の場合は folder1、tenant2 の場合は folder2 とします) を作成し、tenant1 の VM を folder1 に、tenant2 の VM を folder2 に移動してから、適切なフォルダーを指定して、適宜、コレクターの検出範囲を指定することもできます。

## <a name="discover-on-premises-environment"></a>オンプレミス環境の検出

計画が準備できたら、オンプレミス仮想マシンの検出を開始できます。

### <a name="create-a-project"></a>プロジェクトの作成

要件に従って Azure Migrate プロジェクトを作成します。

1. Azure Portal で、**[リソースの作成]** を選択します。
2. 「**Azure Migrate**」を検索し、検索結果でサービス **Azure Migrate (プレビュー)** を選択します。 **[作成]** を選択します。
3. プロジェクト名およびプロジェクトの Azure サブスクリプションを指定します。
4. 新しいリソース グループを作成します。
5. プロジェクトを作成する場所を指定し、**[作成]** を選択します。 別のターゲット場所の場合でも VM を評価することができます。 プロジェクト用に指定された場所は、オンプレミスの VM から収集されたメタデータを格納するために使用します。

### <a name="set-up-the-collector-appliance"></a>コレクター アプライアンスの設定

Azure Migrate は、コレクター アプライアンスと呼ばれるオンプレミスの VM を作成します。 この VM はオンプレミスの VMware VM を検出し、それについてのメタデータを Azure Migrate サービスに送信します。 コレクター アプライアンスをセットアップするには、.OVA ファイルをダウンロードしてオンプレミスの vCenter Server インスタンスにインポートします。

#### <a name="download-the-collector-appliance"></a>コレクター アプライアンスをダウンロードする

複数のプロジェクトがある場合でも、コレクター アプライアンスをダウンロードして vCenter Server にインポートするのは 1 度だけでかまいません。 アプライアンスをダウンロードしてセットアップした後、それを各プロジェクトで実行し、一意のプロジェクト ID とキーを指定します。

1. Azure Migrate プロジェクトで、**[開始]** > **[検出と評価]** > **[マシンの検出]** の順に選択します。
2. **[マシンの検出]** で **[ダウンロード]** を選択し、OVA ファイルをダウンロードします。
3. **[プロジェクトの資格情報をコピーします]** で、プロジェクトの ID とキーをコピーします。 これらの情報はコレクターを構成するときに必要になります。


#### <a name="verify-the-collector-appliance"></a>コレクター アプライアンスを確認する

OVA ファイルをデプロイする前に、そのファイルが安全であることを確認します。

1. ファイルをダウンロードしたマシンで、管理者用のコマンド ウィンドウを開きます。

2. 次のコマンドを実行して、OVA のハッシュを生成します。

   ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```

   使用例: ```C:\>CertUtil -HashFile C:\AzureMigrate\AzureMigrate.ova SHA256```

3. 生成されたハッシュが次の設定と一致することを確認します。

    OVA バージョン 1.0.9.12 の場合

    **アルゴリズム** | **ハッシュ値**
    --- | ---
    MD5 | d0363e5d1b377a8eb08843cf034ac28a
    SHA1 | df4a0ada64bfa59c37acf521d15dcabe7f3f716b
    SHA256 | f677b6c255e3d4d529315a31b5947edfe46f45e4eb4dbc8019d68d1d1b337c2e

    OVA バージョン 1.0.9.8 の場合

    **アルゴリズム** | **ハッシュ値**
    --- | ---
    MD5 | b5d9f0caf15ca357ac0563468c2e6251
    SHA1 | d6179b5bfe84e123fabd37f8a1e4930839eeb0e5
    SHA256 | 09c68b168719cb93bd439ea6a5fe21a3b01beec0e15b84204857061ca5b116ff

    OVA バージョン 1.0.9.7 の場合

    **アルゴリズム** | **ハッシュ値**
    --- | ---
    MD5 | d5b6a03701203ff556fa78694d6d7c35
    SHA1 | f039feaa10dccd811c3d22d9a59fb83d0b01151e
    SHA256 | e5e997c003e29036f62bf3fdce96acd4a271799211a84b34b35dfd290e9bea9c

    OVA バージョン 1.0.9.5 の場合

    **アルゴリズム** | **ハッシュ値**
    --- | ---
    MD5 | fb11ca234ed1f779a61fbb8439d82969
    SHA1 | 5bee071a6334b6a46226ec417f0d2c494709a42e
    SHA256 | b92ad637e7f522c1d7385b009e7d20904b7b9c28d6f1592e8a14d88fbdd3241c  

    OVA バージョン 1.0.9.2 の場合

    **アルゴリズム** | **ハッシュ値**
    --- | ---
    MD5 | 7326020e3b83f225b794920b7cb421fc
    SHA1 | a2d8d496fdca4bd36bfa11ddf460602fa90e30be
    SHA256 | f3d9809dd977c689dda1e482324ecd3da0a6a9a74116c1b22710acc19bea7bb2  

### <a name="create-the-collector-vm"></a>コレクター VM を作成する

ダウンロードしたファイルを vCenter Server にインポートします。

1. vSphere Client コンソールで、**[File]** > **[Deploy OVF Template]** の順に選択します。

    ![OVF をデプロイする](./media/how-to-scale-assessment/vcenter-wizard.png)

2. [Deploy OVF Template] ウィザードで **[Source]** を選択し、OVA ファイルの場所を指定します。
3. **[Name]\(名前\)** と **[Location]\(場所\)** で、コレクター VM のフレンドリ名と、VM がホストされるインベントリ オブジェクトを指定します。
4. **[Host/Cluster]\(ホスト/クラスター\)** で、コレクター VM が実行するホストまたはクラスターを指定します。
5. ストレージで、コレクター VM の保存先を指定します。
6. **[Disk Format]\(ディスク フォーマット\)** で、ディスクの種類とサイズを指定します。
7. **[Network Mapping]\(ネットワーク マッピング\)** で、コレクター VM の接続先となるネットワークを指定します。 このネットワークには、Azure にメタデータを送信するためのインターネット接続が必要です。
8. 設定を確認し、**[Finish]\(完了\)** を選択します。

### <a name="identify-the-id-and-key-for-each-project"></a>各プロジェクトの ID とキーの特定

プロジェクトが複数ある場合は、各プロジェクトの ID とキーを特定する必要があります。 キーは、コレクターを実行して VM を検出するときに必要になります。

1. プロジェクト内で、**[開始]** > **[検出と評価]** > **[マシンの検出]** の順に選択します。
2. **[プロジェクトの資格情報をコピーします]** で、プロジェクトの ID とキーをコピーします。
    ![[プロジェクトの資格情報をコピーします]](./media/how-to-scale-assessment/copy-project-credentials.png)

### <a name="set-the-vcenter-statistics-level"></a>vCenter の統計レベルを設定する
次の表は、検出中に収集されるパフォーマンス カウンターの一覧です。 カウンターは、既定では vCenter Server のさまざまなレベルで使用可能です。

すべてのカウンターが正しく収集されるように、統計レベルを一般の最高レベル (3) に設定することをお勧めします。 vCenter を低いレベルに設定した場合、完全な形で収集できるカウンターがわずかになり、残りのカウンターがレベル 0 に設定したのと同じ結果になってしまう可能性があります。 その結果、評価が不完全なデータを示す場合があります。

また、次の表では、特定のカウンターが収集されなかった場合に影響を受ける評価結果を示しています。

| カウンター                                 | Level | デバイスごとのレベル | 評価の影響                    |
| --------------------------------------- | ----- | ---------------- | ------------------------------------ |
| cpu.usage.average                       | 1     | 該当なし               | 推奨される VM サイズとコスト         |
| mem.usage.average                       | 1     | 該当なし               | 推奨される VM サイズとコスト         |
| virtualDisk.read.average                | 2     | 2                | ディスク サイズ、ストレージ コスト、VM サイズ |
| virtualDisk.write.average               | 2     | 2                | ディスク サイズ、ストレージ コスト、VM サイズ |
| virtualDisk.numberReadAveraged.average  | 1     | 3                | ディスク サイズ、ストレージ コスト、VM サイズ |
| virtualDisk.numberWriteAveraged.average | 1     | 3                | ディスク サイズ、ストレージ コスト、VM サイズ |
| net.received.average                    | 2     | 3                | VM サイズとネットワーク コスト             |
| net.transmitted.average                 | 2     | 3                | VM サイズとネットワーク コスト             |

> [!WARNING]
> 統計レベルを高く設定した場合は、パフォーマンス カウンターを生成するのに最大 1 日かかります。 そのため、1 日経ってから検出を実行することをお勧めします。

### <a name="run-the-collector-to-discover-vms"></a>コレクターを実行して VM を検出する

実行する必要があるそれぞれの検出について、コレクターを実行して指定のスコープの VM を検出します。 1 つずつ検出を実行します。 検出の同時実行はサポートされておらず、各検出は異なるスコープである必要があります。

1.  vSphere Client コンソールで、[VM] を右クリックして **[Open Console]\(コンソールを開く\)** を選択します。
2.  アプライアンスの設定で、言語、タイム ゾーン、パスワードを指定します。
3.  デスクトップにある **[Run collector]** ショートカットをクリックします。
4.  Azure Migrate コレクターで、**[Set up prerequisites]** を開きます。

    a.[サインオン URL] ボックスに、次のパターンを使用して、ユーザーが Pluralsight アプリケーションへのサインオンに使用する次の URL を入力します。 ライセンス条項に同意し、サード パーティの情報を確認します。

    VM がインターネットにアクセスできることをコレクターがチェックします。

    b. VM がプロキシ経由でインターネットにアクセスしている場合は、**[Proxy settings]** を選択し、プロキシ アドレスとリスニング ポートを指定します。 プロキシで認証が必要な場合は、資格情報を指定します。

    コレクター サービスが実行されていることをコレクターがチェックします。 このサービスは、既定でコレクター VM にインストールされています。

    c. VMware PowerCLI をダウンロードしてインストールします。

5.  **[Specify vCenter Server details]\(vCenter Server 詳細の指定\)** で、次の操作を行います。
    - vCenter Server の名前 (FQDN) または IP アドレスを指定します。
    - **[ユーザー名]** と **[パスワード]** で、コレクターが vCenter Server の VM を検出するために使用する読み取り専用の資格情報を指定します。
    - **[Select scope]\(スコープの選択\)** で、VM 検出のスコープを選択します。 コレクターは、指定されたスコープ内の VM のみを検出できます。 スコープは、指定のフォルダー、データセンター、またはクラスターに設定できます。 VM の数は 1,000 台を超えないようにします。

6.  **[Specify migration project]\(移行プロジェクトの指定\)** で、プロジェクトの ID とキーを指定します。 ID とキーをコピーしなかった場合は、コレクター VM から Azure Portal を開きます。 プロジェクトの **[概要]** ページで、**[マシンの検出]** を選択して値をコピーします。  
7.  **[View collection progress]** で検出プロセスを監視し、VM から収集されたメタデータがスコープ内にあることを確認します。 コレクターがおおよその検出時間を表示します。


#### <a name="verify-vms-in-the-portal"></a>ポータル内での VM の特定

検出時間は検出している VM の数によって異なります。 通常、VM が 100 台の場合、コレクターが実行を終了した後、検出が完了するまで約 1 時間かかります。

1. Azure Migrate プロジェクト内で、**[管理]** > **[マシン]** の順に選択します。
2. 検出対象の VM がポータルに表示されていることを確認します。


## <a name="next-steps"></a>次の手順

- 評価のために[グループを作成する](how-to-create-a-group.md)方法を確認します。
- 評価の計算方法の[詳細を確認](concepts-assessment-calculation.md)します。
